<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.38" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://zengkaiqiang562.github.io/java/concurrent/java-concurrent-questions-02.html"><meta property="og:site_name" content="Android Guide"><meta property="og:title" content="Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&é¢è¯•é¢˜æ€»ç»“ï¼ˆè¿›é˜¶ç¯‡ï¼‰"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-03-22T01:57:37.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="Javaå¹¶å‘"><meta property="article:modified_time" content="2022-03-22T01:57:37.000Z"><script>var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?5dd2e8c97962d57b7b8fea1737c01743";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2922463_99aa80ii7cf.css"><title>Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&é¢è¯•é¢˜æ€»ç»“ï¼ˆè¿›é˜¶ç¯‡ï¼‰ | Android Guide</title><meta name="description" content="Android å­¦ä¹  && é¢è¯•æŒ‡å—">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.c9a516cc.css">
    <link rel="modulepreload" href="/assets/app.2a01fc36.js"><link rel="modulepreload" href="/assets/java-concurrent-questions-02.html.1861adbc.js"><link rel="modulepreload" href="/assets/java-concurrent-questions-02.html.3aae12bb.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc sidebar-open"><!--[--><header class="navbar"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><a href="/" class="home-link"><img class="logo" src="/logo.png" alt="Android Guide"><!----><span class="site-name hide-in-pad">Android Guide</span><!--[--><!----><!--]--></a><nav class="nav-links" style=""><div class="nav-item hide-in-mobile"><a href="/home.html" class="nav-link" arialabel="é¢è¯•æŒ‡å—"><i class="icon iconfont icon-java"></i>é¢è¯•æŒ‡å—<!----></a></div><div class="nav-item hide-in-mobile"><a href="/zhuanlan/" class="nav-link" arialabel="ä¼˜è´¨ä¸“æ "><i class="icon iconfont icon-recommend"></i>ä¼˜è´¨ä¸“æ <!----></a></div><div class="nav-item hide-in-mobile"><a href="/open-source-project/" class="nav-link" arialabel="é¡¹ç›®ç²¾é€‰"><i class="icon iconfont icon-github"></i>é¡¹ç›®ç²¾é€‰<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://snailclimb.gitee.io/javaguide/#/" rel="noopener noreferrer" target="_blank" arialabel="æ—§ç‰ˆé“¾æ¥" class="nav-link"><i class="icon iconfont icon-java"></i>æ—§ç‰ˆé“¾æ¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="https://javaguide.cn/feed.json" rel="noopener noreferrer" target="_blank" arialabel="RSSè®¢é˜…" class="nav-link"><i class="icon iconfont icon-rss"></i>RSSè®¢é˜…<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="/about-the-author/" class="nav-link" arialabel="å…³äºä½œè€…"><i class="icon iconfont icon-zuozhe"></i>å…³äºä½œè€…<!----></a></div></nav><div class="nav-actions-wrapper"><!--[--><!----><!--]--><div class="nav-item"><!----></div><div class="nav-item"><a class="repo-link" href="https://github.com/zengkaiqiang562/JavaGuide" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" arialabelledby="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><title id="github" lang="en">github icon</title><g fill="currentColor"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></g></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" arialabelledby="auto" style="display:block;"><title id="auto" lang="en">auto icon</title><g fill="currentColor"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" arialabelledby="dark" style="display:none;"><title id="dark" lang="en">dark icon</title><g fill="currentColor"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" arialabelledby="light" style="display:none;"><title id="light" lang="en">light icon</title><g fill="currentColor"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></g></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button><!--[--><!----><!--]--></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-mianshi"></i><span class="title">é¢è¯•å‡†å¤‡</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><i class="icon iconfont icon-java"></i><span class="title">Java</span><span class="arrow down"></span></button><!--[--><!--[--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-basic"></i><span class="title">åŸºç¡€</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-container"></i><span class="title">å®¹å™¨</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><i class="icon iconfont icon-et-performance"></i><span class="title">å¹¶å‘ç¼–ç¨‹</span><span class="arrow down"></span></button><!--[--><!--[--><ul class="sidebar-links"><li><!--[--><a href="/java/concurrent/java-concurrent-questions-01.html" class="nav-link sidebar-link sidebar-page" arialabel="Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆåŸºç¡€ç¯‡ï¼‰"><!---->Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆåŸºç¡€ç¯‡ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" arialabel="Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆè¿›é˜¶ç¯‡ï¼‰"><!---->Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆè¿›é˜¶ç¯‡ï¼‰<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-synchronized-å…³é”®å­—" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.synchronized å…³é”®å­—"><!---->1.synchronized å…³é”®å­—<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-1-è¯´ä¸€è¯´è‡ªå·±å¯¹äº-synchronized-å…³é”®å­—çš„äº†è§£" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.1.è¯´ä¸€è¯´è‡ªå·±å¯¹äº synchronized å…³é”®å­—çš„äº†è§£"><!---->1.1.è¯´ä¸€è¯´è‡ªå·±å¯¹äº synchronized å…³é”®å­—çš„äº†è§£<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-2-è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨-synchronized-å…³é”®å­—" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.2. è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨ synchronized å…³é”®å­—"><!---->1.2. è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨ synchronized å…³é”®å­—<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨-synchronized-å…³é”®å­—ä¿®é¥°ä¹ˆ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.3. æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ä¹ˆï¼Ÿ"><!---->1.3. æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ä¹ˆï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-è®²ä¸€ä¸‹-synchronized-å…³é”®å­—çš„åº•å±‚åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.3. è®²ä¸€ä¸‹ synchronized å…³é”®å­—çš„åº•å±‚åŸç†"><!---->1.3. è®²ä¸€ä¸‹ synchronized å…³é”®å­—çš„åº•å±‚åŸç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-1-synchronized-åŒæ­¥è¯­å¥å—çš„æƒ…å†µ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.3.1. synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ"><!---->1.3.1. synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-2-synchronized-ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.3.2. synchronized ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ"><!---->1.3.2. synchronized ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-3-æ€»ç»“" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.3.3.æ€»ç»“"><!---->1.3.3.æ€»ç»“<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-4-è¯´è¯´-jdk1-6-ä¹‹åçš„-synchronized-å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–-å¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.4. è¯´è¯´ JDK1.6 ä¹‹åçš„ synchronized å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ï¼Œå¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—"><!---->1.4. è¯´è¯´ JDK1.6 ä¹‹åçš„ synchronized å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ï¼Œå¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-5-è°ˆè°ˆ-synchronized-å’Œ-reentrantlock-çš„åŒºåˆ«" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.5. è°ˆè°ˆ synchronized å’Œ ReentrantLock çš„åŒºåˆ«"><!---->1.5. è°ˆè°ˆ synchronized å’Œ ReentrantLock çš„åŒºåˆ«<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-5-1-ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.5.1. ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”"><!---->1.5.1. ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-5-2-synchronized-ä¾èµ–äº-jvm-è€Œ-reentrantlock-ä¾èµ–äº-api" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.5.2.synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API"><!---->1.5.2.synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-5-3-reentrantlock-æ¯”-synchronized-å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.5.3.ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½"><!---->1.5.3.ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-volatile-å…³é”®å­—" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2. volatile å…³é”®å­—"><!---->2. volatile å…³é”®å­—<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-1-cpu-ç¼“å­˜æ¨¡å‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.1. CPU ç¼“å­˜æ¨¡å‹"><!---->2.1. CPU ç¼“å­˜æ¨¡å‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-2-è®²ä¸€ä¸‹-jmm-java-å†…å­˜æ¨¡å‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.2. è®²ä¸€ä¸‹ JMM(Java å†…å­˜æ¨¡å‹)"><!---->2.2. è®²ä¸€ä¸‹ JMM(Java å†…å­˜æ¨¡å‹)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-3-å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.3. å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§"><!---->2.3. å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-4-è¯´è¯´-synchronized-å…³é”®å­—å’Œ-volatile-å…³é”®å­—çš„åŒºåˆ«" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.4. è¯´è¯´ synchronized å…³é”®å­—å’Œ volatile å…³é”®å­—çš„åŒºåˆ«"><!---->2.4. è¯´è¯´ synchronized å…³é”®å­—å’Œ volatile å…³é”®å­—çš„åŒºåˆ«<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-threadlocal" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3. ThreadLocal"><!---->3. ThreadLocal<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-1-threadlocal-ç®€ä»‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.1. ThreadLocal ç®€ä»‹"><!---->3.1. ThreadLocal ç®€ä»‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-2-threadlocal-ç¤ºä¾‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.2. ThreadLocal ç¤ºä¾‹"><!---->3.2. ThreadLocal ç¤ºä¾‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-3-threadlocal-åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.3. ThreadLocal åŸç†"><!---->3.3. ThreadLocal åŸç†<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-4-threadlocal-å†…å­˜æ³„éœ²é—®é¢˜" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.4. ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜"><!---->3.4. ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-çº¿ç¨‹æ± " class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4. çº¿ç¨‹æ± "><!---->4. çº¿ç¨‹æ± <!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-1-ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± " class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1. ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ"><!---->4.1. ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-2-å®ç°-runnable-æ¥å£å’Œ-callable-æ¥å£çš„åŒºåˆ«" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.2. å®ç° Runnable æ¥å£å’Œ Callable æ¥å£çš„åŒºåˆ«"><!---->4.2. å®ç° Runnable æ¥å£å’Œ Callable æ¥å£çš„åŒºåˆ«<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-3-æ‰§è¡Œ-execute-æ–¹æ³•å’Œ-submit-æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3. æ‰§è¡Œ execute()æ–¹æ³•å’Œ submit()æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ"><!---->4.3. æ‰§è¡Œ execute()æ–¹æ³•å’Œ submit()æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-4-å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± " class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.4. å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± "><!---->4.4. å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± <!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-5-threadpoolexecutor-ç±»åˆ†æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.5 ThreadPoolExecutor ç±»åˆ†æ"><!---->4.5 ThreadPoolExecutor ç±»åˆ†æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-5-1-threadpoolexecutoræ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.5.1 ThreadPoolExecutoræ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ"><!---->4.5.1 ThreadPoolExecutoræ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-5-2-threadpoolexecutor-é¥±å’Œç­–ç•¥" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.5.2 ThreadPoolExecutor é¥±å’Œç­–ç•¥"><!---->4.5.2 ThreadPoolExecutor é¥±å’Œç­–ç•¥<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-6-ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ± -demo" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.6 ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ±  Demo"><!---->4.6 ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ±  Demo<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-7-çº¿ç¨‹æ± åŸç†åˆ†æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.7 çº¿ç¨‹æ± åŸç†åˆ†æ"><!---->4.7 çº¿ç¨‹æ± åŸç†åˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-atomic-åŸå­ç±»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5. Atomic åŸå­ç±»"><!---->5. Atomic åŸå­ç±»<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-1-ä»‹ç»ä¸€ä¸‹-atomic-åŸå­ç±»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.1. ä»‹ç»ä¸€ä¸‹ Atomic åŸå­ç±»"><!---->5.1. ä»‹ç»ä¸€ä¸‹ Atomic åŸå­ç±»<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-2-juc-åŒ…ä¸­çš„åŸå­ç±»æ˜¯å“ª-4-ç±»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.2. JUC åŒ…ä¸­çš„åŸå­ç±»æ˜¯å“ª 4 ç±»?"><!---->5.2. JUC åŒ…ä¸­çš„åŸå­ç±»æ˜¯å“ª 4 ç±»?<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-3-è®²è®²-atomicinteger-çš„ä½¿ç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.3. è®²è®² AtomicInteger çš„ä½¿ç”¨"><!---->5.3. è®²è®² AtomicInteger çš„ä½¿ç”¨<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-4-èƒ½ä¸èƒ½ç»™æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹-atomicinteger-ç±»çš„åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.4. èƒ½ä¸èƒ½ç»™æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ AtomicInteger ç±»çš„åŸç†"><!---->5.4. èƒ½ä¸èƒ½ç»™æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ AtomicInteger ç±»çš„åŸç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-aqs" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6. AQS"><!---->6. AQS<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-1-aqs-ä»‹ç»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.1. AQS ä»‹ç»"><!---->6.1. AQS ä»‹ç»<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-2-aqs-åŸç†åˆ†æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.2. AQS åŸç†åˆ†æ"><!---->6.2. AQS åŸç†åˆ†æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-2-1-aqs-åŸç†æ¦‚è§ˆ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.2.1. AQS åŸç†æ¦‚è§ˆ"><!---->6.2.1. AQS åŸç†æ¦‚è§ˆ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-2-2-aqs-å¯¹èµ„æºçš„å…±äº«æ–¹å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.2.2. AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼"><!---->6.2.2. AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-2-3-aqs-åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.2.3. AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><!---->6.2.3. AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-3-aqs-ç»„ä»¶æ€»ç»“" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.3. AQS ç»„ä»¶æ€»ç»“"><!---->6.3. AQS ç»„ä»¶æ€»ç»“<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-4-ç”¨è¿‡-countdownlatch-ä¹ˆ-ä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.4. ç”¨è¿‡ CountDownLatch ä¹ˆï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„ï¼Ÿ"><!---->6.4. ç”¨è¿‡ CountDownLatch ä¹ˆï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_7-reference" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7 Reference"><!---->7 Reference<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-important"></i><span class="title">é‡è¦çŸ¥è¯†ç‚¹</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li></ul><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-virtual_machine"></i><span class="title">JVM</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-features"></i><span class="title">æ–°ç‰¹æ€§</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li></ul><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-computer"></i><span class="title">è®¡ç®—æœºåŸºç¡€</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-database"></i><span class="title">æ•°æ®åº“</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-Tools"></i><span class="title">å¼€å‘å·¥å…·</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-xitongsheji"></i><span class="title">ç³»ç»Ÿè®¾è®¡</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-distributed-network"></i><span class="title">åˆ†å¸ƒå¼</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-et-performance"></i><span class="title">é«˜æ€§èƒ½</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-CalendarAvailability-1"></i><span class="title">é«˜å¯ç”¨</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆè¿›é˜¶ç¯‡ï¼‰</h1><div class="article-info"><span class="author-info" arialabel="ä½œè€…ğŸ–Š" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" arialabelledby="author"><title id="author" lang="en">author icon</title><g fill="currentColor"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></g></svg><span><a class="author-item" href="https://zengkaiqiang562.github.io/" target="_blank" rel="noopener noreferrer">Zenk562</a></span><span property="author" content="Zenk562"></span></span><span class="category-info" arialabel="åˆ†ç±»ğŸŒˆ" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" arialabelledby="category"><title id="category" lang="en">category icon</title><g fill="currentColor"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></g></svg><ul class="categories-wrapper"><li class="category clickable" role="navigation">Java</li><meta property="articleSection" content="Java"></ul></span><span arialabel="æ ‡ç­¾ğŸ·" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" arialabelledby="tag"><title id="tag" lang="en">tag icon</title><g fill="currentColor"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></g></svg><ul class="tags-wrapper"><li class="tag clickable" role="navigation">Javaå¹¶å‘</li></ul><meta property="keywords" content="Javaå¹¶å‘"></span><span class="date-info" arialabel="å†™ä½œæ—¥æœŸğŸ“…" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" arialabelledby="calendar"><title id="calendar" lang="en">calendar icon</title><g fill="currentColor"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></g></svg><span>2022å¹´1æœˆ31æ—¥</span><meta property="datePublished" content="2022-01-31T08:51:23.000Z"></span><!----><span class="words-info" arialabel="å­—æ•°ğŸ” " isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" arialabelledby="word"><title id="word" lang="en">word icon</title><g fill="currentColor"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></g></svg><span>çº¦ 13203 å­—</span><meta property="wordCount" content="13203"></span></div><hr></div><div class="toc-place-holder"><aside id="toc-list"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-synchronized-å…³é”®å­—" class="router-link-active router-link-exact-active toc-link level2">1.synchronized å…³é”®å­—</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-1-è¯´ä¸€è¯´è‡ªå·±å¯¹äº-synchronized-å…³é”®å­—çš„äº†è§£" class="router-link-active router-link-exact-active toc-link level3">1.1.è¯´ä¸€è¯´è‡ªå·±å¯¹äº synchronized å…³é”®å­—çš„äº†è§£</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-2-è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨-synchronized-å…³é”®å­—" class="router-link-active router-link-exact-active toc-link level3">1.2. è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨ synchronized å…³é”®å­—</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨-synchronized-å…³é”®å­—ä¿®é¥°ä¹ˆ" class="router-link-active router-link-exact-active toc-link level3">1.3. æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ä¹ˆï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-è®²ä¸€ä¸‹-synchronized-å…³é”®å­—çš„åº•å±‚åŸç†" class="router-link-active router-link-exact-active toc-link level3">1.3. è®²ä¸€ä¸‹ synchronized å…³é”®å­—çš„åº•å±‚åŸç†</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-1-synchronized-åŒæ­¥è¯­å¥å—çš„æƒ…å†µ" class="router-link-active router-link-exact-active toc-link level4">1.3.1. synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-2-synchronized-ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ" class="router-link-active router-link-exact-active toc-link level4">1.3.2. synchronized ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-3-3-æ€»ç»“" class="router-link-active router-link-exact-active toc-link level4">1.3.3.æ€»ç»“</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-4-è¯´è¯´-jdk1-6-ä¹‹åçš„-synchronized-å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–-å¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—" class="router-link-active router-link-exact-active toc-link level3">1.4. è¯´è¯´ JDK1.6 ä¹‹åçš„ synchronized å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ï¼Œå¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-5-è°ˆè°ˆ-synchronized-å’Œ-reentrantlock-çš„åŒºåˆ«" class="router-link-active router-link-exact-active toc-link level3">1.5. è°ˆè°ˆ synchronized å’Œ ReentrantLock çš„åŒºåˆ«</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-5-1-ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”" class="router-link-active router-link-exact-active toc-link level4">1.5.1. ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-5-2-synchronized-ä¾èµ–äº-jvm-è€Œ-reentrantlock-ä¾èµ–äº-api" class="router-link-active router-link-exact-active toc-link level4">1.5.2.synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_1-5-3-reentrantlock-æ¯”-synchronized-å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½" class="router-link-active router-link-exact-active toc-link level4">1.5.3.ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½</a></li><!----><!--]--></ul><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-volatile-å…³é”®å­—" class="router-link-active router-link-exact-active toc-link level2">2. volatile å…³é”®å­—</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-1-cpu-ç¼“å­˜æ¨¡å‹" class="router-link-active router-link-exact-active toc-link level3">2.1. CPU ç¼“å­˜æ¨¡å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-2-è®²ä¸€ä¸‹-jmm-java-å†…å­˜æ¨¡å‹" class="router-link-active router-link-exact-active toc-link level3">2.2. è®²ä¸€ä¸‹ JMM(Java å†…å­˜æ¨¡å‹)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-3-å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§" class="router-link-active router-link-exact-active toc-link level3">2.3. å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_2-4-è¯´è¯´-synchronized-å…³é”®å­—å’Œ-volatile-å…³é”®å­—çš„åŒºåˆ«" class="router-link-active router-link-exact-active toc-link level3">2.4. è¯´è¯´ synchronized å…³é”®å­—å’Œ volatile å…³é”®å­—çš„åŒºåˆ«</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-threadlocal" class="router-link-active router-link-exact-active toc-link level2">3. ThreadLocal</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-1-threadlocal-ç®€ä»‹" class="router-link-active router-link-exact-active toc-link level3">3.1. ThreadLocal ç®€ä»‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-2-threadlocal-ç¤ºä¾‹" class="router-link-active router-link-exact-active toc-link level3">3.2. ThreadLocal ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-3-threadlocal-åŸç†" class="router-link-active router-link-exact-active toc-link level3">3.3. ThreadLocal åŸç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_3-4-threadlocal-å†…å­˜æ³„éœ²é—®é¢˜" class="router-link-active router-link-exact-active toc-link level3">3.4. ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-çº¿ç¨‹æ± " class="router-link-active router-link-exact-active toc-link level2">4. çº¿ç¨‹æ± </a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-1-ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± " class="router-link-active router-link-exact-active toc-link level3">4.1. ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-2-å®ç°-runnable-æ¥å£å’Œ-callable-æ¥å£çš„åŒºåˆ«" class="router-link-active router-link-exact-active toc-link level3">4.2. å®ç° Runnable æ¥å£å’Œ Callable æ¥å£çš„åŒºåˆ«</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-3-æ‰§è¡Œ-execute-æ–¹æ³•å’Œ-submit-æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢" class="router-link-active router-link-exact-active toc-link level3">4.3. æ‰§è¡Œ execute()æ–¹æ³•å’Œ submit()æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-4-å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± " class="router-link-active router-link-exact-active toc-link level3">4.4. å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± </a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-5-threadpoolexecutor-ç±»åˆ†æ" class="router-link-active router-link-exact-active toc-link level3">4.5 ThreadPoolExecutor ç±»åˆ†æ</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-5-1-threadpoolexecutoræ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ" class="router-link-active router-link-exact-active toc-link level4">4.5.1 ThreadPoolExecutoræ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-5-2-threadpoolexecutor-é¥±å’Œç­–ç•¥" class="router-link-active router-link-exact-active toc-link level4">4.5.2 ThreadPoolExecutor é¥±å’Œç­–ç•¥</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-6-ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ± -demo" class="router-link-active router-link-exact-active toc-link level3">4.6 ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ±  Demo</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_4-7-çº¿ç¨‹æ± åŸç†åˆ†æ" class="router-link-active router-link-exact-active toc-link level3">4.7 çº¿ç¨‹æ± åŸç†åˆ†æ</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-atomic-åŸå­ç±»" class="router-link-active router-link-exact-active toc-link level2">5. Atomic åŸå­ç±»</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-1-ä»‹ç»ä¸€ä¸‹-atomic-åŸå­ç±»" class="router-link-active router-link-exact-active toc-link level3">5.1. ä»‹ç»ä¸€ä¸‹ Atomic åŸå­ç±»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-2-juc-åŒ…ä¸­çš„åŸå­ç±»æ˜¯å“ª-4-ç±»" class="router-link-active router-link-exact-active toc-link level3">5.2. JUC åŒ…ä¸­çš„åŸå­ç±»æ˜¯å“ª 4 ç±»?</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-3-è®²è®²-atomicinteger-çš„ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level3">5.3. è®²è®² AtomicInteger çš„ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_5-4-èƒ½ä¸èƒ½ç»™æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹-atomicinteger-ç±»çš„åŸç†" class="router-link-active router-link-exact-active toc-link level3">5.4. èƒ½ä¸èƒ½ç»™æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ AtomicInteger ç±»çš„åŸç†</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-aqs" class="router-link-active router-link-exact-active toc-link level2">6. AQS</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-1-aqs-ä»‹ç»" class="router-link-active router-link-exact-active toc-link level3">6.1. AQS ä»‹ç»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-2-aqs-åŸç†åˆ†æ" class="router-link-active router-link-exact-active toc-link level3">6.2. AQS åŸç†åˆ†æ</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-2-1-aqs-åŸç†æ¦‚è§ˆ" class="router-link-active router-link-exact-active toc-link level4">6.2.1. AQS åŸç†æ¦‚è§ˆ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-2-2-aqs-å¯¹èµ„æºçš„å…±äº«æ–¹å¼" class="router-link-active router-link-exact-active toc-link level4">6.2.2. AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-2-3-aqs-åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="router-link-active router-link-exact-active toc-link level4">6.2.3. AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-3-aqs-ç»„ä»¶æ€»ç»“" class="router-link-active router-link-exact-active toc-link level3">6.3. AQS ç»„ä»¶æ€»ç»“</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_6-4-ç”¨è¿‡-countdownlatch-ä¹ˆ-ä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„" class="router-link-active router-link-exact-active toc-link level3">6.4. ç”¨è¿‡ CountDownLatch ä¹ˆï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„ï¼Ÿ</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/java-concurrent-questions-02.html#_7-reference" class="router-link-active router-link-exact-active toc-link level2">7 Reference</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><!--[--><h2 id="_1-synchronized-å…³é”®å­—" tabindex="-1"><a class="header-anchor" href="#_1-synchronized-å…³é”®å­—" aria-hidden="true">#</a> 1.synchronized å…³é”®å­—</h2><h3 id="_1-1-è¯´ä¸€è¯´è‡ªå·±å¯¹äº-synchronized-å…³é”®å­—çš„äº†è§£" tabindex="-1"><a class="header-anchor" href="#_1-1-è¯´ä¸€è¯´è‡ªå·±å¯¹äº-synchronized-å…³é”®å­—çš„äº†è§£" aria-hidden="true">#</a> 1.1.è¯´ä¸€è¯´è‡ªå·±å¯¹äº synchronized å…³é”®å­—çš„äº†è§£</h3><p><strong><code>synchronized</code> å…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ï¼Œ<code>synchronized</code>å…³é”®å­—å¯ä»¥ä¿è¯è¢«å®ƒä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åœ¨ä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚</strong></p><p>å¦å¤–ï¼Œåœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œ<code>synchronized</code> å±äº <strong>é‡é‡çº§é”</strong>ï¼Œæ•ˆç‡ä½ä¸‹ã€‚</p><p><strong>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</strong></p><p>å› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ <code>Mutex Lock</code> æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚</p><p>åº†å¹¸çš„æ˜¯åœ¨ Java 6 ä¹‹å Java å®˜æ–¹å¯¹ä» JVM å±‚é¢å¯¹ <code>synchronized</code> è¾ƒå¤§ä¼˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨çš„ <code>synchronized</code> é”æ•ˆç‡ä¹Ÿä¼˜åŒ–å¾—å¾ˆä¸é”™äº†ã€‚JDK1.6 å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚</p><p>æ‰€ä»¥ï¼Œä½ ä¼šå‘ç°ç›®å‰çš„è¯ï¼Œä¸è®ºæ˜¯å„ç§å¼€æºæ¡†æ¶è¿˜æ˜¯ JDK æºç éƒ½å¤§é‡ä½¿ç”¨äº† <code>synchronized</code> å…³é”®å­—ã€‚</p><h3 id="_1-2-è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨-synchronized-å…³é”®å­—" tabindex="-1"><a class="header-anchor" href="#_1-2-è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨-synchronized-å…³é”®å­—" aria-hidden="true">#</a> 1.2. è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨ synchronized å…³é”®å­—</h3><p><strong>synchronized å…³é”®å­—æœ€ä¸»è¦çš„ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š</strong></p><p><strong>1.ä¿®é¥°å®ä¾‹æ–¹æ³•:</strong> ä½œç”¨äºå½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— <strong>å½“å‰å¯¹è±¡å®ä¾‹çš„é”</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//ä¸šåŠ¡ä»£ç </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>2.ä¿®é¥°é™æ€æ–¹æ³•:</strong> ä¹Ÿå°±æ˜¯ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œç”¨äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— <strong>å½“å‰ class çš„é”</strong>ã€‚å› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ˜¯ç±»æˆå‘˜ï¼ˆ <em>static è¡¨æ˜è¿™æ˜¯è¯¥ç±»çš„ä¸€ä¸ªé™æ€èµ„æºï¼Œä¸ç®¡ new äº†å¤šå°‘ä¸ªå¯¹è±¡ï¼Œåªæœ‰ä¸€ä»½</em>ï¼‰ã€‚æ‰€ä»¥ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ A è°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€ <code>synchronized</code> æ–¹æ³•ï¼Œè€Œçº¿ç¨‹ B éœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ <code>synchronized</code> æ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œ<strong>å› ä¸ºè®¿é—®é™æ€ <code>synchronized</code> æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„é”ï¼Œè€Œè®¿é—®éé™æ€ <code>synchronized</code> æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”</strong>ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//ä¸šåŠ¡ä»£ç </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>3.ä¿®é¥°ä»£ç å—</strong> ï¼šæŒ‡å®šåŠ é”å¯¹è±¡ï¼Œå¯¹ç»™å®šå¯¹è±¡/ç±»åŠ é”ã€‚<code>synchronized(this|object)</code> è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾—<strong>ç»™å®šå¯¹è±¡çš„é”</strong>ã€‚<code>synchronized(ç±».class)</code> è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— <strong>å½“å‰ class çš„é”</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//ä¸šåŠ¡ä»£ç </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>æ€»ç»“ï¼š</strong></p><ul><li><code>synchronized</code> å…³é”®å­—åŠ åˆ° <code>static</code> é™æ€æ–¹æ³•å’Œ <code>synchronized(class)</code> ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ã€‚</li><li><code>synchronized</code> å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ã€‚</li><li>å°½é‡ä¸è¦ä½¿ç”¨ <code>synchronized(String a)</code> å› ä¸º JVM ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ï¼</li></ul><p>ä¸‹é¢æˆ‘ä»¥ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ä¸ºä¾‹è®²è§£ä¸€ä¸‹ <code>synchronized</code> å…³é”®å­—çš„å…·ä½“ä½¿ç”¨ã€‚</p><p>é¢è¯•ä¸­é¢è¯•å®˜ç»å¸¸ä¼šè¯´ï¼šâ€œå•ä¾‹æ¨¡å¼äº†è§£å—ï¼Ÿæ¥ç»™æˆ‘æ‰‹å†™ä¸€ä¸‹ï¼ç»™æˆ‘è§£é‡Šä¸€ä¸‹åŒé‡æ£€éªŒé”æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼çš„åŸç†å‘—ï¼â€</p><p><strong>åŒé‡æ ¡éªŒé”å®ç°å¯¹è±¡å•ä¾‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> uniqueInstance<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span>  <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getUniqueInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»å®ä¾‹è¿‡ï¼Œæ²¡æœ‰å®ä¾‹åŒ–è¿‡æ‰è¿›å…¥åŠ é”ä»£ç </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uniqueInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ç±»å¯¹è±¡åŠ é”</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>uniqueInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    uniqueInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> uniqueInstance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>å¦å¤–ï¼Œéœ€è¦æ³¨æ„ <code>uniqueInstance</code> é‡‡ç”¨ <code>volatile</code> å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦ã€‚</p><p><code>uniqueInstance</code> é‡‡ç”¨ <code>volatile</code> å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ <code>uniqueInstance = new Singleton();</code> è¿™æ®µä»£ç å…¶å®æ˜¯åˆ†ä¸ºä¸‰æ­¥æ‰§è¡Œï¼š</p><ol><li>ä¸º <code>uniqueInstance</code> åˆ†é…å†…å­˜ç©ºé—´</li><li>åˆå§‹åŒ– <code>uniqueInstance</code></li><li>å°† <code>uniqueInstance</code> æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€</li></ol><p>ä½†æ˜¯ç”±äº JVM å…·æœ‰æŒ‡ä»¤é‡æ’çš„ç‰¹æ€§ï¼Œæ‰§è¡Œé¡ºåºæœ‰å¯èƒ½å˜æˆ 1-&gt;3-&gt;2ã€‚æŒ‡ä»¤é‡æ’åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¯¼è‡´ä¸€ä¸ªçº¿ç¨‹è·å¾—è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œçº¿ç¨‹ T1 æ‰§è¡Œäº† 1 å’Œ 3ï¼Œæ­¤æ—¶ T2 è°ƒç”¨ <code>getUniqueInstance</code>() åå‘ç° <code>uniqueInstance</code> ä¸ä¸ºç©ºï¼Œå› æ­¤è¿”å› <code>uniqueInstance</code>ï¼Œä½†æ­¤æ—¶ <code>uniqueInstance</code> è¿˜æœªè¢«åˆå§‹åŒ–ã€‚</p><p>ä½¿ç”¨ <code>volatile</code> å¯ä»¥ç¦æ­¢ JVM çš„æŒ‡ä»¤é‡æ’ï¼Œä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚</p><h3 id="_1-3-æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨-synchronized-å…³é”®å­—ä¿®é¥°ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_1-3-æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨-synchronized-å…³é”®å­—ä¿®é¥°ä¹ˆ" aria-hidden="true">#</a> 1.3. æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ä¹ˆï¼Ÿ</h3><p>å…ˆè¯´ç»“è®ºï¼š<strong>æ„é€ æ–¹æ³•ä¸èƒ½ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ã€‚</strong></p><p>æ„é€ æ–¹æ³•æœ¬èº«å°±å±äºçº¿ç¨‹å®‰å…¨çš„ï¼Œä¸å­˜åœ¨åŒæ­¥çš„æ„é€ æ–¹æ³•ä¸€è¯´ã€‚</p><h3 id="_1-3-è®²ä¸€ä¸‹-synchronized-å…³é”®å­—çš„åº•å±‚åŸç†" tabindex="-1"><a class="header-anchor" href="#_1-3-è®²ä¸€ä¸‹-synchronized-å…³é”®å­—çš„åº•å±‚åŸç†" aria-hidden="true">#</a> 1.3. è®²ä¸€ä¸‹ synchronized å…³é”®å­—çš„åº•å±‚åŸç†</h3><p><strong>synchronized å…³é”®å­—åº•å±‚åŸç†å±äº JVM å±‚é¢ã€‚</strong></p><h4 id="_1-3-1-synchronized-åŒæ­¥è¯­å¥å—çš„æƒ…å†µ" tabindex="-1"><a class="header-anchor" href="#_1-3-1-synchronized-åŒæ­¥è¯­å¥å—çš„æƒ…å†µ" aria-hidden="true">#</a> 1.3.1. synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;synchronized ä»£ç å—&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>é€šè¿‡ JDK è‡ªå¸¦çš„ <code>javap</code> å‘½ä»¤æŸ¥çœ‹ <code>SynchronizedDemo</code> ç±»çš„ç›¸å…³å­—èŠ‚ç ä¿¡æ¯ï¼šé¦–å…ˆåˆ‡æ¢åˆ°ç±»çš„å¯¹åº”ç›®å½•æ‰§è¡Œ <code>javac SynchronizedDemo.java</code> å‘½ä»¤ç”Ÿæˆç¼–è¯‘åçš„ .class æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ<code>javap -c -s -v -l SynchronizedDemo.class</code>ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/synchronizedå…³é”®å­—åŸç†.png" alt="synchronizedå…³é”®å­—åŸç†" loading="lazy"></p><p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š<strong><code>synchronized</code> åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ <code>monitorenter</code> å’Œ <code>monitorexit</code> æŒ‡ä»¤ï¼Œå…¶ä¸­ <code>monitorenter</code> æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ<code>monitorexit</code> æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚</strong></p><p>å½“æ‰§è¡Œ <code>monitorenter</code> æŒ‡ä»¤æ—¶ï¼Œçº¿ç¨‹è¯•å›¾è·å–é”ä¹Ÿå°±æ˜¯è·å– <strong>å¯¹è±¡ç›‘è§†å™¨ <code>monitor</code></strong> çš„æŒæœ‰æƒã€‚</p><blockquote><p>åœ¨ Java è™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitor æ˜¯åŸºäº C++å®ç°çš„ï¼Œç”±<a href="https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp" target="_blank" rel="noopener noreferrer">ObjectMonitor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>å®ç°çš„ã€‚æ¯ä¸ªå¯¹è±¡ä¸­éƒ½å†…ç½®äº†ä¸€ä¸ª <code>ObjectMonitor</code>å¯¹è±¡ã€‚</p><p>å¦å¤–ï¼Œ<code>wait/notify</code>ç­‰æ–¹æ³•ä¹Ÿä¾èµ–äº<code>monitor</code>å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨<code>wait/notify</code>ç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º<code>java.lang.IllegalMonitorStateException</code>çš„å¼‚å¸¸çš„åŸå› ã€‚</p></blockquote><p>åœ¨æ‰§è¡Œ<code>monitorenter</code>æ—¶ï¼Œä¼šå°è¯•è·å–å¯¹è±¡çš„é”ï¼Œå¦‚æœé”çš„è®¡æ•°å™¨ä¸º 0 åˆ™è¡¨ç¤ºé”å¯ä»¥è¢«è·å–ï¼Œè·å–åå°†é”è®¡æ•°å™¨è®¾ä¸º 1 ä¹Ÿå°±æ˜¯åŠ  1ã€‚</p><p><img src="/assets/synchronized-get-lock-code-block.f8021972.png" alt="æ‰§è¡Œ monitorenter è·å–é”" loading="lazy"></p><p>å¯¹è±¡é”çš„çš„æ‹¥æœ‰è€…çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œ <code>monitorexit</code> æŒ‡ä»¤æ¥é‡Šæ”¾é”ã€‚åœ¨æ‰§è¡Œ <code>monitorexit</code> æŒ‡ä»¤åï¼Œå°†é”è®¡æ•°å™¨è®¾ä¸º 0ï¼Œè¡¨æ˜é”è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”ã€‚</p><p><img src="/assets/synchronized-release-lock-block.c8310368.png" alt="æ‰§è¡Œ monitorexit é‡Šæ”¾é”" loading="lazy"></p><p>å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚</p><h4 id="_1-3-2-synchronized-ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ" tabindex="-1"><a class="header-anchor" href="#_1-3-2-synchronized-ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ" aria-hidden="true">#</a> 1.3.2. synchronized ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedDemo2</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;synchronized æ–¹æ³•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/synchronizedå…³é”®å­—åŸç†2.png" alt="synchronizedå…³é”®å­—åŸç†" loading="lazy"></p><p><code>synchronized</code> ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ <code>monitorenter</code> æŒ‡ä»¤å’Œ <code>monitorexit</code> æŒ‡ä»¤ï¼Œå–å¾—ä»£ä¹‹çš„ç¡®å®æ˜¯ <code>ACC_SYNCHRONIZED</code> æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚JVM é€šè¿‡è¯¥ <code>ACC_SYNCHRONIZED</code> è®¿é—®æ ‡å¿—æ¥è¾¨åˆ«ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨ã€‚</p><p>å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å®ä¾‹å¯¹è±¡çš„é”ã€‚å¦‚æœæ˜¯é™æ€æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å½“å‰ class çš„é”ã€‚</p><h4 id="_1-3-3-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#_1-3-3-æ€»ç»“" aria-hidden="true">#</a> 1.3.3.æ€»ç»“</h4><p><code>synchronized</code> åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ <code>monitorenter</code> å’Œ <code>monitorexit</code> æŒ‡ä»¤ï¼Œå…¶ä¸­ <code>monitorenter</code> æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ<code>monitorexit</code> æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚</p><p><code>synchronized</code> ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ <code>monitorenter</code> æŒ‡ä»¤å’Œ <code>monitorexit</code> æŒ‡ä»¤ï¼Œå–å¾—ä»£ä¹‹çš„ç¡®å®æ˜¯ <code>ACC_SYNCHRONIZED</code> æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚</p><p><strong>ä¸è¿‡ä¸¤è€…çš„æœ¬è´¨éƒ½æ˜¯å¯¹å¯¹è±¡ç›‘è§†å™¨ monitor çš„è·å–ã€‚</strong></p><p>ç›¸å…³æ¨èï¼š<a href="https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi/" target="_blank" rel="noopener noreferrer">Javaé”ä¸çº¿ç¨‹çš„é‚£äº›äº‹ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ã€‚</p><p>ğŸ§—ğŸ»è¿›é˜¶ä¸€ä¸‹ï¼šå­¦æœ‰ä½™åŠ›çš„å°ä¼™ä¼´å¯ä»¥æŠ½æ—¶é—´è¯¦ç»†ç ”ç©¶ä¸€ä¸‹å¯¹è±¡ç›‘è§†å™¨ <code>monitor</code>ã€‚</p><h3 id="_1-4-è¯´è¯´-jdk1-6-ä¹‹åçš„-synchronized-å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–-å¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—" tabindex="-1"><a class="header-anchor" href="#_1-4-è¯´è¯´-jdk1-6-ä¹‹åçš„-synchronized-å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–-å¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—" aria-hidden="true">#</a> 1.4. è¯´è¯´ JDK1.6 ä¹‹åçš„ synchronized å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ï¼Œå¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—</h3><p>JDK1.6 å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚åå‘é”ã€è½»é‡çº§é”ã€è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚</p><p>é”ä¸»è¦å­˜åœ¨å››ç§çŠ¶æ€ï¼Œä¾æ¬¡æ˜¯ï¼šæ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶æ€ã€é‡é‡çº§é”çŠ¶æ€ï¼Œä»–ä»¬ä¼šéšç€ç«äº‰çš„æ¿€çƒˆè€Œé€æ¸å‡çº§ã€‚æ³¨æ„é”å¯ä»¥å‡çº§ä¸å¯é™çº§ï¼Œè¿™ç§ç­–ç•¥æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡ã€‚</p><p>å…³äºè¿™å‡ ç§ä¼˜åŒ–çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥æŸ¥çœ‹ä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/wuqinglong/p/9945618.html" target="_blank" rel="noopener noreferrer">Java6 åŠä»¥ä¸Šç‰ˆæœ¬å¯¹ synchronized çš„ä¼˜åŒ–<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_1-5-è°ˆè°ˆ-synchronized-å’Œ-reentrantlock-çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_1-5-è°ˆè°ˆ-synchronized-å’Œ-reentrantlock-çš„åŒºåˆ«" aria-hidden="true">#</a> 1.5. è°ˆè°ˆ synchronized å’Œ ReentrantLock çš„åŒºåˆ«</h3><h4 id="_1-5-1-ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”" tabindex="-1"><a class="header-anchor" href="#_1-5-1-ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”" aria-hidden="true">#</a> 1.5.1. ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”</h4><p><strong>â€œå¯é‡å…¥é”â€</strong> æŒ‡çš„æ˜¯è‡ªå·±å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœæ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚åŒä¸€ä¸ªçº¿ç¨‹æ¯æ¬¡è·å–é”ï¼Œé”çš„è®¡æ•°å™¨éƒ½è‡ªå¢ 1ï¼Œæ‰€ä»¥è¦ç­‰åˆ°é”çš„è®¡æ•°å™¨ä¸‹é™ä¸º 0 æ—¶æ‰èƒ½é‡Šæ”¾é”ã€‚</p><h4 id="_1-5-2-synchronized-ä¾èµ–äº-jvm-è€Œ-reentrantlock-ä¾èµ–äº-api" tabindex="-1"><a class="header-anchor" href="#_1-5-2-synchronized-ä¾èµ–äº-jvm-è€Œ-reentrantlock-ä¾èµ–äº-api" aria-hidden="true">#</a> 1.5.2.synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API</h4><p><code>synchronized</code> æ˜¯ä¾èµ–äº JVM å®ç°çš„ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿè®²åˆ°äº† è™šæ‹Ÿæœºå›¢é˜Ÿåœ¨ JDK1.6 ä¸º <code>synchronized</code> å…³é”®å­—è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æš´éœ²ç»™æˆ‘ä»¬ã€‚<code>ReentrantLock</code> æ˜¯ JDK å±‚é¢å®ç°çš„ï¼ˆä¹Ÿå°±æ˜¯ API å±‚é¢ï¼Œéœ€è¦ lock() å’Œ unlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹å®ƒçš„æºä»£ç ï¼Œæ¥çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><h4 id="_1-5-3-reentrantlock-æ¯”-synchronized-å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#_1-5-3-reentrantlock-æ¯”-synchronized-å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½" aria-hidden="true">#</a> 1.5.3.ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½</h4><p>ç›¸æ¯”<code>synchronized</code>ï¼Œ<code>ReentrantLock</code>å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚ä¸»è¦æ¥è¯´ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š</p><ul><li><strong>ç­‰å¾…å¯ä¸­æ–­</strong> : <code>ReentrantLock</code>æä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡ <code>lock.lockInterruptibly()</code> æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚</li><li><strong>å¯å®ç°å…¬å¹³é”</strong> : <code>ReentrantLock</code>å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œ<code>synchronized</code>åªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚<code>ReentrantLock</code>é»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡ <code>ReentrantLock</code>ç±»çš„<code>ReentrantLock(boolean fair)</code>æ„é€ æ–¹æ³•æ¥åˆ¶å®šæ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚</li><li><strong>å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ï¼ˆé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼‰</strong>: <code>synchronized</code>å…³é”®å­—ä¸<code>wait()</code>å’Œ<code>notify()</code>/<code>notifyAll()</code>æ–¹æ³•ç›¸ç»“åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚<code>ReentrantLock</code>ç±»å½“ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯éœ€è¦å€ŸåŠ©äº<code>Condition</code>æ¥å£ä¸<code>newCondition()</code>æ–¹æ³•ã€‚</li></ul><blockquote><p><code>Condition</code>æ˜¯ JDK1.5 ä¹‹åæ‰æœ‰çš„ï¼Œå®ƒå…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å®ç°å¤šè·¯é€šçŸ¥åŠŸèƒ½ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ª<code>Lock</code>å¯¹è±¡ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ª<code>Condition</code>å®ä¾‹ï¼ˆå³å¯¹è±¡ç›‘è§†å™¨ï¼‰ï¼Œ<strong>çº¿ç¨‹å¯¹è±¡å¯ä»¥æ³¨å†Œåœ¨æŒ‡å®šçš„<code>Condition</code>ä¸­ï¼Œä»è€Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è¿›è¡Œçº¿ç¨‹é€šçŸ¥ï¼Œåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šæ›´åŠ çµæ´»ã€‚ åœ¨ä½¿ç”¨<code>notify()/notifyAll()</code>æ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶ï¼Œè¢«é€šçŸ¥çš„çº¿ç¨‹æ˜¯ç”± JVM é€‰æ‹©çš„ï¼Œç”¨<code>ReentrantLock</code>ç±»ç»“åˆ<code>Condition</code>å®ä¾‹å¯ä»¥å®ç°â€œé€‰æ‹©æ€§é€šçŸ¥â€</strong> ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é‡è¦ï¼Œè€Œä¸”æ˜¯ Condition æ¥å£é»˜è®¤æä¾›çš„ã€‚è€Œ<code>synchronized</code>å…³é”®å­—å°±ç›¸å½“äºæ•´ä¸ª Lock å¯¹è±¡ä¸­åªæœ‰ä¸€ä¸ª<code>Condition</code>å®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ³¨å†Œåœ¨å®ƒä¸€ä¸ªèº«ä¸Šã€‚å¦‚æœæ‰§è¡Œ<code>notifyAll()</code>æ–¹æ³•çš„è¯å°±ä¼šé€šçŸ¥æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹è¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ï¼Œè€Œ<code>Condition</code>å®ä¾‹çš„<code>signalAll()</code>æ–¹æ³• åªä¼šå”¤é†’æ³¨å†Œåœ¨è¯¥<code>Condition</code>å®ä¾‹ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚</p></blockquote><p><strong>å¦‚æœä½ æƒ³ä½¿ç”¨ä¸Šè¿°åŠŸèƒ½ï¼Œé‚£ä¹ˆé€‰æ‹© ReentrantLock æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æ€§èƒ½å·²ä¸æ˜¯é€‰æ‹©æ ‡å‡†</strong></p><h2 id="_2-volatile-å…³é”®å­—" tabindex="-1"><a class="header-anchor" href="#_2-volatile-å…³é”®å­—" aria-hidden="true">#</a> 2. volatile å…³é”®å­—</h2><p>æˆ‘ä»¬å…ˆè¦ä» <strong>CPU ç¼“å­˜æ¨¡å‹</strong> è¯´èµ·ï¼</p><h3 id="_2-1-cpu-ç¼“å­˜æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_2-1-cpu-ç¼“å­˜æ¨¡å‹" aria-hidden="true">#</a> 2.1. CPU ç¼“å­˜æ¨¡å‹</h3><p><strong>ä¸ºä»€ä¹ˆè¦å¼„ä¸€ä¸ª CPU é«˜é€Ÿç¼“å­˜å‘¢ï¼Ÿ</strong></p><p>ç±»æ¯”æˆ‘ä»¬å¼€å‘ç½‘ç«™åå°ç³»ç»Ÿä½¿ç”¨çš„ç¼“å­˜ï¼ˆæ¯”å¦‚ Redisï¼‰æ˜¯ä¸ºäº†è§£å†³ç¨‹åºå¤„ç†é€Ÿåº¦å’Œè®¿é—®å¸¸è§„å…³ç³»å‹æ•°æ®åº“é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚ <strong>CPU ç¼“å­˜åˆ™æ˜¯ä¸ºäº†è§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜å¤„ç†é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚</strong></p><p>æˆ‘ä»¬ç”šè‡³å¯ä»¥æŠŠ <strong>å†…å­˜å¯ä»¥çœ‹ä½œå¤–å­˜çš„é«˜é€Ÿç¼“å­˜</strong>ï¼Œç¨‹åºè¿è¡Œçš„æ—¶å€™æˆ‘ä»¬æŠŠå¤–å­˜çš„æ•°æ®å¤åˆ¶åˆ°å†…å­˜ï¼Œç”±äºå†…å­˜çš„å¤„ç†é€Ÿåº¦è¿œè¿œé«˜äºå¤–å­˜ï¼Œè¿™æ ·æé«˜äº†å¤„ç†é€Ÿåº¦ã€‚</p><p>æ€»ç»“ï¼š<strong>CPU Cache ç¼“å­˜çš„æ˜¯å†…å­˜æ•°æ®ç”¨äºè§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå†…å­˜ç¼“å­˜çš„æ˜¯ç¡¬ç›˜æ•°æ®ç”¨äºè§£å†³ç¡¬ç›˜è®¿é—®é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ã€‚</strong></p><p>ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€ä¸ªç®€å•çš„ CPU Cache ç¤ºæ„å›¾å¦‚ä¸‹ï¼ˆå®é™…ä¸Šï¼Œç°ä»£çš„ CPU Cache é€šå¸¸åˆ†ä¸ºä¸‰å±‚ï¼Œåˆ†åˆ«å« L1,L2,L3 Cacheï¼‰:</p><p><img src="/assets/cpu-cache.7bd155ca.png" alt="cpu-cache" loading="lazy"></p><p><strong>CPU Cache çš„å·¥ä½œæ–¹å¼ï¼š</strong></p><p>å…ˆå¤åˆ¶ä¸€ä»½æ•°æ®åˆ° CPU Cache ä¸­ï¼Œå½“ CPU éœ€è¦ç”¨åˆ°çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä» CPU Cache ä¸­è¯»å–æ•°æ®ï¼Œå½“è¿ç®—å®Œæˆåï¼Œå†å°†è¿ç®—å¾—åˆ°çš„æ•°æ®å†™å› Main Memory ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™æ ·å­˜åœ¨ <strong>å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§çš„é—®é¢˜</strong> ï¼æ¯”å¦‚æˆ‘æ‰§è¡Œä¸€ä¸ª i++æ“ä½œçš„è¯ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œçš„è¯ï¼Œå‡è®¾ä¸¤ä¸ªçº¿ç¨‹ä» CPU Cache ä¸­è¯»å–çš„ i=1ï¼Œä¸¤ä¸ªçº¿ç¨‹åšäº† 1++è¿ç®—å®Œä¹‹åå†å†™å› Main Memory ä¹‹å i=2ï¼Œè€Œæ­£ç¡®ç»“æœåº”è¯¥æ˜¯ i=3ã€‚</p><p><strong>CPU ä¸ºäº†è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜å¯ä»¥é€šè¿‡åˆ¶å®šç¼“å­˜ä¸€è‡´åè®®æˆ–è€…å…¶ä»–æ‰‹æ®µæ¥è§£å†³ã€‚</strong></p><h3 id="_2-2-è®²ä¸€ä¸‹-jmm-java-å†…å­˜æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_2-2-è®²ä¸€ä¸‹-jmm-java-å†…å­˜æ¨¡å‹" aria-hidden="true">#</a> 2.2. è®²ä¸€ä¸‹ JMM(Java å†…å­˜æ¨¡å‹)</h3><p>Java å†…å­˜æ¨¡å‹æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Œå°±æ¯”å¦‚è¯´çº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å¿…é¡»å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ã€‚Java å†…å­˜æ¨¡å‹ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†å±è”½ç³»ç»Ÿå’Œç¡¬ä»¶çš„å·®å¼‚ï¼Œé¿å…ä¸€å¥—ä»£ç åœ¨ä¸åŒçš„å¹³å°ä¸‹äº§ç”Ÿçš„æ•ˆæœä¸ä¸€è‡´ã€‚</p><p>åœ¨ JDK1.2 ä¹‹å‰ï¼ŒJava çš„å†…å­˜æ¨¡å‹å®ç°æ€»æ˜¯ä»<strong>ä¸»å­˜</strong>ï¼ˆå³å…±äº«å†…å­˜ï¼‰è¯»å–å˜é‡ï¼Œæ˜¯ä¸éœ€è¦è¿›è¡Œç‰¹åˆ«çš„æ³¨æ„çš„ã€‚è€Œåœ¨å½“å‰çš„ Java å†…å­˜æ¨¡å‹ä¸‹ï¼Œçº¿ç¨‹å¯ä»¥æŠŠå˜é‡ä¿å­˜<strong>æœ¬åœ°å†…å­˜</strong>ï¼ˆæ¯”å¦‚æœºå™¨çš„å¯„å­˜å™¨ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨ä¸»å­˜ä¸­è¿›è¡Œè¯»å†™ã€‚è¿™å°±å¯èƒ½é€ æˆä¸€ä¸ªçº¿ç¨‹åœ¨ä¸»å­˜ä¸­ä¿®æ”¹äº†ä¸€ä¸ªå˜é‡çš„å€¼ï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿˜ç»§ç»­ä½¿ç”¨å®ƒåœ¨å¯„å­˜å™¨ä¸­çš„å˜é‡å€¼çš„æ‹·è´ï¼Œé€ æˆ<strong>æ•°æ®çš„ä¸ä¸€è‡´</strong>ã€‚</p><blockquote><ul><li><strong>ä¸»å†…å­˜</strong> ï¼šæ‰€æœ‰çº¿ç¨‹åˆ›å»ºçš„å®ä¾‹å¯¹è±¡éƒ½å­˜æ”¾åœ¨ä¸»å†…å­˜ä¸­ï¼Œä¸ç®¡è¯¥å®ä¾‹å¯¹è±¡æ˜¯æˆå‘˜å˜é‡è¿˜æ˜¯æ–¹æ³•ä¸­çš„æœ¬åœ°å˜é‡(ä¹Ÿç§°å±€éƒ¨å˜é‡)</li><li><strong>æœ¬åœ°å†…å­˜</strong> ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜æ¥å­˜å‚¨å…±äº«å˜é‡çš„å‰¯æœ¬ï¼Œå¹¶ä¸”ï¼Œæ¯ä¸ªçº¿ç¨‹åªèƒ½è®¿é—®è‡ªå·±çš„æœ¬åœ°å†…å­˜ï¼Œæ— æ³•è®¿é—®å…¶ä»–çº¿ç¨‹çš„æœ¬åœ°å†…å­˜ã€‚æœ¬åœ°å†…å­˜æ˜¯ JMM æŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå­˜å‚¨äº†ä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡å‰¯æœ¬ã€‚</li></ul></blockquote><p><img src="/assets/jmm.5cd0317c.png" alt="JMM(Java å†…å­˜æ¨¡å‹)" loading="lazy"></p><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±éœ€è¦æŠŠå˜é‡å£°æ˜ä¸º <strong><code>volatile</code></strong> ï¼Œè¿™å°±æŒ‡ç¤º JVMï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong><code>volatile</code> å…³é”®å­— é™¤äº†é˜²æ­¢ JVM çš„æŒ‡ä»¤é‡æ’ ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä½œç”¨å°±æ˜¯ä¿è¯å˜é‡çš„å¯è§æ€§ã€‚</strong></p><p><img src="/assets/jmm2.5f189c6e.png" alt="volatileå…³é”®å­—å¯è§æ€§" loading="lazy"></p><h3 id="_2-3-å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#_2-3-å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§" aria-hidden="true">#</a> 2.3. å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§</h3><ol><li><strong>åŸå­æ€§</strong> : ä¸€æ¬¡æ“ä½œæˆ–è€…å¤šæ¬¡æ“ä½œï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œå…¨éƒ¨éƒ½å¾—åˆ°æ‰§è¡Œå¹¶ä¸”ä¸ä¼šå—åˆ°ä»»ä½•å› ç´ çš„å¹²æ‰°è€Œä¸­æ–­ï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚<code>synchronized</code> å¯ä»¥ä¿è¯ä»£ç ç‰‡æ®µçš„åŸå­æ€§ã€‚</li><li><strong>å¯è§æ€§</strong> ï¼šå½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå¦å¤–çš„çº¿ç¨‹éƒ½æ˜¯ç«‹å³å¯ä»¥çœ‹åˆ°ä¿®æ”¹åçš„æœ€æ–°å€¼ã€‚<code>volatile</code> å…³é”®å­—å¯ä»¥ä¿è¯å…±äº«å˜é‡çš„å¯è§æ€§ã€‚</li><li><strong>æœ‰åºæ€§</strong> ï¼šä»£ç åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­çš„å…ˆåé¡ºåºï¼ŒJava åœ¨ç¼–è¯‘å™¨ä»¥åŠè¿è¡ŒæœŸé—´çš„ä¼˜åŒ–ï¼Œä»£ç çš„æ‰§è¡Œé¡ºåºæœªå¿…å°±æ˜¯ç¼–å†™ä»£ç æ—¶å€™çš„é¡ºåºã€‚<code>volatile</code> å…³é”®å­—å¯ä»¥ç¦æ­¢æŒ‡ä»¤è¿›è¡Œé‡æ’åºä¼˜åŒ–ã€‚</li></ol><h3 id="_2-4-è¯´è¯´-synchronized-å…³é”®å­—å’Œ-volatile-å…³é”®å­—çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_2-4-è¯´è¯´-synchronized-å…³é”®å­—å’Œ-volatile-å…³é”®å­—çš„åŒºåˆ«" aria-hidden="true">#</a> 2.4. è¯´è¯´ synchronized å…³é”®å­—å’Œ volatile å…³é”®å­—çš„åŒºåˆ«</h3><p><code>synchronized</code> å…³é”®å­—å’Œ <code>volatile</code> å…³é”®å­—æ˜¯ä¸¤ä¸ªäº’è¡¥çš„å­˜åœ¨ï¼Œè€Œä¸æ˜¯å¯¹ç«‹çš„å­˜åœ¨ï¼</p><ul><li><strong><code>volatile</code> å…³é”®å­—</strong>æ˜¯çº¿ç¨‹åŒæ­¥çš„<strong>è½»é‡çº§å®ç°</strong>ï¼Œæ‰€ä»¥ <strong><code>volatile </code>æ€§èƒ½è‚¯å®šæ¯”<code>synchronized</code>å…³é”®å­—è¦å¥½</strong> ã€‚ä½†æ˜¯ <strong><code>volatile</code> å…³é”®å­—åªèƒ½ç”¨äºå˜é‡è€Œ <code>synchronized</code> å…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•ä»¥åŠä»£ç å—</strong> ã€‚</li><li><strong><code>volatile</code> å…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚<code>synchronized</code> å…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚</strong></li><li><strong><code>volatile</code>å…³é”®å­—ä¸»è¦ç”¨äºè§£å†³å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œè€Œ <code>synchronized</code> å…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ã€‚</strong></li></ul><h2 id="_3-threadlocal" tabindex="-1"><a class="header-anchor" href="#_3-threadlocal" aria-hidden="true">#</a> 3. ThreadLocal</h2><h3 id="_3-1-threadlocal-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#_3-1-threadlocal-ç®€ä»‹" aria-hidden="true">#</a> 3.1. ThreadLocal ç®€ä»‹</h3><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å˜é‡æ˜¯å¯ä»¥è¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¹¶ä¿®æ”¹çš„ã€‚<strong>å¦‚æœæƒ³å®ç°æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸“å±æœ¬åœ°å˜é‡è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</strong> JDK ä¸­æä¾›çš„<code>ThreadLocal</code>ç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ <strong><code>ThreadLocal</code>ç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†<code>ThreadLocal</code>ç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚</strong></p><p><strong>å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ª<code>ThreadLocal</code>å˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯<code>ThreadLocal</code>å˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ <code>getï¼ˆï¼‰</code> å’Œ <code>setï¼ˆï¼‰</code> æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</strong></p><p>å†ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><p>æ¯”å¦‚æœ‰ä¸¤ä¸ªäººå»å®å±‹æ”¶é›†å®ç‰©ï¼Œè¿™ä¸¤ä¸ªå…±ç”¨ä¸€ä¸ªè¢‹å­çš„è¯è‚¯å®šä¼šäº§ç”Ÿäº‰æ‰§ï¼Œä½†æ˜¯ç»™ä»–ä»¬ä¸¤ä¸ªäººæ¯ä¸ªäººåˆ†é…ä¸€ä¸ªè¢‹å­çš„è¯å°±ä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚å¦‚æœæŠŠè¿™ä¸¤ä¸ªäººæ¯”ä½œçº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆ ThreadLocal å°±æ˜¯ç”¨æ¥é¿å…è¿™ä¸¤ä¸ªçº¿ç¨‹ç«äº‰çš„ã€‚</p><h3 id="_3-2-threadlocal-ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_3-2-threadlocal-ç¤ºä¾‹" aria-hidden="true">#</a> 3.2. ThreadLocal ç¤ºä¾‹</h3><p>ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„è§£é‡Šï¼Œå¤§å®¶å·²ç»ææ‡‚ ThreadLocal ç±»æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿äº†ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalExample</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

     <span class="token comment">// SimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹éƒ½è¦æœ‰è‡ªå·±ç‹¬ç«‹çš„å‰¯æœ¬</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">&gt;</span></span> formatter <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyyMMdd HHmm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocalExample</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread Name= &quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; default Formatter = &quot;</span><span class="token operator">+</span>formatter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//formatter pattern is changed here by thread, but it won&#39;t reflect to other threads</span>
        formatter<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread Name= &quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; formatter = &quot;</span><span class="token operator">+</span>formatter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>Output:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Thread Name= 0 default Formatter = yyyyMMdd HHmm
Thread Name= 0 formatter = yy-M-d ah:mm
Thread Name= 1 default Formatter = yyyyMMdd HHmm
Thread Name= 2 default Formatter = yyyyMMdd HHmm
Thread Name= 1 formatter = yy-M-d ah:mm
Thread Name= 3 default Formatter = yyyyMMdd HHmm
Thread Name= 2 formatter = yy-M-d ah:mm
Thread Name= 4 default Formatter = yyyyMMdd HHmm
Thread Name= 3 formatter = yy-M-d ah:mm
Thread Name= 4 formatter = yy-M-d ah:mm
Thread Name= 5 default Formatter = yyyyMMdd HHmm
Thread Name= 5 formatter = yy-M-d ah:mm
Thread Name= 6 default Formatter = yyyyMMdd HHmm
Thread Name= 6 formatter = yy-M-d ah:mm
Thread Name= 7 default Formatter = yyyyMMdd HHmm
Thread Name= 7 formatter = yy-M-d ah:mm
Thread Name= 8 default Formatter = yyyyMMdd HHmm
Thread Name= 9 default Formatter = yyyyMMdd HHmm
Thread Name= 8 formatter = yy-M-d ah:mm
Thread Name= 9 formatter = yy-M-d ah:mm
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>ä»è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºï¼ŒThread-0 å·²ç»æ”¹å˜äº† formatter çš„å€¼ï¼Œä½†ä»ç„¶æ˜¯ thread-2 é»˜è®¤æ ¼å¼åŒ–ç¨‹åºä¸åˆå§‹åŒ–å€¼ç›¸åŒï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¸€æ ·ã€‚</p><p>ä¸Šé¢æœ‰ä¸€æ®µä»£ç ç”¨åˆ°äº†åˆ›å»º <code>ThreadLocal</code> å˜é‡çš„é‚£æ®µä»£ç ç”¨åˆ°äº† Java8 çš„çŸ¥è¯†ï¼Œå®ƒç­‰äºä¸‹é¢è¿™æ®µä»£ç ï¼Œå¦‚æœä½ å†™äº†ä¸‹é¢è¿™æ®µä»£ç çš„è¯ï¼ŒIDEA ä¼šæç¤ºä½ è½¬æ¢ä¸º Java8 çš„æ ¼å¼(IDEA çœŸçš„ä¸é”™ï¼)ã€‚å› ä¸º ThreadLocal ç±»åœ¨ Java 8 ä¸­æ‰©å±•ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„æ–¹æ³•<code>withInitial()</code>ï¼Œå°† Supplier åŠŸèƒ½æ¥å£ä½œä¸ºå‚æ•°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">&gt;</span></span> formatter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">SimpleDateFormat</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyyMMdd HHmm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_3-3-threadlocal-åŸç†" tabindex="-1"><a class="header-anchor" href="#_3-3-threadlocal-åŸç†" aria-hidden="true">#</a> 3.3. ThreadLocal åŸç†</h3><p>ä» <code>Thread</code>ç±»æºä»£ç å…¥æ‰‹ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment">//......</span>
    <span class="token comment">//ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„ThreadLocalå€¼ã€‚ç”±ThreadLocalç±»ç»´æŠ¤</span>
    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">//ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„InheritableThreadLocalå€¼ã€‚ç”±InheritableThreadLocalç±»ç»´æŠ¤</span>
    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> inheritableThreadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>ä»ä¸Šé¢<code>Thread</code>ç±» æºä»£ç å¯ä»¥çœ‹å‡º<code>Thread</code> ç±»ä¸­æœ‰ä¸€ä¸ª <code>threadLocals</code> å’Œ ä¸€ä¸ª <code>inheritableThreadLocals</code> å˜é‡ï¼Œå®ƒä»¬éƒ½æ˜¯ <code>ThreadLocalMap</code> ç±»å‹çš„å˜é‡,æˆ‘ä»¬å¯ä»¥æŠŠ <code>ThreadLocalMap</code> ç†è§£ä¸º<code>ThreadLocal</code> ç±»å®ç°çš„å®šåˆ¶åŒ–çš„ <code>HashMap</code>ã€‚é»˜è®¤æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå˜é‡éƒ½æ˜¯ nullï¼Œåªæœ‰å½“å‰çº¿ç¨‹è°ƒç”¨ <code>ThreadLocal</code> ç±»çš„ <code>set</code>æˆ–<code>get</code>æ–¹æ³•æ—¶æ‰åˆ›å»ºå®ƒä»¬ï¼Œå®é™…ä¸Šè°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯<code>ThreadLocalMap</code>ç±»å¯¹åº”çš„ <code>get()</code>ã€<code>set()</code>æ–¹æ³•ã€‚</p><p><code>ThreadLocal</code>ç±»çš„<code>set()</code>æ–¹æ³•</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>é€šè¿‡ä¸Šé¢è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬è¶³ä»¥é€šè¿‡çŒœæµ‹å¾—å‡ºç»“è®ºï¼š<strong>æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ <code>ThreadLocalMap</code> ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ <code>ThreadLocal</code> ä¸Šï¼Œ<code>ThreadLocal</code> å¯ä»¥ç†è§£ä¸ºåªæ˜¯<code>ThreadLocalMap</code>çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚</strong> <code>ThrealLocal</code> ç±»ä¸­å¯ä»¥é€šè¿‡<code>Thread.currentThread()</code>è·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡åï¼Œç›´æ¥é€šè¿‡<code>getMap(Thread t)</code>å¯ä»¥è®¿é—®åˆ°è¯¥çº¿ç¨‹çš„<code>ThreadLocalMap</code>å¯¹è±¡ã€‚</p><p><strong>æ¯ä¸ª<code>Thread</code>ä¸­éƒ½å…·å¤‡ä¸€ä¸ª<code>ThreadLocalMap</code>ï¼Œè€Œ<code>ThreadLocalMap</code>å¯ä»¥å­˜å‚¨ä»¥<code>ThreadLocal</code>ä¸º key ï¼ŒObject å¯¹è±¡ä¸º value çš„é”®å€¼å¯¹ã€‚</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> firstKey<span class="token punctuation">,</span> <span class="token class-name">Object</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>æ¯”å¦‚æˆ‘ä»¬åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å£°æ˜äº†ä¸¤ä¸ª <code>ThreadLocal</code> å¯¹è±¡çš„è¯ï¼Œ <code>Thread</code>å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨ä»…æœ‰çš„é‚£ä¸ª<code>ThreadLocalMap</code> å­˜æ”¾æ•°æ®çš„ï¼Œ<code>ThreadLocalMap</code>çš„ key å°±æ˜¯ <code>ThreadLocal</code>å¯¹è±¡ï¼Œvalue å°±æ˜¯ <code>ThreadLocal</code> å¯¹è±¡è°ƒç”¨<code>set</code>æ–¹æ³•è®¾ç½®çš„å€¼ã€‚</p><p><img src="/assets/threadlocalæ•°æ®ç»“æ„.a0bfadf8.png" alt="ThreadLocalæ•°æ®ç»“æ„" loading="lazy"></p><p><code>ThreadLocalMap</code>æ˜¯<code>ThreadLocal</code>çš„é™æ€å†…éƒ¨ç±»ã€‚</p><p><img src="/assets/ThreadLocalå†…éƒ¨ç±».fc4bb676.png" alt="ThreadLocalå†…éƒ¨ç±»" loading="lazy"></p><h3 id="_3-4-threadlocal-å†…å­˜æ³„éœ²é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_3-4-threadlocal-å†…å­˜æ³„éœ²é—®é¢˜" aria-hidden="true">#</a> 3.4. ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜</h3><p><code>ThreadLocalMap</code> ä¸­ä½¿ç”¨çš„ key ä¸º <code>ThreadLocal</code> çš„å¼±å¼•ç”¨,è€Œ value æ˜¯å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ <code>ThreadLocal</code> æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œkey ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ value ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œ<code>ThreadLocalMap</code> ä¸­å°±ä¼šå‡ºç° key ä¸º null çš„ Entryã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œvalue æ°¸è¿œæ— æ³•è¢« GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚ThreadLocalMap å®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ <code>set()</code>ã€<code>get()</code>ã€<code>remove()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•ã€‚ä½¿ç”¨å®Œ <code>ThreadLocal</code>æ–¹æ³•å æœ€å¥½æ‰‹åŠ¨è°ƒç”¨<code>remove()</code>æ–¹æ³•</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/** The value associated with this ThreadLocal. */</span>
    <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

    <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
        value <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>å¼±å¼•ç”¨ä»‹ç»ï¼š</strong></p><blockquote><p>å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰å¼±å¼•ç”¨ï¼Œé‚£å°±ç±»ä¼¼äº<strong>å¯æœ‰å¯æ— çš„ç”Ÿæ´»ç”¨å“</strong>ã€‚å¼±å¼•ç”¨ä¸è½¯å¼•ç”¨çš„åŒºåˆ«åœ¨äºï¼šåªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒ æ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä¸è¿‡ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹ï¼Œ å› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚</p><p>å¼±å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœå¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ŒJava è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªå¼±å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚</p></blockquote><h2 id="_4-çº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#_4-çº¿ç¨‹æ± " aria-hidden="true">#</a> 4. çº¿ç¨‹æ± </h2><h3 id="_4-1-ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#_4-1-ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± " aria-hidden="true">#</a> 4.1. ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ</h3><blockquote><p><strong>æ± åŒ–æŠ€æœ¯æƒ³å¿…å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€Http è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚</strong></p></blockquote><p><strong>çº¿ç¨‹æ± </strong>æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰çš„æ–¹å¼ã€‚ æ¯ä¸ª<strong>çº¿ç¨‹æ± </strong>è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚</p><p>è¿™é‡Œå€Ÿç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹<strong>ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„</strong>ï¼š</p><ul><li><strong>é™ä½èµ„æºæ¶ˆè€—</strong>ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚</li><li><strong>æé«˜å“åº”é€Ÿåº¦</strong>ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚</li><li><strong>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§</strong>ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚</li></ul><h3 id="_4-2-å®ç°-runnable-æ¥å£å’Œ-callable-æ¥å£çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_4-2-å®ç°-runnable-æ¥å£å’Œ-callable-æ¥å£çš„åŒºåˆ«" aria-hidden="true">#</a> 4.2. å®ç° Runnable æ¥å£å’Œ Callable æ¥å£çš„åŒºåˆ«</h3><p><code>Runnable</code>è‡ª Java 1.0 ä»¥æ¥ä¸€ç›´å­˜åœ¨ï¼Œä½†<code>Callable</code>ä»…åœ¨ Java 1.5 ä¸­å¼•å…¥,ç›®çš„å°±æ˜¯ä¸ºäº†æ¥å¤„ç†<code>Runnable</code>ä¸æ”¯æŒçš„ç”¨ä¾‹ã€‚<strong><code>Runnable</code> æ¥å£</strong> ä¸ä¼šè¿”å›ç»“æœæˆ–æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸ï¼Œä½†æ˜¯ <strong><code>Callable</code> æ¥å£</strong> å¯ä»¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœä»»åŠ¡ä¸éœ€è¦è¿”å›ç»“æœæˆ–æŠ›å‡ºå¼‚å¸¸æ¨èä½¿ç”¨ <strong><code>Runnable</code> æ¥å£</strong> ï¼Œè¿™æ ·ä»£ç çœ‹èµ·æ¥ä¼šæ›´åŠ ç®€æ´ã€‚</p><p>å·¥å…·ç±» <code>Executors</code> å¯ä»¥å®ç°å°† <code>Runnable</code> å¯¹è±¡è½¬æ¢æˆ <code>Callable</code> å¯¹è±¡ã€‚ï¼ˆ<code>Executors.callable(Runnable task)</code> æˆ– <code>Executors.callable(Runnable task, Object result)</code>ï¼‰ã€‚</p><p><code>Runnable.java</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
   <span class="token doc-comment comment">/**
    * è¢«çº¿ç¨‹æ‰§è¡Œï¼Œæ²¡æœ‰è¿”å›å€¼ä¹Ÿæ— æ³•æŠ›å‡ºå¼‚å¸¸
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>Callable.java</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * è®¡ç®—ç»“æœï¼Œæˆ–åœ¨æ— æ³•è¿™æ ·åšæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚
     * <span class="token keyword">@return</span> è®¡ç®—å¾—å‡ºçš„ç»“æœ
     * <span class="token keyword">@throws</span> å¦‚æœæ— æ³•è®¡ç®—ç»“æœï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */</span>
    <span class="token class-name">V</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_4-3-æ‰§è¡Œ-execute-æ–¹æ³•å’Œ-submit-æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢" tabindex="-1"><a class="header-anchor" href="#_4-3-æ‰§è¡Œ-execute-æ–¹æ³•å’Œ-submit-æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢" aria-hidden="true">#</a> 4.3. æ‰§è¡Œ execute()æ–¹æ³•å’Œ submit()æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</h3><ol><li><strong><code>execute()</code>æ–¹æ³•ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸä¸å¦ï¼›</strong></li><li><strong><code>submit()</code>æ–¹æ³•ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ã€‚çº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ª <code>Future</code> ç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª <code>Future</code> å¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</strong>ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ <code>Future</code> çš„ <code>get()</code>æ–¹æ³•æ¥è·å–è¿”å›å€¼ï¼Œ<code>get()</code>æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆï¼Œè€Œä½¿ç”¨ <code>get(long timeoutï¼ŒTimeUnit unit)</code>æ–¹æ³•åˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹ä¸€æ®µæ—¶é—´åç«‹å³è¿”å›ï¼Œè¿™æ—¶å€™æœ‰å¯èƒ½ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œã€‚</li></ol><p>æˆ‘ä»¬ä»¥ <strong><code>AbstractExecutorService</code> æ¥å£</strong> ä¸­çš„ä¸€ä¸ª <code>submit</code> æ–¹æ³•ä¸ºä¾‹å­æ¥çœ‹çœ‹æºä»£ç ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> ftask <span class="token operator">=</span> <span class="token function">newTaskFor</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">execute</span><span class="token punctuation">(</span>ftask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ftask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ä¸Šé¢æ–¹æ³•è°ƒç”¨çš„ <code>newTaskFor</code> æ–¹æ³•è¿”å›äº†ä¸€ä¸ª <code>FutureTask</code> å¯¹è±¡ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">newTaskFor</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹<code>execute()</code>æ–¹æ³•ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_4-4-å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#_4-4-å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± " aria-hidden="true">#</a> 4.4. å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± </h3><p>ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©</p><blockquote><p>Executors è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š</p><ul><li><strong>FixedThreadPool å’Œ SingleThreadExecutor</strong> ï¼š å…è®¸è¯·æ±‚çš„é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUE ï¼Œå¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚</li><li><strong>CachedThreadPool å’Œ ScheduledThreadPool</strong> ï¼š å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUE ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚</li></ul></blockquote><p><strong>æ–¹å¼ä¸€ï¼šé€šè¿‡æ„é€ æ–¹æ³•å®ç°</strong></p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/ThreadPoolExecutoræ„é€ æ–¹æ³•.png" alt="ThreadPoolExecutoræ„é€ æ–¹æ³•" loading="lazy"></p><p><strong>æ–¹å¼äºŒï¼šé€šè¿‡ Executor æ¡†æ¶çš„å·¥å…·ç±» Executors æ¥å®ç°</strong></p><p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸‰ç§ç±»å‹çš„ ThreadPoolExecutorï¼š</p><ul><li><strong>FixedThreadPool</strong> ï¼š è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚è¯¥çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å§‹ç»ˆä¸å˜ã€‚å½“æœ‰ä¸€ä¸ªæ–°çš„ä»»åŠ¡æäº¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­è‹¥æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ç«‹å³æ‰§è¡Œã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°çš„ä»»åŠ¡ä¼šè¢«æš‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¾¿å¤„ç†åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li><li><strong>SingleThreadExecutorï¼š</strong> æ–¹æ³•è¿”å›ä¸€ä¸ªåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è‹¥å¤šä½™ä¸€ä¸ªä»»åŠ¡è¢«æäº¤åˆ°è¯¥çº¿ç¨‹æ± ï¼Œä»»åŠ¡ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…çº¿ç¨‹ç©ºé—²ï¼ŒæŒ‰å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li><li><strong>CachedThreadPoolï¼š</strong> è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ç¡®å®šï¼Œä½†è‹¥æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨å¯å¤ç”¨çš„çº¿ç¨‹ã€‚è‹¥æ‰€æœ‰çº¿ç¨‹å‡åœ¨å·¥ä½œï¼Œåˆæœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æ‰€æœ‰çº¿ç¨‹åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†è¿”å›çº¿ç¨‹æ± è¿›è¡Œå¤ç”¨ã€‚</li></ul><p>å¯¹åº” Executors å·¥å…·ç±»ä¸­çš„æ–¹æ³•å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/Executoræ¡†æ¶çš„å·¥å…·ç±».png" alt="Executoræ¡†æ¶çš„å·¥å…·ç±»" loading="lazy"></p><h3 id="_4-5-threadpoolexecutor-ç±»åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_4-5-threadpoolexecutor-ç±»åˆ†æ" aria-hidden="true">#</a> 4.5 ThreadPoolExecutor ç±»åˆ†æ</h3><p><code>ThreadPoolExecutor</code> ç±»ä¸­æä¾›çš„å››ä¸ªæ„é€ æ–¹æ³•ã€‚æˆ‘ä»¬æ¥çœ‹æœ€é•¿çš„é‚£ä¸ªï¼Œå…¶ä½™ä¸‰ä¸ªéƒ½æ˜¯åœ¨è¿™ä¸ªæ„é€ æ–¹æ³•çš„åŸºç¡€ä¸Šäº§ç”Ÿï¼ˆå…¶ä»–å‡ ä¸ªæ„é€ æ–¹æ³•è¯´ç™½ç‚¹éƒ½æ˜¯ç»™å®šæŸäº›é»˜è®¤å‚æ•°çš„æ„é€ æ–¹æ³•æ¯”å¦‚é»˜è®¤åˆ¶å®šæ‹’ç»ç­–ç•¥æ˜¯ä»€ä¹ˆï¼‰ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç è®²äº†ï¼Œæ¯”è¾ƒç®€å•ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
 */</span>
<span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                      <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                      <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                      <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                      <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                      <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                      <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
        maximumPoolSize <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
        maximumPoolSize <span class="token operator">&lt;</span> corePoolSize <span class="token operator">||</span>
        keepAliveTime <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> threadFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactory <span class="token operator">=</span> threadFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>ä¸‹é¢è¿™äº›å¯¹åˆ›å»º éå¸¸é‡è¦ï¼Œåœ¨åé¢ä½¿ç”¨çº¿ç¨‹æ± çš„è¿‡ç¨‹ä¸­ä½ ä¸€å®šä¼šç”¨åˆ°ï¼æ‰€ä»¥ï¼ŒåŠ¡å¿…æ‹¿ç€å°æœ¬æœ¬è®°æ¸…æ¥šã€‚</strong></p><h4 id="_4-5-1-threadpoolexecutoræ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_4-5-1-threadpoolexecutoræ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ" aria-hidden="true">#</a> 4.5.1 <code>ThreadPoolExecutor</code>æ„é€ å‡½æ•°é‡è¦å‚æ•°åˆ†æ</h4><p><strong><code>ThreadPoolExecutor</code> 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š</strong></p><ul><li><strong><code>corePoolSize</code> :</strong> æ ¸å¿ƒçº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚</li><li><strong><code>maximumPoolSize</code> :</strong> å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚</li><li><strong><code>workQueue</code>:</strong> å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚</li></ul><p><code>ThreadPoolExecutor</code>å…¶ä»–å¸¸è§å‚æ•°:</p><ol><li><strong><code>keepAliveTime</code></strong>:å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº <code>corePoolSize</code> çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† <code>keepAliveTime</code>æ‰ä¼šè¢«å›æ”¶é”€æ¯ï¼›</li><li><strong><code>unit</code></strong> : <code>keepAliveTime</code> å‚æ•°çš„æ—¶é—´å•ä½ã€‚</li><li><strong><code>threadFactory</code></strong> :executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</li><li><strong><code>handler</code></strong> :é¥±å’Œç­–ç•¥ã€‚å…³äºé¥±å’Œç­–ç•¥ä¸‹é¢å•ç‹¬ä»‹ç»ä¸€ä¸‹ã€‚</li></ol><h4 id="_4-5-2-threadpoolexecutor-é¥±å’Œç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#_4-5-2-threadpoolexecutor-é¥±å’Œç­–ç•¥" aria-hidden="true">#</a> 4.5.2 <code>ThreadPoolExecutor</code> é¥±å’Œç­–ç•¥</h4><p><strong><code>ThreadPoolExecutor</code> é¥±å’Œç­–ç•¥å®šä¹‰:</strong></p><p>å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»åŠ¡æ—¶ï¼Œ<code>ThreadPoolTaskExecutor</code> å®šä¹‰ä¸€äº›ç­–ç•¥:</p><ul><li><strong><code>ThreadPoolExecutor.AbortPolicy</code>ï¼š</strong> æŠ›å‡º <code>RejectedExecutionException</code>æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚</li><li><strong><code>ThreadPoolExecutor.CallerRunsPolicy</code>ï¼š</strong> è°ƒç”¨æ‰§è¡Œè‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨è°ƒç”¨<code>execute</code>æ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œ(<code>run</code>)è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ è¦æ±‚ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚</li><li><strong><code>ThreadPoolExecutor.DiscardPolicy</code>ï¼š</strong> ä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚</li><li><strong><code>ThreadPoolExecutor.DiscardOldestPolicy</code>ï¼š</strong> æ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼š Spring é€šè¿‡ <code>ThreadPoolTaskExecutor</code> æˆ–è€…æˆ‘ä»¬ç›´æ¥é€šè¿‡ <code>ThreadPoolExecutor</code> çš„æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®š <code>RejectedExecutionHandler</code> é¥±å’Œç­–ç•¥çš„è¯æ¥é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™é»˜è®¤ä½¿ç”¨çš„æ˜¯ <code>ThreadPoolExecutor.AbortPolicy</code>ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>ThreadPoolExecutor</code> å°†æŠ›å‡º <code>RejectedExecutionException</code> æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚ å¯¹äºå¯ä¼¸ç¼©çš„åº”ç”¨ç¨‹åºï¼Œå»ºè®®ä½¿ç”¨ <code>ThreadPoolExecutor.CallerRunsPolicy</code>ã€‚å½“æœ€å¤§æ± è¢«å¡«æ»¡æ—¶ï¼Œæ­¤ç­–ç•¥ä¸ºæˆ‘ä»¬æä¾›å¯ä¼¸ç¼©é˜Ÿåˆ—ã€‚ï¼ˆè¿™ä¸ªç›´æ¥æŸ¥çœ‹ <code>ThreadPoolExecutor</code> çš„æ„é€ å‡½æ•°æºç å°±å¯ä»¥çœ‹å‡ºï¼Œæ¯”è¾ƒç®€å•çš„åŸå› ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼‰</p><h3 id="_4-6-ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ± -demo" tabindex="-1"><a class="header-anchor" href="#_4-6-ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ± -demo" aria-hidden="true">#</a> 4.6 ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ±  Demo</h3><p>ä¸ºäº†è®©å¤§å®¶æ›´æ¸…æ¥šä¸Šé¢çš„é¢è¯•é¢˜ä¸­çš„ä¸€äº›æ¦‚å¿µï¼Œæˆ‘å†™äº†ä¸€ä¸ªç®€å•çš„çº¿ç¨‹æ±  Demoã€‚</p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>Runnable</code> æ¥å£çš„å®ç°ç±»ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯ <code>Callable</code> æ¥å£ï¼Œæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´äº†ä¸¤è€…çš„åŒºåˆ«ã€‚ï¼‰</p><p><code>MyRunnable.java</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * è¿™æ˜¯ä¸€ä¸ªç®€å•çš„Runnableç±»ï¼Œéœ€è¦å¤§çº¦5ç§’é’Ÿæ¥æ‰§è¡Œå…¶ä»»åŠ¡ã€‚
 * <span class="token keyword">@author</span> shuang.kou
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> command<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>command <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; Start. Time = &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">processCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; End. Time = &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>ç¼–å†™æµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬è¿™é‡Œä»¥é˜¿é‡Œå·´å·´æ¨èçš„ä½¿ç”¨ <code>ThreadPoolExecutor</code> æ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°çš„æ–¹å¼æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚</p><p><code>ThreadPoolExecutorDemo.java</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutorDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CORE_POOL_SIZE <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_POOL_SIZE <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> QUEUE_CAPACITY <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> KEEP_ALIVE_TIME <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//ä½¿ç”¨é˜¿é‡Œå·´å·´æ¨èçš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼</span>
        <span class="token comment">//é€šè¿‡ThreadPoolExecutoræ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°åˆ›å»º</span>
        <span class="token class-name">ThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                CORE_POOL_SIZE<span class="token punctuation">,</span>
                MAX_POOL_SIZE<span class="token punctuation">,</span>
                KEEP_ALIVE_TIME<span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>QUEUE_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//åˆ›å»ºWorkerThreadå¯¹è±¡ï¼ˆWorkerThreadç±»å®ç°äº†Runnable æ¥å£ï¼‰</span>
            <span class="token class-name">Runnable</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//æ‰§è¡ŒRunnable</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//ç»ˆæ­¢çº¿ç¨‹æ± </span>
        executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished all threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸Šé¢çš„ä»£ç æŒ‡å®šäº†ï¼š</p><ol><li><code>corePoolSize</code>: æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 5ã€‚</li><li><code>maximumPoolSize</code> ï¼šæœ€å¤§çº¿ç¨‹æ•° 10</li><li><code>keepAliveTime</code> : ç­‰å¾…æ—¶é—´ä¸º 1Lã€‚</li><li><code>unit</code>: ç­‰å¾…æ—¶é—´çš„å•ä½ä¸º TimeUnit.SECONDSã€‚</li><li><code>workQueue</code>ï¼šä»»åŠ¡é˜Ÿåˆ—ä¸º <code>ArrayBlockingQueue</code>ï¼Œå¹¶ä¸”å®¹é‡ä¸º 100;</li><li><code>handler</code>:é¥±å’Œç­–ç•¥ä¸º <code>CallerRunsPolicy</code>ã€‚</li></ol><p><strong>Outputï¼š</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>pool-1-thread-3 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-5 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-2 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-1 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-4 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-3 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-4 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-5 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-2 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-5 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-4 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-3 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-2 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-4 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-5 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-3 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-2 End. Time = Sun Apr 12 11:14:47 CST 2020

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_4-7-çº¿ç¨‹æ± åŸç†åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_4-7-çº¿ç¨‹æ± åŸç†åˆ†æ" aria-hidden="true">#</a> 4.7 çº¿ç¨‹æ± åŸç†åˆ†æ</h3><p>æ‰¿æ¥ 4.6 èŠ‚ï¼Œæˆ‘ä»¬é€šè¿‡ä»£ç è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼š<strong>çº¿ç¨‹æ± é¦–å…ˆä¼šå…ˆæ‰§è¡Œ 5 ä¸ªä»»åŠ¡ï¼Œç„¶åè¿™äº›ä»»åŠ¡æœ‰ä»»åŠ¡è¢«æ‰§è¡Œå®Œçš„è¯ï¼Œå°±ä¼šå»æ‹¿æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚</strong> å¤§å®¶å¯ä»¥å…ˆé€šè¿‡ä¸Šé¢è®²è§£çš„å†…å®¹ï¼Œåˆ†æä¸€ä¸‹åˆ°åº•æ˜¯å’‹å›äº‹ï¼Ÿï¼ˆè‡ªå·±ç‹¬ç«‹æ€è€ƒä¸€ä¼šï¼‰</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±åˆ†æä¸Šé¢çš„è¾“å‡ºå†…å®¹æ¥ç®€å•åˆ†æä¸€ä¸‹çº¿ç¨‹æ± åŸç†ã€‚</p><p><strong>ä¸ºäº†ææ‡‚çº¿ç¨‹æ± çš„åŸç†ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ†æä¸€ä¸‹ <code>execute</code>æ–¹æ³•ã€‚</strong> åœ¨ 4.6 èŠ‚ä¸­çš„ Demo ä¸­æˆ‘ä»¬ä½¿ç”¨ <code>executor.execute(worker)</code>æ¥æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­å»ï¼Œè¿™ä¸ªæ–¹æ³•éå¸¸é‡è¦ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æºç ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// å­˜æ”¾çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span>RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c <span class="token operator">&amp;</span> CAPACITY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœä»»åŠ¡ä¸ºnullï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ctl ä¸­ä¿å­˜çš„çº¿ç¨‹æ± å½“å‰çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  ä¸‹é¢ä¼šæ¶‰åŠåˆ° 3 æ­¥ æ“ä½œ</span>
    <span class="token comment">// 1.é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡æ˜¯å¦å°äº corePoolSize</span>
    <span class="token comment">// å¦‚æœå°äºçš„è¯ï¼Œé€šè¿‡addWorker(command, true)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2.å¦‚æœå½“å‰æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡å¤§äºç­‰äº corePoolSize çš„æ—¶å€™å°±ä¼šèµ°åˆ°è¿™é‡Œ</span>
    <span class="token comment">// é€šè¿‡ isRunning æ–¹æ³•åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€ï¼Œçº¿ç¨‹æ± å¤„äº RUNNING çŠ¶æ€å¹¶ä¸”é˜Ÿåˆ—å¯ä»¥åŠ å…¥ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¢«åŠ å…¥è¿›å»</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å†æ¬¡è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯ RUNNING çŠ¶æ€å°±éœ€è¦ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡ï¼Œå¹¶å°è¯•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚åŒæ—¶æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸ºç©ºå°±æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ‰§è¡Œã€‚</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//3. é€šè¿‡addWorker(command, false)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚</span>
    <span class="token comment">//å¦‚æœaddWorker(command, false)æ‰§è¡Œå¤±è´¥ï¼Œåˆ™é€šè¿‡reject()æ‰§è¡Œç›¸åº”çš„æ‹’ç»ç­–ç•¥çš„å†…å®¹ã€‚</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>é€šè¿‡ä¸‹å›¾å¯ä»¥æ›´å¥½çš„å¯¹ä¸Šé¢è¿™ 3 æ­¥åšä¸€ä¸ªå±•ç¤ºï¼Œä¸‹å›¾æ˜¯æˆ‘ä¸ºäº†çœäº‹ç›´æ¥ä»ç½‘ä¸Šæ‰¾åˆ°ï¼ŒåŸåœ°å€ä¸æ˜ã€‚</p><p><img src="/assets/å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†.2b9eb21a.png" alt="å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†" loading="lazy"></p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨å›åˆ° 4.6 èŠ‚æˆ‘ä»¬å†™çš„ Demoï¼Œ ç°åœ¨æ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“å°±å¯ä»¥ææ‡‚å®ƒçš„åŸç†äº†å‘¢ï¼Ÿ</p><p>æ²¡ææ‡‚çš„è¯ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘çš„åˆ†æï¼š</p><blockquote><p>æˆ‘ä»¬åœ¨ä»£ç ä¸­æ¨¡æ‹Ÿäº† 10 ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬é…ç½®çš„æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 5 ã€ç­‰å¾…é˜Ÿåˆ—å®¹é‡ä¸º 100 ï¼Œæ‰€ä»¥æ¯æ¬¡åªå¯èƒ½å­˜åœ¨ 5 ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå‰©ä¸‹çš„ 5 ä¸ªä»»åŠ¡ä¼šè¢«æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»ã€‚å½“å‰çš„5ä¸ªä»»åŠ¡ä¸­å¦‚æœæœ‰ä»»åŠ¡è¢«æ‰§è¡Œå®Œäº†ï¼Œçº¿ç¨‹æ± å°±ä¼šå»æ‹¿æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚</p></blockquote><h2 id="_5-atomic-åŸå­ç±»" tabindex="-1"><a class="header-anchor" href="#_5-atomic-åŸå­ç±»" aria-hidden="true">#</a> 5. Atomic åŸå­ç±»</h2><h3 id="_5-1-ä»‹ç»ä¸€ä¸‹-atomic-åŸå­ç±»" tabindex="-1"><a class="header-anchor" href="#_5-1-ä»‹ç»ä¸€ä¸‹-atomic-åŸå­ç±»" aria-hidden="true">#</a> 5.1. ä»‹ç»ä¸€ä¸‹ Atomic åŸå­ç±»</h3><p><code>Atomic</code> ç¿»è¯‘æˆä¸­æ–‡æ˜¯åŸå­çš„æ„æ€ã€‚åœ¨åŒ–å­¦ä¸Šï¼Œæˆ‘ä»¬çŸ¥é“åŸå­æ˜¯æ„æˆä¸€èˆ¬ç‰©è´¨çš„æœ€å°å•ä½ï¼Œåœ¨åŒ–å­¦ååº”ä¸­æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚åœ¨æˆ‘ä»¬è¿™é‡Œ Atomic æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ã€‚å³ä½¿æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¸€èµ·æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚</p><p>æ‰€ä»¥ï¼Œæ‰€è°“åŸå­ç±»è¯´ç®€å•ç‚¹å°±æ˜¯å…·æœ‰åŸå­/åŸå­æ“ä½œç‰¹å¾çš„ç±»ã€‚</p><p>å¹¶å‘åŒ… <code>java.util.concurrent</code> çš„åŸå­ç±»éƒ½å­˜æ”¾åœ¨<code>java.util.concurrent.atomic</code>ä¸‹,å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/JUCåŸå­ç±»æ¦‚è§ˆ.png" alt="JUCåŸå­ç±»æ¦‚è§ˆ" loading="lazy"></p><h3 id="_5-2-juc-åŒ…ä¸­çš„åŸå­ç±»æ˜¯å“ª-4-ç±»" tabindex="-1"><a class="header-anchor" href="#_5-2-juc-åŒ…ä¸­çš„åŸå­ç±»æ˜¯å“ª-4-ç±»" aria-hidden="true">#</a> 5.2. JUC åŒ…ä¸­çš„åŸå­ç±»æ˜¯å“ª 4 ç±»?</h3><p><strong>åŸºæœ¬ç±»å‹</strong></p><p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°åŸºæœ¬ç±»å‹</p><ul><li><code>AtomicInteger</code>ï¼šæ•´å‹åŸå­ç±»</li><li><code>AtomicLong</code>ï¼šé•¿æ•´å‹åŸå­ç±»</li><li><code>AtomicBoolean</code>ï¼šå¸ƒå°”å‹åŸå­ç±»</li></ul><p><strong>æ•°ç»„ç±»å‹</strong></p><p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æŸä¸ªå…ƒç´ </p><ul><li><code>AtomicIntegerArray</code>ï¼šæ•´å‹æ•°ç»„åŸå­ç±»</li><li><code>AtomicLongArray</code>ï¼šé•¿æ•´å‹æ•°ç»„åŸå­ç±»</li><li><code>AtomicReferenceArray</code>ï¼šå¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li></ul><p><strong>å¼•ç”¨ç±»å‹</strong></p><ul><li><code>AtomicReference</code>ï¼šå¼•ç”¨ç±»å‹åŸå­ç±»</li><li><code>AtomicStampedReference</code>ï¼šåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºè§£å†³åŸå­çš„æ›´æ–°æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚</li><li><code>AtomicMarkableReference</code> ï¼šåŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹</li></ul><p><strong>å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹</strong></p><ul><li><code>AtomicIntegerFieldUpdater</code>ï¼šåŸå­æ›´æ–°æ•´å‹å­—æ®µçš„æ›´æ–°å™¨</li><li><code>AtomicLongFieldUpdater</code>ï¼šåŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µçš„æ›´æ–°å™¨</li><li><code>AtomicReferenceFieldUpdater</code>ï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹å­—æ®µçš„æ›´æ–°å™¨</li></ul><h3 id="_5-3-è®²è®²-atomicinteger-çš„ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_5-3-è®²è®²-atomicinteger-çš„ä½¿ç”¨" aria-hidden="true">#</a> 5.3. è®²è®² AtomicInteger çš„ä½¿ç”¨</h3><p><strong>AtomicInteger ç±»å¸¸ç”¨æ–¹æ³•</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//è·å–å½“å‰çš„å€¼</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> newValue<span class="token punctuation">)</span><span class="token comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</span>
<span class="token keyword">boolean</span> <span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token comment">//å¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lazySet</span><span class="token punctuation">(</span><span class="token keyword">int</span> newValue<span class="token punctuation">)</span><span class="token comment">//æœ€ç»ˆè®¾ç½®ä¸ºnewValue,ä½¿ç”¨ lazySet è®¾ç½®ä¹‹åå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>AtomicInteger ç±»çš„ä½¿ç”¨ç¤ºä¾‹</strong></p><p>ä½¿ç”¨ AtomicInteger ä¹‹åï¼Œä¸ç”¨å¯¹ increment() æ–¹æ³•åŠ é”ä¹Ÿå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">AtomicIntegerTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ä½¿ç”¨AtomicIntegerä¹‹åï¼Œä¸éœ€è¦å¯¹è¯¥æ–¹æ³•åŠ é”ï¼Œä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_5-4-èƒ½ä¸èƒ½ç»™æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹-atomicinteger-ç±»çš„åŸç†" tabindex="-1"><a class="header-anchor" href="#_5-4-èƒ½ä¸èƒ½ç»™æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹-atomicinteger-ç±»çš„åŸç†" aria-hidden="true">#</a> 5.4. èƒ½ä¸èƒ½ç»™æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ AtomicInteger ç±»çš„åŸç†</h3><p>AtomicInteger çº¿ç¨‹å®‰å…¨åŸç†ç®€å•åˆ†æ</p><p>AtomicInteger ç±»çš„éƒ¨åˆ†æºç ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// setup to use Unsafe.compareAndSwapInt for updatesï¼ˆæ›´æ–°æ“ä½œæ—¶æä¾›â€œæ¯”è¾ƒå¹¶æ›¿æ¢â€çš„ä½œç”¨ï¼‰</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> valueOffset<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        valueOffset <span class="token operator">=</span> unsafe<span class="token punctuation">.</span>objectFieldOffset
            <span class="token punctuation">(</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>AtomicInteger ç±»ä¸»è¦åˆ©ç”¨ CAS (compare and swap) + volatile å’Œ native æ–¹æ³•æ¥ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚</p><p>CAS çš„åŸç†æ˜¯æ‹¿æœŸæœ›çš„å€¼å’ŒåŸæœ¬çš„ä¸€ä¸ªå€¼ä½œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒåˆ™æ›´æ–°æˆæ–°çš„å€¼ã€‚UnSafe ç±»çš„ objectFieldOffset() æ–¹æ³•æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥æ‹¿åˆ°â€œåŸæ¥çš„å€¼â€çš„å†…å­˜åœ°å€ï¼Œè¿”å›å€¼æ˜¯ valueOffsetã€‚å¦å¤– value æ˜¯ä¸€ä¸ª volatile å˜é‡ï¼Œåœ¨å†…å­˜ä¸­å¯è§ï¼Œå› æ­¤ JVM å¯ä»¥ä¿è¯ä»»ä½•æ—¶åˆ»ä»»ä½•çº¿ç¨‹æ€»èƒ½æ‹¿åˆ°è¯¥å˜é‡çš„æœ€æ–°å€¼ã€‚</p><p>å…³äº Atomic åŸå­ç±»è¿™éƒ¨åˆ†æ›´å¤šå†…å®¹å¯ä»¥æŸ¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼šå¹¶å‘ç¼–ç¨‹é¢è¯•å¿…å¤‡ï¼š<a href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247484834&amp;idx=1&amp;sn=7d3835091af8125c13fc6db765f4c5bd&amp;source=41#wechat_redirect" target="_blank" rel="noopener noreferrer">JUC ä¸­çš„ Atomic åŸå­ç±»æ€»ç»“<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="_6-aqs" tabindex="-1"><a class="header-anchor" href="#_6-aqs" aria-hidden="true">#</a> 6. AQS</h2><h3 id="_6-1-aqs-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_6-1-aqs-ä»‹ç»" aria-hidden="true">#</a> 6.1. AQS ä»‹ç»</h3><p>AQS çš„å…¨ç§°ä¸ºï¼ˆ<code>AbstractQueuedSynchronizer</code>ï¼‰ï¼Œè¿™ä¸ªç±»åœ¨<code>java.util.concurrent.locks</code>åŒ…ä¸‹é¢ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/AQSç±».png" alt="AQSç±»" loading="lazy"></p><p>AQS æ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æ¶ï¼Œä½¿ç”¨ AQS èƒ½ç®€å•ä¸”é«˜æ•ˆåœ°æ„é€ å‡ºå¤§é‡åº”ç”¨å¹¿æ³›çš„åŒæ­¥å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬æåˆ°çš„ <code>ReentrantLock</code>ï¼Œ<code>Semaphore</code>ï¼Œå…¶ä»–çš„è¯¸å¦‚ <code>ReentrantReadWriteLock</code>ï¼Œ<code>SynchronousQueue</code>ï¼Œ<code>FutureTask</code> ç­‰ç­‰çš†æ˜¯åŸºäº AQS çš„ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿèƒ½åˆ©ç”¨ AQS éå¸¸è½»æ¾å®¹æ˜“åœ°æ„é€ å‡ºç¬¦åˆæˆ‘ä»¬è‡ªå·±éœ€æ±‚çš„åŒæ­¥å™¨ã€‚</p><h3 id="_6-2-aqs-åŸç†åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_6-2-aqs-åŸç†åˆ†æ" aria-hidden="true">#</a> 6.2. AQS åŸç†åˆ†æ</h3><p>AQS åŸç†è¿™éƒ¨åˆ†å‚è€ƒäº†éƒ¨åˆ†åšå®¢ï¼Œåœ¨ 6.2 èŠ‚æœ«å°¾æ”¾äº†é“¾æ¥ã€‚</p><blockquote><p>åœ¨é¢è¯•ä¸­è¢«é—®åˆ°å¹¶å‘çŸ¥è¯†çš„æ—¶å€™ï¼Œå¤§å¤šéƒ½ä¼šè¢«é—®åˆ°â€œè¯·ä½ è¯´ä¸€ä¸‹è‡ªå·±å¯¹äº AQS åŸç†çš„ç†è§£â€ã€‚ä¸‹é¢ç»™å¤§å®¶ä¸€ä¸ªç¤ºä¾‹ä¾›å¤§å®¶å‚åŠ ï¼Œé¢è¯•ä¸æ˜¯èƒŒé¢˜ï¼Œå¤§å®¶ä¸€å®šè¦åŠ å…¥è‡ªå·±çš„æ€æƒ³ï¼Œå³ä½¿åŠ å…¥ä¸äº†è‡ªå·±çš„æ€æƒ³ä¹Ÿè¦ä¿è¯è‡ªå·±èƒ½å¤Ÿé€šä¿—çš„è®²å‡ºæ¥è€Œä¸æ˜¯èƒŒå‡ºæ¥ã€‚</p></blockquote><p>ä¸‹é¢å¤§éƒ¨åˆ†å†…å®¹å…¶å®åœ¨ AQS ç±»æ³¨é‡Šä¸Šå·²ç»ç»™å‡ºäº†ï¼Œä¸è¿‡æ˜¯è‹±è¯­çœ‹ç€æ¯”è¾ƒåƒåŠ›ä¸€ç‚¹ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹æºç ã€‚</p><h4 id="_6-2-1-aqs-åŸç†æ¦‚è§ˆ" tabindex="-1"><a class="header-anchor" href="#_6-2-1-aqs-åŸç†æ¦‚è§ˆ" aria-hidden="true">#</a> 6.2.1. AQS åŸç†æ¦‚è§ˆ</h4><p><strong>AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯ç”¨ CLH é˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚</strong></p><blockquote><p>CLH(Craig,Landin and Hagersten)é˜Ÿåˆ—æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—ï¼ˆè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼‰ã€‚AQS æ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ã€‚</p></blockquote><p>çœ‹ä¸ª AQS(AbstractQueuedSynchronizer)åŸç†å›¾ï¼š</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/AQSåŸç†å›¾.png" alt="AQSåŸç†å›¾" loading="lazy"></p><p>AQS ä½¿ç”¨ä¸€ä¸ª int æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„ FIFO é˜Ÿåˆ—æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚AQS ä½¿ç”¨ CAS å¯¹è¯¥åŒæ­¥çŠ¶æ€è¿›è¡ŒåŸå­æ“ä½œå®ç°å¯¹å…¶å€¼çš„ä¿®æ”¹ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span><span class="token comment">//å…±äº«å˜é‡ï¼Œä½¿ç”¨volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>çŠ¶æ€ä¿¡æ¯é€šè¿‡ protected ç±»å‹çš„ getStateï¼ŒsetStateï¼ŒcompareAndSetState è¿›è¡Œæ“ä½œ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
<span class="token comment">//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">int</span> newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> newState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_6-2-2-aqs-å¯¹èµ„æºçš„å…±äº«æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_6-2-2-aqs-å¯¹èµ„æºçš„å…±äº«æ–¹å¼" aria-hidden="true">#</a> 6.2.2. AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼</h4><p><strong>AQS å®šä¹‰ä¸¤ç§èµ„æºå…±äº«æ–¹å¼</strong></p><ul><li><strong>Exclusive</strong>ï¼ˆç‹¬å ï¼‰ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œå¦‚ <code>ReentrantLock</code>ã€‚åˆå¯åˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼š <ul><li>å…¬å¹³é”ï¼šæŒ‰ç…§çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„æ’é˜Ÿé¡ºåºï¼Œå…ˆåˆ°è€…å…ˆæ‹¿åˆ°é”</li><li>éå…¬å¹³é”ï¼šå½“çº¿ç¨‹è¦è·å–é”æ—¶ï¼Œæ— è§†é˜Ÿåˆ—é¡ºåºç›´æ¥å»æŠ¢é”ï¼Œè°æŠ¢åˆ°å°±æ˜¯è°çš„</li></ul></li><li><strong>Share</strong>ï¼ˆå…±äº«ï¼‰ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶æ‰§è¡Œï¼Œå¦‚<code> CountDownLatch</code>ã€<code>Semaphore</code>ã€ <code>CyclicBarrier</code>ã€<code>ReadWriteLock</code> æˆ‘ä»¬éƒ½ä¼šåœ¨åé¢è®²åˆ°ã€‚</li></ul><p><code>ReentrantReadWriteLock</code> å¯ä»¥çœ‹æˆæ˜¯ç»„åˆå¼ï¼Œå› ä¸º <code>ReentrantReadWriteLock</code> ä¹Ÿå°±æ˜¯è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹æŸä¸€èµ„æºè¿›è¡Œè¯»ã€‚</p><p>ä¸åŒçš„è‡ªå®šä¹‰åŒæ­¥å™¨äº‰ç”¨å…±äº«èµ„æºçš„æ–¹å¼ä¹Ÿä¸åŒã€‚è‡ªå®šä¹‰åŒæ­¥å™¨åœ¨å®ç°æ—¶åªéœ€è¦å®ç°å…±äº«èµ„æº state çš„è·å–ä¸é‡Šæ”¾æ–¹å¼å³å¯ï¼Œè‡³äºå…·ä½“çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤ï¼ˆå¦‚è·å–èµ„æºå¤±è´¥å…¥é˜Ÿ/å”¤é†’å‡ºé˜Ÿç­‰ï¼‰ï¼ŒAQS å·²ç»åœ¨é¡¶å±‚å®ç°å¥½äº†ã€‚</p><h4 id="_6-2-3-aqs-åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_6-2-3-aqs-åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼" aria-hidden="true">#</a> 6.2.3. AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h4><p>åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œå¦‚æœéœ€è¦è‡ªå®šä¹‰åŒæ­¥å™¨ä¸€èˆ¬çš„æ–¹å¼æ˜¯è¿™æ ·ï¼ˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªåº”ç”¨ï¼‰ï¼š</p><ol><li>ä½¿ç”¨è€…ç»§æ‰¿ <code>AbstractQueuedSynchronizer</code> å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ã€‚ï¼ˆè¿™äº›é‡å†™æ–¹æ³•å¾ˆç®€å•ï¼Œæ— éæ˜¯å¯¹äºå…±äº«èµ„æº state çš„è·å–å’Œé‡Šæ”¾ï¼‰</li><li>å°† AQS ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚</li></ol><p>è¿™å’Œæˆ‘ä»¬ä»¥å¾€é€šè¿‡å®ç°æ¥å£çš„æ–¹å¼æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œè¿™æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªè¿ç”¨ã€‚</p><p><strong>AQS ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ª AQS æä¾›çš„é’©å­æ–¹æ³•ï¼š</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">//å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æºã€‚</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">//å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒã€‚</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>ä»€ä¹ˆæ˜¯é’©å­æ–¹æ³•å‘¢ï¼Ÿ</strong> é’©å­æ–¹æ³•æ˜¯ä¸€ç§è¢«å£°æ˜åœ¨æŠ½è±¡ç±»ä¸­çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥æ˜¯ç©ºæ–¹æ³•ï¼ˆç”±å­ç±»å®ç°ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯é»˜è®¤å®ç°çš„æ–¹æ³•ã€‚æ¨¡æ¿è®¾è®¡æ¨¡å¼é€šè¿‡é’©å­æ–¹æ³•æ§åˆ¶å›ºå®šæ­¥éª¤çš„å®ç°ã€‚</p><p>é™¤äº†ä¸Šé¢æåˆ°çš„é’©å­æ–¹æ³•ä¹‹å¤–ï¼ŒAQS ç±»ä¸­çš„å…¶ä»–æ–¹æ³•éƒ½æ˜¯ <code>final</code> ï¼Œæ‰€ä»¥æ— æ³•è¢«å…¶ä»–ç±»é‡å†™ã€‚</p><p>ä»¥ <code>ReentrantLock</code> ä¸ºä¾‹ï¼Œstate åˆå§‹åŒ–ä¸º 0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚A çº¿ç¨‹ <code>lock()</code> æ—¶ï¼Œä¼šè°ƒç”¨ <code>tryAcquire()</code> ç‹¬å è¯¥é”å¹¶å°† <code>state+1</code> ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å† <code>tryAcquire()</code> æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ° A çº¿ç¨‹ <code>unlock()</code> åˆ° <code>state=</code>0ï¼ˆå³é‡Šæ”¾é”ï¼‰ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒA çº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆstate ä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šå°‘æ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ state æ˜¯èƒ½å›åˆ°é›¶æ€çš„ã€‚</p><p>å†ä»¥ <code>CountDownLatch</code> ä»¥ä¾‹ï¼Œä»»åŠ¡åˆ†ä¸º N ä¸ªå­çº¿ç¨‹å»æ‰§è¡Œï¼Œstate ä¹Ÿåˆå§‹åŒ–ä¸º Nï¼ˆæ³¨æ„ N è¦ä¸çº¿ç¨‹ä¸ªæ•°ä¸€è‡´ï¼‰ã€‚è¿™ N ä¸ªå­çº¿ç¨‹æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œå<code> countDown()</code> ä¸€æ¬¡ï¼Œstate ä¼š CAS(Compare and Swap) å‡ 1ã€‚ç­‰åˆ°æ‰€æœ‰å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œå(å³ <code>state=0</code> )ï¼Œä¼š <code>unpark()</code> ä¸»è°ƒç”¨çº¿ç¨‹ï¼Œç„¶åä¸»è°ƒç”¨çº¿ç¨‹å°±ä¼šä» <code>await()</code> å‡½æ•°è¿”å›ï¼Œç»§ç»­åä½™åŠ¨ä½œã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨è¦ä¹ˆæ˜¯ç‹¬å æ–¹æ³•ï¼Œè¦ä¹ˆæ˜¯å…±äº«æ–¹å¼ï¼Œä»–ä»¬ä¹Ÿåªéœ€å®ç°<code>tryAcquire-tryRelease</code>ã€<code>tryAcquireShared-tryReleaseShared</code>ä¸­çš„ä¸€ç§å³å¯ã€‚ä½† AQS ä¹Ÿæ”¯æŒè‡ªå®šä¹‰åŒæ­¥å™¨åŒæ—¶å®ç°ç‹¬å å’Œå…±äº«ä¸¤ç§æ–¹å¼ï¼Œå¦‚<code>ReentrantReadWriteLock</code>ã€‚</p><p>æ¨èä¸¤ç¯‡ AQS åŸç†å’Œç›¸å…³æºç åˆ†æçš„æ–‡ç« ï¼š</p><ul><li>https://www.cnblogs.com/waterystone/p/4920797.html</li><li>https://www.cnblogs.com/chengxiao/archive/2017/07/24/7141160.html</li></ul><h3 id="_6-3-aqs-ç»„ä»¶æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#_6-3-aqs-ç»„ä»¶æ€»ç»“" aria-hidden="true">#</a> 6.3. AQS ç»„ä»¶æ€»ç»“</h3><ul><li><strong><code>Semaphore</code>(ä¿¡å·é‡)-å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼š</strong> <code>synchronized</code> å’Œ <code>ReentrantLock</code> éƒ½æ˜¯ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºï¼Œ<code>Semaphore</code>(ä¿¡å·é‡)å¯ä»¥æŒ‡å®šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æŸä¸ªèµ„æºã€‚</li><li><strong><code>CountDownLatch </code>ï¼ˆå€’è®¡æ—¶å™¨ï¼‰ï¼š</strong> <code>CountDownLatch</code> æ˜¯ä¸€ä¸ªåŒæ­¥å·¥å…·ç±»ï¼Œç”¨æ¥åè°ƒå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ã€‚è¿™ä¸ªå·¥å…·é€šå¸¸ç”¨æ¥æ§åˆ¶çº¿ç¨‹ç­‰å¾…ï¼Œå®ƒå¯ä»¥è®©æŸä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ç›´åˆ°å€’è®¡æ—¶ç»“æŸï¼Œå†å¼€å§‹æ‰§è¡Œã€‚</li><li><strong><code>CyclicBarrier</code>(å¾ªç¯æ …æ )ï¼š</strong> <code>CyclicBarrier</code> å’Œ <code>CountDownLatch</code> éå¸¸ç±»ä¼¼ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹é—´çš„æŠ€æœ¯ç­‰å¾…ï¼Œä½†æ˜¯å®ƒçš„åŠŸèƒ½æ¯” <code>CountDownLatch</code> æ›´åŠ å¤æ‚å’Œå¼ºå¤§ã€‚ä¸»è¦åº”ç”¨åœºæ™¯å’Œ <code>CountDownLatch</code> ç±»ä¼¼ã€‚<code>CyclicBarrier</code> çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆ<code>Cyclic</code>ï¼‰çš„å±éšœï¼ˆ<code>Barrier</code>ï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚<code>CyclicBarrier</code> é»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯ <code>CyclicBarrier(int parties)</code>ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ <code>await()</code> æ–¹æ³•å‘Šè¯‰ <code>CyclicBarrier</code> æˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚</li></ul><h3 id="_6-4-ç”¨è¿‡-countdownlatch-ä¹ˆ-ä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„" tabindex="-1"><a class="header-anchor" href="#_6-4-ç”¨è¿‡-countdownlatch-ä¹ˆ-ä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„" aria-hidden="true">#</a> 6.4. ç”¨è¿‡ CountDownLatch ä¹ˆï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„ï¼Ÿ</h3><p><code>CountDownLatch</code> çš„ä½œç”¨å°±æ˜¯ å…è®¸ count ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚ä¹‹å‰åœ¨é¡¹ç›®ä¸­ï¼Œæœ‰ä¸€ä¸ªä½¿ç”¨å¤šçº¿ç¨‹è¯»å–å¤šä¸ªæ–‡ä»¶å¤„ç†çš„åœºæ™¯ï¼Œæˆ‘ç”¨åˆ°äº† <code>CountDownLatch</code> ã€‚å…·ä½“åœºæ™¯æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š</p><p>æˆ‘ä»¬è¦è¯»å–å¤„ç† 6 ä¸ªæ–‡ä»¶ï¼Œè¿™ 6 ä¸ªä»»åŠ¡éƒ½æ˜¯æ²¡æœ‰æ‰§è¡Œé¡ºåºä¾èµ–çš„ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿”å›ç»™ç”¨æˆ·çš„æ—¶å€™å°†è¿™å‡ ä¸ªæ–‡ä»¶çš„å¤„ç†çš„ç»“æœè¿›è¡Œç»Ÿè®¡æ•´ç†ã€‚</p><p>ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªçº¿ç¨‹æ± å’Œ count ä¸º 6 çš„<code>CountDownLatch</code>å¯¹è±¡ ã€‚ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†è¯»å–ä»»åŠ¡ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†å®Œä¹‹åå°±å°† count-1ï¼Œè°ƒç”¨<code>CountDownLatch</code>å¯¹è±¡çš„ <code>await()</code>æ–¹æ³•ï¼Œç›´åˆ°æ‰€æœ‰æ–‡ä»¶è¯»å–å®Œä¹‹åï¼Œæ‰ä¼šæ¥ç€æ‰§è¡Œåé¢çš„é€»è¾‘ã€‚</p><p>ä¼ªä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatchExample1</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤„ç†æ–‡ä»¶çš„æ•°é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadCount <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºä¸€ä¸ªå…·æœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± å¯¹è±¡ï¼ˆæ¨èä½¿ç”¨æ„é€ æ–¹æ³•åˆ›å»ºï¼‰</span>
        <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>threadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> threadnum <span class="token operator">=</span> i<span class="token punctuation">;</span>
            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//å¤„ç†æ–‡ä»¶çš„ä¸šåŠ¡æ“ä½œ</span>
                    <span class="token comment">//......</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">//è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶å·²ç»è¢«å®Œæˆ</span>
                    countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;finish&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>æœ‰æ²¡æœ‰å¯ä»¥æ”¹è¿›çš„åœ°æ–¹å‘¢ï¼Ÿ</strong></p><p>å¯ä»¥ä½¿ç”¨ <code>CompletableFuture</code> ç±»æ¥æ”¹è¿›ï¼Java8 çš„ <code>CompletableFuture</code> æä¾›äº†å¾ˆå¤šå¯¹å¤šçº¿ç¨‹å‹å¥½çš„æ–¹æ³•ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸ºæˆ‘ä»¬ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºï¼Œä»€ä¹ˆå¼‚æ­¥ã€ä¸²è¡Œã€å¹¶è¡Œæˆ–è€…ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ä»€ä¹ˆçš„éƒ½éå¸¸æ–¹ä¾¿ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> task1 <span class="token operator">=</span>
    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">//è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> task6 <span class="token operator">=</span>
    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">//è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> headerFuture<span class="token operator">=</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>task1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>task6<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    headerFuture<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;all done. &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>ä¸Šé¢çš„ä»£ç è¿˜å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Œå½“ä»»åŠ¡è¿‡å¤šçš„æ—¶å€™ï¼ŒæŠŠæ¯ä¸€ä¸ª task éƒ½åˆ—å‡ºæ¥ä¸å¤ªç°å®ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡å¾ªç¯æ¥æ·»åŠ ä»»åŠ¡ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//æ–‡ä»¶å¤¹ä½ç½®</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> filePaths <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token comment">// å¼‚æ­¥å¤„ç†æ‰€æœ‰æ–‡ä»¶</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> fileFutures <span class="token operator">=</span> filePaths<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>filePath <span class="token operator">-&gt;</span> <span class="token function">doSomeThing</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å°†ä»–ä»¬åˆå¹¶èµ·æ¥</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> allFutures <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>
    fileFutures<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span>fileFutures<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_7-reference" tabindex="-1"><a class="header-anchor" href="#_7-reference" aria-hidden="true">#</a> 7 Reference</h2><ul><li>ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹</li><li>ã€Šå®æˆ˜ Java é«˜å¹¶å‘ç¨‹åºè®¾è®¡ã€‹</li><li>ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹</li><li>https://www.cnblogs.com/waterystone/p/4920797.html</li><li>https://www.cnblogs.com/chengxiao/archive/2017/07/24/7141160.html</li><li><a href="https://www.journaldev.com/1076/java-threadlocal-example" target="_blank" rel="noopener noreferrer">https://www.journaldev.com/1076/java-threadlocal-example<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><!--]--></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/zengkaiqiang562/JavaGuide/edit/main/docs/java/concurrent/java-concurrent-questions-02.md" rel="noopener noreferrer" target="_blank" arialabel="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" arialabelledby="edit"><title id="edit" lang="en">edit icon</title><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="info">2022/3/22 09:57:37</span></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: koushuangbwcx@163.com">guide</span>,<!--]--><!--[--><span class="contributor" title="email: 1453064869@qq.com">Evan He</span>,<!--]--><!--[--><span class="contributor" title="email: 39112652+Itswag@users.noreply.github.com">Sr</span>,<!--]--><!--[--><span class="contributor" title="email: verne.zhong@gmail.com">Verne.Chung</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/java/concurrent/java-concurrent-questions-01.html" class="nav-link prev" arialabel="Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆåŸºç¡€ç¯‡ï¼‰"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆåŸºç¡€ç¯‡ï¼‰</div></a><!----></nav><!----><!----></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright Â© 2024 Zenk562</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.2a01fc36.js" defer></script>
  </body>
</html>
