<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.38" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://zengkaiqiang562.github.io/lango-tech/subject/surfaceflinger.html"><meta property="og:site_name" content="Android Guide"><meta property="og:title" content="GUIç³»ç»Ÿâ€”â€”SurfaceFlinger"><meta property="og:type" content="article"><meta property="og:image" content="https://zengkaiqiang562.github.io/"><meta property="og:updated_time" content="2024-04-30T10:39:15.000Z"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="GUIç³»ç»Ÿâ€”â€”SurfaceFlinger"><meta property="article:tag" content="ä¸“é¢˜"><meta property="article:modified_time" content="2024-04-30T10:39:15.000Z"><script>var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?5dd2e8c97962d57b7b8fea1737c01743";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2922463_99aa80ii7cf.css"><title>GUIç³»ç»Ÿâ€”â€”SurfaceFlinger | Android Guide</title><meta name="description" content="Android å­¦ä¹  && é¢è¯•æŒ‡å—">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.c9a516cc.css">
    <link rel="modulepreload" href="/assets/app.2a01fc36.js"><link rel="modulepreload" href="/assets/surfaceflinger.html.3357f154.js"><link rel="modulepreload" href="/assets/surfaceflinger.html.8f57c5db.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc sidebar-open"><!--[--><header class="navbar"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><a href="/" class="home-link"><img class="logo" src="/logo.png" alt="Android Guide"><!----><span class="site-name hide-in-pad">Android Guide</span><!--[--><!----><!--]--></a><nav class="nav-links" style=""><div class="nav-item hide-in-mobile"><a href="/home.html" class="nav-link" arialabel="é¢è¯•æŒ‡å—"><i class="icon iconfont icon-java"></i>é¢è¯•æŒ‡å—<!----></a></div><div class="nav-item hide-in-mobile"><a href="/zhuanlan/" class="nav-link" arialabel="ä¼˜è´¨ä¸“æ "><i class="icon iconfont icon-recommend"></i>ä¼˜è´¨ä¸“æ <!----></a></div><div class="nav-item hide-in-mobile"><a href="/open-source-project/" class="nav-link" arialabel="é¡¹ç›®ç²¾é€‰"><i class="icon iconfont icon-github"></i>é¡¹ç›®ç²¾é€‰<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://snailclimb.gitee.io/javaguide/#/" rel="noopener noreferrer" target="_blank" arialabel="æ—§ç‰ˆé“¾æ¥" class="nav-link"><i class="icon iconfont icon-java"></i>æ—§ç‰ˆé“¾æ¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="https://javaguide.cn/feed.json" rel="noopener noreferrer" target="_blank" arialabel="RSSè®¢é˜…" class="nav-link"><i class="icon iconfont icon-rss"></i>RSSè®¢é˜…<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="/about-the-author/" class="nav-link" arialabel="å…³äºä½œè€…"><i class="icon iconfont icon-zuozhe"></i>å…³äºä½œè€…<!----></a></div></nav><div class="nav-actions-wrapper"><!--[--><!----><!--]--><div class="nav-item"><!----></div><div class="nav-item"><a class="repo-link" href="https://github.com/zengkaiqiang562/JavaGuide" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" arialabelledby="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><title id="github" lang="en">github icon</title><g fill="currentColor"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></g></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" arialabelledby="auto" style="display:block;"><title id="auto" lang="en">auto icon</title><g fill="currentColor"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" arialabelledby="dark" style="display:none;"><title id="dark" lang="en">dark icon</title><g fill="currentColor"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" arialabelledby="light" style="display:none;"><title id="light" lang="en">light icon</title><g fill="currentColor"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></g></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button><!--[--><!----><!--]--></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">å¼€å‘æŒ‡å¼•</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">é¡¹ç›®ç®¡ç†</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ç»„ä»¶ç®¡ç†</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">ä¸“é¢˜</span><span class="arrow down"></span></button><!--[--><!--[--><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" arialabel="GUIç³»ç»Ÿâ€”â€”SurfaceFlinger"><!---->GUIç³»ç»Ÿâ€”â€”SurfaceFlinger<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_1-opengl-es-ä¸-egl" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1 OpenGL ES ä¸ EGL"><!---->1 OpenGL ES ä¸ EGL<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_2-android-çš„ç¡¬ä»¶æ¥å£-â€”â€”-hal" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2 Android çš„ç¡¬ä»¶æ¥å£ â€”â€” HAL"><!---->2 Android çš„ç¡¬ä»¶æ¥å£ â€”â€” HAL<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-gralloc-ä¸-framebuffer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3 Gralloc ä¸ Framebuffer"><!---->3 Gralloc ä¸ Framebuffer<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-1-gralloc-æ¨¡å—çš„åŠ è½½" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.1 Gralloc æ¨¡å—çš„åŠ è½½"><!---->3.1 Gralloc æ¨¡å—çš„åŠ è½½<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-2-gralloc-æä¾›çš„æ¥å£" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.2 Gralloc æä¾›çš„æ¥å£"><!---->3.2 Gralloc æä¾›çš„æ¥å£<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-2-1-fb-è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.2.1 fb è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹"><!---->3.2.1 fb è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-2-2-gralloc-è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.2.2 gralloc è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹"><!---->3.2.2 gralloc è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-android-ä¸­çš„æœ¬åœ°çª—å£" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4 Android ä¸­çš„æœ¬åœ°çª—å£"><!---->4 Android ä¸­çš„æœ¬åœ°çª—å£<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-1-framebuffernativewindow" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1 FramebufferNativeWindow"><!---->4.1 FramebufferNativeWindow<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-1-1-æ„é€ å‡½æ•°ä¸­çš„åˆå§‹åŒ–æ“ä½œ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1.1 æ„é€ å‡½æ•°ä¸­çš„åˆå§‹åŒ–æ“ä½œ"><!---->4.1.1 æ„é€ å‡½æ•°ä¸­çš„åˆå§‹åŒ–æ“ä½œ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-1-2-dequeuebuffer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1.2 dequeueBuffer"><!---->4.1.2 dequeueBuffer<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-2-surface" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.2 Surface"><!---->4.2 Surface<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-2-1-surface-çš„åˆ›å»ºæµç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.2.1 Surface çš„åˆ›å»ºæµç¨‹"><!---->4.2.1 Surface çš„åˆ›å»ºæµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-2-æœ¬åœ°çª—å£å°ç»“" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.2 æœ¬åœ°çª—å£å°ç»“"><!---->4.2 æœ¬åœ°çª—å£å°ç»“<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-bufferqueue-è¯¦è§£" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5 BufferQueue è¯¦è§£"><!---->5 BufferQueue è¯¦è§£<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-1-bufferqueue-çš„å†…éƒ¨åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.1 BufferQueue çš„å†…éƒ¨åŸç†"><!---->5.1 BufferQueue çš„å†…éƒ¨åŸç†<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-2-bufferqueue-çš„ç¼“å†²åŒºåˆ†é…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.2 BufferQueue çš„ç¼“å†²åŒºåˆ†é…"><!---->5.2 BufferQueue çš„ç¼“å†²åŒºåˆ†é…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-3-åº”ç”¨ç¨‹åºçš„å…¸å‹ç»˜å›¾æµç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.3 åº”ç”¨ç¨‹åºçš„å…¸å‹ç»˜å›¾æµç¨‹"><!---->5.3 åº”ç”¨ç¨‹åºçš„å…¸å‹ç»˜å›¾æµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-4-åº”ç”¨ç¨‹åºä¸-bufferqueue-çš„å…³ç³»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.4 åº”ç”¨ç¨‹åºä¸ BufferQueue çš„å…³ç³»"><!---->5.4 åº”ç”¨ç¨‹åºä¸ BufferQueue çš„å…³ç³»<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-surfaceflinger" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6 SurfaceFlinger"><!---->6 SurfaceFlinger<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-1-é»„æ²¹è®¡åˆ’-project-butter" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.1 â€œé»„æ²¹è®¡åˆ’â€ï¼ˆProject Butterï¼‰"><!---->6.1 â€œé»„æ²¹è®¡åˆ’â€ï¼ˆProject Butterï¼‰<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-2-surfaceflinger-çš„å¯åŠ¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.2 SurfaceFlinger çš„å¯åŠ¨"><!---->6.2 SurfaceFlinger çš„å¯åŠ¨<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-3-æ¥å£çš„æœåŠ¡ç«¯-â€”â€”-client" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.3 æ¥å£çš„æœåŠ¡ç«¯ â€”â€” Client"><!---->6.3 æ¥å£çš„æœåŠ¡ç«¯ â€”â€” Client<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-3-1-surfaceflinger-createconnection" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.3.1 SurfaceFlinger::createConnection"><!---->6.3.1 SurfaceFlinger::createConnection<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-3-2-client-createsurface" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.3.2 Client::createSurface"><!---->6.3.2 Client::createSurface<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-vsync-çš„äº§ç”Ÿå’Œå¤„ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7 VSync çš„äº§ç”Ÿå’Œå¤„ç†"><!---->7 VSync çš„äº§ç”Ÿå’Œå¤„ç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-1-vsync-ä¿¡å·çš„äº§ç”Ÿå’Œåˆ†å‘" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7.1 VSync ä¿¡å·çš„äº§ç”Ÿå’Œåˆ†å‘"><!---->7.1 VSync ä¿¡å·çš„äº§ç”Ÿå’Œåˆ†å‘<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-1-1-ç¡¬ä»¶æº" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7.1.1 ç¡¬ä»¶æº"><!---->7.1.1 ç¡¬ä»¶æº<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-1-2-è½¯ä»¶æº" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7.1.2 è½¯ä»¶æº"><!---->7.1.2 è½¯ä»¶æº<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-2-vsync-ä¿¡å·çš„å¤„ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7.2 VSync ä¿¡å·çš„å¤„ç†"><!---->7.2 VSync ä¿¡å·çš„å¤„ç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li></ul><!--]--><!----><!--]--></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->GUIç³»ç»Ÿâ€”â€”SurfaceFlinger</h1><div class="article-info"><span class="author-info" arialabel="ä½œè€…ğŸ–Š" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" arialabelledby="author"><title id="author" lang="en">author icon</title><g fill="currentColor"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></g></svg><span><a class="author-item" href="https://zengkaiqiang562.github.io/" target="_blank" rel="noopener noreferrer">Zenk562</a></span><span property="author" content="Zenk562"></span></span><span class="category-info" arialabel="åˆ†ç±»ğŸŒˆ" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" arialabelledby="category"><title id="category" lang="en">category icon</title><g fill="currentColor"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></g></svg><ul class="categories-wrapper"><li class="category clickable" role="navigation">æœ—å›½ç§‘æŠ€</li><meta property="articleSection" content="æœ—å›½ç§‘æŠ€"></ul></span><span arialabel="æ ‡ç­¾ğŸ·" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" arialabelledby="tag"><title id="tag" lang="en">tag icon</title><g fill="currentColor"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></g></svg><ul class="tags-wrapper"><li class="tag clickable" role="navigation">ä¸“é¢˜</li></ul><meta property="keywords" content="ä¸“é¢˜"></span><span class="date-info" arialabel="å†™ä½œæ—¥æœŸğŸ“…" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" arialabelledby="calendar"><title id="calendar" lang="en">calendar icon</title><g fill="currentColor"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></g></svg><span>2024å¹´4æœˆ30æ—¥</span><meta property="datePublished" content="2024-04-30T10:39:15.000Z"></span><!----><span class="words-info" arialabel="å­—æ•°ğŸ” " isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" arialabelledby="word"><title id="word" lang="en">word icon</title><g fill="currentColor"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></g></svg><span>çº¦ 30304 å­—</span><meta property="wordCount" content="30304"></span></div><hr></div><div class="toc-place-holder"><aside id="toc-list"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_1-opengl-es-ä¸-egl" class="router-link-active router-link-exact-active toc-link level2">1 OpenGL ES ä¸ EGL</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_2-android-çš„ç¡¬ä»¶æ¥å£-â€”â€”-hal" class="router-link-active router-link-exact-active toc-link level2">2 Android çš„ç¡¬ä»¶æ¥å£ â€”â€” HAL</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-gralloc-ä¸-framebuffer" class="router-link-active router-link-exact-active toc-link level2">3 Gralloc ä¸ Framebuffer</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-1-gralloc-æ¨¡å—çš„åŠ è½½" class="router-link-active router-link-exact-active toc-link level3">3.1 Gralloc æ¨¡å—çš„åŠ è½½</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-2-gralloc-æä¾›çš„æ¥å£" class="router-link-active router-link-exact-active toc-link level3">3.2 Gralloc æä¾›çš„æ¥å£</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-2-1-fb-è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹" class="router-link-active router-link-exact-active toc-link level4">3.2.1 fb è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_3-2-2-gralloc-è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹" class="router-link-active router-link-exact-active toc-link level4">3.2.2 gralloc è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹</a></li><!----><!--]--></ul><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-android-ä¸­çš„æœ¬åœ°çª—å£" class="router-link-active router-link-exact-active toc-link level2">4 Android ä¸­çš„æœ¬åœ°çª—å£</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-1-framebuffernativewindow" class="router-link-active router-link-exact-active toc-link level3">4.1 FramebufferNativeWindow</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-1-1-æ„é€ å‡½æ•°ä¸­çš„åˆå§‹åŒ–æ“ä½œ" class="router-link-active router-link-exact-active toc-link level4">4.1.1 æ„é€ å‡½æ•°ä¸­çš„åˆå§‹åŒ–æ“ä½œ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-1-2-dequeuebuffer" class="router-link-active router-link-exact-active toc-link level4">4.1.2 dequeueBuffer</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-2-surface" class="router-link-active router-link-exact-active toc-link level3">4.2 Surface</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-2-1-surface-çš„åˆ›å»ºæµç¨‹" class="router-link-active router-link-exact-active toc-link level4">4.2.1 Surface çš„åˆ›å»ºæµç¨‹</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_4-2-æœ¬åœ°çª—å£å°ç»“" class="router-link-active router-link-exact-active toc-link level3">4.2 æœ¬åœ°çª—å£å°ç»“</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-bufferqueue-è¯¦è§£" class="router-link-active router-link-exact-active toc-link level2">5 BufferQueue è¯¦è§£</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-1-bufferqueue-çš„å†…éƒ¨åŸç†" class="router-link-active router-link-exact-active toc-link level3">5.1 BufferQueue çš„å†…éƒ¨åŸç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-2-bufferqueue-çš„ç¼“å†²åŒºåˆ†é…" class="router-link-active router-link-exact-active toc-link level3">5.2 BufferQueue çš„ç¼“å†²åŒºåˆ†é…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-3-åº”ç”¨ç¨‹åºçš„å…¸å‹ç»˜å›¾æµç¨‹" class="router-link-active router-link-exact-active toc-link level3">5.3 åº”ç”¨ç¨‹åºçš„å…¸å‹ç»˜å›¾æµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_5-4-åº”ç”¨ç¨‹åºä¸-bufferqueue-çš„å…³ç³»" class="router-link-active router-link-exact-active toc-link level3">5.4 åº”ç”¨ç¨‹åºä¸ BufferQueue çš„å…³ç³»</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-surfaceflinger" class="router-link-active router-link-exact-active toc-link level2">6 SurfaceFlinger</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-1-é»„æ²¹è®¡åˆ’-project-butter" class="router-link-active router-link-exact-active toc-link level3">6.1 â€œé»„æ²¹è®¡åˆ’â€ï¼ˆProject Butterï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-2-surfaceflinger-çš„å¯åŠ¨" class="router-link-active router-link-exact-active toc-link level3">6.2 SurfaceFlinger çš„å¯åŠ¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-3-æ¥å£çš„æœåŠ¡ç«¯-â€”â€”-client" class="router-link-active router-link-exact-active toc-link level3">6.3 æ¥å£çš„æœåŠ¡ç«¯ â€”â€” Client</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-3-1-surfaceflinger-createconnection" class="router-link-active router-link-exact-active toc-link level4">6.3.1 SurfaceFlinger::createConnection</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_6-3-2-client-createsurface" class="router-link-active router-link-exact-active toc-link level4">6.3.2 Client::createSurface</a></li><!----><!--]--></ul><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-vsync-çš„äº§ç”Ÿå’Œå¤„ç†" class="router-link-active router-link-exact-active toc-link level2">7 VSync çš„äº§ç”Ÿå’Œå¤„ç†</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-1-vsync-ä¿¡å·çš„äº§ç”Ÿå’Œåˆ†å‘" class="router-link-active router-link-exact-active toc-link level3">7.1 VSync ä¿¡å·çš„äº§ç”Ÿå’Œåˆ†å‘</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-1-1-ç¡¬ä»¶æº" class="router-link-active router-link-exact-active toc-link level4">7.1.1 ç¡¬ä»¶æº</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-1-2-è½¯ä»¶æº" class="router-link-active router-link-exact-active toc-link level4">7.1.2 è½¯ä»¶æº</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lango-tech/subject/surfaceflinger.html#_7-2-vsync-ä¿¡å·çš„å¤„ç†" class="router-link-active router-link-exact-active toc-link level3">7.2 VSync ä¿¡å·çš„å¤„ç†</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><!--[--><div class="language-text ext-text"><pre class="language-text"><code>Android çš„ GUI ç³»ç»Ÿæ˜¯åŸºäº OpenGL/EGL æ¥å®ç°çš„
</code></pre></div><h2 id="_1-opengl-es-ä¸-egl" tabindex="-1"><a class="header-anchor" href="#_1-opengl-es-ä¸-egl" aria-hidden="true">#</a> 1 <code>OpenGL ES</code> ä¸ <code>EGL</code></h2><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæè¿°äº† <code>SurfaceFlinger</code> ä¸ <code>OpenGL ES</code> ç­‰æ¨¡å—çš„å…³ç³»ã€‚</p><p><img src="/assets/01.7c94b1b9.png" alt="" loading="lazy"></p><p>ç°åœ¨ç”± â€œåº•å±‚åˆ°ä¸Šå±‚â€ çš„é¡ºåºæ¥é€æ­¥åˆ†æå›¾ä¸­é˜è¿°çš„æ¶æ„ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>ï¼ˆ1ï¼‰Linux å†…æ ¸æä¾›äº†ç»Ÿä¸€çš„ framebuffer æ˜¾ç¤ºé©±åŠ¨ã€‚
	è®¾å¤‡èŠ‚ç‚¹ /dev/graphics/fb* æˆ–è€… /dev/fb*ï¼Œå…¶ä¸­ fb0 è¡¨ç¤ºç¬¬ä¸€ä¸ª Monitorï¼Œå½“å‰ç³»ç»Ÿå®ç°ä¸­åªç”¨åˆ°äº†ä¸€ä¸ªæ˜¾ç¤ºå±ã€‚

ï¼ˆ2ï¼‰Android çš„ HAL å±‚æä¾›äº† Grallocï¼ŒåŒ…æ‹¬ fb å’Œ gralloc ä¸¤ä¸ªè®¾å¤‡ã€‚
    å‰è€…è´Ÿè´£æ‰“å¼€å†…æ ¸ä¸­çš„ framebufferã€åˆå§‹åŒ–é…ç½®ï¼Œå¹¶æä¾›äº† postã€setSwapInterval ç­‰æ“ä½œæ¥å£ï¼›
    åè€…åˆ™ç®¡ç†å¸§ç¼“å†²åŒºçš„åˆ†é…å’Œé‡Šæ”¾ã€‚
    è¿™å°±æ„å‘³ç€ä¸Šå±‚å…ƒç´ åªèƒ½é€šè¿‡ Gralloc æ¥é—´æ¥è®¿é—®å¸§ç¼“å†²åŒºï¼Œä»è€Œä¿è¯äº†ç³»ç»Ÿå¯¹ framebuffer çš„æœ‰åºä½¿ç”¨å’Œç»Ÿä¸€ç®¡ç†ã€‚

    å¦å¤–ï¼ŒHALå±‚çš„å¦ä¸€é‡è¦æ¨¡å—æ˜¯ â€œComposerâ€ â€”â€” å¦‚å…¶åæ‰€ç¤ºï¼Œå®ƒä¸ºå‚å•†è‡ªå®šåˆ¶â€œUIåˆæˆâ€æä¾›äº†æ¥å£ã€‚
    Composer çš„ç›´æ¥ä½¿ç”¨è€…æ˜¯ SurfaceFlinger ä¸­çš„ HWComposerï¼ˆæœ‰ä¸¤ä¸ª HWComposerï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†è®²è§£ï¼‰ï¼Œ
    åè€…é™¤äº†ç®¡ç† Composer çš„ HAL æ¨¡å—å¤–ï¼Œè¿˜è´Ÿè´£ VSync ä¿¡å·çš„äº§ç”Ÿå’Œæ§åˆ¶ã€‚
    VSyncåˆ™æ˜¯ â€œProject Butterâ€ å·¥ç¨‹ä¸­åŠ å…¥çš„ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œå®ƒæ—¢å¯ä»¥ç”±ç¡¬ä»¶äº§ç”Ÿï¼Œä¹Ÿå¯ä»¥é€šè¿‡è½¯ä»¶æ¥æ¨¡æ‹Ÿï¼ˆVsyncThreadï¼‰ï¼Œ
    åç»­æœ‰ä¸“é—¨çš„å°èŠ‚è¿›è¡Œä»‹ç»ã€‚

ï¼ˆ3ï¼‰ç”±äº OpenGL ES æ˜¯ä¸€ä¸ªé€šç”¨çš„å‡½æ•°åº“ï¼Œåœ¨ä¸åŒçš„å¹³å°ç³»ç»Ÿä¸Šéœ€è¦è¢« â€œæœ¬åœ°åŒ–â€ï¼Œ
    å³æŠŠå®ƒä¸å…·ä½“å¹³å°ä¸­çš„çª—å£ç³»ç»Ÿå»ºç«‹èµ·å…³è”ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ­£å¸¸å·¥ä½œã€‚
    ä» FramebufferNativeWindow è¿™ä¸ªåç§°å°±èƒ½åˆ¤æ–­å‡ºæ¥ï¼Œå®ƒå°±æ˜¯è´Ÿè´£ OpenGL ES åœ¨ Android å¹³å°ä¸Šæœ¬åœ°åŒ–çš„ä¸­ä»‹ä¹‹ä¸€ã€‚
    åé¢æˆ‘ä»¬è¿˜ä¼šçœ‹åˆ° Android åº”ç”¨ç¨‹åºä¸­æ‰€ä½¿ç”¨çš„å¦ä¸€ä¸ªâ€œæœ¬åœ°çª—å£â€ã€‚

    ä¸º OpenGL ES é…ç½®æœ¬åœ°çª—å£çš„æ˜¯ EGLã€‚

ï¼ˆ4ï¼‰OpenG Læˆ–è€… OpenGL ES æ›´å¤šçš„åªæ˜¯ä¸€ä¸ªæ¥å£åè®®ï¼Œå…·ä½“å®ç°æ—¢å¯ä»¥é‡‡ç”¨è½¯ä»¶ï¼Œä¹Ÿå¯ä»¥ä¾æ‰˜äºç¡¬ä»¶ã€‚
    æ—¢ç„¶æœ‰å¤šç§å®ç°çš„å¯èƒ½ï¼Œé‚£ä¹ˆ OpenGL ES åœ¨åŠ¨æ€è¿è¡Œæ—¶æ˜¯å¦‚ä½•å–èˆçš„å‘¢ï¼Ÿè¿™ä¹Ÿæ˜¯ EGL çš„ä½œç”¨ä¹‹ä¸€ã€‚
    EGL ä¼šå»è¯»å– egl.cfg è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åæ ¹æ®ç”¨æˆ·çš„è®¾å®šæ¥åŠ¨æ€åŠ è½½ libaglï¼ˆè½¯ä»¶å®ç°ï¼‰æˆ–è€… libhglï¼ˆç¡¬ä»¶å®ç°ï¼‰ã€‚

ï¼ˆ5ï¼‰SurfaceFlinger ä¸­æŒæœ‰ä¸€ä¸ªæˆå‘˜æ•°ç»„ mDisplays æ¥æè¿°ç³»ç»Ÿä¸­æ”¯æŒçš„å„ç§ â€œæ˜¾ç¤ºè®¾å¤‡â€ã€‚
    å…·ä½“æœ‰å“ªäº› Display æ˜¯ç”± SurfaceFlinger åœ¨ readyToRun ä¸­åˆ¤æ–­å¹¶èµ‹å€¼çš„ï¼›
    å¹¶ä¸” DisplayDevice åœ¨åˆå§‹åŒ–æ—¶è¿˜å°†è°ƒç”¨ eglGetDisplayã€eglCreateWindowSurface ç­‰æ¥å£ï¼Œ
    å¹¶åˆ©ç”¨ EGLæ¥ å®Œæˆå¯¹ OpenGL ES ç¯å¢ƒçš„æ­å»ºã€‚

ï¼ˆ6ï¼‰å¾ˆå¤šæ¨¡å—éƒ½å¯ä»¥è°ƒç”¨ OpenGL ES æä¾›çš„ APIï¼ŒåŒ…æ‹¬ SurfaceFlingerã€DisplayDevice ç­‰æ¨¡å—ã€‚
  ï¼ˆè¿™äº› API æ¥å£ä»¥ â€œglâ€ ä¸ºå‰ç¼€ï¼Œå¦‚ glViewportã€glClearã€glMatrixModeã€glLoadIdentity ç­‰ï¼‰ï¼Œ

ï¼ˆ7ï¼‰ä¸ OpenGL ES ç›¸å…³çš„æ¨¡å—å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ ç±»ã€‚
    é…ç½®ç±»ï¼šå³å¸®åŠ© OpenGL ES å®Œæˆé…ç½®çš„ï¼ŒåŒ…æ‹¬ EGLã€DisplayHardware éƒ½å¯ä»¥å½’ä¸ºè¿™ä¸€ç±»ã€‚
    ä¾èµ–ç±»ï¼šä¹Ÿå°±æ˜¯ OpenGL ES è¦æ­£å¸¸è¿è¡Œèµ·æ¥æ‰€ä¾èµ–çš„ â€œæœ¬åœ°åŒ–â€ çš„ä¸œè¥¿ï¼Œä¸Šå›¾ä¸­æ˜¯æŒ‡ FramebufferNativeWindowã€‚
    ä½¿ç”¨ç±»ï¼šä½¿ç”¨è€…ä¹Ÿå¯èƒ½æ˜¯é…ç½®è€…ï¼Œå¦‚ DisplayDevice æ—¢æ‰®æ¼”äº†æ„å»º OpenGL ES ç¯å¢ƒçš„è§’è‰²ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å®ƒçš„ç”¨æˆ·ã€‚
    
</code></pre></div><h2 id="_2-android-çš„ç¡¬ä»¶æ¥å£-â€”â€”-hal" tabindex="-1"><a class="header-anchor" href="#_2-android-çš„ç¡¬ä»¶æ¥å£-â€”â€”-hal" aria-hidden="true">#</a> 2 <code>Android</code> çš„ç¡¬ä»¶æ¥å£ â€”â€” <code>HAL</code></h2><p>å¯¹äº <code>Android</code> ä¸­å¾ˆå¤šå­ç³»ç»Ÿæ¥è¯´ï¼ˆå¦‚æ˜¾ç¤ºç³»ç»Ÿã€éŸ³é¢‘ç³»ç»Ÿç­‰ï¼‰ï¼Œ<code>HAL</code> éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ç»„æˆéƒ¨åˆ† â€”â€” <code>HAL</code> æ˜¯è¿™äº›å­ç³»ç»Ÿä¸ <code>Linux Kernel</code> é©±åŠ¨ä¹‹é—´é€šä¿¡çš„ç»Ÿä¸€æ¥å£ã€‚</p><p>å¯¹äº <code>Gralloc</code> æ¥è¯´ï¼Œå®ƒçš„ç¡¬ä»¶æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* hardware/libhardware/include/hardware/gralloc.h */</span>
<span class="token comment">/* 
 * Every hardware module must have a data structure named HAL_MODULE_INFO_SYM
 * and the fields of this data structure must begin with hw_module_t
 * followed by module specific information.
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">hw_module_t</span> common<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>registerBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> buffer_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>unregisterBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> buffer_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>   

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> buffer_handle_t handle<span class="token punctuation">,</span> 
                  <span class="token keyword">int</span> usage<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>unlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span>buffer_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>perform<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span><span class="token keyword">int</span> operation<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock_ycbcr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span>buffer_handle_t handle<span class="token punctuation">,</span>
					<span class="token keyword">int</span> usage<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">android_ycbcr</span> <span class="token operator">*</span>ycbcr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* reserved for future use */</span>
    <span class="token keyword">void</span><span class="token operator">*</span> reserved_proc<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> gralloc_module_t<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>ä»æ³¨é‡Šä¸­å¯ä»¥çœ‹å‡ºï¼š</p><ol><li>é¦–å…ˆï¼Œæ¯ä¸€ä¸ªç¡¬ä»¶æ¨¡å—éƒ½å¿…é¡»æœ‰ä¸€ä¸ªåç§°ä¸º <code>HAL_MODULE_INFO_SYM</code> çš„å˜é‡ã€‚</li><li>å…¶æ¬¡ï¼Œæ­¤å˜é‡çš„æ•°æ®ç»“æ„è¦ä»¥ <code>hw_module_t</code> å¼€å¤´ã€‚</li></ol></blockquote><h2 id="_3-gralloc-ä¸-framebuffer" tabindex="-1"><a class="header-anchor" href="#_3-gralloc-ä¸-framebuffer" aria-hidden="true">#</a> 3 <code>Gralloc</code> ä¸ <code>Framebuffer</code></h2><p><code>Framebuffer</code> æ˜¯å†…æ ¸ç³»ç»Ÿæä¾›çš„å›¾å½¢ç¡¬ä»¶çš„æŠ½è±¡æè¿°ã€‚ä¹‹æ‰€ä»¥ç§°ä¸º <code>buffer</code>ï¼Œæ˜¯å› ä¸ºå®ƒä¹Ÿå ç”¨äº†ç³»ç»Ÿå­˜å‚¨ç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ä¸€å—åŒ…å«å±å¹•æ˜¾ç¤ºä¿¡æ¯çš„ç¼“å†²åŒºã€‚ ç”±æ­¤å¯è§ï¼Œåœ¨ â€œä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶â€ çš„ <code>Linux</code> ç³»ç»Ÿä¸­ï¼Œ<code>Framebuffer</code> è¢«çœ‹æˆäº†ç»ˆç«¯æ˜¾ç¤ºè®¾å¤‡çš„ â€œåŒ–èº«â€ã€‚</p><p>åœ¨ <code>Android</code> ç³»ç»Ÿä¸­ï¼Œ<code>Framebuffer</code> æä¾›çš„è®¾å¤‡æ–‡ä»¶èŠ‚ç‚¹æ˜¯ <code>/dev/graphics/fb*</code>ã€‚ å› ä¸ºç†è®ºä¸Šæ”¯æŒå¤šä¸ªå±å¹•æ˜¾ç¤ºï¼Œæ‰€ä»¥ <code>fb</code> æŒ‰æ•°å­—åºå·è¿›è¡Œæ’åˆ—ï¼Œå³ <code>fb0</code>ã€<code>fb1</code> ç­‰ã€‚å…¶ä¸­ç¬¬ä¸€ä¸ª <code>fb0</code> æ˜¯ä¸»æ˜¾ç¤ºå±å¹•ï¼Œå¿…é¡»å­˜åœ¨ã€‚</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAO4AAAAvCAYAAADkWvYzAAAJoklEQVR4nO2dz2siyxbHv/fx/oi0NEP7Nu9tjRMJQ0P2EYfMZRYNokvFzQUDJmQxWSQLMYEId3FlXCqBXgx3LleSvSBDyEzin2AziJ3/4r1FVbfVP23tVrvz6gMDY2y7v3bXqTrnVNXxl3//51//BSfZyA30K1nHn8ddBTejiC9VV1HdGeDT6S20aE/NWYJfuOFyOMnjH9sWwOFwlocbLoeTQLjhcjgJhBsuh5NAuOEGQFLa6LeKkBYd02tAjomebSLX1eD65Ab6vSWOjzvG9zH+1Q/Wcpl/hvq0VMTVRQEvXtMOHtMU+v0ZTtSJz3FP+Fy+BjnlAY57NWQ8JLBTHnJdRZU50HGdlTjAr4cCxt24TH/ETc9r4gDHvRwey9cYIQ2l1cTueMk2NLpGaQSAfj6/JqXhDDcQrBG6IDfQr6Rwd65ApS1Rrquo9hpA+RojDHFTHnp+bjYlLyWlTeYXy7RByw30K00cT0POZco5ZPCEzxHPh65M3PSExWzoMUASsWO+eIOUALwMwnb862HrrrK8lwXGf5lGCwCj708AUhA9fac0lIL1c5paR4ldFDD6gjsdyOyFcVXIdfT7L94dz0aJm55XiD7DdNsaAuAcceUG+hXgcxeoVrIgI+Yjcr0aMtBxd17Hw34bl4eC+RGhoqJfMV4tGGHd2BEhAabRSWIKwAxTL19Q/oi8oOOu4zISLzj3/DtmgXEHpbbPOaR32BV0PHdcel0aJgiWP878j9GZFUeeYQYNDdy0+eiRFOszMTHOYzzX8heIrSbygu19A9+whXpD6KD0PcccR9oF2/niZQrNci5bu7Bfx+dZWEMgl2u5hGRLrRqzPafLXmH+XkVFv7JCm15ESM0ernIW1cIAn8qP+LV3hPetIzyfn2FWayL/4QBqu46SisUxrnGunooqfWWPO0dfB3h/UcBlL0VujtzA5aEA/f53jxtFR1t9gAffII+4OhhPV44F5Q8FCG7XoTd93FVwQkUSw7Ef4wwBLlsgxqt9w7NeQL5QhDRiPAU5RzrIr85G7KXHuPb8Wl7Gn0W1l4V+f4bS6YQ+vxqO5SF5flIRV3uPKJWv6fEkTqu2ipiy3kymhn7mCZ/LCkb0e1UvGpiyjTtTQ39ngE/la2hu5wkUC9L3BNZw0lDqRUhtpgOkz2LlkEi7xUn5ltzHzA/yfMyOLmKDBSLR7OkqjwfGgxIgvFhd2cCMrlEqK/N/5wPgsGnNtGm3OCmf4U4nBm40ds+EgPQOuwKrzx25XvM0AFOX32iLA+Qybtcx3PSOz003XNrfrSHA1wF04S32JQCYQB08AeZrqnsvC+g/XDolLz2AKAi2zwzxOIbpbbCMu8y91aZ4AbAjpunrW5xY7skED2MdEFIQLWexjkCjrwPoyCLHptRZ78LzPP5Iym/EszpnjWcCtc3cAzEFAbqZ6wjNy+odfWAi0Owx4lpPqus/V78Ci3aLP+7f4vIwBxlD8jAMN2XcQel0SHq9CxV5D9fJGHX+8OmpJKWNagYOw1kGSTnySAKRkXw88DN6cowgNNE/dL6bEkF899EjxpUadvfTULUJTON0yRh76wGmug5k3mJfuoVGR9xcBtDvv9nOY28szsSfPTNPsIUA9jjQ0gFEl8whHdICz2r0BXeFJvIXKvIIt7FCFOahhiSmAP3HeuLdCDRvIKvsBk08aWkoNWq01Eg1tY7StIF+hXHhDKQi3ns0bPMQI9Ybd0JMBaWxn/Fz14OxeDpqiD/vj3CZeQdJnUDzzBj769GmMwBZsyEAIDHjkt+fGK01hnSEAD68TLeRgZ1APVWgguqn+ZZlpgKtnVUN/V6N/r+Ay14homnFaDVv3HCtvSgZmfSxbUSfzqDDOf8rfyhAwBP+9rImGh8vTDotwi8pRbGPLqS3Nkamn5jpQEZ4g0UjkPbwA/ohGS3FPRJ/Or6erx7DLQ/buNIQd+DI8AdCErEDHc8RD0/EkyDudRBJozYTcxudYeDPkXg6NSCjn5mEC9OO1qg53HQQdZGCTrkYLuw8TiOxmHD4GxQ2zqMG+ugy2npOhdCAP5DRGqtbPFa1yB8KEDwbsKH5o7lKyule0vg1U8OVkvbXon3Dsy5gd7+IXEbH84PT+Pz1EAThjf91FjLBlPi7Zlzsmam2cIDji8X6VkFT/8IYWVQtq6pocsrzU7QDWjpWpclM5hyRhYgLWV5zyBF3iJtzEVcXrHsxT1w4HrzOLJCgjNoKUFdRZd08lyklw5g/u44q1OUGSDbT1EJYLoYw4kxv4x+1zyC2mma2XL8/Q+n7R2ZKDCQBBrIIxBLn6vZN6MTI8xUSMtx4JaU89UygdgbYvXB+72Wn5kbtDnK92nw6RB/gUzeFy4rtQKFgmTLR78+WdssdbUMw9LOu+hA35Z9QWk3meuR9zes8QAiPK3ySK8j3ikIz30hvg9zU2XqmAVZgsR4y9bPjcJV95oNDwCtgxIOtr5yKF0YSKC4rkwLosSzTc/59c+4eZ5PwEfc1wGtO/d/BDZfDSSDcVeZwEgg3XA4ngXDD5XASCDdcDieBLF6AYc9Y0gUEYpyzi1wz55Xjb7g++wYDb8+ybyaPeEGA6/XCagbmhuRY6bQGItC8nnpbnLji6ypL+28h6AP8uepcILPRnuzJ7WCcqa2t8h0QgWYc4Linor83w50epTJvwmqe19ui97n7BOGwieNNlJzkbAVfw2X3Jy7PfMvefBQZ4qb7BGSOLJsKoiS05lYN6Cootb9FpmkR4TSvq94WJ86E22TgqCvELhB333Au75Fj55vHN4yvZrJPMnb4avbBrd4W51XgUSyOXT5n3QliicMsdYVonFUr4uH0Fppjj6ZRp7aDu50a8gH2qgYmKs3RqImB5vD1tjjxxmm4TJ3bhetSbYkbUviNllARU0wFRLJTBV0FJ6M0FK/q5qsSleZNtvI1avatt8V5FUQ7j6tN8QKB1FSazqADgFjEVe8Is3NrxjQ2u1ZYzUnBR3MU9bY48Sdaw2W3mNHGla+k8HeZjcfYSgMxwGtbXJzx0BxNvS1OEojWcC1lJ0ndJYwfrXtJad1gtxItWyHq8p6bwE1zVPW2OIkgQsM9wHGF/VmQed2l+Xyi/ZhtEzc9QXDRvEy9Lc6rYOXpIFKBb0HtIbPu0vwnSlapTxQVQTQ76wHNj1/HxvRFLNYcZb0tTlLgG+k5nATCdwdxOAmEGy6Hk0C44XI4CYQbLoeTQLjhcjgJhBsuh5NAuOFyOAmEG24AJKWNfsvvF+LoMb0GNlF0IoiebSLX1eD6jF9OjPH3iSP/A4I83dYQN6qSAAAAAElFTkSuQmCC" alt="" loading="lazy"></p><p><code>Android</code> çš„å„å­ç³»ç»Ÿé€šå¸¸ä¸ä¼šç›´æ¥ä½¿ç”¨å†…æ ¸é©±åŠ¨ï¼Œè€Œæ˜¯ç”± <code>HAL</code> å±‚æ¥é—´æ¥å¼•ç”¨åº•å±‚æ¶æ„ã€‚æ˜¾ç¤ºç³»ç»Ÿä¸­ä¹ŸåŒæ ·å¦‚æ­¤ â€”â€” å®ƒå€ŸåŠ©äº <code>HAL</code> å±‚æ¥æ“ä½œå¸§ç¼“å†²åŒºï¼Œè€Œå®Œæˆè¿™ä¸€ä¸­ä»‹ä»»åŠ¡çš„å°±æ˜¯ <code>Gralloc</code>ã€‚</p><h3 id="_3-1-gralloc-æ¨¡å—çš„åŠ è½½" tabindex="-1"><a class="header-anchor" href="#_3-1-gralloc-æ¨¡å—çš„åŠ è½½" aria-hidden="true">#</a> 3.1 <code>Gralloc</code> æ¨¡å—çš„åŠ è½½</h3><p><code>Gralloc</code> å¯¹åº”çš„æ¨¡å—æ˜¯ç”± <code>FramebufferNativeWindow</code> åœ¨æ„é€ å‡½æ•°ä¸­åŠ è½½çš„ã€‚å³ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token function">hw_get_module</span><span class="token punctuation">(</span>GRALLOC_HARDWARE_MODULE_ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">module</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>å‡½æ•° <code>hw_get_module</code> æ˜¯ä¸Šå±‚ä½¿ç”¨è€…åŠ è½½ <code>HAL</code> åº“çš„å…¥å£ï¼Œè¿™æ„å‘³ç€ä¸è®ºæ˜¯å“ªä¸ªç¡¬ä»¶å‚å•†æä¾›çš„ <code>HAL</code> åº“ï¼ˆæ¯”å¦‚ <code>Gralloc</code> åº“ï¼‰ï¼Œæˆ‘ä»¬éƒ½åªéœ€è¦é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥åŠ è½½å®ƒä»¬ã€‚</p></blockquote><p>å¯ä»¥çœ‹åˆ°ï¼Œé’ˆå¯¹ <code>Gralloc</code> ä¼ å…¥çš„ç¡¬ä»¶æ¨¡å— <code>ID</code> åä¸ºï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRALLOC_HARDWARE_MODULE_ID</span> <span class="token string">&quot;gralloc&quot;</span></span>
</code></pre></div><p>æŒ‰ç…§ <code>hw_get_module</code> çš„åšæ³•ï¼Œå®ƒä¼šåœ¨å¦‚ä¸‹è·¯å¾„ä¸­æŸ¥æ‰¾ä¸ <code>ID</code> å€¼åŒ¹é…çš„åº“ã€‚</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HAL_LIBRARY_PATH1</span> <span class="token string">&quot;/system/lib/hw&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HAL_LIBRARY_PATH2</span> <span class="token string">&quot;/vendor/lib/hw&quot;</span></span>
</code></pre></div><p><code>lib</code> åº“åæœ‰å¦‚ä¸‹å‡ ç§å½¢å¼ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>gralloc.[ro.hardware].so 
gralloc.[ro.product.board].so 
gralloc.[ro.board.platform].so 
gralloc.[ro.arch].so
</code></pre></div><p>æˆ–è€…å½“ä¸Šè¿°ç³»ç»Ÿå±æ€§ç»„æˆçš„æ–‡ä»¶åéƒ½ä¸å­˜åœ¨æ—¶ï¼Œå°±ä½¿ç”¨é»˜è®¤çš„ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>gralloc.default.so
</code></pre></div><blockquote><p>è¿™ä¸ª <code>default</code> åº“æ˜¯ <code>Android</code> åŸç”Ÿæ€çš„å®ç°ï¼Œæºç ä½ç½®åœ¨ <code>hardware/libhardware/modules/gralloc/</code> ä¸­ï¼Œå®ƒç”± <code>gralloc.cpp</code>ã€<code>framebuffer.cpp</code> å’Œ <code>mapper.cpp</code> ä¸‰ä¸ªä¸»è¦æºæ–‡ä»¶ç¼–è¯‘ç”Ÿæˆã€‚</p></blockquote><h3 id="_3-2-gralloc-æä¾›çš„æ¥å£" tabindex="-1"><a class="header-anchor" href="#_3-2-gralloc-æä¾›çš„æ¥å£" aria-hidden="true">#</a> 3.2 <code>Gralloc</code> æä¾›çš„æ¥å£</h3><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* hardware/libhardware/include/hardware/gralloc.h */</span>
<span class="token comment">/* 
 * Every hardware module must have a data structure named HAL_MODULE_INFO_SYM
 * and the fields of this data structure must begin with hw_module_t
 * followed by module specific information.
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">hw_module_t</span> common<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>registerBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> buffer_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>unregisterBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> buffer_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>   

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> buffer_handle_t handle<span class="token punctuation">,</span> 
                  <span class="token keyword">int</span> usage<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>unlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span>buffer_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>perform<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span><span class="token keyword">int</span> operation<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock_ycbcr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gralloc_module_t</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span>buffer_handle_t handle<span class="token punctuation">,</span>
					<span class="token keyword">int</span> usage<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">android_ycbcr</span> <span class="token operator">*</span>ycbcr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* reserved for future use */</span>
    <span class="token keyword">void</span><span class="token operator">*</span> reserved_proc<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> gralloc_module_t<span class="token punctuation">;</span>
</code></pre></div><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*hardware/libhardware/include/hardware/Hardware.h*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">hw_module_t</span> <span class="token punctuation">{</span>
    â€¦
    <span class="token keyword">struct</span> <span class="token class-name">hw_module_methods_t</span><span class="token operator">*</span> methods<span class="token punctuation">;</span> <span class="token comment">//ä¸€ä¸ª HAL åº“å¿…é¡»æä¾›çš„æ–¹æ³•</span>
    â€¦
<span class="token punctuation">}</span> hw_module_t<span class="token punctuation">;</span>


<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">hw_module_methods_t</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">hw_module_t</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> id<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">hw_device_t</span><span class="token operator">*</span><span class="token operator">*</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> hw_module_methods_t<span class="token punctuation">;</span>
</code></pre></div><p>ä»¥ä¸Šç»™å‡ºäº†ä¸‰ä¸ªç»“æ„ä½“çš„å®šä¹‰ï¼š<code>gralloc_module_t</code>ã€<code>hw_module_t</code>ã€<code>hw_module_methods_t</code>ã€‚æ³¨æ„ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>ç¡¬ä»¶æ¥å£çš„æŠ½è±¡æ¶‰åŠäº†ç»§æ‰¿å…³ç³» â€”â€” â€œæŠ½è±¡çš„ç¡¬ä»¶â€ æ˜¯çˆ¶ç±»ï¼Œè€Œ â€œå…·ä½“çš„ç¡¬ä»¶â€ åˆ™æ˜¯å­ç±»ã€‚
è¿™åœ¨ C++ ä¸­å¾ˆå®¹æ˜“å®ç°ï¼Œä½†æ˜¯ HAL å¤šæ•°æ˜¯ç”± C è¯­è¨€å®ç°çš„ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ
å…¶å®å¾ˆç®€å•ï¼Œåªè¦è®©å­ç±»æ•°æ®ç»“æ„çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡æ˜¯çˆ¶ç±»ç»“æ„å³å¯ã€‚

ç±»ä¼¼äº Gralloc çš„ç¡¬ä»¶æ¥å£å®šä¹‰ï¼ˆgralloc_module_tï¼‰ï¼Œ
ä»»ä½•ç¡¬ä»¶è®¾å¤‡çš„ HAL åº“éƒ½å¿…é¡»å®ç° hw_module_methods_tã€‚ç›®å‰ hw_module_methods_t ç»“æ„ä½“ä¸­åªæœ‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆå˜é‡ï¼Œå³ openã€‚
å½“ä¸Šå±‚ä½¿ç”¨è€…è°ƒç”¨ hw_get_module æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆåœ¨æŒ‡å®šç›®å½•ä¸­æŸ¥æ‰¾å¹¶åŠ è½½æ­£ç¡®çš„ HAL åº“ï¼Œç„¶åé€šè¿‡ open æ–¹æ³•æ¥æ‰“å¼€æŒ‡å®šçš„è®¾å¤‡ã€‚
</code></pre></div><p>åœ¨ <code>Gralloc</code> ä¸­ï¼Œ<code>open</code> æ¥å£å¯ä»¥å¸®åŠ©ä¸Šå±‚ä½¿ç”¨è€…æ‰“å¼€ä¸¤ç§è®¾å¤‡ã€‚åˆ†åˆ«æ˜¯ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRALLOC_HARDWARE_FB0</span> <span class="token string">&quot;fb0&quot;</span>   <span class="token comment">// fb0  å°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è¯´çš„ â€œä¸»å±å¹•â€</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRALLOC_HARDWARE_GPU0</span> <span class="token string">&quot;gpu0&quot;</span> <span class="token comment">// gpu0 è´Ÿè´£å›¾å½¢ç¼“å†²åŒºçš„åˆ†é…å’Œé‡Šæ”¾</span></span>
</code></pre></div><p>è¿™ä¸¤ä¸ªè®¾å¤‡åˆ†åˆ«ç”± <code>FramebufferNativeWindow</code> ä¸­çš„ <code>fbDev</code> å’Œ <code>grDev</code> æˆå‘˜å˜é‡æ¥ç®¡ç†ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*frameworks/native/libs/ui/FramebufferNativeWindow.cpp*/</span>
<span class="token class-name">FramebufferNativeWindow</span><span class="token double-colon punctuation">::</span><span class="token function">FramebufferNativeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">BASE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fbDev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">grDev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mUpdateOnDemand</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    err <span class="token operator">=</span> <span class="token function">framebuffer_open</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fbDev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰“å¼€ fb è®¾å¤‡ï¼ˆå³ framebuffer è®¾å¤‡ï¼‰</span>
    err <span class="token operator">=</span> <span class="token function">gralloc_open</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>grDev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰“å¼€ gralloc è®¾å¤‡</span>
</code></pre></div><blockquote><p>ä¸Šè¿°ä»£ç æ®µä¸­çš„ä¸¤ä¸ª <code>xxx_open</code> å‡½æ•°ç”± <code>hardware/libhardware/include/hardware</code> ç›®å½•ä¸‹çš„ <code>fb.h</code> å’Œ<code> gralloc.h</code> å¤´æ–‡ä»¶æä¾›ï¼Œç”¨äºæ‰“å¼€ <code>fb</code> åŠ <code>gralloc</code> è®¾å¤‡ã€‚</p><p>æ³¨æ„ï¼š</p><ol><li><code>FramebufferNativeWindow.cpp</code> åœ¨é«˜ç‰ˆæœ¬çš„æºä»£ç ä¸­å·²ç»ä¸å­˜åœ¨äº†ï¼Œä½†æ‰“å¼€ <code>fb</code> å’Œ <code>gralloc</code> è®¾å¤‡è¿˜æ˜¯ä¼šè°ƒç”¨ <code>framebuffer_open</code> å’Œ <code>gralloc_open</code> è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</li><li><code>framebuffer_open</code> å’Œ <code>gralloc_open</code> æœ€ç»ˆè°ƒç”¨çš„è‚¯å®šè¿˜æ˜¯ <code>hw_module_methods_t</code> ä¸­çš„ <code>open</code> æ–¹æ³•ï¼Œåªæ˜¯å‡½æ•°å‚æ•°æœ‰æ‰€å·®å¼‚ï¼š</li></ol><div class="language-text ext-text"><pre class="language-text"><code>fb      å¯¹åº”çš„è®¾å¤‡åä¸º GRALLOC_HARDWARE_FB0ï¼›
gralloc å¯¹åº”çš„è®¾å¤‡åä¸º GRALLOC_HARDWARE_GPU0ã€‚
</code></pre></div></blockquote><p><code>Android</code> åŸç”Ÿæ€çš„ <code>Gralloc</code> å®ç°åœ¨ hardware/libhardware/modules/gralloc ä¸­ï¼Œç”± <code>gralloc.cpp</code>ã€<code>framebuffer.cpp</code> å’Œ <code>mapper.cpp</code> ä¸‰ä¸ªä¸»è¦æºæ–‡ä»¶ç¼–è¯‘ç”Ÿæˆã€‚</p><p>åŸç”Ÿæ€çš„ <code>Gralloc</code> å®ç°ä¸­ï¼Œ<code>open</code> æ–¹æ³•æ¥å£å¯¹åº”çš„æ˜¯ <code>gralloc_device_open@Gralloc.cpp</code>ã€‚è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®è®¾å¤‡åæ¥åˆ¤æ–­æ˜¯æ‰“å¼€ <code>fb</code> è¿˜æ˜¯ <code>gralloc</code> è®¾å¤‡ã€‚</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*hardware/libhardware/modules/gralloc/gralloc.cpp*/</span>
<span class="token keyword">int</span> <span class="token function">gralloc_device_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> hw_module_t<span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> hw_device_t<span class="token operator">*</span><span class="token operator">*</span> device<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> GRALLOC_HARDWARE_GPU0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æ‰“å¼€ gralloc è®¾å¤‡</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        status <span class="token operator">=</span> <span class="token function">fb_device_open</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¦åˆ™å°±æ˜¯ fb è®¾å¤‡</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-2-1-fb-è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_3-2-1-fb-è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹" aria-hidden="true">#</a> 3.2.1 <code>fb</code> è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹</h4><p><strong>å…ˆæ¥å¤§æ¦‚çœ‹çœ‹ <code>fb</code> è®¾å¤‡ï¼ˆå³ <code>framebuffer</code> è®¾å¤‡ï¼‰çš„æ‰“å¼€è¿‡ç¨‹ï¼š</strong></p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*hardware/libhardware/modules/gralloc/framebuffer.cpp*/</span>
<span class="token keyword">int</span> <span class="token function">fb_device_open</span><span class="token punctuation">(</span>hw_module_t <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> hw_device_t<span class="token operator">*</span><span class="token operator">*</span> device<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> GRALLOC_HARDWARE_FB0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// è®¾å¤‡åæ˜¯å¦æ­£ç¡®</span>
       fb_context_t <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token punctuation">(</span>fb_context_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* åˆ†é… hw_device_t ç©ºé—´ï¼Œè¿™æ˜¯ä¸€ä¸ªâ€œå£³â€ */</span>
       <span class="token function">memset</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆå§‹åŒ–</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       dev<span class="token operator">-&gt;</span>device<span class="token punctuation">.</span>common<span class="token punctuation">.</span>close <span class="token operator">=</span> fb_close<span class="token punctuation">;</span> <span class="token comment">// è¿™å‡ ä¸ªæ¥å£æ˜¯fbè®¾å¤‡çš„æ ¸å¿ƒ</span>
       dev<span class="token operator">-&gt;</span>device<span class="token punctuation">.</span>setSwapInterval <span class="token operator">=</span> fb_setSwapInterval<span class="token punctuation">;</span>
       dev<span class="token operator">-&gt;</span>device<span class="token punctuation">.</span>post <span class="token operator">=</span> fb_post<span class="token punctuation">;</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       private_module_t<span class="token operator">*</span> m <span class="token operator">=</span> <span class="token punctuation">(</span>private_module_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">module</span><span class="token punctuation">;</span>
       status <span class="token operator">=</span> <span class="token function">mapFrameBuffer</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å†…å­˜æ˜ å°„ï¼Œä»¥åŠå‚æ•°é…ç½®</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token operator">*</span>device <span class="token operator">=</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>device<span class="token punctuation">.</span>common<span class="token punctuation">;</span> <span class="token comment">// â€œå£³â€ å’Œ â€œæ ¸å¿ƒâ€ çš„å…³ç³»</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* hardware/libhardware/modules/gralloc/framebuffer.cpp */</span>
<span class="token keyword">struct</span> <span class="token class-name">fb_context_t</span> <span class="token punctuation">{</span>
    framebuffer_device_t  device<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* hardware/libhardware/include/hardware/fb.h */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">hw_device_t</span> common<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span>  flags<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span>  width<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span>  height<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span>       stride<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span>       format<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">float</span>     xdpi<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span>     ydpi<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">float</span>     fps<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span>       minSwapInterval<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span>       maxSwapInterval<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span>       numFramebuffers<span class="token punctuation">;</span>

    <span class="token keyword">int</span> reserved<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setSwapInterval<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span><span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setUpdateRect<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span><span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>post<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span><span class="token operator">*</span> dev<span class="token punctuation">,</span> buffer_handle_t buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>compositionComplete<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span><span class="token operator">*</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dump<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span><span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token keyword">int</span> buff_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>enableScreen<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span><span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> enable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span><span class="token operator">*</span> reserved_proc<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> framebuffer_device_t<span class="token punctuation">;</span>
</code></pre></div><p>æ•°æ®ç±»å‹ <code>fb_context_t</code> é‡Œçš„å”¯ä¸€æˆå‘˜å°±æ˜¯ <code>framebuffer_device_t</code>ï¼Œè¿™æ˜¯å¯¹ <code>fb</code> è®¾å¤‡çš„ç»Ÿä¸€æè¿°ã€‚</p><p>ä¸€ä¸ªæ ‡å‡†çš„ <code>fb</code> è®¾å¤‡é€šå¸¸è¦æä¾›å¦‚ä¸‹æ¥å£å®ç°ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* å°† buffer æ•°æ® post åˆ°æ˜¾ç¤ºå±ä¸Šã€‚è¦æ±‚ buffer å¿…é¡»ä¸å±å¹•å°ºå¯¸ä¸€è‡´ï¼Œ
	å¹¶ä¸”æ²¡æœ‰è¢«lockedã€‚è¿™æ · buffer å†…å®¹å°†åœ¨ä¸‹ä¸€æ¬¡ VSYNC ä¸­è¢«æ˜¾ç¤ºå‡ºæ¥ã€‚*/</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>post<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span><span class="token operator">*</span> dev<span class="token punctuation">,</span> buffer_handle_t buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è®¾ç½®ä¸¤ä¸ªç¼“å†²åŒºäº¤æ¢çš„æ—¶é—´é—´éš”ã€‚</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setSwapInterval<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span><span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è®¾ç½®åˆ·æ–°åŒºåŸŸï¼Œéœ€è¦ framebuffer é©±åŠ¨æ”¯æŒ â€œupdate-on-demandâ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™ä¸ªåŒºåŸŸå¤–çš„æ•°æ®å¾ˆå¯èƒ½è¢«è®¤ä¸ºæ— æ•ˆã€‚</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setUpdateRect<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">framebuffer_device_t</span><span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>æˆ‘ä»¬å†æ¥è§£é‡Šä¸‹ <code>framebuffer_device_t</code> ä¸­ä¸€äº›é‡è¦çš„æˆå‘˜å˜é‡ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><tr align="left"><th>å˜é‡</th><th>æè¿°</th></tr><tr><td>flags</td><td>æ ‡å¿—ä½ï¼ŒæŒ‡ç¤º framebuffer çš„å±æ€§é…ç½®</td></tr><tr><td>widthã€height</td><td>framebuffer çš„å®½å’Œé«˜,ä»¥åƒç´ ä¸ºå•ä½</td></tr><tr><td>format</td><td> framebuffer çš„åƒç´ æ ¼å¼ï¼Œæ¯”å¦‚ï¼š <ul><li>HAL_PIXEL_FORMAT_RGBA_88888</li><li>HAL_PIXEL_FORMAT_RGIBX_8888</li><li>HAL_PIXEL_FORMAT_RGB_888</li><li>HAL_PIXEL_FORMAT_RGB_565 ç­‰</li></ul></td></tr><tr><td>xdpiã€ydpi</td><td>x å’Œ y è½´çš„å¯†åº¦ï¼ˆdot per inchï¼‰</td></tr><tr><td>xdpiã€ydpi</td><td>x å’Œ y è½´çš„å¯†åº¦ï¼ˆdot per inchï¼‰</td></tr><tr><td>fps</td><td>å±å¹•çš„æ¯ç§’åˆ·æ–°é¢‘ç‡ã€‚å‡å¦‚æ— æ³•ä»è®¾å¤‡è·å–è¿™ä¸ªå€¼ï¼ŒAndroid ç³»ç»Ÿä¼šé»˜è®¤è®¾ç½®ä¸º 60Hz</td></tr><tr><td>minSwapIntervalã€maxSwapInterval</td><td>è¯¥ framebuffer æ”¯æŒçš„æœ€å°å’Œæœ€å¤§çš„ç¼“å†²äº¤æ¢æ—¶é—´</td></tr></table><p>ç³»ç»Ÿæ‰“å¼€ <code>Kernel</code> å±‚çš„ <code>fb</code> è®¾å¤‡ä»¥åŠå¯¹ <code>fb</code> è¿›è¡Œé…ç½®çš„æ“ä½œæ˜¯åœ¨ <code>mapFrameBuffer()</code> ä¸­å®Œæˆçš„ã€‚è¿™ä¸ªå‡½æ•°é¦–å…ˆå°è¯•æ‰“å¼€å¦‚ä¸‹è·¯å¾„ä¸­çš„ <code>fb</code> è®¾å¤‡ï¼š</p><blockquote><p><code>mapFrameBuffer</code> å‡½æ•°å†…éƒ¨è°ƒç”¨ <code>open</code> æ¥å£æ‰“å¼€ <code>fb</code> è®¾å¤‡ï¼Œæƒé™ä¸º <code>O_RDWR</code>ã€‚</p></blockquote><div class="language-text ext-text"><pre class="language-text"><code>&quot;/dev/graphics/fb%u&quot; æˆ–è€… &quot;/dev/fb%u&quot;
</code></pre></div><blockquote><p>å…¶ä¸­ <code>%u</code> è¡¨ç¤ºä¸åŒçš„æ•°å­—ï¼Œä»£è¡¨ä¸åŒçš„å±å¹•ã€‚</p></blockquote><div class="language-text ext-text"><pre class="language-text"><code>æˆåŠŸæ‰“å¼€ fb è®¾å¤‡åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ï¼š

	ioctl(fd, FBIOGET_FSCREENINFO, &amp;finfo); 
	ioctl(fd, FBIOGET_VSCREENINFO, &amp;info)

æ¥å¾—åˆ°æ˜¾ç¤ºå±çš„ä¸€ç³»åˆ—å‚æ•°ï¼ŒåŒæ—¶é€šè¿‡ï¼š

	ioctl(fd, FBIOPUT_VSCREENINFO, &amp;info)

æ¥å¯¹åº•å±‚ fb è®¾å¤‡è¿›è¡Œé…ç½®ã€‚
</code></pre></div><p>å¦å¤–ï¼Œå‡½æ•° <code>mapFrameBuffer</code> çš„å¦ä¸€é‡è¦ä»»åŠ¡å°±æ˜¯ä¸º <code>fb</code> è®¾å¤‡åšå†…å­˜æ˜ å°„ã€‚ä¸»è¦æºç è¯­å¥å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* hardware/libhardware/modules/gralloc/framebuffer.cpp */</span>
<span class="token comment">/* mapFrameBufferLocked å‡½æ•°ä¸­ */</span>
<span class="token comment">/*
æ˜ å°„åœ°å€ä¿å­˜åœ¨ module-&gt;framebuffer-&gt;baseã€‚
å˜é‡ module å¯¹åº”çš„æ˜¯å‰é¢ hw_get_module(GRALLOC_HARDWARE_MODULE_ID, &amp;module) å¾—åˆ°çš„ hw_module_t
ï¼ˆhw_module_t è¢«å¼ºåˆ¶ç±»å‹è½¬åŒ–ä¸º private_module_tï¼‰ã€‚
*/</span>
<span class="token keyword">void</span><span class="token operator">*</span> vaddr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> fbSize<span class="token punctuation">,</span> PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token keyword">module</span><span class="token operator">-&gt;</span>framebuffer<span class="token operator">-&gt;</span>base <span class="token operator">=</span> <span class="token function">intptr_t</span><span class="token punctuation">(</span>vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>vaddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fbSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-2-2-gralloc-è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_3-2-2-gralloc-è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹" aria-hidden="true">#</a> 3.2.2 <code>gralloc</code> è®¾å¤‡çš„æ‰“å¼€è¿‡ç¨‹</h4><p><strong>æ¥ä¸‹æ¥å†çœ‹çœ‹ç³»ç»Ÿæ‰“å¼€ <code>gralloc</code> è®¾å¤‡çš„è¿‡ç¨‹ï¼Œå®ƒç›¸å¯¹äº <code>fb</code> è®¾å¤‡ç®€å•äº›ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code> <span class="token comment">/*hardware/libhardware/modules/gralloc/gralloc.cpp*/</span>
<span class="token keyword">int</span> <span class="token function">gralloc_device_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> hw_module_t<span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> hw_device_t<span class="token operator">*</span><span class="token operator">*</span> device<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> GRALLOC_HARDWARE_GPU0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        gralloc_context_t <span class="token operator">*</span>dev<span class="token punctuation">;</span> <span class="token comment">// åšæ³•å’Œ fb ç±»ä¼¼</span>
        dev <span class="token operator">=</span> <span class="token punctuation">(</span>gralloc_context_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆ†é…ç©ºé—´</span>
        <span class="token comment">/* initialize our state here */</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        dev<span class="token operator">-&gt;</span>device<span class="token punctuation">.</span>alloc <span class="token operator">=</span> gralloc_alloc<span class="token punctuation">;</span> <span class="token comment">// ä»æä¾›çš„æ¥å£æ¥çœ‹ï¼Œgralloc ä¸»è¦è´Ÿè´£ â€œåˆ†é…å’Œé‡Šæ”¾â€ æ“ä½œ</span>
        dev<span class="token operator">-&gt;</span>device<span class="token punctuation">.</span>free <span class="token operator">=</span> gralloc_free<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ä¸Šè¿°ä»£ç æ®µä¸­ä¸ <code>fb</code> ç›¸ä¼¼çš„éƒ¨åˆ†æˆ‘ä»¬å°±ä¸å¤šåšä»‹ç»äº†ã€‚</p></blockquote><p>å› ä¸º <code>gralloc</code> æ‹…è´Ÿç€å›¾å½¢ç¼“å†²åŒºçš„åˆ†é…ä¸é‡Šæ”¾ï¼Œæ‰€ä»¥å®ƒæä¾›çš„ä¸¤ä¸ªæœ€é‡è¦çš„æ¥å£æ˜¯ <code>alloc</code> å’Œ <code>free</code>ã€‚è¿™é‡Œæš‚æ—¶å…ˆä¸æ·±å…¥åˆ†æï¼Œåç»­ä¼šæœ‰è®²è§£ã€‚</p><h2 id="_4-android-ä¸­çš„æœ¬åœ°çª—å£" tabindex="-1"><a class="header-anchor" href="#_4-android-ä¸­çš„æœ¬åœ°çª—å£" aria-hidden="true">#</a> 4 <code>Android</code> ä¸­çš„æœ¬åœ°çª—å£</h2><p>åœ¨ <a href="#_9-1-opengl-es-%E4%B8%8E-egl"><code>OpenGL ES</code> ä¸ <code>EGL</code></a> å°èŠ‚ä¸­æåˆ°äº† â€œæœ¬åœ°çª—å£â€ï¼ˆ<code>Native Window</code>ï¼‰è¿™ä¸€æ¦‚å¿µã€‚</p><p>æœ¬åœ°çª—å£æ˜¯ <code>OpenGL</code> èƒ½å¦å…¼å®¹å¤šç§ç³»ç»Ÿï¼ˆå¦‚ <code>Windows</code>ï¼Œ<code>Android</code>ï¼‰çš„å…³é”®ã€‚</p><p>é‚£ä¹ˆå¯¹äº <code>Android</code> ç³»ç»Ÿæ¥è¯´ï¼Œå®ƒæ˜¯å¦‚ä½•å°† <code>OpenGL ES</code> æœ¬åœ°åŒ–çš„å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œå®ƒæä¾›äº†ä»€ä¹ˆæ ·çš„æœ¬åœ°çª—å£ï¼Ÿ</p><p>æ ¹æ®æ•´ä¸ª <code>Android</code> ç³»ç»Ÿçš„ <code>GUI</code> è®¾è®¡ç†å¿µï¼Œæˆ‘ä»¬ä¸éš¾çŒœæƒ³åˆ°è‡³å°‘éœ€è¦ä¸¤ç§æœ¬åœ°çª—å£ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>é¢å‘ç®¡ç†è€…ï¼ˆSurfaceFlingerï¼‰
	æ—¢ç„¶ SurfaceFlinger æ‰®æ¼”äº†ç³»ç»Ÿä¸­æ‰€æœ‰ UI ç•Œé¢çš„ç®¡ç†è€…ï¼Œé‚£ä¹ˆå®ƒæ— å¯åšééœ€è¦ç›´æ¥æˆ–é—´æ¥åœ°æŒæœ‰ â€œæœ¬åœ°çª—å£â€ã€‚
	æˆ‘ä»¬çŸ¥é“ï¼Œè¿™ä¸ªçª—å£å°±æ˜¯ FramebufferNativeWindowã€‚

é¢å‘åº”ç”¨ç¨‹åº
	è¿™ç±»æœ¬åœ°çª—å£æ˜¯ Surfaceã€‚
</code></pre></div><p>ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ç§æœ¬åœ°çª—å£å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>å› ä¸ºä¸€ä¸ªç³»ç»Ÿè®¾å¤‡ä¸­æ˜¾ç„¶åªä¼šæœ‰ä¸€ä¸ªå¸§ç¼“å†²åŒº framebufferï¼Œä½†ä¸€ä¸ªç³»ç»Ÿè®¾å¤‡ä¸­å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ª UI ç¨‹åºã€‚

ä¸ºäº†èƒ½å¤Ÿè®©å¤šä¸ª UI ç¨‹åºæœ‰åºåœ°è¿›è¡Œæ˜¾ç¤ºï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ª UI ç¨‹åºå•ç‹¬åœ°åˆ†é…æœ¬åœ°çª—å£ï¼Œ
ä¸º UI ç¨‹åºå•ç‹¬åˆ†é…æœ¬åœ°çª—å£å…¶å®å°±æ˜¯å•ç‹¬åˆ†é…ä¸€ä¸ªå†…å­˜ç¼“å­˜åŒºæ¥ä¿å­˜æ˜¾ç¤ºæ•°æ®ã€‚

è€Œ SurfaceFlinger æ‰€æŒæœ‰çš„æœ¬åœ°çª—å£å°±æ˜¯èƒ½ç›´æ¥æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å¸§ç¼“å†²åŒº framebufferã€‚
SurfaceFlinger ä½œä¸ºç®¡ç†è€…ï¼Œä¼šæ”¶é›†æ‰€æœ‰ UI ç¨‹åºçš„å†…å­˜ç¼“å†²åŒºä¸­çš„æ˜¾ç¤ºæ•°æ®ï¼Œ
å¹¶è¿›è¡Œç»Ÿä¸€çš„å›¾åƒæ··åˆæ“ä½œï¼Œç„¶åè¾“å‡ºåˆ°å¸§ç¼“å†²åŒº framebuffer ä¸­ã€‚
</code></pre></div><h3 id="_4-1-framebuffernativewindow" tabindex="-1"><a class="header-anchor" href="#_4-1-framebuffernativewindow" aria-hidden="true">#</a> 4.1 <code>FramebufferNativeWindow</code></h3><p>EGL éœ€è¦é€šè¿‡æœ¬åœ°çª—å£æ¥ä¸º<code> OpenGL/OpenGL ES</code> åˆ›é€ ç¯å¢ƒã€‚å…¶å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>EGLSurface <span class="token function">eglCreateWindowSurface</span><span class="token punctuation">(</span>EGLDisplay dpy<span class="token punctuation">,</span> EGLConfig config<span class="token punctuation">,</span> NativeWindowType window<span class="token punctuation">,</span> <span class="token keyword">const</span> EGLint <span class="token operator">*</span>attrib_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä»å‡½æ•°åŸå‹æ¥çœ‹ï¼Œä¸è®ºæ˜¯å“ªä¸€ç±»æœ¬åœ°çª—å£ï¼Œéƒ½å¿…é¡»è¦ä¸ NativeWindowType ä¿æŒä¸€è‡´ï¼Œå¦åˆ™å°±æ— æ³•æ­£å¸¸ä½¿ç”¨ EGL äº†ã€‚</p><p>å…ˆä»æ•°æ®ç±»å‹çš„å®šä¹‰æ¥çœ‹çœ‹è¿™ä¸ª window å‚æ•°æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*frameworks/native/opengl/include/egl/Eglplatform.h*/</span>
<span class="token keyword">typedef</span> EGLNativeWindowType NativeWindowType<span class="token punctuation">;</span> <span class="token comment">// NativeWindowType å…¶å®å°±æ˜¯ EGLNativeWindowType</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_WIN32<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__VC32__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>__CYGWIN__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>__SCITECH_SNAP__<span class="token punctuation">)</span></span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">typedef</span> HWND  EGLNativeWindowType<span class="token punctuation">;</span> <span class="token comment">/* Win32 å’Œ WinCEç³»ç»Ÿä¸‹çš„å®šä¹‰ */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__WINSCW__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__SYMBIAN32__<span class="token punctuation">)</span>  </span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>EGLNativeWindowType<span class="token punctuation">;</span> <span class="token comment">/* Symbianç³»ç»Ÿ */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__ANDROID__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>ANDROID<span class="token punctuation">)</span></span></span>
<span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token operator">*</span> EGLNativeWindowType<span class="token punctuation">;</span> <span class="token comment">/* Androidç³»ç»Ÿ */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__unix__<span class="token punctuation">)</span></span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">typedef</span> Window   EGLNativeWindowType<span class="token punctuation">;</span> <span class="token comment">/* UNIXç³»ç»Ÿ */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token string">&quot;Platform not recognized&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre></div><p>ä»¥ä¸Šä»£ç ä¸­ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿå¹³å°ä¸‹ <code>EGLNativeWindowType</code> æ‰€å¯¹åº”çš„å…·ä½“æ•°æ®ç±»å‹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th style="text-align:left;"><strong>æ“ä½œç³»ç»Ÿ</strong></th><th style="text-align:left;"><strong>æ•°æ®ç±»å‹</strong></th></tr></thead><tbody><tr><td style="text-align:left;">Win32ã€WinCE</td><td style="text-align:left;">HWNDï¼Œå³å¥æŸ„</td></tr><tr><td style="text-align:left;">Symbian</td><td style="text-align:left;">Void*</td></tr><tr><td style="text-align:left;">Android`</td><td style="text-align:left;">ANativeWindow*</td></tr><tr><td style="text-align:left;">UNIX</td><td style="text-align:left;">Window</td></tr><tr><td style="text-align:left;">å…¶ä»–</td><td style="text-align:left;">æš‚æ—¶ä¸æ”¯æŒ</td></tr></tbody></table><p><code>ANativeWindow</code> çš„å®šä¹‰åœ¨ <code>window.h</code> å¤´æ–‡ä»¶ä¸­ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*system/core/include/system/window.h*/</span>
<span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">;</span> <span class="token comment">// ä¸ Surface æˆ– updater æœ‰å…³çš„å±æ€§</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> minSwapInterval<span class="token punctuation">;</span> <span class="token comment">// æ‰€æ”¯æŒçš„æœ€å°äº¤æ¢é—´éš”æ—¶é—´</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> maxSwapInterval<span class="token punctuation">;</span> <span class="token comment">// æ‰€æ”¯æŒçš„æœ€å¤§äº¤æ¢é—´éš”æ—¶é—´</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span> xdpi<span class="token punctuation">;</span> <span class="token comment">// æ°´å¹³æ–¹å‘çš„å¯†åº¦ï¼Œä»¥ dpi ä¸ºå•ä½</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span> ydpi<span class="token punctuation">;</span> <span class="token comment">// å‚ç›´æ–¹å‘çš„å¯†åº¦ï¼Œä»¥ dpi ä¸ºå•ä½</span>
    intptr_t oem<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//ä¸ºOEMå®šåˆ¶é©±åŠ¨æ‰€ä¿ç•™çš„ç©ºé—´</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setSwapInterval<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>dequeueBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">ANativeWindowBuffer</span><span class="token operator">*</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>queueBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">ANativeWindowBuffer</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>cancelBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">ANativeWindowBuffer</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>query<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token operator">*</span> window<span class="token punctuation">,</span><span class="token keyword">int</span> what<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>perform<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token operator">*</span> window<span class="token punctuation">,</span><span class="token keyword">int</span> operation<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> reserved_proc<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>ANativeWindow</code> ç»“æ„ä½“ä¸­å‡ ä¸ªé‡è¦æˆå‘˜å‡½æ•°å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><tr align="left"><th>Member Function</th><th>Description</th></tr><tr><td>setSwapInterval</td><td>è®¾ç½®äº¤æ¢é—´éš”æ—¶é—´</td></tr><tr><td>dequeueBuffer</td><td>EGL é€šè¿‡è¿™ä¸ªæ¥å£æ¥ç”³è¯·ä¸€ä¸ª bufferã€‚ä»å‰é¢æˆ‘ä»¬æ‰€ä¸¾çš„ä¾‹å­æ¥è¯´ï¼Œä¸¤ä¸ªæœ¬åœ°çª—å£æ‰€æä¾›çš„ buffer åˆ†åˆ«æ¥è‡ªäºå¸§ç¼“å†²åŒºå’Œå†…å­˜ç©ºé—´ã€‚<br> å•è¯ dequeue çš„å­—é¢æ„æ€æ˜¯å‡ºé˜Ÿåˆ—ã€‚è¿™ä»ä¾§é¢å‘Šè¯‰æˆ‘ä»¬ï¼Œä¸€ä¸ª Window æ‰€åŒ…å«çš„ buffer å¾ˆå¯èƒ½ä¸æ­¢ä¸€ä»½</td></tr><tr><td>queueBuffer</td><td>å½“ EGL å¯¹ä¸€å— buffer æ¸²æŸ“å®Œæˆåï¼Œå®ƒè°ƒç”¨è¿™ä¸ªæ¥å£æ¥ unlock å’Œ post buffer</td></tr><tr><td>cancelBuffer</td><td>è¿™ä¸ªæ¥å£å¯ä»¥ç”¨æ¥å–æ¶ˆä¸€ä¸ªå·²ç» dequeued çš„ bufferï¼Œä½†è¦ç‰¹åˆ«æ³¨æ„åŒæ­¥çš„é—®é¢˜</td></tr><tr><td>query</td><td>ç”¨äºå‘æœ¬åœ°çª—å£å’¨è¯¢ç›¸å…³ä¿¡æ¯</td></tr><tr><td>perform</td><td> ç”¨äºæ‰§è¡Œæœ¬åœ°çª—å£æ”¯æŒçš„å„ç§æ“ä½œï¼Œæ¯”å¦‚: <ul><li>NATIVE_WINDOW_SET_USAGE</li><li>NATIVE_WINDOW_SET_CROP</li><li>NATIVE_WINDOW_SET_BUFFER_COUNT</li><li>NATIVE_WINDOW_SET_BUFFERS_TRANSFORM</li><li>NATIVE_WINDOW_SET_BUFFERS_TIMESTAMP ç­‰</li></ul></td></tr></table><p>ä»ä¸Šé¢å¯¹ <code>ANativeWindow</code> çš„æè¿°å¯ä»¥çœ‹å‡ºï¼Œå®ƒæ›´åƒä¸€ä»½ â€œåè®®â€ï¼Œè§„å®šäº†ä¸€ä¸ªæœ¬åœ°çª—å£çš„å½¢æ€å’ŒåŠŸèƒ½ã€‚è¿™å¯¹äºæ”¯æŒå¤šç§æœ¬åœ°çª—å£çš„ç³»ç»Ÿæ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºåªæœ‰è¿™æ ·æˆ‘ä»¬æ‰èƒ½é’ˆå¯¹æŸç§ç‰¹å®šçš„å¹³å°çª—å£æ¥å¡«å……å…·ä½“çš„å®ç°ã€‚</p><p>è¿™ä¸ªå°èŠ‚ä¸­æˆ‘ä»¬éœ€è¦åˆ†æ <code>FramebufferNativeWindow</code> æ˜¯å¦‚ä½•å±¥è¡Œè¿™ä»½ â€œåè®®â€ çš„ã€‚</p><p><code>FramebufferNativeWindow</code> æœ¬èº«ä»£ç å¹¶ä¸å¤šï¼Œä¸‹é¢åˆ†åˆ«é€‰å–å…¶æ„é€ å‡½æ•°åŠ <code>dequeue</code> å‡½æ•°æ¥åˆ†æã€‚å…¶ä»–éƒ¨åˆ†çš„å®ç°éƒ½ç±»ä¼¼ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒé˜…è¯»ã€‚</p><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ï¼Œ<code>FramebufferNativeWindow</code> å·²è¢«ç§»é™¤ï¼Œå®ç°äº† ANativeWindow æ¥å£çš„å­ç±»åªå‘ç°å¦‚ä¸‹ä¸¤ä¸ªï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>frameworks<span class="token operator">/</span>native<span class="token operator">/</span>services<span class="token operator">/</span>surfaceflinger<span class="token operator">/</span>CompositionEngine<span class="token operator">/</span>include<span class="token operator">/</span>compositionengine<span class="token operator">/</span>mock<span class="token operator">/</span>NativeWindow<span class="token punctuation">.</span>h
frameworks<span class="token operator">/</span>native<span class="token operator">/</span>libs<span class="token operator">/</span>gui<span class="token operator">/</span>include<span class="token operator">/</span>gui<span class="token operator">/</span>Surface<span class="token punctuation">.</span>h
</code></pre></div><p>é«˜ç‰ˆæœ¬çš„å·®å¼‚å†åç»­æ›´æ–°æ–‡æ¡£æ—¶å†è¡¥å……ã€‚</p></blockquote><h4 id="_4-1-1-æ„é€ å‡½æ•°ä¸­çš„åˆå§‹åŒ–æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#_4-1-1-æ„é€ å‡½æ•°ä¸­çš„åˆå§‹åŒ–æ“ä½œ" aria-hidden="true">#</a> 4.1.1 æ„é€ å‡½æ•°ä¸­çš„åˆå§‹åŒ–æ“ä½œ</h4><p>æ ¹æ® FramebufferNativeWindow æ‰€å®Œæˆçš„åŠŸèƒ½ï¼Œå¯ä»¥å¤§æ¦‚æ¨æµ‹å‡ºå®ƒçš„æ„é€ å‡½æ•°é‡Œåº”è¯¥è‡³å°‘å®Œæˆå¦‚ä¸‹åˆå§‹åŒ–æ“ä½œã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>1. åŠ è½½ GRALLOC_HARDWARE_MODULE_ID æ¨¡å—ï¼ˆå³ Gralloc æ¨¡å—ï¼‰ï¼Œè¯¦ç»†æµç¨‹åœ¨ Gralloc å°èŠ‚å·²ç»è§£é‡Šè¿‡äº†ã€‚
2. åˆ†åˆ«æ‰“å¼€ fb å’Œ gralloc è®¾å¤‡ã€‚æˆ‘ä»¬åœ¨ Gralloc å°èŠ‚ä¹Ÿå·²ç»åˆ†æè¿‡ï¼Œæ‰“å¼€åçš„è®¾å¤‡ç”±å…¨å±€å˜é‡ fbDev å’Œ grDev ç®¡ç†ã€‚
3. æ ¹æ®è®¾å¤‡çš„å±æ€§æ¥ç»™ FramebufferNativeWindow èµ‹åˆå€¼ã€‚
4. æ ¹æ® FramebufferNativeWindow çš„å®ç°æ¥å¡«å…… ANativeWindow ä¸­çš„ â€œåè®®â€ã€‚
5. å…¶ä»–ä¸€äº›å¿…è¦çš„åˆå§‹åŒ–ã€‚
</code></pre></div><p>ä¸‹é¢ä»æºç çš„è§’åº¦æ¥åˆ†æä¸Šè¿°æ¯ä¸ªæ­¥éª¤å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/ui/FramebufferNativeWindow.cpp */</span>
<span class="token class-name">FramebufferNativeWindow</span><span class="token double-colon punctuation">::</span><span class="token function">FramebufferNativeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">BASE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fbDev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">grDev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mUpdateOnDemand</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    hw_module_t <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hw_get_module</span><span class="token punctuation">(</span>GRALLOC_HARDWARE_MODULE_ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">module</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// åŠ è½½æ¨¡å—</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">int</span> stride<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        err <span class="token operator">=</span> <span class="token function">framebuffer_open</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fbDev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        err <span class="token operator">=</span> <span class="token function">gralloc_open</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>grDev<span class="token punctuation">)</span> <span class="token punctuation">;</span><span class="token comment">// åˆ†åˆ«æ‰“å¼€ fb å’Œ gralloc</span>
        <span class="token comment">/*ä¸Šé¢è¿™éƒ¨åˆ†å†…å®¹æˆ‘ä»¬åœ¨å‰å‡ ä¸ªå°èŠ‚å·²ç»åˆ†æè¿‡äº†ï¼Œä¸æ¸…æ¥šçš„å¯ä»¥å›å¤´çœ‹ä¸€ä¸‹*/</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fbDev<span class="token operator">-&gt;</span>numFramebuffers <span class="token operator">&gt;=</span> MIN_NUM_FRAME_BUFFERS <span class="token operator">&amp;&amp;</span>
            fbDev<span class="token operator">-&gt;</span>numFramebuffers <span class="token operator">&lt;=</span> MAX_NUM_FRAME_BUFFERS<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// æ ¹æ®fbè®¾å¤‡å±æ€§è·å¾—bufferæ•°</span>
            mNumBuffers <span class="token operator">=</span> fbDev<span class="token operator">-&gt;</span>numFramebuffers<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mNumBuffers <span class="token operator">=</span> MIN_NUM_FRAME_BUFFERS<span class="token punctuation">;</span> <span class="token comment">// å¦åˆ™å°±é‡‡ç”¨æœ€å°‘çš„ buffer æ•°å€¼ï¼Œå³ 2</span>
        <span class="token punctuation">}</span>
        mNumFreeBuffers <span class="token operator">=</span> mNumBuffers<span class="token punctuation">;</span> <span class="token comment">// å¯ç”¨çš„ buffer ä¸ªæ•°ï¼Œåˆå§‹æ—¶æ˜¯æ‰€æœ‰ buffer å¯ç”¨</span>
        mBufferHead <span class="token operator">=</span> mNumBuffers<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mNumBuffers<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">// ç»™æ¯ä¸ª buffer åˆå§‹åŒ–</span>
        <span class="token punctuation">{</span>
            buffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">NativeBuffer</span><span class="token punctuation">(</span>fbDev<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> fbDev<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> fbDev<span class="token operator">-&gt;</span>format<span class="token punctuation">,</span> GRALLOC_USAGE _HW_FB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token operator">/</span> <span class="token operator">/</span>NativeBufferæ˜¯ä»€ä¹ˆï¼Ÿ

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mNumBuffers<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">// ç»™æ¯ä¸ª buffer åˆ†é…ç©ºé—´</span>
        <span class="token punctuation">{</span>
            err <span class="token operator">=</span> grDev<span class="token operator">-&gt;</span><span class="token function">alloc</span><span class="token punctuation">(</span>grDev<span class="token punctuation">,</span> fbDev<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> fbDev<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> fbDev<span class="token operator">-&gt;</span>format<span class="token punctuation">,</span> GRALLOC_USAGE_HW_FB<span class="token punctuation">,</span> 
								<span class="token operator">&amp;</span>buffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* ä¸ºæœ¬åœ°çª—å£èµ‹å±æ€§å€¼ */</span>
        <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ANativeWindow<span class="token double-colon punctuation">::</span>flags<span class="token punctuation">)</span> <span class="token operator">=</span> fbDev<span class="token operator">-&gt;</span>flags<span class="token punctuation">;</span>
        <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ANativeWindow<span class="token double-colon punctuation">::</span>xdpi<span class="token punctuation">)</span> <span class="token operator">=</span> fbDev<span class="token operator">-&gt;</span>xdpi<span class="token punctuation">;</span>
        <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ANativeWindow<span class="token double-colon punctuation">::</span>ydpi<span class="token punctuation">)</span> <span class="token operator">=</span> fbDev<span class="token operator">-&gt;</span>ydpi<span class="token punctuation">;</span>
        <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ANativeWindow<span class="token double-colon punctuation">::</span>minSwapInterval<span class="token punctuation">)</span> <span class="token operator">=</span>fbDev<span class="token operator">-&gt;</span>minSwapInterval<span class="token punctuation">;</span>
        <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ANativeWindow<span class="token double-colon punctuation">::</span>maxSwapInterval<span class="token punctuation">)</span> <span class="token operator">=</span> fbDev<span class="token operator">-&gt;</span>maxSwapInterval<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn&#39;t get gralloc module&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* ä»¥ä¸‹ä»£ç æ®µå¼€å§‹å±¥è¡Œçª—å£ â€œåè®®â€ */</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>setSwapInterval <span class="token operator">=</span> setSwapInterval<span class="token punctuation">;</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>dequeueBuffer <span class="token operator">=</span> dequeueBuffer<span class="token punctuation">;</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>queueBuffer <span class="token operator">=</span> queueBuffer<span class="token punctuation">;</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>query <span class="token operator">=</span> query<span class="token punctuation">;</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>perform <span class="token operator">=</span> perform<span class="token punctuation">;</span>

    <span class="token comment">/* ä¸‹é¢è¿™å‡ ä¸ªæ¥å£å·²ç»è¢«åºŸå¼ƒäº†ï¼Œä¸è¿‡ä¸ºäº†ä¿æŒå…¼å®¹æ€§ï¼Œæš‚æ—¶è¿˜æ˜¯ä¿ç•™çš„ */</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>dequeueBuffer_DEPRECATED <span class="token operator">=</span> dequeueBuffer_DEPRECATED<span class="token punctuation">;</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>lockBuffer_DEPRECATED <span class="token operator">=</span> lockBuffer_DEPRECATED<span class="token punctuation">;</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>queueBuffer_DEPRECATED <span class="token operator">=</span> queueBuffer_DEPRECATED<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚ä¸Šåˆå§‹åŒ–ä»£ç ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ <code>FramebufferNativeWindow</code> æ˜¯å¦‚ä½•åˆ†é… <code>buffer</code> çš„ã€‚æ¢å¥è¯è¯´ï¼Œå…¶ <code>dequeue</code> æ–¹æ³•æ‰€è·å¾—çš„ç¼“å†²åŒºæ˜¯ä»ä½•è€Œæ¥çš„ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>æˆå‘˜å˜é‡ mNumBuffers ä»£è¡¨äº† FramebufferNativeWindow æ‰€ç®¡ç†çš„ buffer æ€»æ•°ã€‚å®ƒå–å†³äºä¸¤ä¸ªæ–¹é¢ï¼š
1. é¦–å…ˆä» fb è®¾å¤‡ä¸­å–å€¼ï¼Œå³ numFramebuffersï¼›
2. å¦åˆ™å°±é»˜è®¤å®šä¹‰ä¸º MIN_NUM_FRAME_BUFFERSã€‚

å¦‚ä¸‹æ‰€ç¤ºï¼š
    #define MIN_NUM_FRAME_BUFFERS 2 
    #define MAX_NUM_FRAME_BUFFERS 3

å¯è§ Android ç³»ç»Ÿè®¤ä¸ºæœ€å°‘çš„ buffer æ•°ä¸º 2ï¼Œæœ€å¤§ä¸º 3ã€‚
</code></pre></div><p>æœ‰äººå¯èƒ½ä¼šè§‰å¾—å¥‡æ€ªï¼Œæ—¢ç„¶ <code>FramebufferNativeWindow</code> å¯¹åº”çš„æ˜¯çœŸå®çš„ç‰©ç†å±å¹•ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜éœ€è¦ä¸¤ä¸ª <code>buffer</code> å‘¢ï¼Ÿ</p><p>è€ƒè™‘åªæœ‰ä¸€ä¸ª <code>buffer</code> çš„æƒ…å†µï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>è¿™æ„å‘³ç€ç»˜åˆ¶ä»€ä¹ˆï¼Œå±å¹•ä¸Šå°±è¦æ˜¾ç¤ºä»€ä¹ˆã€‚
å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œå°†çœ‹åˆ°ä¸€ä¸ªä¸æ–­åˆ·æ–°çš„ç”»é¢ã€‚é€šä¿—åœ°è®²ï¼Œå°±æ˜¯ç”»é¢å¾ˆ â€œå¡â€ã€‚
ç‰¹åˆ«æ˜¯å¯¹äºå›¾åƒåˆ·æ–°å¾ˆé¢‘ç¹çš„åœºæ™¯ï¼ˆæ¯”å¦‚å¤§å‹æ¸¸æˆï¼‰ï¼Œç”¨æˆ·çš„ä½“éªŒå°±ä¼šæ›´å·®ã€‚
</code></pre></div><p>é‚£ä¹ˆï¼Œæœ‰ä»€ä¹ˆè§£å†³çš„åŠæ³•å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>æˆ‘ä»¬çŸ¥é“ï¼Œå‡ºç°è¿™ç§ç°è±¡çš„åŸå› å°±æ˜¯ç¨‹åºç›´æ¥ä»¥å±å¹•ä¸ºç»˜å›¾æ¿ï¼ŒæŠŠè¿˜æ²¡æœ‰å‡†å¤‡å°±ç»ªçš„å›¾åƒç›´æ¥å‘ˆç°ç»™äº†ç”¨æˆ·ã€‚æ¢å¥è¯è¯´ï¼Œ
å¦‚æœå¯ä»¥ç­‰åˆ°æ•´å¹…å›¾åƒç»˜åˆ¶å®Œæˆä»¥åå†åˆ·æ–°åˆ°å±å¹•ä¸Šï¼Œé‚£ä¹ˆç”¨æˆ·åœ¨ä»»ä½•æ—¶å€™çœ‹åˆ°çš„éƒ½æ˜¯æ­£ç¡®è€Œå®Œæ•´çš„ç”»é¢ï¼Œé—®é¢˜ä¹Ÿå°±è§£å†³äº†ã€‚
</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª <code>buffer</code> ç”¨æ¥ä¿å­˜ç»˜åˆ¶æ•°æ®ï¼Œä¸€ä¸ª <code>buffer</code> ç”¨æ¥å°†ä¿å­˜çš„ç»˜åˆ¶æ•°æ®åˆ·æ–°åˆ°å±å¹•ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/03.431d864f.png" alt="" loading="lazy"></p><blockquote><p>ä¸Šå›¾è¡¨ç¤ºçš„å°±æ˜¯é€šå¸¸æ‰€ç§°çš„ â€œåŒç¼“å†²â€ï¼ˆ<code>Double-Buffering</code>ï¼‰æŠ€æœ¯ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œå…¶å®è¿˜æœ‰ä¸‰ç¼“å†²ï¼ˆ<code>Triple Buffering</code>ï¼‰ã€å››ç¼“å†²ï¼ˆ<code>Quad Buffering</code>ï¼‰ç­‰ï¼Œ æˆ‘ä»¬å°†å®ƒä»¬ç»Ÿç§°ä¸º â€œå¤šç¼“å†²â€ï¼ˆ<code>Multiple Buffering</code>ï¼‰æœºåˆ¶ã€‚</p></blockquote><p>ç†è§£äº†ä¸ºä»€ä¹ˆéœ€è¦åŒç¼“å†²ä»¥åï¼Œæˆ‘ä»¬å†å›è¿‡å¤´æ¥çœ‹ <code>FramebufferNativeWindow</code> çš„æ„é€ å‡½æ•°ã€‚</p><p>æ¥ä¸‹æ¥è¦è§£å†³çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¤šä¸ªç¼“å†²åŒºç©ºé—´æ˜¯ä»å“ªé‡Œåˆ†é…çš„ï¼Ÿ</p><p>é€šè¿‡å‰å‡ ä¸ªå°èŠ‚çš„çŸ¥è¯†å¯çŸ¥ï¼Œåº”è¯¥æ˜¯è¦å‘ <code>HAL</code> å±‚çš„ <code>Gralloc</code> ç”³è¯·ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>FramebufferNativeWindow æ„é€ å‡½æ•°ä¸­çš„ç¬¬ä¸€ä¸ª for å¾ªç¯é‡Œå…ˆç»™å„ buffer åˆ›å»ºç›¸åº”çš„å®ä¾‹ï¼ˆnew NativeBufferï¼‰ï¼Œ
å…¶ä¸­çš„å±æ€§å€¼éƒ½æ¥æºäº fbDevï¼Œå¦‚å®½ã€é«˜ã€æ ¼å¼ç­‰ã€‚

ç´§éšå…¶åçš„å°±æ˜¯è°ƒç”¨ Gralloc è®¾å¤‡çš„ alloc() æ–¹æ³•ï¼š

	/*
	å‡½æ•°åŸå‹ï¼š
	int (*alloc)(struct alloc_device_t* dev, int w, int h, int format, int usage, buffer_handle_t* handle, int* stride);
	*/
	err = grDev-&gt;alloc(grDev, fbDev-&gt;width, fbDev-&gt;height, fbDev-&gt;format, GRALLOC_USAGE_HW_FB, 
						&amp;buffers[i]-&gt;handle, &amp;buffers[i]-&gt;stride);

æ³¨æ„ç¬¬ 5 ä¸ªå‚æ•°ï¼Œå®ƒä»£è¡¨æ‰€è¦ç”³è¯·çš„ç¼“å†²åŒºçš„ç”¨é€”ï¼Œ
å®šä¹‰åœ¨ hardware/libhardware/include/hardware/gralloc.h ä¸­ï¼Œç›®å‰å·²ç»æ”¯æŒå‡ åç§ã€‚æ¯”å¦‚ï¼š

	GRALLOC_USAGE_HW_TEXTURE       // ç¼“å†²åŒºå°†ç”¨äºOpenGL ES Textureã€‚
	GRALLOC_USAGE_HW_RENDER        // ç¼“å†²åŒºå°†ç”¨äºOpenGL ESçš„æ¸²æŸ“ã€‚
	GRALLOC_USAGE_HW_2D            // ç¼“å†²åŒºä¼šæä¾›ç»™2D ç¡¬ä»¶å›¾å½¢è®¾å¤‡ã€‚
	GRALLOC_USAGE_HW_COMPOSER      // ç¼“å†²åŒºç”¨äºHWComposer HALæ¨¡å—ã€‚
	GRALLOC_USAGE_HW_FB            // ç¼“å†²åŒºç”¨äºframebufferè®¾å¤‡ã€‚
	GRALLOC_USAGE_HW_VIDEO_ENCODER // ç¼“å†²åŒºç”¨äºç¡¬ä»¶è§†é¢‘ç¼–ç å™¨ã€‚

è¿™é‡Œç”³è¯·çš„ç¼“å†²åŒºæ˜¯è¦åœ¨ç»ˆç«¯å±å¹•ä¸Šæ˜¾ç¤ºçš„ï¼Œæ‰€ä»¥ç”³è¯·çš„ usage ç±» å‹æ˜¯ GRALLOC_USAGE_HW_FBï¼Œ
å¯¹åº”çš„ Gralloc ä¸­çš„å®ç°æ˜¯ gralloc_alloc_framebuffer@gralloc.cppï¼›

å‡å¦‚æ˜¯å…¶ä»–ç”¨é€”çš„ç¼“å†²åŒºç”³è¯·ï¼Œåˆ™å¯¹åº” gralloc_alloc_buffer@gralloc.cppã€‚
ä¸è¿‡ï¼Œå¦‚æœåº•å±‚åªå…è®¸ä¸€ä¸ª bufferï¼ˆä¸æ”¯æŒ page-flipping çš„æƒ…å†µï¼‰ï¼Œ
é‚£ä¹ˆ gralloc_alloc_framebuffer ä¹ŸåŒæ ·å¯èƒ½åªè¿”å›ä¸€ä¸ª ashmem ä¸­ç”³è¯·çš„ â€œå†…å­˜ç©ºé—´â€ï¼ŒçœŸæ­£çš„ â€œå¸§ç¼“å†²åŒºâ€ åˆ™è¦åœ¨ post æ—¶æ‰ä¼šè¢«ç”¨åˆ°ã€‚
</code></pre></div><p>æ‰€æœ‰ç”³è¯·åˆ°çš„ç¼“å†²åŒºéƒ½éœ€è¦ç”± <code>FramebufferNativeWindow</code> ä¸­çš„å…¨å±€å˜é‡ <code>buffers[MAX_NUM_FRAME_BUFFERS]</code> æ¥è®°å½•ï¼Œ</p><p>æ¯ä¸ªæ•°æ®å…ƒç´ æ˜¯ä¸€ä¸ª <code>NativeBuffer</code>ã€‚è¿™ä¸ªç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">NativeBuffer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">ANativeObjectBase</span><span class="token operator">&lt;</span><span class="token class-name">ANativeWindowBuffer</span><span class="token punctuation">,</span> <span class="token class-name">NativeBuffer</span><span class="token punctuation">,</span> <span class="token class-name">LightRefBase</span><span class="token operator">&lt;</span><span class="token class-name">NativeBuffer</span><span class="token operator">&gt;&gt;</span></span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>å¯è§è¿™ä¸ª â€œæœ¬åœ°ç¼“å†²åŒºâ€ ç»§æ‰¿äº† <code>ANativeWindowBuffer</code> çš„ç‰¹æ€§ï¼Œåè€…çš„å®šä¹‰åœ¨ <code>/system/core/include/system/window.h</code> ä¸­ï¼š</p><blockquote><p>é«˜ç‰ˆæœ¬ç³»ç»Ÿå®šä¹‰åœ¨äº† <code>frameworks/native/libs/nativebase/include/nativebase/nativebase.h</code> ä¸­ã€‚</p></blockquote><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ANativeWindowBuffer</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">int</span> width<span class="token punctuation">;</span> <span class="token comment">// å®½</span>
    <span class="token keyword">int</span> height<span class="token punctuation">;</span> <span class="token operator">/</span> <span class="token operator">/</span>é«˜
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    buffer_handle_t handle<span class="token punctuation">;</span> <span class="token comment">/* ä»£è¡¨å†…å­˜å—çš„å¥æŸ„ï¼Œæ¯”å¦‚ ashmem æœºåˆ¶ */</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> ANativeWindowBuffer_t<span class="token punctuation">;</span>
</code></pre></div><p>å¦å¤–ï¼Œå½“å‰å¯ç”¨ï¼ˆ<code>free</code>ï¼‰çš„ <code>buffer</code> æ•°é‡ç”± <code>mNumFreeBuffers</code> ç®¡ç†ï¼Œè¿™ä¸ªå˜é‡çš„åˆå§‹å€¼ä¹Ÿæ˜¯ <code>mNumBuffers</code>ï¼Œå³æ€»å…±æœ‰ <code>2</code> æˆ– <code>3</code> ä¸ªå¯ç”¨ç¼“å†²åŒºã€‚</p><p>åœ¨ç¨‹åºåç»­çš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå§‹ç»ˆç”± <code>mBufferHead</code> æ¥æŒ‡å‘ä¸‹ä¸€ä¸ªå°†è¢«ç”³è¯·çš„ <code>buffer</code>ï¼ˆæ³¨æ„ï¼šä¸æ˜¯ä¸‹ä¸€ä¸ªå¯ç”¨ <code>buffer</code>ï¼‰ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯å½“ç”¨æˆ·å‘ FramebufferNativeWindow ç”³è¯·ä¸€ä¸ª buffer æ—¶ï¼ˆdequeueBufferï¼‰ï¼Œè¿™ä¸ª mBufferHead å°±ä¼šå¢åŠ  1ï¼›
ä¸€æ—¦å®ƒçš„å€¼è¶…è¿‡æœ€å¤§å€¼ï¼Œåˆ™è¿˜ä¼šå˜æˆ 0ï¼Œå¦‚æ­¤å°±å®ç°äº†å¾ªç¯ç®¡ç†ã€‚åé¢åœ¨è®²è§£ dequeueBuffer æ—¶å†è¯¦ç»†è§£é‡Šã€‚
</code></pre></div><p>ä¸€ä¸ªæœ¬åœ°çª—å£åŒ…å«äº†å¾ˆå¤šå±æ€§å€¼ï¼Œå¦‚å„ç§æ ‡å¿—ï¼ˆ<code>flags</code>ï¼‰ã€æ¨ªçºµåæ ‡çš„å¯†åº¦å€¼ç­‰ã€‚è¿™äº›æ•°å€¼éƒ½å¯ä»¥ä» <code>fb</code> è®¾å¤‡ä¸­æŸ¥è¯¢åˆ°ï¼Œ<code>æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬èµ‹äºˆåˆšç”Ÿæˆçš„FramebufferNativeWindow</code> å®ä¾‹çš„å±æ€§ã€‚</p><p>æœ€åï¼Œå°±åº”è¯¥å±¥è¡Œ <code>ANativeWindow</code> çš„æ¥å£åè®®äº†ã€‚<code>FramebufferNativeWindow</code> ä¼šå°†å…¶å¯¹åº”çš„æˆå‘˜å‡½æ•°é€ä¸ªå¡«å……åˆ° <code>ANativeWindow</code> çš„å‡½æ•°æŒ‡é’ˆä¸­ï¼Œæ¯”å¦‚ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>ANativeWindow<span class="token double-colon punctuation">::</span>setSwapInterval <span class="token operator">=</span> setSwapInterval<span class="token punctuation">;</span> 
ANativeWindow<span class="token double-colon punctuation">::</span>dequeueBuffer <span class="token operator">=</span> dequeueBuffer<span class="token punctuation">;</span>
</code></pre></div><p>è¿™æ ·å­ <code>OpenGL ES</code> æ‰èƒ½é€šè¿‡ä¸€ä¸ª <code>ANativeWindow</code> æ¥ä¸æœ¬åœ°çª—å£ç³»ç»Ÿå»ºç«‹æ­£ç¡®çš„è¿æ¥ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬è¯¦ç»†åˆ†æå…¶ä¸­ <code>dequeueBuffer</code> çš„å®ç°ã€‚</p><h4 id="_4-1-2-dequeuebuffer" tabindex="-1"><a class="header-anchor" href="#_4-1-2-dequeuebuffer" aria-hidden="true">#</a> 4.1.2 <code>dequeueBuffer</code></h4><p>è¿™ä¸ªå‡½æ•°è™½ç„¶å¾ˆçŸ­ï¼ˆåªæœ‰äºŒåå‡ è¡Œï¼‰ï¼Œå´æ˜¯ <code>FramebufferNativeWindow</code> ä¸­çš„æ ¸å¿ƒã€‚<code>OpenGL ES</code> å°±æ˜¯é€šè¿‡å®ƒæ¥åˆ†é…ä¸€ä¸ªå¯ç”¨äºæ¸²æŸ“çš„ç¼“å†²åŒºçš„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*
	dequeueBuffer åœ¨ ANativeWindow ä¸­çš„å‡½æ•°åŸå‹ï¼š
	int (*dequeueBuffer)(struct ANativeWindow* window, struct ANativeWindowBuffer** buffer, int* fenceFd);
*/</span>
<span class="token keyword">int</span> <span class="token class-name">FramebufferNativeWindow</span><span class="token double-colon punctuation">::</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span>ANativeWindow<span class="token operator">*</span> window<span class="token punctuation">,</span> ANativeWindowBuffer<span class="token operator">*</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> fenceFd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">/* Step1 */</span>
    FramebufferNativeWindow<span class="token operator">*</span> self <span class="token operator">=</span> <span class="token function">getSelf</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span> 

	<span class="token comment">/* Step2 */</span>
    Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">/* Step3. è®¡ç®— mBufferHead */</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> self<span class="token operator">-&gt;</span>mBufferHead<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>mBufferHead <span class="token operator">&gt;=</span> self<span class="token operator">-&gt;</span>mNumBuffers<span class="token punctuation">)</span>
        self<span class="token operator">-&gt;</span>mBufferHead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å¾ªç¯</span>

    <span class="token comment">/* Step4. å¦‚æœå½“å‰æ²¡æœ‰å¯ç”¨ç¼“å†²åŒº */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>self<span class="token operator">-&gt;</span>mNumFreeBuffers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token operator">-&gt;</span>mCondition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Step5. å¦‚æœæœ‰äººé‡Šæ”¾äº†ç¼“å†²åŒº */</span>
    self<span class="token operator">-&gt;</span>mNumFreeBuffers<span class="token operator">--</span><span class="token punctuation">;</span>
    self<span class="token operator">-&gt;</span>mCurrentBufferIndex <span class="token operator">=</span> index<span class="token punctuation">;</span>
    <span class="token operator">*</span>buffer <span class="token operator">=</span> self<span class="token operator">-&gt;</span>buffers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>fenceFd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step1@FramebufferNativeWindow::dequeueBuffer

è¿™é‡Œå…ˆå°†å…¥å‚ä¸­ ANativeWindow ç±»å‹çš„å˜é‡ window å¼ºåˆ¶è½¬åŒ–ä¸º FramebufferNativeWindowã€‚
å› ä¸ºå‰è€…æ˜¯åè€…çš„çˆ¶ç±»ï¼Œæ‰€ä»¥è¿™æ ·çš„è½¬åŒ–å½“ç„¶æ˜¯æœ‰æ•ˆçš„ã€‚

ä¸è¿‡ç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šå‘ç°ï¼Œä¸ºä»€ä¹ˆå‡½æ•°å…¥å‚ä¸­è¿˜è¦ç‰¹åˆ«ä¼ å…¥ä¸€ä¸ª ANativeWindow å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œ
ç›´æ¥ä½¿ç”¨FramebufferNativeWindowçš„thisæŒ‡é’ˆä¸è¡Œå—ï¼Ÿ
è¿™ä¹ˆåšå¾ˆå¯èƒ½æ˜¯ä¸ºäº†å…¼å®¹å„ç§å¹³å°ã€‚

å¤§å®¶åº”è¯¥æ³¨æ„åˆ° ANativeWindow æ˜¯ä¸€ä¸ª Struct æ•°æ®ç±»å‹ï¼Œè€Œåœ¨ C è¯­è¨€ä¸­ Struct æ˜¯æ²¡æœ‰æˆå‘˜å‡½æ•°çš„ï¼Œ
æ‰€ä»¥æˆ‘ä»¬é€šå¸¸æ˜¯ç”¨å‡½æ•°æŒ‡é’ˆçš„å½¢å¼æ¥æ¨¡æ‹Ÿä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œå¦‚è¿™ä¸ª dequeueBuffer åœ¨ ANativeWindow çš„å®šä¹‰å°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œ

è€Œä¸”ç³»ç»Ÿå¹¶æ²¡æœ‰åŠæ³•é¢„å…ˆçŸ¥é“æœ€ç»ˆå¡«å……åˆ° ANativeWindow ä¸­çš„å‡½æ•°æŒ‡é’ˆå®ç°é‡Œæ˜¯å¦å¯ä»¥ä½¿ç”¨ this æŒ‡é’ˆï¼Œ
æ‰€ä»¥åœ¨å‚æ•°ä¸­å¸¦å…¥ä¸€ä¸ª window å˜é‡å°±æ˜¯å¿…è¦çš„ã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step2@FramebufferNativeWindow::dequeueBuffer

è·å¾—ä¸€ä¸ª Mutex é”ã€‚
å› ä¸ºæ¥ä¸‹æ¥çš„æ“ä½œæ¶‰åŠèµ„æºäº’æ–¥åŒºï¼Œè‡ªç„¶éœ€è¦æœ‰ä¸€ä¸ªä¿æŠ¤æªæ–½ã€‚
è¿™é‡Œé‡‡ç”¨çš„æ˜¯ Autolockï¼Œæ„å‘³ç€ dequeueBuffer å‡½æ•°ç»“æŸåä¼šè‡ªåŠ¨é‡Šæ”¾ Mutexã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step3@FramebufferNativeWindow::dequeueBuffer

å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ mBufferHead å˜é‡ï¼Œè¿™é‡Œæ¥çœ‹çœ‹å®ƒçš„å®é™…ä½¿ç”¨ã€‚
é¦–å…ˆ index å¾—åˆ°çš„æ˜¯ mBufferHead æ‰€ä»£è¡¨çš„å½“å‰ä½ç½®ï¼Œç„¶å mBufferHead å¢åŠ  1ã€‚
ç”±äºæˆ‘ä»¬æ˜¯å¾ªç¯åˆ©ç”¨å¤šä¸ªç¼“å†²åŒºçš„ï¼Œæ‰€ä»¥å¦‚æœè¿™ä¸ªå˜é‡çš„å€¼å¤§äºæˆ–ç­‰äº mNumBuffersï¼Œé‚£ä¹ˆå°±éœ€è¦æŠŠå®ƒç½®ä¸º 0ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼ŒmBufferHead çš„å€¼æ°¸è¿œåªèƒ½æ˜¯ [0-2] ä¸­çš„ä¸€ä¸ªã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step4@FramebufferNativeWindow::dequeueBuffer

mBufferHead å¹¶ä¸ä»£è¡¨å®ƒæ‰€æŒ‡å‘çš„ç¼“å†²åŒºæ˜¯å¯ç”¨çš„ã€‚
å‡å¦‚å½“å‰çš„ mNumFreeBuffers è¡¨æ˜å·²ç»æ²¡æœ‰å¤šä½™çš„ç¼“å†²åŒºç©ºé—´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç­‰å¾…æœ‰äººé‡Šæ”¾ buffer åæ‰èƒ½ç»§ç»­æ“ä½œã€‚
(è¿™é‡Œä½¿ç”¨åˆ° Condition è¿™ä¸€åŒæ­¥æœºåˆ¶ã€‚)
å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œè¿™é‡Œè°ƒç”¨äº† mCondition.waitï¼Œé‚£ä¹ˆå¿…ç„¶æœ‰å…¶ä»–åœ°æ–¹è¦å”¤é†’å®ƒ â€”â€” å…·ä½“çš„å°±æ˜¯åœ¨ queueBuffer()ä¸­ã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step5@FramebufferNativeWindow::dequeueBuffer

ä¸€æ—¦æˆåŠŸè·å–åˆ°ä¸€ä¸ª buffer åï¼Œç¨‹åºè¦æŠŠå¯ç”¨çš„ buffer è®¡æ•°å€¼å‡ 1ï¼ˆmNumFreeBuffers--ï¼‰ã€‚
å¦å¤– mBufferHead å‰é¢å·²ç»åšè¿‡è‡ªå¢ï¼ˆ++ï¼‰å¤„ç†ï¼Œè¿™é‡Œå°±ä¸ç”¨å†åšç‰¹åˆ«å·¥ä½œã€‚
</code></pre></div><p>è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº† <code>Android</code> ç³»ç»Ÿä¸­ <code>FramebufferNativeWindow</code> æœ¬åœ°çª—å£çš„åˆ†æã€‚</p><p>æ¥ä¸‹æ¥è®²è§£å¦ä¸€ä¸ªé‡è¦çš„æœ¬åœ°çª—å£ã€‚</p><h3 id="_4-2-surface" tabindex="-1"><a class="header-anchor" href="#_4-2-surface" aria-hidden="true">#</a> 4.2 <code>Surface</code></h3><p><code>Surface</code> æ˜¯é’ˆå¯¹åº”ç”¨ç¨‹åºç«¯çš„æœ¬åœ°çª—å£ï¼Œå’Œ <code>FramebufferNativeWindow</code> ä¸€æ ·ï¼Œå®ƒå¿…é¡»ç»§æ‰¿ <code>AnativeWindow</code>ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/include/gui/Surface.h */</span>
<span class="token keyword">class</span> <span class="token class-name">Surface</span> <span class="token operator">:</span> <span class="token keyword">public</span> ANativeObjectBase<span class="token operator">&lt;</span>ANativeWindow<span class="token punctuation">,</span> Surface<span class="token punctuation">,</span> RefBase<span class="token operator">&gt;</span>
</code></pre></div><p>è¿™ä¸ªæœ¬åœ°çª—å£å½“ç„¶ä¹Ÿéœ€è¦å®ç° <code>ANativeWindow</code> æ‰€åˆ¶å®šçš„ â€œåè®®â€ï¼Œæˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹æ˜¯å®ƒä¸å‰é¢çš„ <code>FramebufferNativeWindow</code> æœ‰ä»€ä¹ˆä¸åŒã€‚</p><p><code>Surface</code> çš„æ„é€ å‡½æ•°åªæ˜¯ç®€å•åœ°ç»™ <code>ANativeWindow::dequeueBuffer</code> ç­‰å‡½æ•°æŒ‡é’ˆåŠå†…éƒ¨å˜é‡èµ‹äº†åˆå€¼ã€‚</p><p>ç”±äºæ•´ä¸ªå‡½æ•°çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªæ‘˜å½•éƒ¨åˆ†æ ¸å¿ƒå†…å®¹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/Surface.cpp */</span>
<span class="token class-name">Surface</span><span class="token double-colon punctuation">::</span><span class="token function">Surface</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">&amp;</span> bufferProducer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">mGraphicBufferProducer</span><span class="token punctuation">(</span>bufferProducer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* ç»™ ANativeWindow ä¸­çš„å‡½æ•°æŒ‡é’ˆèµ‹å€¼ */</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>setSwapInterval  <span class="token operator">=</span> hook_setSwapInterval<span class="token punctuation">;</span>
    ANativeWindow<span class="token double-colon punctuation">::</span>dequeueBuffer    <span class="token operator">=</span> hook_dequeueBuffer<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/* ä¸ºå„å†…éƒ¨å˜é‡èµ‹å€¼ï¼Œå› ä¸ºæ­¤æ—¶ç”¨æˆ·è¿˜æ²¡æœ‰å‘èµ·ç”³è¯·ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†å˜é‡çš„åˆå§‹å€¼æ˜¯ 0 */</span>
    mReqWidth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    mReqHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mDefaultWidth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    mDefaultHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    mUserWidth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    mUserHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Surface</code> æ˜¯é¢å‘ <code>Android</code> ç³»ç»Ÿä¸­æ‰€æœ‰ <code>UI</code> åº”ç”¨ç¨‹åºçš„ï¼Œå³å®ƒæ‰¿æ‹…ç€åº”ç”¨è¿›ç¨‹ä¸­çš„ <code>UI</code> æ˜¾ç¤ºéœ€æ±‚ã€‚</p><p>åŸºäºè¿™ç‚¹ï¼Œå¯ä»¥æ¨æµ‹å‡ºå…¶å†…éƒ¨å®ç°è‡³å°‘è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. é¢å‘ä¸Šå±‚å®ç°ï¼ˆä¸»è¦æ˜¯ Java å±‚ï¼‰æä¾›ç»˜åˆ¶å›¾åƒçš„ â€œç”»æ¿â€
    å‰é¢è¯´è¿‡ï¼Œè¿™ä¸ªæœ¬åœ°çª—å£åˆ†é…çš„å†…å­˜ç©ºé—´ä¸å±äºå¸§ç¼“å†²åŒºï¼Œé‚£ä¹ˆå…·ä½“æ˜¯ç”±è°æ¥åˆ†é…çš„ï¼Œåˆæ˜¯å¦‚ä½•ç®¡ç†çš„å‘¢ï¼Ÿ

2. å®ƒä¸ SurfaceFlinger é—´æ˜¯å¦‚ä½•åˆ†å·¥çš„
	æ˜¾ç„¶ SurfaceFlinger éœ€è¦æ”¶é›†ç³»ç»Ÿä¸­æ‰€æœ‰åº”ç”¨ç¨‹åºç»˜åˆ¶çš„å›¾åƒæ•°æ®ï¼Œç„¶åé›†ä¸­æ˜¾ç¤ºåˆ°ç‰©ç†å±å¹•ä¸Šã€‚
	åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒSurface æ‰®æ¼”äº†ä»€ä¹ˆæ ·çš„è§’è‰²å‘¢ï¼Ÿ
</code></pre></div><p>å…ˆæ¥è§£é‡Šä¸‹ <code>Surface</code> ç±»ä¸­ä¸€äº›é‡è¦çš„æˆå‘˜å˜é‡ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><tr><th>æˆå‘˜å˜é‡</th><th>è¯´æ˜</th></tr><tr><td>sp&lt;IGraphicBufferProducer&gt;mGraphicBufferProducer</td><td> è¿™ä¸ªå˜é‡æ˜¯ Surface çš„æ ¸å¿ƒï¼Œå¾ˆå¤š â€œåè®®â€ å°±æ˜¯é€šè¿‡å®ƒå®ç°çš„ï¼Œåé¢ä¼šæœ‰è¯¦ç»†è®²è§£ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå®ƒå·²ç»å¤šæ¬¡æ”¹åï¼Œ4.1 çš„ç‰ˆæœ¬ä¸­å«ä½œ mSurfaceTextureï¼Œåæ›´åä¸º mBufferProducerï¼Œ è€Œç›®å‰åˆ™æ˜¯å« mGraphicBufferProducerã€‚ </td></tr><tr><td>BufferSlot mSlots[NUM_BUFFER_SLOTS]</td><td> ä»åç§°ä¸Šä¸éš¾çœ‹å‡ºï¼Œè¿™æ˜¯ Surface å†…éƒ¨ç”¨äºå­˜å‚¨ buffer çš„åœ°æ–¹ï¼Œå®¹é‡ NUM_BUFFER_SLOTS æœ€å¤šå¯è¾¾ 32 ä¸ªã€‚ BufferSlot ç±»çš„å†…éƒ¨åˆç”±ä¸€ä¸ª GraphicBuffer å’Œä¸€ä¸ª dirtyRegion ç»„æˆï¼Œå½“ç”¨æˆ· dequeueBuffer æ—¶æ‰ä¼šåˆ†é…çœŸæ­£çš„ç©ºé—´ </td></tr><tr><td>uint32_t mReqWidth</td><td> Surface ä¸­æœ‰å¤šç»„ç›¸ä¼¼çš„å®½/é«˜å˜é‡ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯æœ‰åŒºåˆ«çš„ã€‚ è¿™é‡Œçš„å®½å’Œé«˜æ˜¯æŒ‡ä¸‹ä¸€æ¬¡ dequeue æ—¶å°†ä¼šç”³è¯·çš„å°ºå¯¸ï¼Œåˆå§‹å€¼éƒ½æ˜¯ 1 </td></tr><tr><td>uint32_t mReqHeight</td><td></td></tr><tr><td>uint32_t mReqFormat</td><td> å’Œä¸Šé¢ä¸¤ä¸ªå˜é‡ç±»ä¼¼ï¼Œè¿™æ˜¯æŒ‡ä¸‹æ¬¡ dequeue æ—¶å°†ä¼šç”³è¯·çš„ buffer çš„åƒç´ æ ¼å¼ï¼Œ åˆå§‹å€¼æ˜¯ PIXEL_FORMAT_RGBA_8888 </td></tr><tr><td>uint32_t mReqUsage</td><td>æŒ‡ä¸‹æ¬¡ dequeue æ—¶å°†ä¼šæŒ‡å®šçš„ usage ç±»å‹</td></tr><tr><td>Rect mCrop</td><td> Crop è¡¨ç¤º â€œä¿®å‰ªâ€ï¼Œè¿™ä¸ªå˜é‡å°†åœ¨ä¸‹æ¬¡ queue æ—¶ç”¨äºä¿®å‰ªç¼“å†²åŒºï¼Œ å¯ä»¥è°ƒç”¨ setCrop æ¥è®¾ç½®å…·ä½“çš„å€¼ </td></tr><tr><td>int mScalingMode</td><td> åŒæ ·ï¼Œè¿™ä¸ªå˜é‡å°†ç”¨äºä¸‹æ¬¡ queue æ—¶å¯¹ç¼“å†²åŒºè¿›è¡Œ scaleï¼Œ å¯ä»¥è°ƒç”¨ setScalingMode æ¥è®¾ç½®å…·ä½“çš„å€¼ </td></tr><tr><td>uint32_t mTransform</td><td>ç”¨äºä¸‹æ¬¡ queue æ—¶çš„å›¾å½¢ç¿»è½¬ç­‰æ“ä½œï¼ˆTransformï¼‰</td></tr><tr><td>uint32_t mDefaultWidth</td><td>é»˜è®¤æƒ…å†µä¸‹çš„ç¼“å†²åŒºå®½é«˜å€¼</td></tr><tr><td>uint32_t mDefaultHeight</td><td></td></tr><tr><td>uint32_t mUserWidth</td><td>å¦‚æœä¸ä¸ºé›¶çš„è¯ï¼Œå°±æ˜¯åº”ç”¨å±‚æŒ‡å®šçš„å€¼ï¼Œè€Œä¸”ä¼šè¦†ç›–å‰é¢çš„ mDefaultWidth/mDefaultHeight</td></tr><tr><td>uint32_t mUserHeight</td><td></td></tr><tr><td>sp&lt;GraphicBuffer&gt; mLockedBuffer</td><td>è®¿é—®è¿™ 3 ä¸ªå˜é‡éœ€è¦èµ„æºé”çš„ä¿æŠ¤ï¼Œæ¥ä¸‹æ¥è¿˜ä¼šæœ‰åˆ†æ</td></tr><tr><td>sp&lt;GraphicBuffer&gt; mPostedBuffer</td><td></td></tr><tr><td>Region mDirtyRegion</td><td></td></tr></table><p>ä»ä¸Šè¡¨ä¸­ <code>Surface</code> ç±»çš„å†…éƒ¨å˜é‡çš„æè¿°ä¸­ï¼Œå¯ä»¥äº†è§£åˆ°ä¸¤ç‚¹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. Surface å°†é€šè¿‡ mGraphicBufferProducer æ¥è·å– bufferï¼Œ
2. è€Œä¸”è¿™äº› buffer ç¼“å†²åŒºä¼šè¢«è®°å½•åœ¨ mSlots æ•°ç»„ä¸­ã€‚
</code></pre></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æå…¶ä¸­çš„å®ç°ç»†èŠ‚ã€‚</p><p>å‰é¢ <code>Surface</code> æ„é€ å‡½æ•°ä¸­çœ‹åˆ° <code>ANativeWindow</code> ä¸­çš„å‡½æ•°æŒ‡é’ˆèµ‹äºˆçš„æ˜¯å„ç§ä»¥ <code>hook</code> å¼€å¤´çš„å‡½æ•°ï¼Œè€Œè¿™äº› <code>hook_XX</code> å†…éƒ¨åˆç›´æ¥ â€œé’©ä½â€ äº† <code>Surface</code> ä¸­çœŸæ­£çš„å®ç°ã€‚</p><blockquote><p>æ¯”å¦‚ <code>Surface::hook_dequeueBuffer</code> å¯¹åº”çš„æ˜¯ <code>Surface::dequeueBuffer</code>ï¼Œè¿™å°±å¥½åƒ â€œé’©å­â€ çš„åŠŸèƒ½ä¸€æ ·ï¼Œæ‰€ä»¥å¾—åä¸º <code>hook</code>ã€‚</p></blockquote><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/Surface.cpp */</span>
<span class="token keyword">int</span> <span class="token class-name">Surface</span><span class="token double-colon punctuation">::</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span>android_native_buffer_t<span class="token operator">*</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>fenceFd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> buf <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/* Step1. å®½é«˜è®¡ç®— */</span>
    <span class="token keyword">int</span> reqW <span class="token operator">=</span> mReqWidth <span class="token operator">?</span> mReqWidth <span class="token operator">:</span> mUserWidth<span class="token punctuation">;</span>
    <span class="token keyword">int</span> reqH <span class="token operator">=</span> mReqHeight <span class="token operator">?</span> mReqHeight <span class="token operator">:</span> mUserHeight<span class="token punctuation">;</span>

    <span class="token comment">/* Step2. dequeueBuffer å¾—åˆ°ä¸€ä¸ªç¼“å†²åŒº */</span>
    sp<span class="token operator">&lt;</span>Fence<span class="token operator">&gt;</span> fence<span class="token punctuation">;</span>
	<span class="token comment">/* ç”Ÿäº§è€…å‘æŒ¥ä½œç”¨äº† */</span>
    status_t result <span class="token operator">=</span> mGraphicBufferProducer<span class="token operator">-&gt;</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token punctuation">,</span> reqW<span class="token punctuation">,</span> reqH<span class="token punctuation">,</span> mReqFormat<span class="token punctuation">,</span> mReqUsage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token function">gbuf</span><span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* æ³¨æ„ buf æ˜¯ä¸€ä¸ª int å€¼ï¼Œä»£è¡¨çš„æ˜¯ mSlots æ•°ç»„åºå· */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>result <span class="token operator">&amp;</span> IGraphicBufferProducer<span class="token double-colon punctuation">::</span>BUFFER_NEEDS_REALLOCATION<span class="token punctuation">)</span> <span class="token operator">||</span> gbuf <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> mGraphicBufferProducer<span class="token operator">-&gt;</span><span class="token function">requestBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gbuf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç”³è¯·ç©ºé—´</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">*</span>buffer <span class="token operator">=</span> gbuf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step1@Surface::dequeueBuffer

å›¾å½¢ç¼“å†²åŒºä¸€å®šæœ‰å®½é«˜å±æ€§ï¼Œå…·ä½“çš„å€¼ç”± mReqWidth/mReqHeight æˆ–è€… mUserWidth/mUserHeight å†³å®šï¼Œ
å…¶ä¸­å‰è€…çš„ä¼˜å…ˆçº§æ¯”åè€…é«˜ã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step2@Surface::dequeueBuffer

å¦‚å‰é¢æ‰€è¿°ï¼ŒçœŸæ­£æ‰§è¡Œ dequeueBuffer æ“ä½œçš„ç¡®å®æ˜¯ mGraphicBufferProducer(IGraphicBufferProducer)ã€‚
Surface ä¸­çš„è¿™ä¸ªæ ¸å¿ƒæˆå‘˜å˜é‡çš„æ¥æºå¯ä»¥æœ‰ä¸¤ä¸ªï¼š
	1. ä½œä¸º Surface çš„æ„é€ å‡½æ•°å‚æ•°ä¼ å…¥ï¼›
	2. æˆ–è€… Surface çš„å­ç±»é€šè¿‡ç›´æ¥è°ƒç”¨ setIGraphicBufferProducer æ¥ç”Ÿæˆã€‚
åœ¨åº”ç”¨è¿›ç¨‹ç¯å¢ƒä¸­ï¼Œå±äºåè€…ã€‚
</code></pre></div><h4 id="_4-2-1-surface-çš„åˆ›å»ºæµç¨‹" tabindex="-1"><a class="header-anchor" href="#_4-2-1-surface-çš„åˆ›å»ºæµç¨‹" aria-hidden="true">#</a> 4.2.1 <code>Surface</code> çš„åˆ›å»ºæµç¨‹</h4><p>å¤§è‡´æµç¨‹æ˜¯ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>ViewRootImpl æŒæœ‰ä¸€ä¸ª Java å±‚çš„ Surface å¯¹è±¡ï¼ˆå³ mSurfaceï¼‰ï¼Œåˆå§‹æ—¶æ˜¯ç©ºçš„ã€‚
åç»­ ViewRootImpl å°†å‘ WindowManagerService å‘èµ· relayout è¯·æ±‚ï¼Œæ­¤æ—¶ mSurface æ‰è¢«èµ‹äºˆçœŸæ­£æœ‰æ•ˆçš„å€¼ã€‚

WindowManagerService ä¼šå…ˆè®© WindowStateAnimator ç”Ÿæˆä¸€ä¸ª SurfaceControlï¼Œ
ç„¶åé€šè¿‡ Surface.copyFrom() å‡½æ•°å°†å…¶å¤åˆ¶åˆ° mSurface ä¸­ã€‚

è¿™ä¸ªå¤åˆ¶å‡½æ•°ä¼šé€šè¿‡ native æ¥å£ nativeCreateFromSurfaceControl æ¥ç”Ÿæˆæœ¬åœ° Surfaceå¯¹è±¡ï¼ˆC++ å¯¹è±¡ï¼‰ï¼Œ
å…·ä½“æ˜¯åœ¨ android_view_Surface.cpp æ–‡ä»¶ä¸­ã€‚

JNI å‡½æ•° nativeCreateFromSurfaceControl å°†ä» SurfaceControl ä¸­æå–å‡º Surfaceï¼ˆC++ ï¼‰ï¼Œ
æœ€ç»ˆè®°å½•åˆ° Surfaceï¼ˆJavaï¼‰ çš„æˆå‘˜å˜é‡ä¸­ã€‚

è¿™æ ·ï¼ŒåæœŸæˆ‘ä»¬å°±å¯ä»¥ä» Surfaceï¼ˆJavaï¼‰ çš„æˆå‘˜å˜é‡ä¸­è¿˜åŸå‡ºåº•å±‚çš„ Surfaceï¼ˆC++ ï¼‰ å¯¹è±¡äº†ã€‚
</code></pre></div><p><code>Surface</code> çš„åˆ›å»ºæµç¨‹å›¾å¤§è‡´å¦‚ä¸‹ï¼š</p><p><img src="/assets/04.0f4e4fa4.png" alt="" loading="lazy"></p><p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>Surface</code> ç”± <code>SurfaceControl</code> ç®¡ç†ï¼Œè€Œåè€…åˆç”± <code>SurfaceComposerClient</code> åˆ›å»ºï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/SurfaceComposerClient.cpp */</span>
sp<span class="token operator">&lt;</span>SurfaceControl<span class="token operator">&gt;</span> <span class="token class-name">SurfaceComposerClient</span><span class="token double-colon punctuation">::</span><span class="token function">createSurface</span><span class="token punctuation">(</span><span class="token keyword">const</span> String8<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> w<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> h<span class="token punctuation">,</span> 
															PixelFormat format<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>SurfaceControl<span class="token operator">&gt;</span> sur<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mStatus <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span> handle<span class="token punctuation">;</span>
        sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span> gbp<span class="token punctuation">;</span>

        <span class="token comment">// ç”Ÿæˆä¸€ä¸ª Surface</span>
        status_t err <span class="token operator">=</span> mClient<span class="token operator">-&gt;</span><span class="token function">createSurface</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> format<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gbp<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sur <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">SurfaceControl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> gbp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// SurfaceControl æ˜¯ â€œæœ¬åœ°â€ çš„å¯¹è±¡</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sur<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>ä¸Šè¿°ä»£ç æ®µä¸­ï¼ŒmClient æ˜¯ä¸€ä¸ª ISurfaceComposerClient çš„ sp æŒ‡é’ˆï¼Œç¨‹åºé€šè¿‡å®ƒæ¥ç”Ÿæˆä¸€ä¸ª Surfaceã€‚
å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒSurfaceControl å¯¹è±¡å¹¶ä¸æ˜¯ç”± ISurfaceComposerClient çš„ createSurface ç›´æ¥ç”Ÿæˆçš„ï¼Œ
ISurfaceComposerClient::createSurface å‡½æ•°çš„å‚æ•°ä¸­åŒ…æ‹¬äº† gbpï¼ˆIGraphicBufferProducerï¼‰ï¼Œå³å‰é¢æ‰€è¯´çš„ â€œbufferç”Ÿäº§è€…â€ã€‚
ä»ä¸­æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒçœŸæ­£ä¸ SurfaceFlinger é—´æœ‰è”ç³»çš„åº”è¯¥å°±æ˜¯ gbpï¼ˆIGraphicBufferProducerï¼‰ã€‚
</code></pre></div><p>é‚£ä¹ˆ <code>ISurfaceComposerClient</code> çš„æœåŠ¡å™¨ç«¯å®ç°æ˜¯è°ï¼Ÿ</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/SurfaceComposerClient.cpp */</span>
<span class="token keyword">void</span> <span class="token class-name">SurfaceComposerClient</span><span class="token double-colon punctuation">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>ISurfaceComposer<span class="token operator">&gt;</span> <span class="token function">sm</span><span class="token punctuation">(</span><span class="token class-name">ComposerService</span><span class="token double-colon punctuation">::</span><span class="token function">getComposerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sp<span class="token operator">&lt;</span>ISurfaceComposerClient<span class="token operator">&gt;</span> conn <span class="token operator">=</span> sm<span class="token operator">-&gt;</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mClient <span class="token operator">=</span> conn<span class="token punctuation">;</span>
            mStatus <span class="token operator">=</span> NO_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç”±æ­¤å¯è§ï¼Œ<code>ISurfaceComposerClient</code> æ˜¯ç”± <code>ISurfaceComposer::createConnection</code> ç”Ÿæˆçš„ã€‚åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæ€»å…±æ¶‰åŠäº† 3 ä¸ªåŒ¿åçš„ <code>Binder Server</code>ï¼Œå®ƒä»¬æ‰€æä¾›çš„æ¥å£å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><tr><th>åŒ¿å Binder</th><th>æä¾›çš„æ¥å£</th></tr><tr><td>ISurfaceComposer</td><td>createConnection</td></tr><tr><td>ISurfaceComposerClient</td><td> virtual status_t createSurface(..., sp&lt;IGraphicBufferProducer&gt;* gbp)=0;<br> virtual status_t destroySurface(const sp&lt;IBinder&gt;&amp; handle) = 0; </td></tr><tr><td>IGraphicBufferProducer</td><td> status_t requestBuffer(int slot, sp&lt;GraphicBuffer&gt;* buf);<br> status_t setBufferCount(int bufferCount);<br> status_t dequeueBuffer(...);<br> status_t queueBuffer(...);<br> void cancelBuffer(int slot);<br> int query(int what, int* value);<br> status_t setSynchronousMode(bool enabled);<br> status_t connect(int api, QueueBufferOutput* output);<br> status_t disconnect(int api); </td></tr></table><div class="language-text ext-text"><pre class="language-text"><code>åŒ¿å Binder ä¸€å®šæ˜¯éœ€è¦ç”±ä¸€ä¸ªå®å Binder æ¥æä¾›çš„ï¼Œå®ƒå°±æ˜¯ SurfaceFlingerï¼Œ
è¿™ä¸ª SurfaceFlinger ç³»ç»ŸæœåŠ¡æ˜¯åœ¨ ServiceManager ä¸­ â€œæ³¨å†Œåœ¨æ¡ˆâ€ çš„ã€‚

å…·ä½“æ˜¯åœ¨ SurfaceComposerClient::onFirstRef() è¿™ä¸ªå‡½æ•°ä¸­ï¼Œ
é€šè¿‡å‘ ServiceManager æŸ¥è¯¢åç§°ä¸º â€œSurfaceFlingerâ€ çš„ Binder Server æ¥è·å¾—çš„ã€‚

ä¸è¿‡å’Œå…¶ä»–å¸¸è§ Binder Server ä¸åŒçš„æ˜¯ï¼Œ
SurfaceFlinger è™½ç„¶åœ¨ ServiceManager ä¸­æ³¨å†Œçš„åç§°ä¸º â€œSurfaceFlingerâ€ï¼Œ
ä½†å®ƒåœ¨æœåŠ¡å™¨ç«¯å®ç°çš„ Binder æ¥å£å´æ˜¯ ISurfaceComposerï¼Œ
å› è€Œ SurfaceComposerClient å¾—åˆ°çš„å…¶å®æ˜¯ ISurfaceComposerã€‚å¤§å®¶è¦ç‰¹åˆ«æ³¨æ„è¿™ç‚¹ï¼Œå¦åˆ™å¯èƒ½ä¼šå¼•èµ·æ··ä¹±ã€‚

æˆ‘ä»¬å¯ä»¥ä» SurfaceFlinger çš„ç»§æ‰¿å…³ç³»ä¸­çœ‹å‡ºè¿™ä¸€åŒºåˆ«ï¼Œå¦‚ä¸‹ä»£ç ç‰‡æ–­ï¼š
</code></pre></div><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/SurfaceFlinger.h */</span>
<span class="token keyword">class</span> <span class="token class-name">SurfaceFlinger</span> <span class="token operator">:</span>
	<span class="token keyword">public</span> BinderService<span class="token operator">&lt;</span>SurfaceFlinger<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// åœ¨ServiceManager ä¸­æ³¨å†Œä¸º â€œSurfaceFlingerâ€</span>
	<span class="token keyword">public</span> BnSurfaceComposer<span class="token punctuation">,</span> <span class="token comment">// å®ç°çš„æ¥å£å´å« ISurfaceComposerï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡</span>
</code></pre></div><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/SurfaceFlinger.h */</span>
<span class="token comment">/* é«˜ç‰ˆæœ¬ä¸­çš„å£°æ˜ */</span>
<span class="token keyword">class</span> <span class="token class-name">SurfaceFlinger</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">BnSurfaceComposer</span><span class="token punctuation">,</span>
	<span class="token keyword">public</span> <span class="token class-name">PriorityDumper</span><span class="token punctuation">,</span>
	<span class="token keyword">private</span> IBinder<span class="token double-colon punctuation">::</span><span class="token class-name">DeathRecipient</span><span class="token punctuation">,</span>
	<span class="token keyword">private</span> HWC2<span class="token double-colon punctuation">::</span><span class="token class-name">ComposerCallback</span><span class="token punctuation">,</span>
	<span class="token keyword">private</span> <span class="token class-name">ICompositor</span><span class="token punctuation">,</span>
	<span class="token keyword">private</span> scheduler<span class="token double-colon punctuation">::</span><span class="token class-name">ISchedulerCallback</span><span class="token punctuation">,</span>
	<span class="token keyword">private</span> compositionengine<span class="token double-colon punctuation">::</span><span class="token class-name">ICEPowerCallback</span><span class="token punctuation">,</span>
	<span class="token keyword">private</span> scheduler<span class="token double-colon punctuation">::</span><span class="token class-name">IVsyncTrackerCallback</span>

<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">ANDROID_API</span></span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">&quot;SurfaceFlinger&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>


<span class="token comment">/* frameworks/native/libs/gui/include/gui/ISurfaceComposer.h */</span>
<span class="token keyword">class</span> <span class="token class-name">BnSurfaceComposer</span><span class="token operator">:</span> <span class="token keyword">public</span> BnInterface<span class="token operator">&lt;</span>ISurfaceComposer<span class="token operator">&gt;</span>
</code></pre></div><p>ç»•äº†ä¸€å¤§åœˆï¼Œæˆ‘ä»¬æ¥ç€åˆ†æå‰é¢ <code>Surface::dequeueBuffer</code> å‡½æ•°çš„å®ç°ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>ç›®å‰æˆ‘ä»¬å·²ç»æ¸…æ¥š mGraphicBufferProducer çš„ç”±æ¥äº†ã€‚æ¥ä¸‹æ¥ç¨‹åºåˆ©ç”¨è¿™ä¸ªå˜é‡æ¥ dequeueBufferã€‚

é‚£ä¹ˆï¼ŒIGraphicBufferProducer åœ¨æœåŠ¡å™¨ç«¯åˆæ˜¯ç”±è°æ¥å®ç°çš„å‘¢ï¼Ÿ
å› ä¸ºè¿™é‡Œé¢ç‰µæ‰¯åˆ°å¾ˆå¤šæ–°çš„ç±»ï¼Œæˆ‘ä»¬å…ˆä¸åšè¿‡å¤šè§£é‡Šï¼Œåˆ°åé¢ BufferQueue å°èŠ‚å†è¯¦ç»†åˆ†æå…¶ä¸­çš„ä¾èµ–å…³ç³»ã€‚

å½“ mGraphicBufferProducer-&gt;dequeueBuffer è¿”å›åï¼Œbuf å˜é‡å°±æ˜¯ mSlots[] æ•°ç»„ä¸­å¯ç”¨çš„æˆå‘˜åºå·ã€‚
æ¥ä¸‹æ¥å°±è¦é€šè¿‡è¿™ä¸ªåºå·æ¥è·å–çœŸæ­£çš„ buffer åœ°å€ï¼Œå³ mSlots[buf].bufferã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step3@Surface::dequeueBuffer

å‡å¦‚è¿”å›å€¼ result ä¸­çš„æ ‡å¿—åŒ…å«äº† BUFFER_NEEDS_REALLOCATIONï¼Œ
è¯´æ˜ BufferQueue éœ€è¦ä¸ºè¿™ä¸ª Slot é‡æ–°åˆ†é…ç©ºé—´ï¼Œå…·ä½“ç»†èŠ‚è¯·å‚è§ä¸‹ä¸€ä¸ªå°èŠ‚ã€‚
æ­¤æ—¶è¿˜éœ€è¦å¦å¤–è°ƒç”¨ requestBuffer æ¥ç¡®å®š gbuf çš„å€¼ï¼Œå…¶ä¸­åˆç‰µæ¶‰åˆ°å¾ˆå¤šä¸œè¥¿ï¼Œä¹Ÿæ”¾åœ¨ä¸‹ä¸€å°èŠ‚ç»Ÿä¸€è§£é‡Šã€‚
</code></pre></div><h3 id="_4-2-æœ¬åœ°çª—å£å°ç»“" tabindex="-1"><a class="header-anchor" href="#_4-2-æœ¬åœ°çª—å£å°ç»“" aria-hidden="true">#</a> 4.2 æœ¬åœ°çª—å£å°ç»“</h3><p>ç›®å‰ï¼Œå·²ç»ä»‹ç»äº†æ˜¾ç¤ºç³»ç»Ÿä¸­ä¸¤ä¸ªé‡è¦çš„æœ¬åœ°çª—å£ï¼š<code>FramebufferNativewindow</code> å’Œ <code>Surface</code>ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>FramebufferNativewindow æ˜¯ä¸“é—¨ä¸º SurfaceFlinger æœåŠ¡çš„ï¼Œå®ƒç”± Gralloc æä¾›æ”¯æŒï¼›

Surface è™½ç„¶æ˜¯ä¸ºåº”ç”¨ç¨‹åºæœåŠ¡çš„ï¼Œä½†æœ¬è´¨ä¸Šè¿˜æ˜¯ç”± SurfaceFlinger æœåŠ¡ç»Ÿä¸€ç®¡ç†çš„ï¼Œå› è€Œæ¶‰åŠå¾ˆå¤šè·¨è¿›ç¨‹çš„é€šä¿¡ç»†èŠ‚ã€‚
</code></pre></div><p>è¿™ä¸ªå°èŠ‚æˆ‘ä»¬åªæ˜¯ç®€å•åœ°å‹¾å‹’å‡ºå…¶ä¸­çš„æ¡†æ¶ï¼Œæ¥ä¸‹æ¥å°±è¦åˆ†å‡ ä¸ªæ–¹é¢æ¥åšå®Œæ•´çš„åˆ†æäº†ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. BufferQueue
ä¸ºåº”ç”¨ç¨‹åºæœåŠ¡çš„æœ¬åœ°çª—å£ Surfaceï¼Œå…¶ä¾èµ–çš„ IGraphicBufferProducer å¯¹è±¡åœ¨ Server ç«¯çš„å®ç°æ˜¯ BufferQueueã€‚
æˆ‘ä»¬å°†è¯¦ç»†è§£æ BufferQueue çš„å†…éƒ¨å®ç°ï¼Œå¹¶ç»“åˆåº”ç”¨ç¨‹åºç«¯çš„ä½¿ç”¨æµç¨‹æ¥ç†è§£å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚

2. Bufferï¼ŒConsumerï¼ŒProducer æ˜¯ â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ æ¨¡å‹ä¸­çš„ 3 ä¸ªå‚ä¸å¯¹è±¡ï¼Œ
å¦‚ä½•åè°ƒå¥½å®ƒä»¬çš„å·¥ä½œæ˜¯åº”ç”¨ç¨‹åºèƒ½å¦æ­£å¸¸æ˜¾ç¤º UI çš„å…³é”®ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆè®²è§£ Bufferï¼ˆBufferQueueï¼‰ä¸ Producerï¼ˆåº”ç”¨ç¨‹åºï¼‰é—´çš„äº¤äº’ï¼Œ
ç„¶åè½¬è€Œåˆ‡å…¥ Consumerï¼ˆSurfaceFlingerï¼‰åšè¯¦ç»†åˆ†æã€‚
</code></pre></div><h2 id="_5-bufferqueue-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_5-bufferqueue-è¯¦è§£" aria-hidden="true">#</a> 5 <code>BufferQueue</code> è¯¦è§£</h2><p><code>BufferQueue</code> æ˜¯ <code>Surface</code> å®ç°æœ¬åœ°çª—å£çš„å…³é”®ã€‚ä»é€»è¾‘ä¸Šæ¥æ¨æ–­ï¼Œ<code>BufferQueue</code> åº”è¯¥æ˜¯é©»ç•™åœ¨ <code>SurfaceFlinger</code> è¿™è¾¹çš„è¿›ç¨‹ä¸­ã€‚</p><p>æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥è§£å†³çš„ç–‘æƒ‘æ˜¯ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. æ¯ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥æœ‰å‡ ä¸ª BufferQueueï¼Œå³å®ƒä»¬çš„å…³ç³»æ˜¯ä¸€å¯¹ä¸€ã€å¤šå¯¹ä¸€ï¼Œè¿˜æ˜¯ä¸€å¯¹å¤šï¼Ÿ
2. åº”ç”¨ç¨‹åºç»˜åˆ¶ UI æ‰€éœ€çš„å†…å­˜ç©ºé—´æ˜¯ç”±è°æ¥åˆ†é…çš„ï¼Ÿ
3. åº”ç”¨ç¨‹åºä¸ SurfaceFlinger å¦‚ä½•äº’æ–¥å…±äº«æ•°æ®åŒºï¼Ÿ
4. æˆ‘ä»¬è¿™é‡Œé¢ä¸´çš„æ˜¯ç»å…¸çš„ â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ æ¨¡å‹ã€‚Android æ˜¾ç¤ºç³»ç»Ÿæ˜¯å¦‚ä½•åè°ƒå¥½è¿™ä¸¤è€…å¯¹ç¼“å†²åŒºçš„äº’æ–¥è®¿é—®çš„å‘¢ï¼Ÿ
</code></pre></div><h3 id="_5-1-bufferqueue-çš„å†…éƒ¨åŸç†" tabindex="-1"><a class="header-anchor" href="#_5-1-bufferqueue-çš„å†…éƒ¨åŸç†" aria-hidden="true">#</a> 5.1 <code>BufferQueue</code> çš„å†…éƒ¨åŸç†</h3><p>å…ˆæ¥è§£æä¸‹ <code>BufferQueue</code> çš„å†…éƒ¨æ„é€ ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/05.c960f523.png" alt="" loading="lazy"></p><p>å› ä¸º BufferQueue æ˜¯ IGraphicBufferProducer æœåŠ¡å™¨ç«¯çš„å®ç°ï¼Œæ‰€ä»¥å®ƒå¿…é¡»é‡è½½æ¥å£ä¸­çš„å„ç§è™šå‡½æ•°ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>å¦‚ queueBufferã€requestBufferã€dequeueBuffer ç­‰ã€‚
</code></pre></div><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ï¼Œ<code>IGraphicBufferProducer</code> è¢«æŠ½å–åˆ° <code>BufferQueueProducer</code> ä¸­å®ç°äº†ï¼Œ <code>BufferQueue</code> æä¾›äº† <code>BufferQueue::createBufferQueue</code> æ–¹æ³•ï¼Œåˆ›å»ºäº† <code>BufferQueueProducer</code> å¯¹è±¡ï¼Œ åŒæ—¶è¿˜åˆ›å»ºäº† <code>BufferQueueConsumer</code> å¯¹è±¡ã€‚</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/include/gui/BufferQueue.h */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createBufferQueue</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">*</span> outProducer<span class="token punctuation">,</span>
           sp<span class="token operator">&lt;</span>IGraphicBufferConsumer<span class="token operator">&gt;</span><span class="token operator">*</span> outConsumer<span class="token punctuation">,</span>
           <span class="token keyword">bool</span> consumerIsSurfaceFlinger <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/include/gui/BufferQueueProducer.h */</span>
<span class="token keyword">class</span> <span class="token class-name">BufferQueueProducer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">BnGraphicBufferProducer</span><span class="token punctuation">,</span>
                            <span class="token keyword">private</span> IBinder<span class="token double-colon punctuation">::</span><span class="token class-name">DeathRecipient</span></span> <span class="token punctuation">{</span>

<span class="token comment">/* frameworks/native/libs/gui/include/gui/IGraphicBufferProducer.h */</span>
<span class="token keyword">class</span> <span class="token class-name">BnGraphicBufferProducer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">BnInterface</span><span class="token operator">&lt;</span><span class="token class-name">IGraphicBufferProducer</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{</span>
</code></pre></div></blockquote><p>å¦å¤–ï¼Œè¿™ä¸ª <code>BufferQueue</code> çš„å†…éƒ¨æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æˆå‘˜æ•°ç»„ï¼Œå³ <code>mSlots[NUM_BUFFER_SLOTS]</code>ã€‚</p><p>åœ¨å‰é¢è®²è§£çš„ <code>Surface</code> ç±»ä¸­ä¹Ÿæœ‰ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„æ•°ç»„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/include/gui/Surface.h */</span>
<span class="token keyword">class</span> <span class="token class-name">Surface</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">ANativeObjectBase</span><span class="token operator">&lt;</span><span class="token class-name">ANativeWindow</span><span class="token punctuation">,</span> <span class="token class-name">Surface</span><span class="token punctuation">,</span> <span class="token class-name">RefBase</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	BufferSlot mSlots<span class="token punctuation">[</span>NUM_BUFFER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>è™½ç„¶ä¸¤ä¸ªæ•°ç»„ä»å½¢å¼ä¸Šçœ‹ä¸€æ¨¡ä¸€æ ·ï¼Œä½†è¦ç‰¹åˆ«æ³¨æ„å…¶ä¸­çš„ <code>BufferSlot</code> å®šä¹‰å¹¶ä¸ç›¸åŒï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/include/gui/Surface.h */</span>
<span class="token keyword">struct</span> <span class="token class-name">BufferSlot</span> <span class="token punctuation">{</span>
	sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span> buffer<span class="token punctuation">;</span>
	Region dirtyRegion<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/* frameworks/native/libs/gui/include/gui/BufferSlot.h */</span>
<span class="token keyword">struct</span> <span class="token class-name">BufferSlot</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span> mGraphicBuffer<span class="token punctuation">;</span>
	BufferState mBufferState<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>åé¢ä¸€ä¸ª BufferSlot ä¸­çš„ GraphicBuffer å˜é‡ï¼ˆmGraphicBufferï¼‰ç”¨äºè®°å½•è¿™ä¸ª Slot æ‰€æ¶‰åŠçš„ç¼“å†²åŒºï¼›
å¦ä¸€ä¸ª BufferState å˜é‡ï¼ˆmBufferState`ï¼‰ç”¨äºè·Ÿè¸ªæ¯ä¸ªç¼“å†²åŒºçš„çŠ¶æ€ã€‚æ¯”å¦‚ï¼š
</code></pre></div><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">enum</span> <span class="token class-name">BufferState</span> <span class="token punctuation">{</span>

    <span class="token comment">/* Buffer å½“å‰å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è¢«dequeuedã€‚æ­¤æ—¶ Buffer çš„ owner å¯è®¤ä¸ºæ˜¯ BufferQueue */</span>
	FREE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 

    <span class="token comment">/*
        Buffer å·²ç»è¢« dequeuedï¼Œè¿˜æœªè¢« queued æˆ– canceledã€‚æ­¤æ—¶Bufferçš„ownerå¯è®¤ä¸ºæ˜¯producerï¼ˆåº”ç”¨ç¨‹åºï¼‰ï¼Œ
        è¿™æ„å‘³ç€ BufferQueue å’Œ SurfaceFlinger(consumer) æ­¤æ—¶éƒ½ä¸å¯ä»¥æ“ä½œè¿™å—ç¼“å†²åŒº
    */</span>
	DEQUEUED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> 

    <span class="token comment">/*Buffe rå·²ç»è¢«å®¢æˆ·ç«¯ queuedï¼Œä¸è¿‡è¿˜ä¸èƒ½å¯¹å®ƒè¿›è¡Œ dequeueï¼Œä½†å¯ä»¥ acquiredã€‚æ­¤æ—¶çš„ owner æ˜¯ BufferQueue*/</span>
	QUEUED <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> 

    <span class="token comment">/* Buffer çš„ owner æ”¹ä¸º consumerï¼Œå¯ä»¥è¢« releasedï¼Œç„¶åçŠ¶æ€åˆè¿”å› FREE*/</span>
	ACQUIRED <span class="token operator">=</span> <span class="token number">3</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* é«˜ç‰ˆæœ¬ä¸­ï¼ŒBufferState ä½œä¸ºä¸€ä¸ªç»“æ„ä½“å®šä¹‰åœ¨ frameworks/native/libs/gui/include/gui/BufferSlot.h ä¸­ */</span>
</code></pre></div><p>ä»ä¸Šé¢çš„çŠ¶æ€æè¿°å¯ä»¥çœ‹å‡ºï¼Œä¸€å— <code>Buffer</code> åœ¨å¤„ç†è¿‡ç¨‹ä¸­ç»å†çš„ç”Ÿå‘½å‘¨æœŸä¾æ¬¡æ˜¯ <code>FREE -&gt; DEQUEUED -&gt; QUEUED -&gt; ACQUIRED -&gt; FREE</code>ã€‚</p><p>ä» <code>Owner</code> çš„è§’åº¦ç»™å‡ºçš„ <code>Buffer</code> çŠ¶æ€è¿ç§»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/assets/06.68976e1b.png" alt="" loading="lazy"></p><p>ä» <code>Buffer</code> çŠ¶æ€è¿ç§»å›¾ä¸­å¯ä»¥æ¸…æ¥šåœ°äº†è§£ <code>Buffer</code> çš„å„ä¸ªçŠ¶æ€ã€å¼•èµ·çŠ¶æ€è¿ç§»çš„æ¡ä»¶ä»¥åŠå„çŠ¶æ€ä¸‹çš„ <code>Owner</code>ã€‚</p><p>å‚ä¸ <code>Buffer</code> ç®¡ç†çš„ <code>Owner</code> å¯¹è±¡æœ‰ 3 ä¸ªï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>BufferQueue
    æˆ‘ä»¬å¯ä»¥è®¤ä¸º BufferQueue æ˜¯ä¸€ä¸ªæœåŠ¡ä¸­å¿ƒï¼Œå…¶ä»–ä¸¤ä¸ª Owner å¿…é¡»è¦é€šè¿‡å®ƒæ¥ç®¡ç† Bufferã€‚
    æ¯”å¦‚å½“ Producer æƒ³è¦è·å–ä¸€ä¸ª Buffer æ—¶ï¼Œå®ƒä¸èƒ½è¶Šè¿‡ BufferQueue ç›´æ¥ä¸ Consumer è¿›è¡Œè”ç³»ï¼Œåä¹‹äº¦ç„¶ã€‚

Producer
    ç”Ÿäº§è€…å°±æ˜¯ â€œå¡«å……â€ Buffer æ•°æ®çš„äººï¼Œé€šå¸¸æƒ…å†µä¸‹å½“ç„¶å°±æ˜¯åº”ç”¨ç¨‹åºã€‚
    å› ä¸ºåº”ç”¨ç¨‹åºä¸æ–­åœ°åˆ·æ–° UIï¼Œä»è€Œå°†äº§ç”Ÿçš„æ˜¾ç¤ºæ•°æ®æºæºä¸ç»åœ°å†™åˆ° Buffer ä¸­ã€‚
    å½“ Producer éœ€è¦ä½¿ç”¨ä¸€å— Buffer æ—¶ï¼Œå®ƒé¦–å…ˆä¼šå‘ BufferQueue å‘èµ· dequeue ç”³è¯·ï¼Œç„¶åæ‰èƒ½å¯¹æŒ‡å®šçš„ç¼“å†²åŒºè¿›è¡Œæ“ä½œã€‚
    ç»è¿‡ dequeue å Buffer å°±å±äº producer çš„äº†ï¼Œå®ƒå¯ä»¥å¯¹ Buffer è¿›è¡Œä»»ä½•å¿…è¦çš„æ“ä½œï¼Œè€Œå…¶ä»– Owner æ­¤åˆ»ç»ä¸èƒ½æ“…è‡ªæ’æ‰‹ã€‚

    å½“ç”Ÿäº§è€…è®¤ä¸ºä¸€å— Buffer å·²ç»å†™å…¥å®Œæˆåï¼Œå°†è¿›ä¸€æ­¥è°ƒç”¨ BufferQueue çš„ queue æ¥å£ã€‚
    ä»å­—é¢ä¸Šçœ‹è¿™ä¸ªå‡½æ•°æ˜¯ â€œå…¥åˆ—â€ çš„æ„æ€ï¼Œå½¢è±¡åœ°è¡¨è¾¾äº† Buffer æ­¤æ—¶çš„æ“ä½œ â€”â€” æŠŠ Buffer å½’è¿˜åˆ° BufferQueue çš„é˜Ÿåˆ—ä¸­ã€‚
    ä¸€æ—¦ queue æˆåŠŸï¼ŒOwner ä¹Ÿå°±éšä¹‹æ”¹å˜ä¸º BufferQueue äº†ã€‚

Consumer
    æ¶ˆè´¹è€…æ˜¯ä¸ç”Ÿäº§è€…ç›¸å¯¹åº”çš„ï¼Œå®ƒçš„æ“ä½œåŒæ ·å—åˆ° BufferQueue çš„ç®¡æ§ã€‚
    å½“ä¸€å— Buffer å·²ç»å°±ç»ªåï¼ŒConsumer å°±å¯ä»¥å¼€å§‹å·¥ä½œäº†ï¼Œç»†èŠ‚æˆ‘ä»¬ä¼šåœ¨åç»­ SurfaceFlinger ä¸­æè¿°ã€‚
</code></pre></div><p>è¿™é‡Œéœ€è¦ç‰¹åˆ«ç•™æ„çš„æ˜¯ï¼Œä»å„ä¸ªå¯¹è±¡æ‰€æ‰®æ¼”çš„è§’è‰²æ¥çœ‹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>BufferQueue æ˜¯ä¸­ä»‹æœºæ„ï¼Œå±äºæœåŠ¡æä¾›æ–¹ï¼›
Producer å±äº Buffer å†…å®¹çš„äº§å‡ºæ–¹ï¼Œå®ƒå¯¹ç¼“å†²åŒºçš„æ“ä½œæ˜¯ä¸€ä¸ª â€œä¸»åŠ¨â€ çš„è¿‡ç¨‹ï¼›
è€Œ Consumer å¯¹ Buffer çš„å¤„ç†åˆ™æ˜¯ â€œè¢«åŠ¨â€ çš„ã€â€œç­‰å¾…å¼â€ çš„ï¼Œå³ï¼šå®ƒå¿…é¡»è¦ç­‰åˆ°ä¸€å— Buffer å¡«å……å®Œæˆåæ‰èƒ½å·¥ä½œã€‚
</code></pre></div><p>åœ¨è¿™æ ·çš„æ¨¡å‹ä¸‹ï¼Œæˆ‘ä»¬æ€ä¹ˆä¿è¯ <code>Consumer</code> å¯ä»¥åŠæ—¶å¤„ç† <code>Buffer</code> å‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œå½“ä¸€å— <code>Buffer</code> æ•°æ® <code>ready</code> åï¼Œåº”è¯¥æ€ä¹ˆå‘ŠçŸ¥ <code>Consumer</code> æ¥æ“ä½œå‘¢ï¼Ÿ</p><p>ä»”ç»†è§‚å¯Ÿï¼Œå¯ä»¥çœ‹åˆ° <code>BufferQueue</code> é‡ŒåŒæ—¶è¿˜æä¾›äº†ä¸€ä¸ªç‰¹åˆ«çš„ç±»ï¼Œåç§°ä¸º <code>ConsumerListener</code>ã€‚å…¶ä¸­çš„å‡½æ•°æ¥å£åŒ…æ‹¬ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">ConsumerListener</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token class-name">RefBase</span></span> <span class="token punctuation">{</span>      

    <span class="token comment">/* å½“ä¸€å— buffer å¯ä»¥è¢«æ¶ˆè´¹æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œç‰¹åˆ«æ³¨æ„æ­¤æ—¶æ²¡æœ‰å…±äº«é”çš„ä¿æŠ¤ */</span>  
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onFrameAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 

    <span class="token comment">/* BufferQueue é€šçŸ¥ consumer å®ƒå·²ç»é‡Šæ”¾å…¶ slot ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ª GraphicBuffer å¼•ç”¨ */</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onBuffersReleased</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 
    é«˜ç‰ˆæœ¬ç³»ç»Ÿå®šä¹‰åœ¨ frameworks/native/libs/gui/include/gui/IConsumerListener.h ä¸­
    å£°æ˜ç•¥æœ‰ä¸åŒï¼Œä½†å‡½æ•°åç§°éƒ½ä¸€æ ·
 */</span>
</code></pre></div><p>è¿™æ ·å°±å¾ˆæ¸…æ¥šäº†ï¼Œå½“æœ‰ä¸€å¸§æ•°æ®å‡†å¤‡å°±ç»ªåï¼Œ<code>BufferQueue</code> å°±ä¼šè°ƒç”¨ <code>onFrameAvailable()</code> æ¥é€šçŸ¥ <code>Consumer</code> è¿›è¡Œæ¶ˆè´¹ã€‚</p><h3 id="_5-2-bufferqueue-çš„ç¼“å†²åŒºåˆ†é…" tabindex="-1"><a class="header-anchor" href="#_5-2-bufferqueue-çš„ç¼“å†²åŒºåˆ†é…" aria-hidden="true">#</a> 5.2 <code>BufferQueue</code> çš„ç¼“å†²åŒºåˆ†é…</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œ<code>BufferQueue</code> ä¸­æœ‰ä¸€ä¸ª <code>mSlots</code> æ•°ç»„ç”¨äºç®¡ç†å…¶å†…çš„å„ç¼“å†²åŒºï¼Œæœ€å¤§å®¹é‡ä¸º 32ã€‚</p><p>ä» <code>mSlots</code> æ•°ç»„çš„å£°æ˜æ–¹å¼æ¥çœ‹ï¼Œè¿™ä¸ª <code>mSlots</code> åœ¨ç¨‹åºä¸€å¼€å§‹å°±é™æ€åˆ†é…äº† 32 ä¸ª <code>BufferSlot</code> å¤§å°çš„ç©ºé—´ã€‚ä¸è¿‡è¿™å¹¶ä¸ä»£è¡¨å…¶ä¸­çš„æ•°æ®ç¼“å†²åŒºä¹Ÿæ˜¯ä¸€æ¬¡æ€§é™æ€åˆ†é…çš„ï¼Œæ°æ°ç›¸åï¼Œä» <code>BufferSlot</code> çš„å†…éƒ¨å˜é‡æŒ‡é’ˆ <code>mGraphicBuffer</code> å¯ä»¥çœ‹å‡ºï¼Œç¼“å†²åŒºçš„ç©ºé—´åˆ†é…åº”å½“æ˜¯åŠ¨æ€çš„ï¼ˆä»ä¸‹é¢çš„æ³¨é‡Šä¹Ÿèƒ½çœ‹å‡ºä¸€äº›ç«¯å€ªï¼‰ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/include/gui/BufferSlot.h */</span>
<span class="token comment">// mGraphicBuffer points to the buffer allocated for this slot or is NULL</span>
<span class="token comment">// if no buffer has been allocated.</span>
sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span> mGraphicBuffer<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ï¼Œ<code>mSlots</code> æ•°æ®å®šä¹‰åœ¨äº† <code>BufferQueueProducer.h</code> ä¸­ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/include/gui/BufferQueueProducer.h */</span>
BufferQueueDefs<span class="token double-colon punctuation">::</span>SlotsType<span class="token operator">&amp;</span> mSlots<span class="token punctuation">;</span>

<span class="token comment">// åœ¨åˆ›å»º BufferQueueProducer å¯¹è±¡æ—¶ï¼Œåœ¨ BufferQueueProducer çš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–</span>
<span class="token comment">/* frameworks/native/libs/gui/BufferQueueProducer.cpp */</span>
<span class="token class-name">BufferQueueProducer</span><span class="token double-colon punctuation">::</span><span class="token function">BufferQueueProducer</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>BufferQueueCore<span class="token operator">&gt;</span><span class="token operator">&amp;</span> core<span class="token punctuation">,</span>
       <span class="token keyword">bool</span> consumerIsSurfaceFlinger<span class="token punctuation">)</span> <span class="token operator">:</span>
   <span class="token function">mCore</span><span class="token punctuation">(</span>core<span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token function">mSlots</span><span class="token punctuation">(</span>core<span class="token operator">-&gt;</span>mSlots<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// å°† BufferQueueCore::mSlots èµ‹å€¼ç»™äº† BufferQueueProducer::mSlots</span>

<span class="token comment">/* frameworks/native/libs/gui/include/gui/BufferQueueCore.h */</span>
BufferQueueDefs<span class="token double-colon punctuation">::</span>SlotsType mSlots<span class="token punctuation">;</span>

<span class="token comment">// BufferQueueDefs::SlotsType ç±»å‹çš„å£°æ˜å¦‚ä¸‹</span>
<span class="token comment">/* frameworks/native/libs/gui/include/gui/BufferQueueDefs.h */</span>
<span class="token comment">// BufferQueueDefs::SlotsType æ˜¯ä¸€ä¸ª BufferSlot æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦æ˜¯ NUM_BUFFER_SLOTS</span>
<span class="token keyword">typedef</span> BufferSlot SlotsType<span class="token punctuation">[</span>NUM_BUFFER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// NUM_BUFFER_SLOTS å®šä¹‰å¦‚ä¸‹</span>
<span class="token comment">/* frameworks/native/libs/ui/include/ui/BufferQueueDefs.h */</span>
<span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> NUM_BUFFER_SLOTS <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span> <span class="token comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œé«˜ç‰ˆæœ¬ä¸­ï¼ŒmSlots æ•°ç»„çš„å®¹é‡æ‰©å……åˆ°äº† 64</span>
</code></pre></div></blockquote><p>ç°åœ¨çš„é—®é¢˜å°±è½¬åŒ–ä¸ºï¼šåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šç»™ä¸€ä¸ª <code>Slot</code> åˆ†é…å®é™…çš„ç©ºé—´å‘¢ï¼Ÿ</p><p>é¦–å…ˆèƒ½æƒ³åˆ°çš„å°±æ˜¯ <code>dequeueBuffer</code> ã€‚ç†ç”±å¦‚ä¸‹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. ç¼“å†²åŒºçš„ç©ºé—´åˆ†é…åº”è¯¥æ—¢è¦æ»¡è¶³ä½¿ç”¨è€…çš„éœ€æ±‚ï¼Œåˆè¦é˜²æ­¢æµªè´¹ã€‚
åé¢è¿™ä¸€ç‚¹ mSlots å·²ç»æ»¡è¶³äº†ï¼Œå› ä¸ºå®ƒå¹¶æ²¡æœ‰é‡‡å–ä¸€å¼€å§‹å°±é™æ€é¢„åˆ†é…çš„æ–¹å¼ã€‚

2. æ—¢ç„¶ Producer å¯¹ buffer çš„æ“ä½œæ˜¯ â€œä¸»åŠ¨â€ çš„ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€å®ƒæ˜¯æ•´ä¸ªéœ€æ±‚çš„å‘èµ·è€…ã€‚
æ¢å¥è¯è¯´ï¼Œåªè¦å®ƒæ²¡æœ‰ dequeueBufferï¼Œæˆ–è€… dequeueBuffer æ—¶èƒ½è·å–åˆ°å¯ç”¨çš„ç¼“å†²åŒºï¼Œé‚£å½“ç„¶å°±æ²¡æœ‰å¿…è¦å†é‡æ–°åˆ†é…ç©ºé—´äº†ã€‚
</code></pre></div><p>ä¸‹é¢è¯¦ç»†åˆ†æ <code>dequeueBuffer</code> å‡½æ•°ï¼Œå¹¶éªŒè¯æˆ‘ä»¬ä¸Šé¢çš„çŒœæµ‹ï¼š</p><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ï¼Œ<code>BufferQueue::dequeueBuffer</code> å‡½æ•°å¯¹åº” <code>BufferQueueProducer::dequeueBuffer</code> å‡½æ•°ã€‚</p><p>ç›®å‰ä»»ç„¶ä»¥ä½ç‰ˆæœ¬çš„ä»£ç è¿›è¡Œåˆ†æï¼Œåç»­å†æ›´æ–°åˆ°é«˜ç‰ˆæœ¬ã€‚</p></blockquote><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*frameworks/native/libs/gui/BufferQueue.cpp*/</span>
status_t <span class="token class-name">BufferQueue</span><span class="token double-colon punctuation">::</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>outBuf<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>Fence<span class="token operator">&gt;</span><span class="token operator">*</span> outFence<span class="token punctuation">,</span><span class="token keyword">uint32_t</span> w<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> h<span class="token punctuation">,</span>
        <span class="token keyword">uint32_t</span> format<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> usage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    status_t  <span class="token function">returnFlags</span><span class="token punctuation">(</span>OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">{</span> <span class="token comment">// Scope for the lock</span>
        <span class="token comment">/* 
            è¿™é‡Œé‡‡ç”¨äº†è‡ªåŠ¨é”ï¼Œæ‰€ä»¥ä¸Šé¢éœ€è¦åŠ ä¸ª â€œ{â€ï¼Œè¿™æ ·å½“ lock å˜é‡ç”Ÿå‘½å‘¨æœŸç»“æŸåé”ä¹Ÿå°±è‡ªåŠ¨é‡Šæ”¾äº†ã€‚
            è¿™ç§å†™æ³•åœ¨ Android ä¸­å¾ˆå¸¸è§ 
        */</span>
        Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">int</span> found <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dequeuedCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> tryAgain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token comment">/* Step1. å¾ªç¯æŸ¥æ‰¾ç¬¦åˆè¦æ±‚çš„ Slot */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>tryAgain<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                       
            found <span class="token operator">=</span> INVALID_BUFFER_SLOT<span class="token punctuation">;</span> <span class="token comment">// åˆå§‹å€¼</span>
            foundSync <span class="token operator">=</span> INVALID_BUFFER_SLOT<span class="token punctuation">;</span>
            dequeuedCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxBufferCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token keyword">int</span> state <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">;</span>

                <span class="token comment">/* Step2. ç»Ÿè®¡ dequeued buffer æ•°é‡ï¼Œåé¢ä¼šç”¨åˆ° */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> BufferSlot<span class="token double-colon punctuation">::</span>DEQUEUED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dequeuedCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>               

                <span class="token comment">/* Step3. å¯»æ‰¾ç¬¦åˆè¦æ±‚çš„ Slot */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> BufferSlot<span class="token double-colon punctuation">::</span>FREE<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>found <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> mSlots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mFrameNumber <span class="token operator">&lt;</span> mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mFrameNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          found <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">// æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„ Slot</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token comment">// for å¾ªç¯ç»“æŸ</span>

            <span class="token comment">/* Step4. å¦‚æœ Client æ²¡æœ‰è®¾ç½® buffer count çš„è¯ï¼Œå°±ä¸å…è®¸ dequeue ä¸€ä¸ªä»¥ä¸Šçš„  */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOverrideMaxBufferCount<span class="token operator">&amp;&amp;</span> dequeuedCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ST_LOGE</span><span class="token punctuation">(</span><span class="token string">&quot;dequeueBuffer: can&#39;t dequeue multiple buffers without setting the buffer count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">/* Step5. åˆ¤æ–­æ˜¯å¦è¦é‡è¯• */</span>
            tryAgain <span class="token operator">=</span> found <span class="token operator">==</span> INVALID_BUFFER_SLOT<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tryAgain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mDequeueCondition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token comment">// while å¾ªç¯ç»“æŸ</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>found <span class="token operator">==</span> INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* å› ä¸ºå‰é¢ while å¾ªç¯å¦‚æœæ²¡æ‰¾åˆ°çš„è¯æ˜¯ä¸ä¼šé€€å‡ºçš„ï¼Œæ‰€ä»¥ç†è®ºä¸Šä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µ */</span>
            <span class="token function">ST_LOGE</span><span class="token punctuation">(</span><span class="token string">&quot;dequeueBuffer: no available buffer slots&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> <span class="token keyword">int</span> buf <span class="token operator">=</span> found<span class="token punctuation">;</span>
        <span class="token operator">*</span>outBuf <span class="token operator">=</span> found<span class="token punctuation">;</span> <span class="token comment">// è¿”å›å€¼</span>
        <span class="token comment">/* æˆåŠŸæ‰¾åˆ°å¯ç”¨çš„ Slot åºå·ï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹å¯¹è¿™ä¸ªæŒ‡å®šçš„ Slot è¿›è¡Œåˆå§‹æ“ä½œï¼ŒåŠçŠ¶æ€å˜è¿ç­‰ */</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">/* Step6. Buffer çŠ¶æ€æ”¹å˜ */</span>
        mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState <span class="token operator">=</span> BufferSlot<span class="token double-colon punctuation">::</span>DEQUEUED<span class="token punctuation">;</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">buffer</span><span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">(</span>buffer<span class="token operator">-&gt;</span>width<span class="token punctuation">)</span>  <span class="token operator">!=</span> w<span class="token punctuation">)</span> <span class="token operator">||</span>   
            <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">(</span>buffer<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span> <span class="token operator">!=</span> h<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">(</span>buffer<span class="token operator">-&gt;</span>format<span class="token punctuation">)</span> <span class="token operator">!=</span> format<span class="token punctuation">)</span>
                 <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">(</span>buffer<span class="token operator">-&gt;</span>usage<span class="token punctuation">)</span> <span class="token operator">&amp;</span> usage<span class="token punctuation">)</span> <span class="token operator">!=</span> usage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>   
            <span class="token comment">/* Step7. ä¸º BufferSlot å¯¹è±¡åšåˆå§‹åŒ– */</span>
            mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>mAcquireCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>mRequestBufferCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglFence <span class="token operator">=</span> EGL_NO_SYNC_KHR<span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence <span class="token operator">=</span> Fence<span class="token double-colon punctuation">::</span>NO_FENCE<span class="token punctuation">;</span>
            mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglDisplay <span class="token operator">=</span> EGL_NO_DISPLAY<span class="token punctuation">;</span>

            returnFlags <span class="token operator">|=</span> IGraphicBufferProducer<span class="token double-colon punctuation">::</span>BUFFER_NEEDS_REALLOCATION<span class="token punctuation">;</span> <span class="token comment">/* éœ€è¦é‡æ–°åˆ†é… */</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>  <span class="token comment">// è‡ªåŠ¨é” lock ç»“æŸçš„åœ°æ–¹</span>

    <span class="token comment">/* Step8. å¦‚æœä¸Šè¿°åˆ¤æ–­ç»“æœæ˜¯éœ€è¦é‡æ–°åˆ†é…ç©ºé—´çš„è¯ */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFlags <span class="token operator">&amp;</span> IGraphicBufferProducer<span class="token double-colon punctuation">::</span>BUFFER_NEEDS_REALLOCATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        status_t error<span class="token punctuation">;</span>
        <span class="token comment">/* ç»ˆäºåˆ†é…ç©ºé—´äº† */</span>
        sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span> <span class="token function">graphicBuffer</span><span class="token punctuation">(</span>mGraphicBufferAlloc<span class="token operator">-&gt;</span><span class="token function">createGraphicBuffer</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> format<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">{</span> <span class="token comment">// Scope for the lock</span>
            Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mSlots<span class="token punctuation">[</span><span class="token operator">*</span>outBuf<span class="token punctuation">]</span><span class="token punctuation">.</span>mGraphicBuffer <span class="token operator">=</span> graphicBuffer<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> returnFlags<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å› ä¸ºè¿™ä¸ªå‡½æ•°å¾ˆé•¿ï¼Œæˆ‘ä»¬åªä¿ç•™æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚ä»æ•´ä½“æ¡†æ¶æ¥çœ‹ï¼Œ<code>Step1ï½Step5</code> æ˜¯åœ¨æŸ¥æ‰¾ä¸€ä¸ªå¯ç”¨çš„ <code>Slot</code> åºå·ã€‚ä» <code>Step6</code> å¼€å§‹ï¼Œå°±é’ˆå¯¹è¿™ä¸€ç‰¹å®šçš„ <code>Slot</code> è¿›è¡Œæ“ä½œäº†ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†æ­¥è¿›è¡Œè§£æï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>Step1@ BufferQueue::dequeueBuffer

è¿›å…¥ while å¾ªç¯ï¼Œé€€å‡ºçš„æ¡ä»¶æ˜¯ tryAgain ä¸º falseã€‚
è¿™ä¸ªå˜é‡é»˜è®¤å€¼æ˜¯ trueï¼Œå¦‚æœä¸€è½®å¾ªç¯ç»“æŸå found ä¸å†æ˜¯ INVALID_BUFFER_SLOTï¼Œå°±ä¼šå˜æˆ falseï¼Œä»è€Œç»“æŸæ•´ä¸ª while å¾ªç¯ã€‚

å¾ªç¯çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯æŸ¥æ‰¾ç¬¦åˆè¦æ±‚çš„ Slotï¼Œå…¶ä¸­ found å˜é‡æ˜¯ä¸€ä¸ª int å€¼ï¼ŒæŒ‡çš„æ˜¯è¿™ä¸ª BufferSlot åœ¨ mSlots æ•°ç»„ä¸­çš„åºå·ã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step2@ BufferQueue::dequeueBuffer

ç»Ÿè®¡å½“å‰å·²ç»è¢« dequeued çš„ buffer æ•°é‡ï¼Œè¿™å°†ç”¨äºåé¢çš„åˆ¤æ–­ï¼Œ
å³å‡å¦‚ Client æ²¡æœ‰è®¾ç½® buffer countï¼Œé‚£ä¹ˆå®ƒä¼šè¢«ç¦æ­¢ dequeue ä¸€ä¸ªä»¥ä¸Šçš„ bufferã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step3@ BufferQueue::dequeueBuffer

å‡å¦‚å½“å‰çš„ buffer çŠ¶æ€æ˜¯ FREEï¼Œé‚£ä¹ˆè¿™ä¸ª Slot å°±å¯ä»¥è¿›å…¥å¤‡é€‰äº†ã€‚
ä¸ºä»€ä¹ˆåªæ˜¯å¤‡é€‰è€Œä¸æ˜¯ç›´æ¥è¿”å›è¿™ä¸€ç»“æœå‘¢ï¼Ÿ
å› ä¸º mSlots ä¸­å¾ˆå¯èƒ½æœ‰å¤šä¸ªç¬¦åˆæ¡ä»¶çš„ Slotï¼Œå½“ç„¶éœ€è¦æŒ‘é€‰å…¶ä¸­æœ€åŒ¹é…çš„ã€‚
åˆ¤æ–­çš„ä¾æ®æ˜¯å½“å‰ç¬¦åˆè¦æ±‚çš„ Slot çš„ mFrameNumber æ˜¯å¦æ¯”ä¸Šä¸€æ¬¡é€‰ä¸­çš„æœ€ä¼˜ Slot çš„ mFrameNumber å°ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

    mSlots[i].mFrameNumber &lt; mSlots[found].mFrameNumber;
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step4@ BufferQueue::dequeueBuffer

è¿™é‡Œçš„åˆ¤æ–­æ¥æºäºç¬¬äºŒæ­¥çš„è®¡ç®—ç»“æœï¼Œä¸€æ—¦å‘ç° dequeue çš„æ•°é‡â€œè¶…æ ‡â€ï¼Œå°±ç›´æ¥å‡ºé”™è¿”å›ã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step5@ BufferQueue::dequeueBuffer

ç»è¿‡ä¸Šè¿°å‡ ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å·²ç»æ‰«æäº†ä¸€é mSlots ä¸­çš„æ‰€æœ‰æˆå‘˜ï¼Œè¿™æ—¶å°±è¦åˆ¤æ–­æ˜¯å¦å¯ä»¥é€€å‡ºå¾ªç¯ã€‚
å‰é¢å·²ç»è¯´è¿‡ï¼Œå¦‚æœæˆåŠŸæ‰¾åˆ°æœ‰æ•ˆçš„ Slot å°±å¯ä»¥ä¸ç”¨å†å¾ªç¯æŸ¥æ‰¾äº†ï¼Œå¦åˆ™ tryAgain ä»ç„¶æ˜¯ trueã€‚
å‡å¦‚æ˜¯åä¸€ç§æƒ…å†µï¼Œè¯æ˜å½“å‰å·²ç»æ²¡æœ‰ FREE çš„ Slotã€‚è¿™æ—¶å¦‚æœç›´æ¥è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ï¼Œç»“æœé€šå¸¸ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåè€Œæµªè´¹äº† CPU èµ„æºã€‚
æ‰€ä»¥ï¼Œå°±éœ€è¦ä½¿ç”¨æ¡ä»¶é”æ¥ç­‰å¾…ã€‚ä»£ç å¦‚ä¸‹ï¼š

    mDequeueCondition.wait(mMutex);

å½“æœ‰ Buffer è¢«é‡Šæ”¾æ—¶ï¼Œè¿™ä¸ªé”çš„æ¡ä»¶å°±ä¼šæ»¡è¶³ï¼Œç„¶åç¨‹åºæ‰ç»§ç»­æŸ¥æ‰¾å¯ç”¨çš„ Slotã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step6@ BufferQueue::dequeueBuffer

æ ¹æ®å‰é¢çš„ Buffer çŠ¶æ€è¿ç§»å›¾ï¼Œå½“å¤„äº FREE çŠ¶æ€çš„ Buffer è¢« dequeue æˆåŠŸåï¼Œ
å®ƒå°†è¿›å…¥ DEQUEUEDï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦æ”¹å˜å…¶ mBufferStateã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step7@ BufferQueue::dequeueBuffer

é€šè¿‡ä¸Šè¿°å‡ ä¸ªæ­¥éª¤çš„åŠªåŠ›ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»æˆåŠŸåœ°å¯»æ‰¾åˆ°æœ‰æ•ˆçš„ Slot åºå·äº†ã€‚
ä½†æ˜¯è¿™å¹¶ä¸ä»£è¡¨è¿™ä¸ª Slot å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¸ºä»€ä¹ˆï¼Ÿæœ€ç›´æ¥çš„ä¸€ä¸ªåŸå› å°±æ˜¯è¿™ä¸ª Slot å¯èƒ½è¿˜æ²¡æœ‰åˆ†é…ç©ºé—´ã€‚

å› ä¸º BufferSlot::mGraphicBuffer åˆå§‹å€¼æ˜¯ NULLï¼Œå‡å¦‚æˆ‘ä»¬æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨å®ƒï¼Œå¿…ç„¶æ˜¯éœ€è¦ä¸ºå®ƒåˆ†é…ç©ºé—´çš„ã€‚
å¦å¤–ï¼Œå³ä¾¿ mGraphicBuffer ä¸ä¸ºç©ºï¼Œ
ä½†å¦‚æœç”¨æˆ·æ‰€éœ€è¦çš„ Buffer å±æ€§ï¼ˆæ¯”å¦‚ widthï¼Œheightï¼Œformat ç­‰ï¼‰å’Œå½“å‰è¿™ä¸ªä¸ç¬¦ï¼Œé‚£ä¹ˆè¿˜æ˜¯è¦è¿›è¡Œé‡æ–°åˆ†é…ã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step8@ BufferQueue::dequeueBuffer

å¦‚æœä¸Šä¸€æ­¥çš„åˆ¤æ–­ç»“æœæ˜¯ BUFFER_NEEDS_REALLOCATIONï¼Œè¯´æ˜æ­¤ Slot è¿˜æœªåˆ†é…åˆ°æœ‰æ•ˆçš„ buffer ç©ºé—´ï¼Œ
å…·ä½“åˆ†é…æ“ä½œä½¿ç”¨çš„æ˜¯ mGraphicBufferAlloc è¿™ä¸ª Allocatorï¼Œ
è¿™é‡Œæš‚ä¸æ·±ç©¶å…¶ä¸­çš„å®ç°äº†ï¼Œåç»­è¿˜ä¼šæœ‰è¯¦ç»†åˆ†æã€‚
</code></pre></div><p>å¦‚æœé‡æ–°åˆ†é…äº†ç©ºé—´ï¼Œé‚£ä¹ˆæœ€åçš„è¿”å›å€¼ä¸­ä¼šåŠ ä¸Š <code>BUFFER_NEEDS_REALLOCATION</code> æ ‡å¿—ã€‚</p><p>å®¢æˆ·ç«¯åœ¨å‘ç°è¿™ä¸ªæ ‡å¿—åï¼Œè¿˜åº”è°ƒç”¨ <code>requestBuffer()</code> æ¥å–å¾—æœ€æ–°çš„ <code>buffer</code> åœ°å€ã€‚</p><p><a href="#_9-4-2-surface">9.4.2 Surface</a> å°èŠ‚ä¸­çš„ <code>Surface::dequeueBuffer()</code> çš„ <code>Step3</code> å°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œè¿™é‡Œç»“åˆèµ·æ¥åˆ†æã€‚ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œå†æŠŠè¿™éƒ¨åˆ†ä»£ç ç®€å•åœ°åˆ—å‡ºæ¥ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>frameworks<span class="token operator">/</span>native<span class="token operator">/</span>libs<span class="token operator">/</span>gui<span class="token operator">/</span>Surface<span class="token punctuation">.</span>cpp
<span class="token comment">/* frameworks/native/libs/gui/Surface.cpp */</span>
<span class="token keyword">int</span> <span class="token class-name">Surface</span><span class="token double-colon punctuation">::</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span>android_native_buffer_t<span class="token operator">*</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>fenceFd<span class="token punctuation">)</span> <span class="token punctuation">{</span>â€¦
    Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> buf <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">/* Step1. å®½é«˜è®¡ç®— */</span>
    <span class="token keyword">int</span> reqW <span class="token operator">=</span> mReqWidth <span class="token operator">?</span> mReqWidth <span class="token operator">:</span> mUserWidth<span class="token punctuation">;</span>
    <span class="token keyword">int</span> reqH <span class="token operator">=</span> mReqHeight <span class="token operator">?</span> mReqHeight <span class="token operator">:</span> mUserHeight<span class="token punctuation">;</span>

    <span class="token comment">/* Step2. dequeueBuffer å¾—åˆ°ä¸€ä¸ªç¼“å†²åŒº */</span>
    sp<span class="token operator">&lt;</span>Fence<span class="token operator">&gt;</span> fence<span class="token punctuation">;</span>
    <span class="token comment">/* è¿™ä¸€å°èŠ‚è®²è§£çš„å°±æ˜¯è¿™ä¸ªæ¥å£çš„å®ç° */</span>
    status_t result <span class="token operator">=</span> mGraphicBufferProducer<span class="token operator">-&gt;</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token punctuation">,</span> reqW<span class="token punctuation">,</span> reqH<span class="token punctuation">,</span> mReqFormat<span class="token punctuation">,</span> mReqUsage<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token function">gbuf</span><span class="token punctuation">(</span>mSlots<span class="token punctuation">[</span>buf<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* æ³¨æ„ buf æ˜¯ä¸€ä¸ª int å€¼ï¼Œ ä»£è¡¨çš„æ˜¯ mSlots æ•°ç»„åºå· */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>result <span class="token operator">&amp;</span> IGraphicBufferProducer<span class="token double-colon punctuation">::</span>BUFFER_NEEDS_REALLOCATION<span class="token punctuation">)</span> <span class="token operator">||</span> gbuf <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* å› ä¸ºè¿™ä¸ª buffer æ˜¯éœ€è¦é‡æ–°åˆ†é…å¾—åˆ°çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦è¿›ä¸€æ­¥è°ƒç”¨ requestBufferï¼Œåé¢æœ‰è¯¦ç»†è®²è§£ */</span>
        result <span class="token operator">=</span> mGraphicBufferProducer<span class="token operator">-&gt;</span><span class="token function">requestBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">*</span>buffer <span class="token operator">=</span> gbuf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“ <code>mGraphicBufferProducer-&gt;dequeueBuffer</code> æˆåŠŸè¿”å›åï¼Œ<code>buf</code> å¾—åˆ°äº† <code>mSlots</code> ä¸­å¯ç”¨æ•°ç»„æˆå‘˜çš„åºå·ï¼ˆå¯¹åº”è¿™ä¸€å°èŠ‚çš„ <code>found</code> å˜é‡ï¼‰ã€‚</p><p>ä½†ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„é—®é¢˜æ˜¯ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>æ—¢ç„¶å®¢æˆ·ç«¯å’Œ BufferQueue è¿è¡Œäºä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œé‚£ä¹ˆå®ƒä»¬çš„ mSlots[buf] ä¼šæŒ‡å‘åŒä¸€å—ç‰©ç†å†…å­˜å—ï¼Ÿ
</code></pre></div><p>è¿™å°±æ˜¯ <code>requestBuffer</code> å­˜åœ¨çš„æ„ä¹‰ã€‚</p><p>å…ˆæ¥çœ‹çœ‹ <code>BpGraphicBufferProducer</code> ä¸­æ˜¯å¦‚ä½•å‘èµ· <code>Binder</code> ç”³è¯·çš„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/IGraphicBufferProducer.cpp */</span>
<span class="token keyword">class</span> <span class="token class-name">BpGraphicBufferProducer</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">BpInterface</span><span class="token operator">&lt;</span><span class="token class-name">IGraphicBufferProducer</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">virtual</span> status_t <span class="token function">requestBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> bufferIdx<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span><span class="token operator">*</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å‡½æ•°å‚æ•°æœ‰ä¸¤ä¸ª</span>
    Parcel data<span class="token punctuation">,</span> reply<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token class-name">IGraphicBufferProducer</span><span class="token double-colon punctuation">::</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* åªå†™å…¥äº† bufferIdx å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ BnGraphicBufferProducer ä¸­å®é™…ä¸Šæ˜¯çœ‹ä¸åˆ° buf å˜é‡çš„ */</span>
    data<span class="token punctuation">.</span><span class="token function">writeInt32</span><span class="token punctuation">(</span>bufferIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    status_t result <span class="token operator">=</span><span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">transact</span><span class="token punctuation">(</span>REQUEST_BUFFER<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡Œè·¨è¿›ç¨‹æ“ä½œ</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/* è¿™é‡Œè¯»å–çš„æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬ç¨åå¯ä»¥å» BnGraphicBufferProducer ä¸­ç¡®è®¤ä¸‹ */</span>
    <span class="token keyword">bool</span> nonNull <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nonNull<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">GraphicBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç”Ÿæˆä¸€ä¸ª GraphicBufferï¼Œçœ‹åˆ°æ²¡ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ¬åœ°å®ä¾‹</span>
        <span class="token comment">/* buf æ˜¯ä¸€ä¸ª sp æŒ‡é’ˆ,é‚£ä¹ˆ **sp å®é™…ä¸Šå¾—åˆ°çš„å°±æ˜¯è¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­æŒ‡çš„æ˜¯ mSlots[buf].buffer */</span>
        reply<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    result <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* è¯»å–ç»“æœ */</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Native</code> å±‚çš„ <code>BpXXX/BnXXX</code> ä¸ <code>Java</code> å±‚çš„ä¸åŒä¹‹å¤„åœ¨äºï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>Java å±‚çš„é€šå¸¸éƒ½æ˜¯ä¾èµ–äº aidlæ¥ è‡ªåŠ¨ç”Ÿæˆè¿™ä¸¤ä¸ªç±»ï¼Œè€Œ Native å±‚ çš„åˆ™æ˜¯æ‰‹å·¥å®Œæˆçš„ã€‚
</code></pre></div><p>ä¹Ÿæ­£å› ä¸ºæ˜¯æ‰‹å·¥ä¹¦å†™çš„ï¼Œä½¿ç”¨èµ·æ¥æ‰æ›´å…·çµæ´»æ€§ã€‚æ¯”å¦‚åœ¨ <code>IGraphicBufferProducer</code> è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>å¼€å‘è€… â€œè€â€ äº†ç‚¹æŠ€å·§ â€”â€” Surface ä¸­è°ƒç”¨äº†

    IgraphicBuffer Producer::requestBuffer(int slot, sp&lt;GraphicBuffer&gt;* buf)

è¿™ä¸ªå‡½æ•°è™½ç„¶å½¢å¼ä¸Šæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä½†åªæœ‰ç¬¬ä¸€ä¸ªæ˜¯å…¥å‚ï¼Œåä¸€ä¸ªåˆ™æ˜¯å‡ºå‚ã€‚
åœ¨å®é™…çš„ Binder é€šä¿¡ä¸­ï¼Œåªæœ‰ Slot åºå·è¿™ä¸ª int å€¼ï¼ˆå³ bufferIdxï¼‰ä¼ é€’ç»™äº†å¯¹æ–¹è¿›ç¨‹ï¼Œ
è€Œ buf åˆ™è‡ªå§‹è‡³ç»ˆéƒ½æ˜¯ Surface æ‰€åœ¨çš„æœ¬åœ°è¿›ç¨‹åœ¨å¤„ç†ã€‚
ä¸è¿‡ä»è°ƒç”¨è€…çš„è§’åº¦æ¥è®²ï¼Œå¥½åƒæ˜¯ç”± IGraphicBufferProducer çš„ Server ç«¯å®Œæˆäº†å¯¹ buf çš„èµ‹å€¼ã€‚
</code></pre></div><p>ä» <code>BpGraphicBufferProducer::requestBuffer</code> è¿™ä¸ªå‡½æ•°å®ç°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>Client</code> ç«¯å‘ <code>Server</code> ç«¯è¯·æ±‚äº†ä¸€ä¸ª <code>REQUEST_BUFFER</code> æœåŠ¡ï¼Œç„¶åé€šè¿‡è¯»å–è¿”å›å€¼æ¥è·å¾—ç¼“å†²åŒºä¿¡æ¯ã€‚</p><p>ä¸ºäº†èƒ½çœ‹æ¸…æ¥šè¿™å…¶ä¸­çš„ç»†èŠ‚ï¼Œæœ‰å¿…è¦å†åˆ†æä¸€ä¸‹ <code>BnGraphicBufferProducer</code> å…·ä½“æ˜¯å¦‚ä½•å“åº”è¿™ä¸ªæœåŠ¡è¯·æ±‚çš„ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/IGraphicBufferProducer.cpp */</span>
status_t <span class="token class-name">BnGraphicBufferProducer</span><span class="token double-colon punctuation">::</span><span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> code<span class="token punctuation">,</span> <span class="token keyword">const</span> Parcel<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> Parcel<span class="token operator">*</span> reply<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> REQUEST_BUFFER<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token function">CHECK_INTERFACE</span><span class="token punctuation">(</span>IGraphicBufferProducer<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> bufferIdx   <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é¦–å…ˆè¯»å–è¦å¤„ç†çš„ Slot åºå·</span>
            sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span> buffer<span class="token punctuation">;</span> <span class="token comment">// ç”Ÿæˆä¸€ä¸ª GraphicBuffer æ™ºèƒ½æŒ‡é’ˆ</span>
            <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">requestBuffer</span><span class="token punctuation">(</span>bufferIdx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨æœ¬åœ°ç«¯çš„å®ç°</span>
            reply<span class="token operator">-&gt;</span><span class="token function">writeInt32</span><span class="token punctuation">(</span>buffer <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ³¨æ„ï¼Œç¬¬ä¸€ä¸ªå†™å…¥çš„å€¼æ˜¯åˆ¤æ–­ buffer ä¸ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª bool å€¼</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reply<span class="token operator">-&gt;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">*</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¥½ï¼ŒçœŸæ­£çš„å†…å®¹åœ¨è¿™é‡Œï¼Œåé¢æˆ‘ä»¬è¯¦ç»†è§£é‡Š</span>
            <span class="token punctuation">}</span>
            reply<span class="token operator">-&gt;</span><span class="token function">writeInt32</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å†™å…¥ç»“æœå€¼</span>
            <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>BnGraphicBufferProducer é¦–å…ˆè¯»å– Slot åºå·ï¼Œå³ bufferIdxï¼›
ç„¶åé€šè¿‡ BufferQueue çš„æ¥å£ requestBuffer æ¥è·å–ä¸ä¹‹å¯¹åº”çš„æ­£ç¡®çš„ GraphicBufferï¼Œè¿™é‡Œæ˜¯æŒ‡ mSlots[slot].mGraphicBufferã€‚

è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼ŒBnGraphicBufferProducer åœ¨ reply ä¸­ç¬¬ä¸€ä¸ªå†™å…¥çš„æ˜¯ bool å€¼ï¼ˆbuffer!=0ï¼‰ï¼Œ
ç´§éšå…¶åçš„æ‰æ˜¯ GraphicBufferï¼Œæœ€åå†™å…¥ç»“æœå€¼ï¼Œå¤§åŠŸå‘Šæˆã€‚
</code></pre></div><p>æ˜¾ç„¶ <code>BpGraphicBufferProducer</code> å¿…é¡»è¦æŒ‰ç…§ä¸ <code>BnGraphicBufferProducer</code> åŒæ ·çš„å†™å…¥é¡ºåºæ¥è¯»å–æ•°æ®ï¼Œå³ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. å› è€Œ BpGraphicBufferProducer::requestBuffer é¦–å…ˆè·å–ä¸€ä¸ª int32 å€¼ï¼Œèµ‹äºˆ nonNull å˜é‡ã€‚
è¿™ä¸ª nonNull å€¼å¯¹åº”çš„æ˜¯ BnGraphicBufferProducer::onTransact ä¸­çš„ buffer != 0 çš„é€»è¾‘åˆ¤æ–­ã€‚
å‡å¦‚ç¡®å®ä¸ä¸ºç©ºï¼Œé‚£è¯´æ˜æˆ‘ä»¬å¯ä»¥æ¥ç€è¯»å– GraphicBuffer äº†ã€‚

2. å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯å¯¹ GraphicBuffer å˜é‡çš„ â€œå†™å…¥å’Œè¯»å–â€ æ“ä½œåˆ†åˆ«æ˜¯ï¼š
    reply-&gt;write(*buffer); // BnGraphicBufferProducer::onTransact å†™å…¥ 
    reply.read(**buf); // BpGraphicBufferProducer::requestBuffer è¯»å–

3. è¯»å– result ç»“æœå€¼ã€‚
</code></pre></div><p>ç¬¬ 2 ç‚¹ä¸­ï¼Œ<code>Server</code> ç«¯å†™å…¥çš„ <code>GraphicBuffer</code> å¯¹è±¡éœ€è¦åœ¨ <code>Client</code> ä¸­å®Œæ•´åœ°å¤ç°å‡ºæ¥ã€‚è¿™å°±éœ€è¦ä½œä¸º <code>Binder</code> å¯¹è±¡çš„ <code>GraphicBuffer</code> ç»§æ‰¿ <code>Flattenable</code>ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/ui/include/ui/GraphicBuffer.h */</span>
<span class="token keyword">class</span> <span class="token class-name">GraphicBuffer</span>
    <span class="token operator">:</span> <span class="token keyword">public</span> ANativeObjectBase<span class="token operator">&lt;</span>ANativeWindowBuffer<span class="token punctuation">,</span> GraphicBuffer<span class="token punctuation">,</span> LightRefBase<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> 
      <span class="token keyword">public</span> Flattenable

<span class="token comment">/* é«˜ç‰ˆæœ¬ä¸­çš„å£°æ˜ç±»ä¼¼ï¼Œå¦‚ä¸‹ï¼š */</span>
<span class="token keyword">class</span> <span class="token class-name">GraphicBuffer</span>
    <span class="token operator">:</span> <span class="token keyword">public</span> ANativeObjectBase<span class="token operator">&lt;</span>ANativeWindowBuffer<span class="token punctuation">,</span> GraphicBuffer<span class="token punctuation">,</span> RefBase<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token keyword">public</span> Flattenable<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span>
</code></pre></div><p>æ¥ä¸‹æ¥åªéœ€è¦çœ‹ä¸‹ <code>GraphicBuffer</code> æ˜¯å¦‚ä½•å®ç° <code>flatten</code> å’Œ <code>unflatten</code> æ¥å£çš„ï¼Œç›¸ä¿¡å°±èƒ½æ­æ™“è°œåº•äº†ï¼š</p><blockquote><p>è°œé¢˜æ˜¯ï¼šæ—¢ç„¶å®¢æˆ·ç«¯å’Œ <code>BufferQueue</code> è¿è¡Œäºä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œé‚£ä¹ˆå®ƒä»¬çš„ <code>mSlots[buf]</code> ä¼šæŒ‡å‘åŒä¸€å—ç‰©ç†å†…å­˜å—ï¼Ÿ</p></blockquote><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/ui/GraphicBuffer.cpp */</span>
status_t <span class="token class-name">GraphicBuffer</span><span class="token double-colon punctuation">::</span><span class="token function">flatten</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">int</span> fds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">int</span><span class="token operator">*</span> buf <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> handle<span class="token operator">-&gt;</span>numFds<span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> handle<span class="token operator">-&gt;</span>numInts<span class="token punctuation">;</span>
        native_handle_t <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">const</span> h <span class="token operator">=</span> handle<span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>fds<span class="token punctuation">,</span> h<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> h<span class="token operator">-&gt;</span>numFds<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token operator">-&gt;</span>data <span class="token operator">+</span> h<span class="token operator">-&gt;</span>numFds<span class="token punctuation">,</span> h<span class="token operator">-&gt;</span>numInts<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>GraphicBuffer::flatten</code> å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æœ€å…³å¿ƒçš„æ˜¯ <code>handle</code> è¿™ä¸ªå˜é‡çš„ <code>flatten</code>ï¼Œå®ƒå®é™…ä¸Šæ˜¯ <code>GraphicBuffer</code> ä¸­æ‰“å¼€çš„ä¸€ä¸ª <code>ashmem</code> å¥æŸ„ï¼Œè¿™æ˜¯ä¸¤è¾¹è¿›ç¨‹å®ç°å…±äº«ç¼“å†²åŒºçš„å…³é”®ã€‚ä¸ <code>handle</code> ç›¸å…³çš„å˜é‡åˆ†åˆ«æ˜¯ <code>buf[6]-buf[8]</code> ä»¥åŠ <code>fds</code>ï¼Œå¤§å®¶å¯ä»¥æ·±å…¥ç†è§£ä¸‹å®ƒä»¬çš„ä½œç”¨ã€‚</p><p>å†æ¥çœ‹çœ‹ <code>Client</code> ç«¯æ˜¯å¦‚ä½•è¿˜åŸå‡ºä¸€ä¸ª <code>GraphicBuffer</code> çš„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/ui/GraphicBuffer.cpp */</span>
status_t <span class="token class-name">GraphicBuffer</span><span class="token double-colon punctuation">::</span><span class="token function">unflatten</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">int</span> fds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">int</span> <span class="token keyword">const</span><span class="token operator">*</span> buf <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   
    <span class="token keyword">const</span> size_t numFds  <span class="token operator">=</span> buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> size_t numInts <span class="token operator">=</span> buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>numFds <span class="token operator">||</span> numInts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        native_handle<span class="token operator">*</span> h <span class="token operator">=</span> <span class="token function">native_handle_create</span><span class="token punctuation">(</span>numFds<span class="token punctuation">,</span> numInts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>h<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> fds<span class="token punctuation">,</span> numFds<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>h<span class="token operator">-&gt;</span>data <span class="token operator">+</span> numFds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> numInts<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        handle <span class="token operator">=</span> h<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mBufferMapper<span class="token punctuation">.</span><span class="token function">registerBuffer</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åŒæ ·ï¼Œ<code>unflatten</code> ä¸­çš„æ“ä½œä¹Ÿæ˜¯ä¾æ® <code>flatten</code> æ—¶å†™å…¥çš„æ ¼å¼ã€‚</p><p>å…¶ä¸­æœ€é‡è¦çš„ä¸¤ä¸ªå‡½æ•°æ˜¯ <code>native_handle_create()</code> å’Œ <code>registerBuffer()</code>ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>native_handle_create() å‡½æ•°ç”Ÿæˆ native_handle å®ä¾‹ï¼Œå¹¶å°†ç›¸å…³æ•°æ®å¤åˆ¶åˆ°å…¶å†…éƒ¨ã€‚

registerBuffer() å‡½æ•°åˆ™å±äº GraphicBufferMapper ç±»ä¸­çš„å®ç°ï¼Œ
æˆå‘˜å˜é‡ mBufferMapper æ˜¯åœ¨ GraphicBuffer æ„é€ å‡½æ•°ä¸­ç”Ÿæˆçš„ï¼Œå®ƒæ‰€æ‰¿æ‹…çš„ä»»åŠ¡æ˜¯å’Œ Gralloc æ‰“äº¤é“ã€‚
</code></pre></div><p><code>GraphicBufferMapper</code> æ„é€ å‡½æ•°çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token class-name">GraphicBufferMapper</span><span class="token double-colon punctuation">::</span><span class="token function">GraphicBufferMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    hw_module_t <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">hw_get_module</span><span class="token punctuation">(</span>GRALLOC_HARDWARE_MODULE_ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">module</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™é‡Œå‡ºç°äº† <code>Gralloc</code> çš„ <code>module id</code>ï¼Œåœ¨ <a href="#_9-3-1-gralloc-%E6%A8%A1%E5%9D%97%E7%9A%84%E5%8A%A0%E8%BD%BD">9.3.1 Gralloc æ¨¡å—çš„åŠ è½½</a> å°èŠ‚ä¸­æœ‰ä»‹ç»è¿‡ã€‚</p><p><code>GraphicBufferMapper::registerBuffer()</code> åªæ˜¯èµ·åˆ°äº†ä¸­ä»‹ä½œç”¨ï¼Œå®ƒä¼šç›´æ¥è°ƒç”¨ <code>gralloc_module_t::registerBuffer()</code>ã€‚</p><p>é‚£ä¹ˆåè€…ç©¶ç«Ÿå®Œæˆäº†ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿå› ä¸ºè¿™ä¸ªå‡½æ•°çš„å®ç°ä¸å…·ä½“å¹³å°æœ‰å…³ï¼Œæˆ‘ä»¬ä»¥ <code>msm7k</code> ä¸ºä¾‹æ¥å¤§æ¦‚åˆ†æä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* hardware/msm7k/libgralloc/Mapper.cpp */</span>
<span class="token keyword">int</span> <span class="token function">gralloc_register_buffer</span><span class="token punctuation">(</span>gralloc_module_t <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">module</span><span class="token punctuation">,</span> buffer_handle_t handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    private_handle_t<span class="token operator">*</span> hnd <span class="token operator">=</span> <span class="token punctuation">(</span>private_handle_t<span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    
    err <span class="token operator">=</span> <span class="token function">gralloc_map</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ <code>handle</code> å¥æŸ„ <code>Client</code> ç«¯å¯ä»¥å°†æŒ‡å®šçš„å†…å­˜åŒºåŸŸæ˜ å°„åˆ°è‡ªå·±çš„è¿›ç¨‹ç©ºé—´ä¸­ï¼Œè€Œè¿™å—åŒºåŸŸä¸ <code>BufferQueue</code> ä¸­æ‰€æŒ‡å‘çš„ç‰©ç†ç©ºé—´æ˜¯ä¸€è‡´çš„ï¼Œä»è€ŒæˆåŠŸåœ°å®ç°äº†ä¸¤è€…çš„ç¼“å†²åŒºå…±äº«ã€‚</p><p>è¿™æ ·åœ¨ <code>Surface::dequeueBuffer()</code> å‡½æ•°çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦é‡åˆ° <code>mGraphicBufferProducer-&gt;requestBuffer</code> ç»“æœä¸­åŒ…å«æœ‰ <code>BUFFER_NEEDS_REALLOCATION</code> çš„æƒ…å†µï¼Œå°±éœ€è¦é€šè¿‡ <code>requestBuffer()</code> å¾—åˆ°çš„ç»“æœæ¥ â€œåˆ·æ–°â€ <code>Client</code> è¿™ç«¯ <code>mSlots[]</code> æ‰€ç®¡è¾–çš„ç¼“å†²åŒºä¿¡æ¯ï¼Œä»¥ä¿è¯ <code>Surface</code> ä¸ <code>BufferQueue</code> åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½åœ¨ 32 ä¸ª <code>BufferSlot</code> ä¸­ä¿æŒæ•°æ®ç¼“å†²åŒºä¸Šçš„é«˜åº¦ä¸€è‡´ã€‚è¿™ä¹Ÿæ˜¯åé¢å®ƒä»¬èƒ½æ­£ç¡®å®æ–½ â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ æ¨¡å‹çš„åŸºç¡€ã€‚</p><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­å°†è°ƒç”¨ <code>mBufferMapper.registerBuffer</code> æ”¹æˆäº†è°ƒç”¨ <code>mBufferMapper.importBuffer</code></p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/ui/GraphicBufferMapper.cpp */</span>
status_t <span class="token class-name">GraphicBufferMapper</span><span class="token double-colon punctuation">::</span><span class="token function">importBuffer</span><span class="token punctuation">(</span><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> rawHandle<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> width<span class="token punctuation">,</span>
                                           <span class="token keyword">uint32_t</span> height<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> layerCount<span class="token punctuation">,</span> PixelFormat format<span class="token punctuation">,</span>
                                           <span class="token keyword">uint64_t</span> usage<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> stride<span class="token punctuation">,</span>
                                           buffer_handle_t<span class="token operator">*</span> outHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    buffer_handle_t bufferHandle<span class="token punctuation">;</span>
    status_t error <span class="token operator">=</span> mMapper<span class="token operator">-&gt;</span><span class="token function">importBuffer</span><span class="token punctuation">(</span>rawHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">&quot;importBuffer(%p) failed: %d&quot;</span><span class="token punctuation">,</span> rawHandle<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error <span class="token operator">=</span> mMapper<span class="token operator">-&gt;</span><span class="token function">validateBufferSize</span><span class="token punctuation">(</span>bufferHandle<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> format<span class="token punctuation">,</span> layerCount<span class="token punctuation">,</span> usage<span class="token punctuation">,</span>
                                        stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;validateBufferSize(%p) failed: %d&quot;</span><span class="token punctuation">,</span> rawHandle<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">freeBuffer</span><span class="token punctuation">(</span>bufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>status_t<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>outHandle <span class="token operator">=</span> bufferHandle<span class="token punctuation">;</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* frameworks/native/libs/ui/include/ui/Gralloc.h */</span>
<span class="token keyword">class</span> <span class="token class-name">GrallocMapper</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">virtual</span> status_t <span class="token function">importBuffer</span><span class="token punctuation">(</span><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> rawHandle<span class="token punctuation">,</span>
                                  buffer_handle_t<span class="token operator">*</span> outBufferHandle<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">/* 
    GrallocMapper çš„å­ç±»å®ç°æœ‰å¤šä¸ªï¼šGralloc5Mapperã€Gralloc4Mapperã€Gralloc3Mapperã€Gralloc2Mapperï¼Œ
    åˆ†åˆ«å£°æ˜åœ¨ Grallo5.hã€ Grallo4.hã€ Grallo3.hã€ Grallo2.h
    åˆ†åˆ«å®šä¹‰åœ¨ Grallo5.cppã€ Grallo4.cppã€ Grallo3.cppã€ Grallo2.cpp
*/</span>

<span class="token comment">/* frameworks/native/libs/ui/GraphicBufferMapper.cpp */</span>
<span class="token class-name">GraphicBufferMapper</span><span class="token double-colon punctuation">::</span><span class="token function">GraphicBufferMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mMapper <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> Gralloc5Mapper<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mMapper<span class="token operator">-&gt;</span><span class="token function">isLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMapperVersion <span class="token operator">=</span> Version<span class="token double-colon punctuation">::</span>GRALLOC_5<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mMapper <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> Gralloc4Mapper<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mMapper<span class="token operator">-&gt;</span><span class="token function">isLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMapperVersion <span class="token operator">=</span> Version<span class="token double-colon punctuation">::</span>GRALLOC_4<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mMapper <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> Gralloc3Mapper<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mMapper<span class="token operator">-&gt;</span><span class="token function">isLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMapperVersion <span class="token operator">=</span> Version<span class="token double-colon punctuation">::</span>GRALLOC_3<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mMapper <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> Gralloc2Mapper<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mMapper<span class="token operator">-&gt;</span><span class="token function">isLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMapperVersion <span class="token operator">=</span> Version<span class="token double-colon punctuation">::</span>GRALLOC_2<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">&quot;gralloc-mapper is missing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä»¥ Gralloc5Mapper ä¸ºä¾‹</span>
<span class="token comment">/* frameworks/native/libs/ui/Gralloc5.cpp */</span>
status_t <span class="token class-name">Gralloc5Mapper</span><span class="token double-colon punctuation">::</span><span class="token function">importBuffer</span><span class="token punctuation">(</span><span class="token keyword">const</span> native_handle_t <span class="token operator">*</span>rawHandle<span class="token punctuation">,</span>
                                      buffer_handle_t <span class="token operator">*</span>outBufferHandle<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mMapper<span class="token operator">-&gt;</span>v5<span class="token punctuation">.</span><span class="token function">importBuffer</span><span class="token punctuation">(</span>rawHandle<span class="token punctuation">,</span> outBufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Gralloc5Mapper</span><span class="token double-colon punctuation">::</span><span class="token function">Gralloc5Mapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mMapper <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mapper<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> Gralloc5 <span class="token operator">&amp;</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> Gralloc5 instance <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> allocator <span class="token operator">=</span> <span class="token function">waitForAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allocator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Gralloc5<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>so <span class="token operator">=</span> <span class="token function">loadIMapperLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>so<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Gralloc5<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åœ¨åŠ¨æ€é“¾æ¥åº“ so ä¸­æŸ¥æ‰¾åä¸º AIMapper_loadIMapper çš„ç¬¦å·</span>
        <span class="token keyword">auto</span> loadIMapper <span class="token operator">=</span> <span class="token punctuation">(</span>AIMapper_loadIMapperFn<span class="token punctuation">)</span><span class="token function">dlsym</span><span class="token punctuation">(</span>so<span class="token punctuation">,</span> <span class="token string">&quot;AIMapper_loadIMapper&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        AIMapper <span class="token operator">*</span>mapper <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        AIMapper_Error error <span class="token operator">=</span> <span class="token function">loadIMapper</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> AIMAPPER_ERROR_NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;AIMapper_loadIMapper failed %d&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Gralloc5<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Gralloc5<span class="token punctuation">{</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">,</span> mapper<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">loadIMapperLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>imapperLibrary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> allocator <span class="token operator">=</span> <span class="token function">waitForAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string mapperSuffix<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> status <span class="token operator">=</span> allocator<span class="token operator">-&gt;</span><span class="token function">getIMapperLibrarySuffix</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mapperSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get IMapper library suffix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span><span class="token operator">*</span> so <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO(b/322384429) switch this to __ANDROID_API_V__ when V is finalized</span>
        <span class="token keyword">if</span> <span class="token function">API_LEVEL_AT_LEAST</span><span class="token punctuation">(</span>__ANDROID_API_FUTURE__<span class="token punctuation">,</span> <span class="token number">202404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            so <span class="token operator">=</span> <span class="token function">AServiceManager_openDeclaredPassthroughHal</span><span class="token punctuation">(</span><span class="token string">&quot;mapper&quot;</span><span class="token punctuation">,</span> mapperSuffix<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                            RTLD_LOCAL <span class="token operator">|</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>string lib_name <span class="token operator">=</span> <span class="token string">&quot;mapper.&quot;</span> <span class="token operator">+</span> mapperSuffix <span class="token operator">+</span> <span class="token string">&quot;.so&quot;</span><span class="token punctuation">;</span>
            so <span class="token operator">=</span> <span class="token function">android_load_sphal_library</span><span class="token punctuation">(</span>lib_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RTLD_LOCAL <span class="token operator">|</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>so<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load mapper.%s.so&quot;</span><span class="token punctuation">,</span> mapperSuffix<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> so<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> imapperLibrary<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* hardware/interfaces/graphics/mapper/stable-c/include/android/hardware/graphics/mapper/IMapper.h */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AIMapperV5</span> <span class="token punctuation">{</span>
    <span class="token function">AIMapper_Error</span> <span class="token punctuation">(</span><span class="token operator">*</span>_Nonnull importBuffer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> _Nonnull handle<span class="token punctuation">,</span>
                                            buffer_handle_t _Nullable<span class="token operator">*</span> _Nonnull outBufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></blockquote><h3 id="_5-3-åº”ç”¨ç¨‹åºçš„å…¸å‹ç»˜å›¾æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_5-3-åº”ç”¨ç¨‹åºçš„å…¸å‹ç»˜å›¾æµç¨‹" aria-hidden="true">#</a> 5.3 åº”ç”¨ç¨‹åºçš„å…¸å‹ç»˜å›¾æµç¨‹</h3><p><code>BufferQueue</code> å¯ä»¥æœ‰å¤šè¾¾ 32 ä¸ªçš„ <code>BufferSlot</code>ï¼Œä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>ä¸€ä¸ªå¯èƒ½çš„åŸå› å°±æ˜¯æé«˜å›¾å½¢æ¸²æŸ“é€Ÿåº¦ã€‚å› ä¸ºå‡å¦‚åªæœ‰ä¸¤ä¸ª bufferï¼Œå¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œ
å½“åº”ç”¨ç¨‹åºè¿™ä¸ªç”Ÿäº§è€…çš„äº§å‡ºæ•ˆç‡å¤§äºæ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦æ—¶ï¼Œ
å¾ˆå¿«å°±ä¼š dequeue å®Œæ‰€æœ‰ç¼“å†²åŒºè€Œå¤„äºç­‰å¾…çŠ¶æ€ï¼Œä»è€Œå¯¼è‡´ä¸å¿…è¦çš„éº»çƒ¦ã€‚
å½“ç„¶ï¼Œå®é™…ä¸Š 32 åªæ˜¯æœ€å¤§çš„å®¹é‡ï¼Œå…·ä½“å€¼æ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œå¤§å®¶å¯ä»¥ç»“åˆåé¢çš„ Project Butter æ¥è¿›ä¸€æ­¥ç†è§£ã€‚
</code></pre></div><p>æ ¹æ®å‰é¢ä»‹ç»çš„ <code>BufferQueue</code> çš„å†…éƒ¨åŸç†ï¼Œåº”ç”¨ç¨‹åºè¯¥å¦‚ä½•ä¸ä¹‹é…åˆçš„å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>è§£å†³è¿™ä¸ªç–‘æƒ‘çš„å…³é”®å°±æ˜¯äº†è§£åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•æ‰§è¡Œç»˜å›¾æµç¨‹çš„ï¼Œè¿™ä¹Ÿæ˜¯æœ¬èŠ‚å†…å®¹çš„é‡ç‚¹ã€‚

ä¸è¿‡å¤§å®¶åº”è¯¥æœ‰ä¸ªå¿ƒç†å‡†å¤‡ï¼Œå³ï¼šåº”ç”¨ç¨‹åºå¹¶ä¸ä¼šç›´æ¥ä½¿ç”¨ BufferQueueï¼ˆæˆ–è€… Surfaceï¼‰ã€‚
å’Œ Android ç³»ç»Ÿä¸­å¾ˆå¤šå…¶ä»–åœ°æ–¹ä¸€æ ·ï¼Œâ€œå±‚å±‚å°è£…â€ åœ¨è¿™é‡ŒåŒæ ·æ˜¯å­˜åœ¨çš„ã€‚
å› è€Œæˆ‘ä»¬ä¸€æ–¹é¢è¦å°½é‡æŠ“ä½æ ¸å¿ƒï¼Œå¦ä¸€æ–¹é¢ä¹Ÿè¦è¾…ä»¥æœ‰æ•ˆçš„åˆ†ææ‰‹æ®µï¼Œæ‰èƒ½æ›´å¿«æ›´å¥½åœ°ä»è¯¸å¤šé”™ç»¼å¤æ‚çš„ç±»å…³ç³»ä¸­æ‰¾å‡ºé—®é¢˜çš„ç­”æ¡ˆã€‚
</code></pre></div><p>æœ¬å°èŠ‚é€‰å– â€œç³»ç»Ÿå¼€æœºåŠ¨ç”»â€ è¿™ä¸€åº”ç”¨ç¨‹åºä¸ºä¾‹ï¼Œæ¥åˆ†æåº”ç”¨ç¨‹åºå›¾å½¢ç»˜åˆ¶çš„æµç¨‹ã€‚</p><blockquote><p>å¼€æœºåŠ¨ç”»åº”ç”¨ç¨‹åºä¸ <code>SurfaceFlinger</code> éƒ½æ˜¯ä½¿ç”¨ <code>OpenGL ES</code> æ¥å®Œæˆ <code>UI</code> æ˜¾ç¤ºçš„ã€‚</p><p>ä¸è¿‡å› ä¸ºå¼€æœºåŠ¨ç”»æ˜¯ä¸€ä¸ª <code>C++</code> ç¨‹åºï¼Œæ‰€ä»¥ä¸éœ€è¦ä¸Šå±‚ <code>GLSurfaceView</code> çš„æ”¯æŒã€‚</p></blockquote><p>å½“ä¸€ä¸ª <code>Android</code> è®¾å¤‡ä¸Šç”µåï¼Œæ­£å¸¸æƒ…å†µä¸‹å®ƒä¼šå…ˆåæ˜¾ç¤ºæœ€å¤š 4 ä¸ªä¸åŒçš„å¼€æœºç”»é¢ã€‚åˆ†åˆ«æ˜¯ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>BootLoader
    è¿™æ˜¯ç¬¬ä¸€ä¸ªå‡ºç°çš„ç”»é¢ã€‚
    å› ä¸º boot-loader åªæ˜¯è´Ÿè´£ç³»ç»Ÿåç»­æ¨¡å—çš„åŠ è½½ä¸å¯åŠ¨ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬åªè®©å®ƒæ˜¾ç¤ºä¸€å¼ é™æ€çš„å›¾ç‰‡ã€‚

Kernel
    å†…æ ¸ä¹Ÿæœ‰è‡ªå·±çš„æ˜¾ç¤ºç”»é¢ã€‚
    å’Œ boot-loader ä¸€æ ·ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒä¹Ÿåªæ˜¯ä¸€å¼ é™æ€å›¾ç‰‡ã€‚

Androidï¼ˆæœ€å¤š 2 ä¸ªï¼‰
    Android æ˜¯ç³»ç»Ÿå¯åŠ¨çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼Œä¹Ÿæ˜¯æœ€è€—æ—¶é—´çš„ä¸€ä¸ªã€‚
    å®ƒçš„å¼€æœºç”»é¢æ—¢å¯ä»¥æ˜¯é™æ€çš„æ–‡å­—ã€å›¾ç‰‡ï¼Œä¹Ÿå¯ä»¥æ˜¯åŠ¨æ€çš„ç”»é¢ã€‚
    å¦å¤–ï¼Œè¿™ä¸€é˜¶æ®µå¯ä»¥åŒ…å«æœ€å¤šä¸¤ä¸ªå¼€æœºç”»é¢ï¼š
        1. é€šå¸¸å‰ä¸€ä¸ªæ˜¯æ–‡å­—æˆ–è€…é™æ€å›¾ç‰‡ï¼ˆæ³¨æ„ï¼šé»˜è®¤æ˜¯å›¾ç‰‡ï¼Œä½†å¦‚æœå›¾ç‰‡ä¸å­˜åœ¨çš„è¯ï¼Œå°±æ˜¾ç¤ºæ–‡å­—ï¼‰ï¼›
        2. å¦å¤–ä¸€ä¸ªåˆ™æ˜¯åŠ¨ç”»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
</code></pre></div><p><img src="/assets/07.f0964739.png" alt="" loading="lazy"></p><p>è¿™ä¸ªå¼€æœºåŠ¨ç”»çš„å®ç°ç±»æ˜¯ <code>BootAnimation</code>ï¼Œå®ƒçš„å†…éƒ¨å°±æ˜¯å€ŸåŠ©äº SurfaceFlinger æ¥å®Œæˆçš„ã€‚</p><p>å¦å¤–ï¼Œç”±äºå®ƒå¹¶ä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ <code>Java</code> å±‚åº”ç”¨ç¨‹åºï¼Œä»è€Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æŠ›ç¦»å¾ˆå¤šä¸Šå±‚çš„ç‰µç»Šï¼ˆæ¯”å¦‚ä¸€å¤§å † <code>JNI</code> è°ƒç”¨ï¼‰ï¼Œè¿›è€Œä»¥æœ€ç›´è§‚çš„æ–¹å¼æ¥å®¡è§† <code>BufferQueue</code> çš„ä½¿ç”¨ç»†èŠ‚ï¼Œè¿™æ˜¯åˆ†ææœ¬èŠ‚é—®é¢˜çš„æœ€ä½³é€‰æ‹©ã€‚</p><p><code>BootAnimation</code> æ˜¯ä¸€ä¸ª <code>C++</code> ç¨‹åºï¼Œå…¶å·¥ç¨‹æºç è·¯å¾„æ˜¯ï¼š</p><p><img src="/assets/08.9d069137.png" alt="" loading="lazy"></p><p>å’Œå¾ˆå¤š <code>native</code> åº”ç”¨ä¸€æ ·ï¼Œå®ƒä¹Ÿæ˜¯åœ¨ <code>init</code> è„šæœ¬ä¸­è¢«å¯åŠ¨çš„ã€‚å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>service bootanim <span class="token operator">/</span>system<span class="token operator">/</span>bin<span class="token operator">/</span>bootanimation
    <span class="token keyword">class</span> <span class="token class-name">main</span>
    user graphics
    group graphics
    disabled
    oneshot
</code></pre></div><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ï¼Œç•¥æœ‰ä¸åŒï¼Œå‚è€ƒï¼š</p><p><a href="https://cloud.tencent.com/developer/article/2358064" target="_blank" rel="noopener noreferrer">Android å¼€æœºåŠ¨ç”»å¯åŠ¨æµç¨‹<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://blog.csdn.net/m0_46857231/article/details/123066642" target="_blank" rel="noopener noreferrer">å®‰å“ 12 å¼€æœºåŠ¨ç”» Bootanimation æºç åˆ†æ-å¯åŠ¨æµç¨‹<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><p>å½“ <code>bootanimation</code> è¢«å¯åŠ¨åï¼Œå®ƒé¦–å…ˆä¼šè¿›å…¥ <code>main</code> å‡½æ•°ï¼ˆå³ <code>main@bootanimation_main.cpp</code>ï¼‰ç”Ÿæˆä¸€ä¸ª <code>BootAnimation</code> å¯¹è±¡ï¼Œå¹¶å¼€å¯çº¿ç¨‹æ± ï¼ˆå› ä¸ºå®ƒéœ€è¦ä¸ <code>SurfaceFlinger</code> ç­‰ç³»ç»ŸæœåŠ¡è¿›è¡Œè·¨è¿›ç¨‹çš„é€šä¿¡ï¼‰ã€‚åœ¨ <code>BootAnimation</code> çš„æ„é€ å‡½æ•°ä¸­ï¼ŒåŒæ—¶ä¼šç”Ÿæˆä¸€ä¸ª <code>SurfaceComposerClient</code>ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/base/cmds/bootanimation/BootAnimation.cpp */</span>
<span class="token class-name">BootAnimation</span><span class="token double-colon punctuation">::</span><span class="token function">BootAnimation</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>Callbacks<span class="token operator">&gt;</span> callbacks<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mLooper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Looper</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">SurfaceComposerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>SurfaceComposerClient</code> æ˜¯æ¯ä¸ª UI åº”ç”¨ç¨‹åºä¸ <code>SurfaceFlinger</code> é—´çš„ç‹¬ç«‹çº½å¸¦ï¼Œåç»­å¾ˆå¤šæ“ä½œéƒ½æ˜¯é€šè¿‡å®ƒæ¥å®Œæˆçš„ã€‚</p><p>ä¸è¿‡ <code>SurfaceComposerClient</code> æ›´å¤šçš„åªæ˜¯ä¸€ä¸ªå°è£…ï¼ŒçœŸæ­£èµ·ä½œç”¨çš„è¿˜æ˜¯å…¶å†…éƒ¨çš„ <code>ISurfaceComposerClient</code>ã€‚</p><p>å‰é¢å°èŠ‚ä¸­æˆ‘ä»¬å·²ç»è®²è§£äº† <code>IGraphicBufferProducer</code> ä¸ <code>ISurfaceComposerClient</code> åœ¨åº”ç”¨ç¨‹åºä¸­çš„è·å–é¡ºåºï¼Œé‚£ä¹ˆä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>ç®€å•æ¥è¯´ï¼Œ
ISurfaceComposerClient æ˜¯åº”ç”¨ç¨‹åºä¸ SurfaceFlinger é—´çš„æ¡¥æ¢ï¼Œ
IgraphicBufferProducer åˆ™æ˜¯åº”ç”¨ç¨‹åºä¸ BufferQueue é—´çš„ä¼ è¾“é€šé“ã€‚

è¿™æ ·çš„è®¾è®¡æ˜¯åˆç†çš„ï¼Œä½“ç°äº†æ¨¡å—åŒ–çš„æ€æƒ³ï¼š
    SurfaceFlinger çš„èŒè´£æ˜¯ â€œFlingerâ€ï¼Œå³æŠŠç³»ç»Ÿä¸­æ‰€æœ‰åº”ç”¨ç¨‹åºæœ€ç»ˆçš„ â€œç»˜å›¾ç»“æœâ€ è¿›è¡Œ â€œæ··åˆâ€ï¼Œç„¶åç»Ÿä¸€æ˜¾ç¤ºåˆ°ç‰©ç†å±å¹•ä¸Šã€‚
    å®ƒä¸åº”è¯¥ä¹Ÿæ²¡æœ‰åŠæ³•åˆ†å‡ºå¤ªå¤šçš„ç²¾åŠ›å»é€ä¸€å…³æ³¨å„ä¸ªåº”ç”¨ç¨‹åºçš„ â€œç»˜ç”»è¿‡ç¨‹â€ã€‚
    è¿™ä¸ªä»»åŠ¡è‡ªç„¶è€Œç„¶åœ°è½åœ¨äº† BufferQueue çš„è‚©è†€ä¸Šï¼Œ
    å®ƒæ˜¯ SurfaceFlinger æ´¾å‡ºçš„ä»£è¡¨ï¼Œä¹Ÿæ˜¯æ¯ä¸ªåº”ç”¨ç¨‹åº â€œä¸€å¯¹ä¸€â€ çš„è¾…å¯¼è€å¸ˆï¼Œ
    æŒ‡å¯¼ç€ UI ç¨‹åºçš„ â€œç”»æ¿ç”³è¯·â€ã€â€œä½œç”»æµç¨‹â€ ç­‰ä¸€ç³»åˆ—çƒ¦çç»†èŠ‚ã€‚
</code></pre></div><p>æ‰€ä»¥ BootAnimation åœ¨å…¶æ„é€ å‡½æ•°ä¸­å°±å»ºç«‹äº†ä¸ SurfaceFlinger çš„è¿æ¥é€šé“ã€‚</p><p>é‚£ä¹ˆï¼Œå®ƒåœ¨ä»€ä¹ˆæ—¶å€™ä¼šå†å»å»ºç«‹ä¸ BufferQueue çš„è¿æ¥å‘¢ï¼Ÿ</p><p>å› ä¸º BootAnimation ç»§æ‰¿è‡ª RefBaseï¼Œå½“ main å‡½æ•°ä¸­é€šè¿‡ sp æŒ‡é’ˆå¼•ç”¨å®ƒæ—¶ï¼Œä¼šè§¦å‘å¦‚ä¸‹å‡½æ•°ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token double-colon punctuation">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ç¬¬ä¸€æ¬¡è¢«å¼•ç”¨æ—¶</span>
    status_t err <span class="token operator">=</span> mSession<span class="token operator">-&gt;</span><span class="token function">linkToComposerDeath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç›‘å¬æ­»äº¡äº‹ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>        
        <span class="token function">run</span><span class="token punctuation">(</span><span class="token string">&quot;BootAnimation&quot;</span><span class="token punctuation">,</span> PRIORITY_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¼€å¯çº¿ç¨‹</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ï¼Œ<code>BootAnimation::run</code> æ–¹æ³•åœ¨ <code>main@bootanimation_main.cpp</code> å‡½æ•°ä¸­æ‰§è¡Œï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">bool</span> noBootAnimation <span class="token operator">=</span> <span class="token function">bootAnimationDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>noBootAnimation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">&gt;</span> <span class="token function">proc</span><span class="token punctuation">(</span><span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">startThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// create the boot animation object (may take up to 200ms for 2MB zip)</span>
        sp<span class="token operator">&lt;</span>BootAnimation<span class="token operator">&gt;</span> boot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BootAnimation</span><span class="token punctuation">(</span>audioplay<span class="token double-colon punctuation">::</span><span class="token function">createAnimationCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        boot<span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">&quot;BootAnimation&quot;</span><span class="token punctuation">,</span> PRIORITY_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡Œ BootAnimation::run å‡½æ•°</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">joinThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></blockquote><p>å½“ä¸€ä¸ª <code>Client</code> ä¸è¿œç¨‹ <code>Server</code> å»ºç«‹äº† <code>Binder</code> é€šä¿¡åï¼Œå®ƒå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª <code>Server</code> çš„æœåŠ¡äº†ï¼Œä½†å‰ææ˜¯æœåŠ¡å™¨è¿è¡Œæ­£å¸¸ã€‚</p><p>æ¢å¥è¯è¯´ï¼Œå‡å¦‚å‡ºç°äº† <code>Server</code> å¼‚å¸¸çš„æƒ…å†µï¼Œ<code>Client</code> åˆå¦‚ä½•çŸ¥é“å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>è¿™å°±æ˜¯ linkToComposerDeath è¦è§£å†³çš„é—®é¢˜ï¼Œ
linkToComposerDeath çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡æ˜äº†æ¥æ”¶ Binder Server æ­»äº¡äº‹ä»¶çš„äººï¼Œåœ¨æœ¬ä¾‹ä¸­å°±æ˜¯ BootAnimation è‡ªèº«ã€‚
æ‰€ä»¥ BootAnimation ç»§æ‰¿äº†I Binder::DeathRecipientï¼Œå¹¶å®ç°äº†å…¶ä¸­çš„ binderDied æ¥å£ã€‚
</code></pre></div><p>å¦‚æœ <code>BootAnimation::onFirstRef</code> ä¸­ <code>err == NO_ERROR</code> æˆç«‹çš„è¯ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è¦å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰¿è½½ä¸šåŠ¡äº†ã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦ç‹¬ç«‹åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>å‰é¢ main å‡½æ•°ä¸­ï¼Œå¤§å®¶åº”è¯¥å‘ç°äº† BootAnimation å¯åŠ¨äº† Binder çº¿ç¨‹æ± ã€‚
å¯ä»¥æƒ³è±¡åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯ä¸å¯èƒ½æ—¢ç›‘å¬ Binder è¯·æ±‚ï¼Œåˆå»åšå¼€æœºåŠ¨ç”»ç»˜åˆ¶çš„ã€‚
</code></pre></div><p>å½“ä¸€ä¸ªæ–°çš„çº¿ç¨‹è¢« <code>run</code> èµ·æ¥åï¼Œåˆè§¦å‘äº†ä¸‹åˆ—å‡½æ•°çš„è°ƒç”¨ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/base/cmds/bootanimation/BootAnimation.cpp */</span>
status_t <span class="token class-name">BootAnimation</span><span class="token double-colon punctuation">::</span><span class="token function">readyToRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>â€¦   
    <span class="token comment">/* ç¬¬ä¸€éƒ¨åˆ†ï¼Œå‘serverç«¯è·å–bufferç©ºé—´ï¼Œä»è€Œå¾—åˆ°EGLéœ€è¦çš„æœ¬åœ°çª—å£ */</span>
    sp<span class="token operator">&lt;</span>SurfaceControl<span class="token operator">&gt;</span> control <span class="token operator">=</span> 
        <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">createSurface</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span><span class="token string">&quot;BootAnimation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dinfo<span class="token punctuation">.</span>w<span class="token punctuation">,</span> dinfo<span class="token punctuation">.</span>h<span class="token punctuation">,</span> PIXEL_FORMAT_RGB_565<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SurfaceComposerClient</span><span class="token double-colon punctuation">::</span><span class="token function">openGlobalTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    control<span class="token operator">-&gt;</span><span class="token function">setLayer</span><span class="token punctuation">(</span><span class="token number">0x40000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SurfaceComposerClient</span><span class="token double-colon punctuation">::</span><span class="token function">closeGlobalTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>Surface<span class="token operator">&gt;</span> s <span class="token operator">=</span> control<span class="token operator">-&gt;</span><span class="token function">getSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* ä»¥ä¸‹ä¸ºç¬¬äºŒéƒ¨åˆ†ï¼Œå³ EGL çš„é…ç½®æµç¨‹ */</span>
    <span class="token keyword">const</span> EGLint attribs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">/* å±æ€§å€¼è¾ƒå¤šï¼Œä¸ºäº†èŠ‚çº¦ç¯‡å¹…ï¼Œæˆ‘ä»¬çœç•¥å…·ä½“å†…å®¹ */</span>
    EGLint w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> dummy<span class="token punctuation">;</span>
    EGLint numConfigs<span class="token punctuation">;</span> <span class="token comment">//æ€»å…±æœ‰å¤šå°‘ä¸ª config</span>
    EGLConfig config<span class="token punctuation">;</span>
    EGLSurface surface<span class="token punctuation">;</span>
    EGLContext context<span class="token punctuation">;</span>
    <span class="token comment">// ç¬¬ä¸€æ­¥ï¼Œå¾—åˆ°é»˜è®¤çš„ç‰©ç†å±å¹•</span>
    EGLDisplay display <span class="token operator">=</span> <span class="token function">eglGetDisplay</span><span class="token punctuation">(</span>EGL_DEFAULT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// ç¬¬äºŒæ­¥ï¼Œåˆå§‹åŒ–</span>
    <span class="token function">eglInitialize</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// ç¬¬ä¸‰æ­¥ï¼Œé€‰å–æœ€ä½³çš„ config</span>
    <span class="token function">eglChooseConfig</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> attribs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>numConfigs<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// ç¬¬å››æ­¥ï¼Œé€šè¿‡æœ¬åœ°çª—å£åˆ›å»º Surface</span>
    surface <span class="token operator">=</span> <span class="token function">eglCreateWindowSurface</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> config<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// ç¬¬äº”æ­¥ï¼Œåˆ›å»º context ç¯å¢ƒ</span>
    context <span class="token operator">=</span> <span class="token function">eglCreateContext</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// ç¬¬å…­æ­¥ï¼Œè®¾ç½®å½“å‰ç¯å¢ƒ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">eglMakeCurrent</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> surface<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">==</span> EGL_FALSE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> NO_INIT<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>è¿™ä¸ªå‡½æ•°ä¸ä½†å‘æˆ‘ä»¬å±•ç¤ºäº†åº”ç”¨ç¨‹åºä¸ <code>BufferQueue</code> çš„é€šä¿¡è¿‡ç¨‹ï¼Œ</p><p>è€Œä¸”è¿˜æœ‰å¦å¤–ä¸€ä¸ªé‡è¦çš„å­¦ä¹ ç‚¹ï¼Œå³ <code>Opengl ES</code> ä¸ <code>EGL</code> çš„ä½¿ç”¨æµç¨‹ã€‚</p></blockquote><div class="language-text ext-text"><pre class="language-text"><code>å‡½æ•° readyToRun é¦–å…ˆé€šè¿‡ session()-&gt;createSurface() æ¥è·å–ä¸€ä¸ª SurfaceControlã€‚
å…¶ä¸­ session() å¾—åˆ°çš„æ˜¯ mSession å˜é‡ï¼Œä¹Ÿå°±æ˜¯å‰é¢æ„é€ å‡½æ•°ä¸­ç”Ÿæˆçš„ SurfaceComposerClient å¯¹è±¡ï¼Œ
æ‰€ä»¥ SurfaceComposerClient::createSurface() æœ€ç»ˆå°±æ˜¯ç”± SurfaceFlinger ç›¸å…³è”çš„æœåŠ¡æ¥å®ç°çš„ã€‚
</code></pre></div><p>å…·ä½“è€Œè¨€ï¼Œ<code>SurfaceComposerClient</code> å¯¹åº”çš„ <code>Server</code> ç«¯çš„å®ç°æ˜¯ <code>Client(C++)</code>ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/libs/gui/SurfaceComposerClient.cpp */</span>
sp<span class="token operator">&lt;</span>SurfaceControl<span class="token operator">&gt;</span> <span class="token class-name">SurfaceComposerClient</span><span class="token double-colon punctuation">::</span><span class="token function">createSurface</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token function">createSurfaceChecked</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

status_t <span class="token class-name">SurfaceComposerClient</span><span class="token double-colon punctuation">::</span><span class="token function">createSurfaceChecked</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    binder<span class="token double-colon punctuation">::</span>Status status <span class="token operator">=</span> mClient<span class="token operator">-&gt;</span><span class="token function">createSurface</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">/* frameworks/native/libs/gui/include/gui/SurfaceComposerClient.h */</span>
<span class="token keyword">class</span> <span class="token class-name">SurfaceComposerClient</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">RefBase</span></span>
<span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>ISurfaceComposerClient<span class="token operator">&gt;</span>  mClient<span class="token punctuation">;</span>

<span class="token comment">/* frameworks/native/services/surfaceflinger/Client.h */</span>
<span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> gui<span class="token double-colon punctuation">::</span><span class="token class-name">BnSurfaceComposerClient</span></span> 
<span class="token punctuation">{</span>

<span class="token comment">/*frameworks/native/services/surfaceflinger/Client.cpp*/</span>
status_t <span class="token class-name">Client</span><span class="token double-colon punctuation">::</span><span class="token function">createSurface</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    sp<span class="token operator">&lt;</span>MessageBase<span class="token operator">&gt;</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MessageCreateLayer</span><span class="token punctuation">(</span>mFlinger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> format<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> gbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFlinger<span class="token operator">-&gt;</span><span class="token function">postMessageSync</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å‘é€ç»™ SurfaceFlinger è¿›è¡Œå¤„ç†</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>MessageCreateLayer<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Client::createSurface</code> å‡½æ•°å°†ç”¨æˆ·çš„è¯·æ±‚é€šè¿‡æ¶ˆæ¯æ¨é€åˆ°å‰è€…çš„å¤„ç†é˜Ÿåˆ—ä¸­ï¼Œç­‰åˆ°æœ‰ç»“æœåæ‰è¿”å›ã€‚</p><blockquote><p>ä» <code>postMessageSync</code> åç§°å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªåŒæ­¥å‡½æ•°ï¼Œ</p><p>å…³äº <code>Client</code> ä¸ <code>SurfaceFlinger</code> é—´çš„è¿™ç§å·¥ä½œæ–¹å¼ï¼Œæˆ‘ä»¬ä¼šæ”¾åœ¨åç»­ <code>SurfaceFlinger</code> å°èŠ‚ä½œè¯¦ç»†è§£é‡Šã€‚</p></blockquote><p>å› è€Œæœ€ç»ˆè¿˜æ˜¯è¦ç”± <code>SurfaceFlinger</code> æ¥æ‰§è¡Œæ“ä½œï¼Œåªä¸è¿‡ â€œæ“ä½œçš„å†…å®¹â€ åˆæ˜¯ç”± <code>Message</code> æœ¬èº«æä¾›çš„ã€‚</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">MessageCreateLayer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">MessageBase</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> flinger<span class="token operator">-&gt;</span><span class="token function">createLayer</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> client<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> format<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>handle<span class="token punctuation">,</span> gbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ï¼Œ<code>Client::createSurface</code> å‡½æ•°ä¸­ä¸å†è°ƒç”¨ <code>mFlinger-&gt;postMessageSync</code> å‘æ¶ˆæ¯ï¼Œ</p><p>è€Œæ˜¯ç›´æ¥è°ƒç”¨ <code>mFlinger-&gt;createLayer</code>ã€‚</p></blockquote><p>ç°åœ¨çš„é—®é¢˜å°±è½¬æ¢ä¸ºï¼š<strong><code>createLayer</code> ç”Ÿæˆäº†ä»€ä¹ˆå¯¹è±¡å‘¢ï¼Ÿ</strong></p><p>æ²¡é”™ï¼Œå°±æ˜¯ <code>IGraphicBufferProducer</code>ã€‚</p><p>å¦‚ä¸‹ä»£ç çœç•¥äº†ä¸­é—´ä¸€å¤§æ®µè¿‡ç¨‹ï¼Œåªä¿ç•™ä¸é—®é¢˜ç›¸å…³çš„éƒ¨åˆ†ï¼Œæ›´è¯¦ç»†çš„åˆ†æå¯ä»¥å‚è§åç»­å°èŠ‚ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>status_t <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">createLayer</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">*</span> gbp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    status_t result <span class="token operator">=</span> NO_ERROR<span class="token punctuation">;</span>

    sp<span class="token operator">&lt;</span>Layer<span class="token operator">&gt;</span> layer<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ISurfaceComposerClient<span class="token double-colon punctuation">::</span>eFXSurfaceMask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ISurfaceComposerClient<span class="token double-colon punctuation">::</span>eFXSurfaceNormal<span class="token operator">:</span> <span class="token comment">// æ™®é€š Surface</span>
            result <span class="token operator">=</span> <span class="token function">createNormalLayer</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span>name<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> format<span class="token punctuation">,</span>handle<span class="token punctuation">,</span> gbp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ISurfaceComposerClient<span class="token double-colon punctuation">::</span>eFXSurfaceDim<span class="token operator">:</span>
            result <span class="token operator">=</span> <span class="token function">createDimLayer</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span>name<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>handle<span class="token punctuation">,</span> gbp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            result <span class="token operator">=</span> BAD_VALUE<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é€šè¿‡ä¸Šé¢çš„ä»£ç æ®µå¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œ<code>SurfaceFlinger</code> ä¸ä½†ç”Ÿæˆäº† <code>IGraphicBufferProducer</code> å¯¹è±¡ï¼Œè€Œä¸”å¼•å…¥äº†æ–°çš„æ¦‚å¿µï¼š<strong><code>Layer</code></strong>ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>Layer ç±»åœ¨ SurfaceFlinger ä¸­è¡¨ç¤º â€œå±‚â€ï¼Œé€šä¿—åœ°è®²å°±æ˜¯ä»£è¡¨äº†ä¸€ä¸ª â€œç”»é¢â€ï¼Œ
æœ€ç»ˆç‰©ç†å±å¹•ä¸Šçš„æ˜¾ç¤ºç»“æœå°±æ˜¯é€šè¿‡å¯¹ç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨çš„æ‰€æœ‰ â€œç”»é¢â€ è¿›è¡Œå¤„ç†è€Œå¾—åˆ°çš„ã€‚

è¿™å°±å¥½æ¯”ä¸€æ’äººï¼ˆåˆ—é˜Ÿï¼‰å„ä¸¾ç€ä¸€å¼ ç»˜ç”»ä½œå“ï¼Œé‚£ä¹ˆè§‚å¯Ÿè€…ä»æœ€å‰é¢å¾€åçœ‹æ—¶ï¼Œä»–é¦–å…ˆçœ‹åˆ°çš„å°±æ˜¯ç¬¬ä¸€å¼ ç”»ï¼›
è€Œå‡å¦‚ç¬¬ä¸€å¼ ç”»æ°å¥½æ¯”ç¬¬äºŒå¼ å°ï¼Œåˆæˆ–è€…ç¬¬ä¸€å¼ æ˜¯é€æ˜/åŠé€æ˜çš„ï¼ˆè¿™å¹¶éä¸å¯èƒ½ï¼Œå¦‚ä½œè€…æ˜¯åœ¨ç»ç’ƒä¸Šåˆ›ä½œçš„ï¼‰ï¼Œé‚£ä¹ˆä»–å°±èƒ½çœ‹åˆ°ç¬¬äºŒå¼ ç”»ã€‚
ä¾æ­¤ç±»æ¨ï¼Œæœ€ç»ˆçœ‹åˆ°çš„å°±æ˜¯è¿™äº› â€œç”»â€ï¼ˆLayerï¼‰çš„æ··åˆï¼ˆFlingerï¼‰ç»“æœã€‚
</code></pre></div><p>ä»¥ä¸Šç±»æ¯”å‘Šè¯‰æˆ‘ä»¬ï¼Œ<code>layer</code> æ˜¯æœ‰å±‚çº§çš„ï¼Œè¶Šé è¿‘ç”¨æˆ·çš„é‚£ä¸ª â€œå±‚â€ å°±è¶Šæœ‰ä¼˜åŠ¿ã€‚</p><p>äº†è§£äº† <code>layer</code> çš„å±‚çº§æ¦‚å¿µåï¼Œå‡½æ•° <code>BootAnimation::readyToRun</code> æ¥ä¸‹æ¥è°ƒç”¨ <code>setLayer</code> å°±ä¸éš¾ç†è§£äº†ã€‚</p><p>ä¸è¿‡å‚æ•°ä¸­ä¼ å…¥äº†ä¸€ä¸ªæ•°å€¼ <code>0x40000000</code>ï¼Œè¿™åˆæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>å…¶å®è¿™ä¸ªå€¼å°±æ˜¯ layer çš„å±‚çº§ï¼Œåœ¨æ˜¾ç¤ºç³»ç»Ÿä¸­é€šå¸¸è¢«ç§°ä¸º Z-Orderï¼Œè€Œä¸”æ•°å­—è¶Šå¤§å°±è¶Šé è¿‘ç”¨æˆ·ã€‚

BootAnimation æ˜¾ç¤ºæ—¶å› ä¸ºæ•´ä¸ªç³»ç»Ÿä¸­è¿˜åªæœ‰å¼€æœºç”»é¢ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦æ‹…å¿ƒ Z-Order çš„é—®é¢˜ã€‚
æ¢å¥è¯è¯´ï¼Œ0x40000000 è¿™ä¸ªå€¼è¶³çŸ£ã€‚
</code></pre></div><p>è®¾ç½®å®Œå±‚çº§åï¼Œ<code>BootAnimation::readyToRun</code> æ¥ç€è°ƒç”¨ <code>control-&gt;getSurface()</code> æ¥å¾—åˆ°ä¸€ä¸ª <code>Surface</code> å¯¹è±¡ã€‚</p><blockquote><p><code>Surface</code> å¯¹è±¡å°±æ˜¯ â€œ<code>Android</code> ä¸­çš„æœ¬åœ°çª—å£â€ å°èŠ‚ä¸­ä»‹ç»çš„å…¶ä¸­ä¸€ä¸ªæœ¬åœ°çª—å£</p><p>è¯¦è§ï¼š <a href="#_9-4-2-1-surface-%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B">9.4.2.1 Surface çš„åˆ›å»ºæµç¨‹</a></p></blockquote><blockquote><p>æ¶‰åŠçš„ç›¸å…³ç±»è¶Šæ¥è¶Šå¤šï¼Œä¸ºäº†é¿å…æ··æ·†ï¼Œæˆ‘ä»¬å…ˆæ¥æ•´ç†ä¸‹ç›®å‰å·²ç»å‡ºç°çš„å„ä¸ªç±»çš„å…³ç³»ï¼š</p></blockquote><div class="language-text ext-text"><pre class="language-text"><code>ISurfaceComposerClientï¼š
    åº”ç”¨ç¨‹åºä¸ SurfaceFlinger é—´çš„é€šé“ï¼Œåœ¨åº”ç”¨è¿›ç¨‹ä¸­åˆ™è¢«å°è£…åœ¨ SurfaceComposerClient è¿™ä¸ªç±»ä¸­ã€‚
    è¿™æ˜¯ä¸€ä¸ªåŒ¿åçš„ Binder Serverï¼Œ
    ç”±åº”ç”¨ç¨‹åºè°ƒç”¨ SurfaceFlinger è¿™ä¸ªå®å Binder çš„ createConnection æ–¹æ³•æ¥è·å–åˆ°ï¼Œ
    ï¼ˆå…·ä½“ä½ç½®åœ¨ SurfaceComposerClient::onFirstRef ä¸­ï¼‰
    æœåŠ¡ç«¯çš„å®ç°æ˜¯ frameworks/native/services/surfaceflinger/Client.hã€‚

IGraphicBufferProducerï¼š
    ç”±åº”ç”¨ç¨‹åºè°ƒç”¨ ISurfaceComposerClient::createSurface() å¾—åˆ°ï¼Œ
    åŒæ—¶åœ¨ SurfaceFlinger è¿™ä¸€è¿›ç¨‹ä¸­å°†ä¼šæœ‰ä¸€ä¸ª Layer è¢«åˆ›å»ºï¼Œä»£è¡¨äº†ä¸€ä¸ª â€œç”»é¢â€ã€‚
    ISurface å°±æ˜¯æ§åˆ¶è¿™ä¸€ç”»é¢çš„ handleï¼Œå®ƒå°†ä¿å­˜åœ¨åº”ç”¨ç¨‹åºç«¯çš„ SurfaceControl ä¸­ã€‚

Surfaceï¼š
    ä»é€»è¾‘å…³ç³»ä¸Šçœ‹ï¼Œå®ƒæ˜¯ä¸Šè¿° ISurface çš„ä½¿ç”¨è€…ã€‚
    ä»ç»§æ‰¿å…³ç³»ä¸Šçœ‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ¬åœ°çª—å£ã€‚
    Surface å†…éƒ¨æŒæœ‰ IGraphicBufferProducerï¼Œå³ BufferQueue çš„å®ç°æ¥å£ã€‚
    æ¢ä¸ªè§’åº¦æ¥æ€è€ƒï¼Œå½“ EGL æƒ³é€šè¿‡ Surface è¿™ä¸ªæœ¬åœ°çª—å£å®ŒæˆæŸäº›åŠŸèƒ½æ—¶ï¼Œ
    Surface å®é™…ä¸Šåˆåˆ©ç”¨ ISurface å’Œ IGraphicBufferProducer æ¥å–å¾—è¿œç¨‹æœåŠ¡ç«¯çš„å¯¹åº”æœåŠ¡ï¼Œä»¥å®Œæˆ EGL çš„è¯·æ±‚ã€‚
</code></pre></div><p>å›åˆ° <code>BootAnimation::readyToRun()</code> ä¸­ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>å› ä¸ºæœ¬åœ°çª—å£ Surface å·²ç»æˆåŠŸåˆ›å»ºï¼Œæ¥ä¸‹æ¥å°±è¯¥ EGL ä¸Šåœºäº†ã€‚
å…·ä½“æµç¨‹æˆ‘ä»¬åœ¨ä»£ç ä¸­éƒ½åŠ äº†æ³¨é‡Šï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚
</code></pre></div><p>å½“ <code>EGL</code> å‡†å¤‡å¥½ç¯å¢ƒåï¼Œæ„å‘³ç€ç¨‹åºå¯ä»¥æ­£å¸¸ä½¿ç”¨ <code>OpenGL ES</code> æä¾›çš„å„ç§ <code>API</code> å‡½æ•°è¿›è¡Œç»˜å›¾äº†ã€‚</p><blockquote><p>è¿™éƒ¨åˆ†å®ç°å°±é›†ä¸­åœ¨éšåçš„ <code>BootAnimation::threadLoop()</code></p><p>ä»¥åŠ <code>BootAnimation::android()/BootAnimation::movie()</code> ä¸­ã€‚</p></blockquote><p>æœ€åï¼Œå¯¹ä¸€ä¸ªå…¸å‹çš„åº”ç”¨ç¨‹åºä½¿ç”¨ SurfaceFlinger è¿›è¡Œç»˜å›¾çš„æµç¨‹æ€»ç»“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><blockquote><p>å…¶ä¸­æ¶‰åŠ <code>IgraphicBufferProducer</code>ã€<code>Surface</code>ã€<code>SurfaceControl</code>ã€<code>Layer</code> ç­‰å¤ªå¤šå…ƒç´ ï¼Œåªé€‰å–éƒ¨åˆ†é‡ç‚¹ç±»è¿›è¡Œå±•ç¤º</p></blockquote><p><img src="/assets/09.10599114.png" alt="" loading="lazy"></p><h3 id="_5-4-åº”ç”¨ç¨‹åºä¸-bufferqueue-çš„å…³ç³»" tabindex="-1"><a class="header-anchor" href="#_5-4-åº”ç”¨ç¨‹åºä¸-bufferqueue-çš„å…³ç³»" aria-hidden="true">#</a> 5.4 åº”ç”¨ç¨‹åºä¸ <code>BufferQueue</code> çš„å…³ç³»</h3><p>ç°åœ¨æˆ‘ä»¬å·²ç»æ˜ç™½äº†åº”ç”¨ç¨‹åºåˆ©ç”¨ <code>SurfaceFlinger</code> è¿›è¡Œç»˜åˆ¶å·¥ä½œçš„å¤§è‡´æµç¨‹ï¼Œåªä¸è¿‡åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ç›´åˆ°æœ€åæ‰å‡ºç°äº† <code>BufferQueue</code>ã€‚</p><p><strong>é‚£ä¹ˆï¼Œåº”ç”¨ç¨‹åºå…·ä½“æ˜¯å¦‚ä½•å€ŸåŠ© <code>BufferQueue</code> æ¥å®Œæˆå·¥ä½œçš„å‘¢ï¼Ÿ</strong></p><p>ä»”ç»†è§‚å¯Ÿä¸éš¾å‘ç°ï¼Œå½“åº”ç”¨ç¨‹åºç«¯é€šè¿‡ <code>ISurfaceComposerClient::createSurface()</code> æ¥å‘èµ·åˆ›å»º <code>Surface</code> çš„è¯·æ±‚æ—¶ï¼Œ<code>SurfaceFlinger</code> æœåŠ¡è¿›ç¨‹è¿™è¾¹ä¼šåˆ›å»ºä¸€ä¸ª <code>Layer</code>ã€‚æ—¢ç„¶ <code>Layer</code> ä»£è¡¨äº†ä¸€ä¸ªç”»é¢å›¾å±‚ï¼Œé‚£ä¹ˆå®ƒè‚¯å®šéœ€è¦å­˜å‚¨ â€œå›¾å±‚æ•°æ®â€ çš„åœ°æ–¹ï¼Œå› è€Œæˆ‘ä»¬é€‰æ‹©ä»¥è¿™é‡Œä½œä¸ºå…¥å£ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp*/</span>
status_t <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">createLayer</span><span class="token punctuation">(</span><span class="token keyword">const</span> String8<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Client<span class="token operator">&gt;</span><span class="token operator">&amp;</span> client<span class="token punctuation">,</span>
        <span class="token keyword">uint32_t</span> w<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> h<span class="token punctuation">,</span> PixelFormat format<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">,</span>
        sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">*</span> gbp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>
    status_t result <span class="token operator">=</span> NO_ERROR<span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>Layer<span class="token operator">&gt;</span> layer<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ISurfaceComposerClient<span class="token double-colon punctuation">::</span>eFXSurfaceMask<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Layerç±»å‹ï¼Œç›®å‰åªæœ‰ä¸¤ç§</span>
        <span class="token keyword">case</span> ISurfaceComposerClient<span class="token double-colon punctuation">::</span>eFXSurfaceNormal<span class="token operator">:</span> <span class="token comment">// æ™®é€š Layer</span>
            result <span class="token operator">=</span> <span class="token function">createNormalLayer</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> name<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> format<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> gbp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ISurfaceComposerClient<span class="token double-colon punctuation">::</span>eFXSurfaceDim<span class="token operator">:</span> <span class="token comment">// Dim æ•ˆæœçš„ Layer</span>
            result <span class="token operator">=</span> <span class="token function">createDimLayer</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> name<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> gbp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            result <span class="token operator">=</span> BAD_VALUE<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addClientLayer</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token operator">*</span>handle<span class="token punctuation">,</span> <span class="token operator">*</span>gbp<span class="token punctuation">,</span> layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ·»åŠ åˆ°å…¨å±€çš„ç®¡ç†ä¸­</span>
        <span class="token function">setTransactionFlags</span><span class="token punctuation">(</span>eTransactionNeeded<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è®¾ç½®ä¸šåŠ¡æ ‡å¿—</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™ä¸ªå‡½æ•°ç”¨äºç”Ÿæˆä¸€ä¸ª <code>Layer</code>ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>ä» enum å€¼å®šä¹‰æ¥çœ‹ï¼Œå½“å‰ç³»ç»Ÿä¸­æœ‰å¤šè¾¾åå‡ ç§ Layer ç±»å‹ï¼Œåªä¸è¿‡å¤šæ•°è¿˜æ²¡æœ‰çœŸæ­£å®ç°ã€‚
ç›®å‰èƒ½ç”¨çš„åªæœ‰ä¸¤ä¸ªï¼Œå³ eFXSurfaceNormal å’Œ eFXSurfaceDimã€‚
1. æ­£å¸¸æƒ…å†µä¸‹çš„å›¾å±‚ï¼›
2. å¸¦æœ‰ Dim æ•ˆæœçš„å›¾å±‚ã€‚
æ›´æ—©å‰ç‰ˆæœ¬ä¸­è¿˜æœ‰ä¸€ç§ Blur æ•ˆæœçš„ Layerã€‚å¯èƒ½å‡ºäºæ•ˆç‡çš„è€ƒè™‘ï¼Œå½“å‰ç³»ç»Ÿä¸­å·²ç»ç»Ÿä¸€å°†å®ƒç”¨ Dim æ›¿ä»£äº†ã€‚
ç›¸ä¿¡åœ¨åç»­çš„ Android ç‰ˆæœ¬ä¸­è¿˜ä¼šæŠŠå®ƒä»¬å†åŒºåˆ†å¼€æ¥ã€‚
</code></pre></div><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ <code>SurfaceFlinger::createLayer</code> çš„å®ç°å·²æœ‰æ‰€ä¸åŒã€‚</p><p>ä¸ç®¡å“ªç§ç±»å‹çš„ <code>Layer</code>ï¼Œéƒ½ç»Ÿä¸€è°ƒç”¨ <code>SurfaceFlinger::createBufferStateLayer</code></p></blockquote><p>æœ€ç»ˆè¿”å›ç»™è°ƒç”¨è€…çš„æœ‰ä¸¤ä¸ªï¼šå³ <code>handle</code> å’Œ <code>gbp</code>ã€‚å‰è€…æ˜¯ä¸€ä¸ª <code>IBinder</code> å¯¹è±¡ï¼Œåè€…åˆ™æ˜¯å¤§å®¶ç†Ÿæ‚‰çš„ <code>IGraphicBufferProducer</code>ã€‚</p><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ è¿”å›æ•°æ®çš„å°è£…å½¢å¼ä¹Ÿä¸å¤ªä¸€æ ·äº†ã€‚</p></blockquote><p><code>Layer</code> å’Œ <code>handle</code> åŠ <code>gbp</code> æœ‰ä»€ä¹ˆè”ç³»å‘¢ï¼Ÿæˆ‘ä»¬é€‰å– <code>eFXSurfaceNormal</code> ç±»å‹çš„å›¾å±‚æ¥æ·±å…¥åˆ†æï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>status_t <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">createNormalLayer</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Client<span class="token operator">&gt;</span><span class="token operator">&amp;</span> client<span class="token punctuation">,</span>
        <span class="token keyword">const</span> String8<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> w<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> h<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">,</span> PixelFormat<span class="token operator">&amp;</span> format<span class="token punctuation">,</span>
        sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">*</span> gbp<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>Layer<span class="token operator">&gt;</span><span class="token operator">*</span> outLayer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// format çš„èµ‹å€¼è¿‡ç¨‹çœç•¥</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// ç”Ÿæˆ Layer å¯¹è±¡</span>
    <span class="token operator">*</span>outLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Layer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> client<span class="token punctuation">,</span> name<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// ä¸º Layer è®¾ç½®ç¼“å†²åŒº</span>
    status_t err <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>outLayer<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setBuffers</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> format<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>handle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>outLayer<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// handle æ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°è·å–çš„ï¼Œåé¢æˆ‘ä»¬å†åˆ†æ</span>
        <span class="token operator">*</span>gbp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>outLayer<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getBufferQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// gbp æ˜¯ä» Layer ä¸­å–å‡ºæ¥çš„</span>
    <span class="token punctuation">}</span>
    <span class="token function">ALOGE_IF</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;createNormalLayer() failed (%s)&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>æ³¨æ„ï¼š</p><p>é«˜ç‰ˆæœ¬ä¸­ï¼Œåˆ›å»º <code>Layer</code> å¯¹è±¡çš„è¿‡ç¨‹æœ‰æ‰€ä¸åŒï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp */</span>
status_t <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">createBufferStateLayer</span><span class="token punctuation">(</span>
                LayerCreationArgs<span class="token operator">&amp;</span> args<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>Layer<span class="token operator">&gt;</span><span class="token operator">*</span> outLayer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>outLayer <span class="token operator">=</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createBufferStateLayer</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>handle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>outLayer<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* frameworks/native/services/surfaceflinger/SurfaceFlingerDefaultFactory.cpp */</span>
sp<span class="token operator">&lt;</span>Layer<span class="token operator">&gt;</span> <span class="token class-name">DefaultFactory</span><span class="token double-colon punctuation">::</span><span class="token function">createBufferStateLayer</span><span class="token punctuation">(</span><span class="token keyword">const</span> LayerCreationArgs<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨æ„é€ å‡½æ•° Layer::Layer(const surfaceflinger::LayerCreationArgs&amp; args) åˆ›å»º Layer å¯¹è±¡</span>
    <span class="token keyword">return</span> <span class="token class-name">sp</span><span class="token operator">&lt;</span>Layer<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token comment">/* frameworks/native/services/surfaceflinger/Layer.cpp */</span>
<span class="token keyword">void</span> <span class="token class-name">Layer</span><span class="token double-colon punctuation">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mFlinger<span class="token operator">-&gt;</span><span class="token function">onLayerFirstRef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp */</span>
<span class="token keyword">void</span> <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">onLayerFirstRef</span><span class="token punctuation">(</span>Layer<span class="token operator">*</span> layer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mNumLayers<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token operator">-&gt;</span><span class="token function">isRemovedFromCurrentState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mScheduler<span class="token operator">-&gt;</span><span class="token function">registerLayer</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ³¨æ„ï¼šé«˜ç‰ˆæœ¬ä¸­ï¼Œä¼šæŠŠ Layer æ³¨å†Œåˆ° Scheduler ä¸­</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¹¶ä¸”ï¼Œé«˜ç‰ˆæœ¬ä¸­çš„ <code>Layer</code> ä¹Ÿæ²¡æœ‰æä¾› <code>Layer::getBufferQueue()</code> å‡½æ•°äº†ï¼Œåªæä¾›äº† <code>Layer::getBuffer()</code> å‡½æ•°</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/Layer.h */</span>
<span class="token keyword">class</span> <span class="token class-name">Layer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token class-name">RefBase</span></span> 
<span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">&gt;</span> <span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
</code></pre></div></blockquote><p><code>SurfaceFlinger::createNormalLayer</code> è¿™ä¸ªå‡½æ•°çš„é€»è¾‘å¾ˆç®€å•ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>æ–°å»º Layer å¯¹è±¡ï¼Œ
è®¾ç½® Buffers çš„å±æ€§ï¼ˆsetBuffersï¼‰ï¼Œ
ç„¶ååˆ†åˆ«é€šè¿‡ getHandle å’Œ getBufferQueue è·å¾— handle åŠ gbpã€‚
</code></pre></div><p>å…ˆæ¥çœ‹çœ‹ <code>handle</code> åˆ°åº•æ˜¯ä½•æ–¹ â€œç¥åœ£â€ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/Layer.cpp */</span>
sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span> <span class="token class-name">Layer</span><span class="token double-colon punctuation">::</span><span class="token function">getHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">class</span> <span class="token class-name">Handle</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">BBinder</span><span class="token punctuation">,</span> <span class="token keyword">public</span> <span class="token class-name">LayerCleaner</span></span> <span class="token punctuation">{</span> <span class="token comment">// Handle â€œçœŸèº«â€ åœ¨è¿™é‡Œ</span>
    wp<span class="token operator">&lt;</span><span class="token keyword">const</span> Layer<span class="token operator">&gt;</span> mOwner<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>SurfaceFlinger<span class="token operator">&gt;</span><span class="token operator">&amp;</span> flinger<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Layer<span class="token operator">&gt;</span><span class="token operator">&amp;</span> layer<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">LayerCleaner</span><span class="token punctuation">(</span>flinger<span class="token punctuation">,</span> layer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mOwner</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ç©ºçš„ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">Handle</span><span class="token punctuation">(</span>mFlinger<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–°å»ºä¸€ä¸ª Handle å¯¹è±¡</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç”±è¿™æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œ<code>Handle</code> å‡ ä¹æ²¡æœ‰ä»»ä½•æœ‰ç”¨çš„å†…å®¹ã€‚é‚£ä¹ˆï¼Œå…¶è®¾è®¡åˆè¡·æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œ<code>Handle</code> ç»§æ‰¿äº† <code>LayerCleaner</code>ã€‚ä»å­—é¢æ„æ€æ¥çœ‹ï¼Œå®ƒæ˜¯ â€œå›¾å±‚æ¸…ç†è€…â€ï¼Œæ¸…ç†æ—¶æœºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>Layer<span class="token double-colon punctuation">::</span>LayerCleaner<span class="token double-colon punctuation">::</span>ï½<span class="token function">LayerCleaner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// destroy client resources</span>
    mFlinger<span class="token operator">-&gt;</span><span class="token function">onLayerDestroyed</span><span class="token punctuation">(</span>mLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ LayerCleanerï¼ˆæˆ–è€… Handleï¼‰è¿›è¡Œææ„æ“ä½œæ—¶ï¼Œä¼šå»ä¸»åŠ¨è°ƒç”¨ SurfaceFlinger çš„ onLayerDestroyed æ¥æ”¶æ‹¾ â€œå›¾å±‚æ®‹å±€â€ã€‚æ¢å¥è¯è¯´ï¼Œä¸€æ—¦æ²¡æœ‰äººå¼•ç”¨æ­¤Handleå¯¹è±¡ï¼Œç³»ç»Ÿå°±ä¼šå¼€å§‹æ¸…ç†å·¥ä½œã€‚</p><p>äº†è§£äº† Handle åï¼Œæˆ‘ä»¬å†æ¥åˆ†æ Layer ä¸­çš„å¦ä¸€ä¸ªé‡è¦å…ƒç´ ï¼Œå³ BufferQueueï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/Layer.cpp */</span>
sp<span class="token operator">&lt;</span>BufferQueue<span class="token operator">&gt;</span> <span class="token class-name">Layer</span><span class="token double-colon punctuation">::</span><span class="token function">getBufferQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mSurfaceFlingerConsumer<span class="token operator">-&gt;</span><span class="token function">getBufferQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>SurfaceFlinger</code> è‡ªè®¤ä¸ºæ˜¯ â€œ<code>Consumer</code>â€ è¿˜æ˜¯æ¯”è¾ƒè´´åˆ‡çš„ã€‚è€Œè¿™ä¸ªæ¶ˆè´¹è€…çš„å¦ä¸€ä¸ªèŒè´£å±…ç„¶æ˜¯æä¾› <code>Buffer</code> ç©ºé—´ï¼ŒçœŸæ˜¯ â€œä¸€æ¡é¾™æœåŠ¡â€ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ¥çœ‹çœ‹ <code>SurfaceFlinger</code> æ˜¯å¦‚ä½•æä¾›çš„ <code>BufferQueue</code>ï¼Œå…¶ä¸­åˆæ¶‰åŠå¤šä¸ªç±»çš„ç»§æ‰¿ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/10.801c9046.png" alt="" loading="lazy"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>SurfaceFlingerConsumer</code> ä¸­çœŸæ­£æŒæœ‰ <code>BufferQueue</code> å¯¹è±¡çš„æ˜¯æˆå‘˜å˜é‡ <code>ConsumerBase::mBufferQueu</code>eï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡åˆæ˜¯æ€ä¹ˆèµ‹å€¼çš„å‘¢ï¼Ÿå…¶å®è¿˜æ˜¯åœ¨ <code>Layer</code> ä¸­ï¼Œå³å½“æœ‰äººç¬¬ä¸€æ¬¡å¼•ç”¨ <code>Layer</code> æ—¶è§¦å‘äº†å®ƒçš„ <code>onFirstRef</code>ã€‚æ­¤æ—¶ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">Layer</span><span class="token double-colon punctuation">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>BufferQueue<span class="token operator">&gt;</span> bq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">SurfaceTextureLayer</span><span class="token punctuation">(</span>mFlinger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSurfaceFlingerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">SurfaceFlingerConsumer</span><span class="token punctuation">(</span>mTextureName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> GL_TEXTURE_EXTERNAL_OES<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> bq<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™æ ·å°±åŸºæœ¬æ¸…æ¥šäº†ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>Layer ä¸­ç›´æ¥æˆ–è€…é—´æ¥åœ°æä¾›äº† Handle å’Œ BufferQueueï¼Œè€Œä¸”ä¸¤è€…éƒ½æ˜¯åŒ¿åçš„ Binder Serverã€‚
å½“å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºè°ƒç”¨ createSurface æ—¶ï¼Œå®ƒå¯ä»¥åŒæ—¶è·å–åˆ°è¿™ä¸¤ä¸ªé‡è¦å¯¹è±¡ã€‚
å¤§å®¶ä¸€å®šè¦è®°ä½ï¼ŒIGraphicBufferProducer çš„ Server ç«¯çš„å®ç°æ˜¯ BufferQueueã€‚ç”±äºå‘½åä¸Šçš„å·®å¼‚ï¼Œè¿™ç‚¹å¾ˆå®¹æ˜“æé”™ã€‚

å› è€Œåº”ç”¨ç¨‹åºä¸ BufferQueue çš„å…³ç³»å°±æ¯”è¾ƒæ˜æœ—äº†ã€‚
è™½ç„¶ä¸­é—´ç»å†äº†å¤šæ¬¡è·¨è¿›ç¨‹é€šä¿¡ï¼Œä½†å¯¹äºåº”ç”¨ç¨‹åºæ¥è¯´æœ€ç»ˆåªä½¿ç”¨åˆ°äº† BufferQueueï¼ˆé€šè¿‡ IGraphicBufferProducerï¼‰ã€‚
</code></pre></div><p>æœ¬å°èŠ‚å¯ä»¥ä»ä¾§é¢è¯æ˜å¦‚ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li><p>åº”ç”¨ç¨‹åºå¯ä»¥è°ƒç”¨ <code>createSurface</code> æ¥å»ºç«‹å¤šä¸ª <code>Layer</code>ï¼Œå®ƒä»¬æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>ç†ç”±å°±æ˜¯ createSurface ä¸­æ²¡æœ‰ä»»ä½•æœºåˆ¶æ¥é™åˆ¶åº”ç”¨ç¨‹åºçš„å¤šæ¬¡è°ƒç”¨ï¼›
ç›¸åï¼Œå®ƒä¼šå¯¹ä¸€ä¸ªåº”ç”¨ç¨‹åºå¤šæ¬¡ç”³è¯·è€Œäº§ç”Ÿçš„ Layer è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
</code></pre></div><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>status_t <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">createLayer</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
        <span class="token function">addClientLayer</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token operator">*</span>handle<span class="token punctuation">,</span> <span class="token operator">*</span>gbp<span class="token punctuation">,</span> layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ·»åŠ æ–°å¢çš„ Layer åˆ°å…¨å±€ç®¡ç†ä¸­</span>
        <span class="token function">setTransactionFlags</span><span class="token punctuation">(</span>eTransactionNeeded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>ä¸ºåº”ç”¨ç¨‹åºç”³è¯·çš„ Layerï¼Œä¸€æ–¹é¢éœ€è¦å‘ŠçŸ¥ SurfaceFlingerï¼Œå¦ä¸€æ–¹é¢è¦è®°å½•åˆ°å„ Client å†…éƒ¨ä¸­ã€‚
è¿™ä¸¤ä¸ªæ­¥éª¤æ˜¯ç”± addClientLayer() åˆ†åˆ«è°ƒç”¨ Client::attachLayer() å’Œ SurfaceFlinger::addLayer_l() æ¥å®Œæˆçš„ï¼š
</code></pre></div><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">addClientLayer</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Client<span class="token operator">&gt;</span><span class="token operator">&amp;</span> client<span class="token punctuation">,</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">&amp;</span> handle<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">&amp;</span> gbc<span class="token punctuation">,</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Layer<span class="token operator">&gt;</span><span class="token operator">&amp;</span> lbc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// attach this layer to the client</span>
    client<span class="token operator">-&gt;</span><span class="token function">attachLayer</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> lbc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è®©æ­¤ Layer ä¸ Client ç›¸å…³è”</span>

    <span class="token comment">// add this layer to the current state list</span>
    Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mStateLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mCurrentState<span class="token punctuation">.</span>layersSortedByZ<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>lbc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°† Layer æŒ‰é¡ºåºæ·»åŠ åˆ°å…¨å±€å˜é‡ä¸­</span>
    mGraphicBufferProducerList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>gbc<span class="token operator">-&gt;</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°† gbc ä¹Ÿæ·»åŠ åˆ°å…¨å±€å˜é‡ä¸­</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>å¯¹äº SurfaceFlingerï¼Œå®ƒéœ€è¦å¯¹ç³»ç»Ÿä¸­å½“å‰æ‰€æœ‰çš„ Layer è¿›è¡Œ Z-Order æ’åºï¼Œä»¥å†³å®šç”¨æˆ·æ‰€èƒ½çœ‹åˆ°çš„ â€œç”»é¢â€ æ˜¯ä»€ä¹ˆæ ·çš„ï¼›
å¯¹äº Clientï¼Œå®ƒåˆ™åˆ©ç”¨å†…éƒ¨çš„ mLayers æˆå‘˜å˜é‡æ¥é€ä¸€è®°å½•æ–°å¢ï¼ˆattachLayerï¼‰å’Œç§»é™¤ï¼ˆdetachLayerï¼‰çš„å›¾å±‚ã€‚
ä»ä¸­ä¸éš¾çœ‹å‡ºï¼Œä¸€ä¸ª Client æ˜¯å¯ä»¥åŒ…å«å¤šä¸ª Layer çš„ã€‚
</code></pre></div></li><li><p>æ¯ä¸ª <code>Layer</code> å¯¹åº”ä¸€ä¸ª <code>BufferQueue</code>ã€‚æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºå¯èƒ½å¯¹åº”å¤šä¸ª <code>BufferQueue</code>ã€‚å¦å¤–ï¼Œ<code>Layer</code> æ²¡æœ‰ç›´æ¥æŒæœ‰ <code>BufferQueue</code> å¯¹è±¡ï¼Œè€Œæ˜¯ç”±å…¶å†…éƒ¨çš„ <code>mSurfaceFlingerConsumer</code> æ¥ç®¡ç†ã€‚</p></li></ol><h2 id="_6-surfaceflinger" tabindex="-1"><a class="header-anchor" href="#_6-surfaceflinger" aria-hidden="true">#</a> 6 <code>SurfaceFlinger</code></h2><p>ä»æœ¬å°èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬æ­£å¼åˆ‡å…¥ <code>SurfaceFlinger</code> çš„åˆ†æã€‚</p><p>ä¸ºäº†ä¿æŒè®²è§£çš„è¿è´¯æ€§ï¼Œéƒ¨åˆ†å†…å®¹å¯èƒ½åœ¨å‰é¢çš„ç« èŠ‚ä¸­å·²ç»æœ‰æ‰€æ¶‰åŠï¼Œæ¥ä¸‹æ¥å°†ä¼šå¯¹å…¶ä¸­çš„ç»†èŠ‚åšæ›´å¤šçš„æ‰©å±•è®²è§£ã€‚</p><p>å†…å®¹ç»„ç»‡å¦‚ä¸‹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. é¦–å…ˆä»‹ç»ä» Android 4.1 ç‰ˆæœ¬èµ·å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼ˆProject Butterï¼‰ã€‚
    ç†è§£è¿™ä¸ªé¡¹ç›®æ˜¯å¿…è¦çš„ï¼Œå¯ä»¥è¯´ SurfaceFlinger æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†å†…å®¹å°±æ˜¯å›´ç»•å®ƒå±•å¼€çš„ã€‚
2. SurfaceFlinger çš„å¯åŠ¨è¿‡ç¨‹åŠå·¥ä½œæ–¹å¼ã€‚
3. SurfaceFlinger ä¸ BufferQueue åŠåº”ç”¨ç¨‹åºé—´çš„å…³ç³»ã€‚
4. SurfaceFlinger å¯¹ VSYNC ä¿¡å·çš„å¤„ç†è¿‡ç¨‹ï¼ˆé‡ç‚¹ï¼‰ã€‚
</code></pre></div><h3 id="_6-1-é»„æ²¹è®¡åˆ’-project-butter" tabindex="-1"><a class="header-anchor" href="#_6-1-é»„æ²¹è®¡åˆ’-project-butter" aria-hidden="true">#</a> 6.1 â€œé»„æ²¹è®¡åˆ’â€ï¼ˆ<code>Project Butter</code>ï¼‰</h3><p>ä¸ºä»€ä¹ˆä¼šå«è¿™ä¸ªåå­—å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>ä¸€ä¸ªå¯èƒ½çš„åŸå› å°±æ˜¯è¿™ä¸ª Project çš„ç›®çš„æ˜¯æ”¹å–„ç”¨æˆ·æŠ±æ€¨æœ€å¤šçš„ Android å‡ å¤§ç¼ºé™·ä¹‹ä¸€ï¼Œå³ UI å“åº”é€Ÿåº¦ã€‚
Google å¸Œæœ›è¿™ä¸€æ–°è®¡åˆ’å¯ä»¥è®© Android ç³»ç»Ÿæ‘†è„± â€œUIäº¤äº’â€ ä¸Šçš„ â€œæ»åâ€ æ„Ÿï¼Œè€Œèƒ½åƒåŠ äº†é»„æ²¹ä¸€èˆ¬ â€œé¡ºæ»‘â€ã€‚
</code></pre></div><p><code>Google</code> åœ¨ 2012 å¹´çš„ <code>I/O</code> å¤§ä¼šä¸Šå®£å¸ƒäº†è¿™ä¸€è®¡åˆ’ï¼Œå¹¶åœ¨ <code>Android 4.1</code> ä¸­æ­£å¼æ­è½½äº†å…·ä½“çš„å®ç°æœºåˆ¶ã€‚</p><p>â€œé»„æ²¹è®¡åˆ’â€ ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼Œå³ <strong><code>VSync</code> å’Œ <code>Triple Buffering</code></strong>ã€‚ä¸‹é¢å…ˆåˆ†åˆ«ä»‹ç»å¼•å…¥å®ƒä»¬çš„åŸå› ã€‚</p><p>å½“æˆ‘ä»¬ç©æ¸¸æˆæˆ–è€…çœ‹ç”µå½±æ—¶ï¼Œå¯èƒ½ç»å¸¸é‡åˆ°ä»¥ä¸‹æƒ…å½¢ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>æŸäº›æ¸¸æˆåœºé¢å¥½åƒç”±å‡ ä¸ªåœºæ™¯ â€œæ‹¼å‡‘â€ è€Œæˆã€‚
ç”µå½±ç”»é¢ä¸è¿è´¯ï¼Œå¥½åƒè¢« â€œå‰²è£‚â€ äº†ã€‚
</code></pre></div><p>è¿™æ ·æè¿°æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬å¼•ç”¨ <code>wikipedia</code> ä¸Šçš„ä¸€å¼ å›¾æ¥çœ‹ä¸‹å®é™…æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/11.daa37838.png" alt="" loading="lazy"></p><p>ä»¥æ—¶é—´ä¸ºæ¨ªåæ ‡æ¥æè¿°æ¥ä¸‹æ¥ä¼šå‘ç”Ÿçš„äº‹æƒ…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/12.c87c1d5b.png" alt="" loading="lazy"></p><p>ä¸ŠåŠéƒ¨åˆ†çš„æ–¹æ¡†è¡¨ç¤ºåœ¨ä¸åŒçš„æ—¶é—´ç‚¹æ—¶æ˜¾ç¤ºå±çš„å†…å®¹ï¼ˆåŠ æ·±çš„éƒ¨åˆ†ï¼‰ï¼Œä¸‹åŠéƒ¨åˆ†åˆ™æ˜¯åŒä¸€æ—¶é—´ç‚¹æ—¶ <code>Frame Buffer</code> ä¸­çš„æ•°æ®çŠ¶æ€ï¼Œç¼–å·è¡¨ç¤ºç¬¬å‡ ä¸ª <code>frame</code> å¸§ï¼Œä¸è€ƒè™‘æ¸…å±ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>0.01ç§’
    ç”±äºä¸¤è€…é€Ÿç‡ç›¸å·®ä¸å°‘ï¼Œæ­¤æ—¶bufferä¸­å·²ç»å‡†å¤‡å¥½äº†ç¬¬ 1 å¸§æ•°æ®ï¼Œè€Œæ˜¾ç¤ºå™¨åªæ˜¾ç¤ºäº†ç¬¬ 1 å¸§ç”»é¢çš„ 2/3ã€‚

0.015ç§’
    ç¬¬ 1 å¸§ç”»é¢åœ¨æ˜¾ç¤ºå±ä¸Šç»ˆäºå®Œæ•´åœ°æ˜¾ç¤ºäº†å‡ºæ¥ï¼Œè€Œæ­¤æ—¶ buffer ä¸­æœ‰ 1/3 çš„éƒ¨åˆ†å·²ç»è¢«å¡«å……ä¸Šç¬¬ 2 å¸§æ•°æ®äº†ã€‚

0.02ç§’
    Buffer ä¸­å·²ç»å‡†å¤‡å¥½äº†ç¬¬ 2 å¸§æ•°æ®ï¼Œè€Œæ˜¾ç¤ºå±å‡ºç°äº† Screen Tearingï¼Œ
    å³ï¼šæœ‰ä¸‰åˆ†ä¹‹ä¸€çš„å†…å®¹å±äºç¬¬ 2 å¸§ï¼Œå…¶ä½™çš„åˆ™æ¥æºäºç¬¬ 1 å¸§ç”»é¢ã€‚
</code></pre></div><p>åœ¨å•ç¼“å†²åŒºçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å¾ˆéš¾è§„é¿çš„ã€‚æ‰€ä»¥ä¹‹å‰æˆ‘ä»¬ä»‹ç»çš„åŒç¼“å†²æŠ€æœ¯ï¼ˆ<a href="#_9-4-1-1-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%93%8D%E4%BD%9C">9.4.1.1 å°èŠ‚</a>ï¼‰ï¼Œå…¶åŸºæœ¬åŸç†å°±æ˜¯é‡‡ç”¨äº†ä¸¤å— <code>buffer</code>ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>ä¸€å— Back Buffer ç”¨äº CPU/GPU åå°ç»˜åˆ¶ï¼Œ
ä¸€å— Frame Buffer ç”¨äºå±å¹•æ˜¾ç¤ºï¼›
</code></pre></div><p>å½“ <code>Back Buffer</code> å‡†å¤‡å°±ç»ªåï¼Œå®ƒä»¬æ‰è¿›è¡Œäº¤æ¢ã€‚</p><p>ä¸å¯å¦è®¤ï¼ŒåŒç¼“å†²æŠ€æœ¯ï¼ˆ<code>Double Buffering</code>ï¼‰å¯ä»¥åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šé™ä½ <code>Screen Tearing</code> ç±»å‹çš„é”™è¯¯ï¼Œä½†å®ƒæ˜¯ä¸‡èƒ½çš„å—ï¼Ÿ</p><p><strong>ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„é—®é¢˜æ˜¯ï¼šæˆ‘ä»¬åº”è¯¥æ¯éš”å¤šå°‘æ—¶é—´ç‚¹è¿›è¡Œä¸¤ä¸ªç¼“å†²åŒºçš„äº¤æ¢å‘¢ï¼Ÿ</strong></p><div class="language-text ext-text"><pre class="language-text"><code>å‡å¦‚æ˜¯ Back Buffer å‡†å¤‡å®Œæˆä¸€å¸§æ•°æ®ä»¥åå°±è¿›è¡Œï¼Œé‚£ä¹ˆå¦‚æœæ­¤æ—¶å±å¹•è¿˜æ²¡æœ‰å®Œæ•´æ˜¾ç¤ºä¸Šä¸€å¸§å†…å®¹ï¼Œè‚¯å®šæ˜¯ä¼šå‡ºé—®é¢˜çš„ã€‚
çœ‹æ¥åªèƒ½ç­‰åˆ°å±å¹•å¤„ç†å®Œä¸€å¸§æ•°æ®åï¼Œæ‰å¯ä»¥æ‰§è¡Œè¿™ä¸€æ“ä½œã€‚
</code></pre></div><p>ä¸€ä¸ªå…¸å‹çš„æ˜¾ç¤ºå™¨æœ‰ä¸¤ä¸ªé‡è¦ç‰¹æ€§ï¼Œå³ â€œè¡Œé¢‘å’Œåœºé¢‘â€ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>è¡Œé¢‘ï¼ˆHorizontal Scanning Frequencyï¼‰åˆç§°ä¸º â€œæ°´å¹³æ‰«æé¢‘ç‡â€ï¼Œæ˜¯å±å¹•æ¯ç§’é’Ÿä»å·¦è‡³å³æ‰«æçš„æ¬¡æ•°ï¼›
åœºé¢‘ï¼ˆVertical Scanning Frequencyï¼‰ä¹Ÿç§°ä¸º â€œå‚ç›´æ‰«æé¢‘ç‡â€ï¼Œæ˜¯æ¯ç§’é’Ÿæ•´ä¸ªå±å¹•åˆ·æ–°çš„æ¬¡æ•°ã€‚

ç”±æ­¤ä¹Ÿå¯ä»¥å¾—å‡ºå®ƒä»¬çš„å…³ç³»ï¼šè¡Œé¢‘ = åœºé¢‘ * çºµåæ ‡åˆ†è¾¨ç‡
</code></pre></div><p>å½“æ‰«æå®Œä¸€ä¸ªå±å¹•åï¼Œè®¾å¤‡éœ€è¦é‡æ–°å›åˆ°ç¬¬ä¸€è¡Œä»¥è¿›å…¥ä¸‹ä¸€è½®çš„å¾ªç¯ï¼Œæ­¤æ—¶æœ‰ä¸€æ®µæ—¶é—´ç©ºéš™ï¼Œç§°ä¸º <code>Vertical Blanking Interval</code>ï¼ˆ<code>VBI</code>ï¼‰ã€‚</p><p>è¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬è¿›è¡Œç¼“å†²åŒºäº¤æ¢çš„æœ€ä½³æ—¶é—´ã€‚å› ä¸ºæ­¤æ—¶å±å¹•æ²¡æœ‰åœ¨åˆ·æ–°ï¼Œä¹Ÿå°±é¿å…äº†äº¤æ¢è¿‡ç¨‹ä¸­å‡ºç° <code>Screen Tearing</code> çš„çŠ¶å†µã€‚</p><p><code>Vsync</code>ï¼ˆå‚ç›´åŒæ­¥ï¼‰æ˜¯ <code>Vertical Synchronization</code> çš„ç®€å†™ï¼Œå®ƒåˆ©ç”¨ <code>VBI</code> æ—¶æœŸå‡ºç°çš„ <code>Vertical Sync Pulse</code> æ¥ä¿è¯åŒç¼“å†²èƒ½åœ¨æœ€ä½³æ—¶é—´ç‚¹è¿›è¡Œäº¤æ¢ã€‚</p><blockquote><p>æ‰€ä»¥è¯´ <code>VSync</code> è¿™ä¸ªæ¦‚å¿µå¹¶ä¸æ˜¯ <code>Google</code> é¦–åˆ›çš„ï¼Œè€Œæ˜¯åœ¨æ—©äº›å¹´å‰çš„ <code>PC</code> é¢†åŸŸå°±å·²ç»å‡ºç°äº†ã€‚ä¸è¿‡ <code>Android 4.1</code> èµ‹äºˆäº†å®ƒæ–°çš„åŠŸç”¨ï¼Œç¨åå°±å¯ä»¥çœ‹åˆ°ã€‚</p></blockquote><p>ä¸Šé¢æˆ‘ä»¬è®¨è®ºçš„æƒ…å†µå…¶å®æ˜¯åŸºäºä¸€ä¸ªå‡è®¾ï¼Œå³ â€œç»˜å›¾é€Ÿåº¦å¤§äºæ˜¾ç¤ºé€Ÿåº¦â€ï¼Œé‚£ä¹ˆå½“ â€œç»˜å›¾é€Ÿåº¦å°äºæ˜¾ç¤ºé€Ÿåº¦â€ å‘¢ï¼Ÿ</p><p>å…ˆæ¥åˆ†æç»˜å›¾è¿‡ç¨‹ä¸­å½“ â€œç»˜å›¾é€Ÿåº¦å°äºæ˜¾ç¤ºé€Ÿåº¦â€ï¼Œä¸”æ²¡æœ‰é‡‡ç”¨ <code>VSync</code> åŒæ­¥æ—¶çš„æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/13.bf525034.png" alt="" loading="lazy"></p><p>ä¸Šå›¾ä¸­æœ‰ 3 ä¸ªå…ƒç´ ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>Display è¡¨ç¤ºæ˜¾ç¤ºå±å¹•ï¼Œ
GPU å’Œ CPU è´Ÿè´£æ¸²æŸ“å¸§æ•°æ®ã€‚æ¯ä¸€å¸§ä»¥æ–¹æ¡†è¡¨ç¤ºå¹¶ä»¥æ•°å­—è¿›è¡Œç¼–å·ï¼Œå¦‚ 0ã€1ã€2 ç­‰ã€‚
VSync ç”¨äºæŒ‡å¯¼åŒç¼“å†²åŒºçš„äº¤æ¢ã€‚
</code></pre></div><p>ä»¥æ—¶é—´çš„é¡ºåºæ¥çœ‹çœ‹å½“ä¸é‡‡ç”¨ <code>VSync</code> åŒæ­¥æ—¶å°†ä¼šå‘ç”Ÿä»€ä¹ˆå¼‚å¸¸ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>Step1. 
    Display æ˜¾ç¤ºç¬¬ 0 å¸§æ•°æ®ï¼Œæ­¤æ—¶ CPU å’Œ GPU æ¸²æŸ“ç¬¬ 1 å¸§ç”»é¢ï¼Œè€Œä¸”èµ¶åœ¨ Display æ˜¾ç¤ºä¸‹ä¸€å¸§ï¼ˆå¸§1ï¼‰å‰å®Œæˆã€‚
Step2. 
    å› ä¸ºæ¸²æŸ“åŠæ—¶ï¼ŒDisplay åœ¨ç¬¬ 0 å¸§æ˜¾ç¤ºå®Œæˆåï¼Œä¹Ÿå°±æ˜¯ç¬¬ 1 ä¸ª VSync åï¼Œæ­£å¸¸æ˜¾ç¤ºç¬¬ 1 å¸§ã€‚
Step3. 
    ç”±äºæŸäº›åŸå› ï¼ˆæ¯”å¦‚ CPU èµ„æºè¢«å ç”¨ï¼‰ï¼Œç³»ç»Ÿæ²¡èƒ½åŠæ—¶åœ°å¤„ç†ç¬¬ 2 å¸§ï¼Œè€Œæ˜¯ç­‰åˆ°ç¬¬ 2 ä¸ª VSync åˆ°æ¥å‰æ‰å¼€å§‹å¤„ç†ã€‚
Step4. 
    ç¬¬ 2 ä¸ª VSync æ¥ä¸´æ—¶ï¼Œç”±äºç¬¬ 2 å¸§æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å°±ç»ªï¼Œå®é™…æ˜¾ç¤ºçš„è¿˜æ˜¯ç¬¬ 1 å¸§çš„å†…å®¹ã€‚
    è¿™ç§æƒ…å†µè¢« Android å¼€å‘ç»„å‘½åä¸º â€œJankâ€ã€‚
Step5. 
    å½“ç¬¬ 2 å¸§æ•°æ®å‡†å¤‡å®Œæˆåï¼Œå®ƒå¹¶ä¸ä¼šç«‹å³è¢«æ˜¾ç¤ºï¼Œè€Œæ˜¯è¦ç­‰å¾…ä¸‹ä¸€ä¸ª VSyncã€‚
</code></pre></div><p>æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯å±å¹• â€œå¹³ç™½æ— æ•…â€ åœ°é‡å¤æ˜¾ç¤ºäº†ä¸€æ¬¡ç¬¬ 1 å¸§ã€‚</p><p>åŸå› å¤§å®¶åº”è¯¥éƒ½çœ‹åˆ°äº†ï¼Œå°±æ˜¯ <code>CPU</code> æ²¡æœ‰åŠæ—¶åœ°ç€æ‰‹å¤„ç†ç¬¬ 2 å¸§çš„æ¸²æŸ“å·¥ä½œï¼Œä»¥è‡´ â€œå»¶è¯¯å†›æœºâ€ã€‚</p><p><code>Android</code> ç³»ç»Ÿä¸­ä¸€ç›´å­˜åœ¨ç€è¿™ä¸ªé—®é¢˜ï¼Œç›´åˆ° â€œé»„æ²¹è®¡åˆ’â€ çš„å¼•å…¥ã€‚</p><p>ä» <code>Android 4.1 Jelly Bean</code> å¼€å§‹ï¼Œ<code>VSync</code> å¾—åˆ°äº†è¿›ä¸€æ­¥çš„åº”ç”¨ï¼Œå³ï¼šç³»ç»Ÿåœ¨æ”¶åˆ° <code>VSync Pulse</code> åï¼Œå°†ç«‹å³å¼€å§‹ä¸‹ä¸€å¸§çš„æ¸²æŸ“ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/14.8d49815d.png" alt="" loading="lazy"></p><p>ä¸Šå›¾ä¸­å±•ç¤ºçš„æ˜¯é‡‡ç”¨ <code>VSync</code> è¿›è¡Œæ˜¾ç¤ºåŒæ­¥çš„æƒ…å†µã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>ä¸€æ—¦ VSync ä¿¡å·å‡ºç°ï¼ŒCPU ä¾¿ä¸å†çŠ¹è±«ï¼Œå³åˆ»å¼€å§‹æ‰§è¡Œ Buffer çš„å‡†å¤‡å·¥ä½œã€‚
å¤§éƒ¨åˆ†çš„ Android æ˜¾ç¤ºè®¾å¤‡åˆ·æ–°é¢‘ç‡æ˜¯ 60Hzï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æ¯ä¸€å¸§æœ€å¤šåªèƒ½ç•™ç»™ç³»ç»Ÿ 1/60=16ms å·¦å³çš„å‡†å¤‡æ—¶é—´ã€‚
å‡å¦‚ CPU/GPU çš„ FPSï¼ˆFrames Per Secondï¼‰é«˜äºè¿™ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ¡ˆæ˜¯å®Œç¾çš„ï¼Œæ˜¾ç¤ºæ•ˆæœå°†å¾ˆå¥½ã€‚
</code></pre></div><p>å¯æ˜¯æˆ‘ä»¬æ²¡æœ‰åŠæ³•ä¿è¯æ‰€æœ‰è®¾å¤‡çš„ç¡¬ä»¶é…ç½®éƒ½èƒ½è¾¾åˆ°è¦æ±‚ã€‚å‡å¦‚ <code>CPU/GPU</code> çš„æ€§èƒ½æ— æ³•æ»¡è¶³ä¸Šå›¾æ¡ä»¶ï¼ˆå³ï¼š<code>FPS</code> ä½äºå±å¹•åˆ·æ–°ç‡ï¼‰ï¼Œåˆä¼šæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p><p>åœ¨åˆ†æè¿™ä¸€é—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹é‡‡ç”¨ <code>VSync</code> å’ŒåŒç¼“å†²æœºåˆ¶çš„æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/15.db128946.png" alt="" loading="lazy"></p><p>å›¾ä¸­é‡‡ç”¨äº†åŒç¼“å†²æŠ€æœ¯ä»¥åŠå‰é¢ä»‹ç»çš„ <code>VSync</code> åŒæ­¥æœºåˆ¶ï¼Œå¯ä»¥çœ‹åˆ°æ•´ä¸ªæ˜¾ç¤ºè¿‡ç¨‹è¿˜æ˜¯ç›¸å½“ä¸é”™çš„ã€‚è™½ç„¶ <code>CPU/GPU</code> å¤„ç†æ‰€ç”¨çš„æ—¶é—´æ—¶çŸ­æ—¶é•¿ï¼Œä½†æ€»çš„æ¥è¯´éƒ½åœ¨ <code>16ms</code> ä»¥å†…ï¼Œå› è€Œä¸å½±å“æ˜¾ç¤ºæ•ˆæœã€‚</p><blockquote><p><code>A</code> å’Œ <code>B</code> åˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªç¼“å†²åŒºï¼Œå®ƒä»¬ä¸æ–­åœ°äº’ç›¸äº¤æ¢ä»¥ä¿è¯ç”»é¢çš„æ­£ç¡®æ˜¾ç¤ºã€‚</p></blockquote><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»§ç»­åˆ†æ <code>FPS</code> ä½äºå±å¹•åˆ·æ–°ç‡çš„æƒ…å†µäº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/16.c2db6c77.png" alt="" loading="lazy"></p><div class="language-text ext-text"><pre class="language-text"><code>å¦‚æœ CPU/GPU çš„å¤„ç†æ—¶é—´è¶…è¿‡ 16msï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ª VSync åˆ°æ¥æ—¶ï¼Œç¼“å†²åŒº B ä¸­çš„æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå°±åªèƒ½ç»§ç»­æ˜¾ç¤ºä¹‹å‰ A ç¼“å†²åŒºä¸­çš„å†…å®¹ã€‚
è€Œ B å®Œæˆåï¼Œåˆå› ä¸ºç¼ºä¹ VSync Pulse ä¿¡å·ï¼Œä¹Ÿåªèƒ½ç­‰åˆ°ä¸‹ä¸€è½®æ‰æœ‰æœºä¼šäº¤æ¢äº†ã€‚
äºæ˜¯åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€å¤§æ®µæ—¶é—´æ˜¯è¢«æµªè´¹çš„ã€‚
å½“ä¸‹ä¸€ä¸ª VSync å‡ºç°æ—¶ï¼ŒCPU/GPU é©¬ä¸Šæ‰§è¡Œæ“ä½œï¼Œæ­¤æ—¶å®ƒå¯æ“ä½œçš„ Buffer æ˜¯ Aï¼Œç›¸åº”çš„æ˜¾ç¤ºå±å¯¹åº”çš„å°±æ˜¯ Bã€‚è¿™æ—¶çœ‹èµ·æ¥å°±æ˜¯æ­£å¸¸çš„ã€‚
åªä¸è¿‡ç”±äºæ‰§è¡Œæ—¶é—´ä»ç„¶è¶…è¿‡ 16msï¼Œå¯¼è‡´ä¸‹ä¸€æ¬¡åº”è¯¥æ‰§è¡Œçš„ç¼“å†²åŒºäº¤æ¢åˆè¢«æ¨è¿Ÿã€‚
å¦‚æ­¤å¾ªç¯åå¤ï¼Œä¾¿å‡ºç°äº†è¶Šæ¥è¶Šå¤šçš„ â€œJankâ€ã€‚
</code></pre></div><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰è§„é¿çš„åŠæ³•å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>å¾ˆæ˜¾ç„¶ï¼Œç¬¬ä¸€æ¬¡çš„ Jank çœ‹èµ·æ¥æ˜¯æ²¡æœ‰åŠæ³•çš„ï¼Œé™¤éå‡çº§ç¡¬ä»¶é…ç½®æ¥åŠ å¿« FPSã€‚
æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹æ˜¯è¢« CPU/GPU æµªè´¹çš„æ—¶é—´æ®µæ€ä¹ˆæ‰èƒ½å……åˆ†åˆ©ç”¨èµ·æ¥ã€‚
åˆ†æä¸Šè¿°è¿‡ç¨‹ï¼Œé€ æˆ CPU/GPU æ— äº‹å¯åšçš„å‡è±¡æ˜¯å› ä¸ºå½“å‰å·²ç»æ²¡æœ‰å¯ç”¨çš„ buffer äº†ã€‚
</code></pre></div><p>æ¢å¥è¯è¯´ï¼Œå¦‚æœå¢åŠ ä¸€ä¸ª <code>Buffer</code>ï¼Œæƒ…å†µä¼šä¸ä¼šå¥½è½¬å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/17.f4371b5e.png" alt="" loading="lazy"></p><p><code>Triple Buffering</code> æ˜¯ <code>Multiple Buffering</code> çš„ä¸€ç§ï¼ŒæŒ‡çš„æ˜¯ç³»ç»Ÿä½¿ç”¨ 3 ä¸ªç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå·¥ä½œã€‚</p><p>æˆ‘ä»¬é€æ­¥åˆ†æä¸‹è¿™ä¸ªæ–°æœºåˆ¶æ˜¯å¦æœ‰æ•ˆã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>é¦–å…ˆå’Œé¢„æ–™ä¸­çš„ä¸€è‡´ï¼Œç¬¬ä¸€æ¬¡ â€œJankâ€ æ— å¯åšéã€‚
ä¸è¿‡å½“ç¬¬ä¸€æ¬¡ VSync å‘ç”Ÿåï¼ŒCPU ä¸ç”¨å†ç­‰å¾…äº†ï¼Œå®ƒä¼šä½¿ç”¨ç¬¬ä¸‰ä¸ª Buffer C æ¥è¿›è¡Œä¸‹ä¸€å¸§æ•°æ®çš„å‡†å¤‡å·¥ä½œã€‚
è™½ç„¶å¯¹ç¼“å†²åŒº C çš„å¤„ç†æ‰€éœ€æ—¶é—´åŒæ ·è¶…è¿‡äº† 16msï¼Œä½†è¿™å¹¶ä¸å½±å“æœ€ç»ˆçš„æ˜¾ç¤ºï¼Œå› ä¸ºç¬¬äºŒæ¬¡ VSync åˆ°æ¥åï¼Œå®ƒé€‰æ‹© Buffer B è¿›è¡Œæ˜¾ç¤ºï¼›
è€Œåˆ°äº†ç¬¬ä¸‰æ¬¡ VSync æ—¶ï¼Œå®ƒä¼šæ¥ç€é‡‡ç”¨ Cï¼Œè€Œä¸æ˜¯åƒ Double Buffering ä¸­æ‰€çœ‹åˆ°çš„åªèƒ½å†æ˜¾ç¤ºä¸€é Bã€‚
è¿™æ ·å°±æœ‰æ•ˆåœ°é™ä½äº†ç³»ç»Ÿæ˜¾ç¤ºé”™è¯¯çš„æ¦‚ç‡ã€‚
</code></pre></div><blockquote><p>å‰é¢å°èŠ‚æˆ‘ä»¬çœ‹åˆ° <code>BufferQueue</code> ä¸­æœ€å¤šæœ‰ 32 ä¸ª <code>BufferSlot</code>ï¼Œä¸è¿‡åœ¨å®é™…ä½¿ç”¨æ—¶çš„å…·ä½“å€¼æ˜¯å¯ä»¥è®¾ç½®çš„ã€‚</p></blockquote><p><code>TARGET_DISABLE_TRIPLE_BUFFERING</code> è¿™ä¸ªå®ç”¨äº<code> Disable Triple Buffering</code>ã€‚å¦‚æœå®æ‰“å¼€çš„è¯ï¼Œ<code>Layer.cpp</code> åœ¨ <code>onFirstRef</code> æœ‰å¦‚ä¸‹æ“ä½œã€‚</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_DISABLE_TRIPLE_BUFFERING</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">warning</span> <span class="token string">&quot;disabling triple buffering&quot;</span></span>
    mSurfaceFlingerConsumer<span class="token operator">-&gt;</span><span class="token function">setDefaultMaxBufferCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    mSurfaceFlingerConsumer<span class="token operator">-&gt;</span><span class="token function">setDefaultMaxBufferCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre></div><p><code>mSurfaceFlingerConsumer::setDefaultMaxBufferCount</code> å°†è¿›ä¸€æ­¥è°ƒç”¨ <code>BufferQueue::setDefaultMaxBufferCount</code>ï¼Œç„¶åæŠŠ <code>Buffer</code> æ•°ï¼ˆ2 æˆ–è€… 3ï¼‰ä¿å­˜åˆ° <code>BufferQueue</code> å†…éƒ¨çš„ <code>mDefaultMaxBufferCount</code> æˆå‘˜å˜é‡ä¸­ã€‚</p><p>å¯¹äºåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œå®ƒä¹Ÿå¯ä»¥é€šè¿‡ <code>IGraphicBufferProducer::setBufferCount</code> æ¥å‘Šè¯‰ <code>BufferQueue</code> å®ƒæ‰€å¸Œæœ›çš„ <code>Slot</code> å€¼ï¼Œè¿™ä¸ªæ“ä½œæœ€ç»ˆå½±å“çš„æ˜¯ <code>BufferQueue</code> ä¸­çš„å¦ä¸€ä¸ªæˆå‘˜å˜é‡ <code>mOverrideMaxBufferCount</code>ï¼ˆè€Œä¸æ˜¯ <code>mDefaultMaxBufferCount</code>ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªå˜é‡æ˜¯ 0ï¼Œè¡¨ç¤ºåº”ç”¨ç«¯ä¸å…³å¿ƒåˆ°åº•æœ‰å¤šå°‘ <code>Buffer</code> å¯ç”¨ã€‚</p><p>åœ¨å…·ä½“çš„å®ç°ä¸­ï¼Œä»¥ä¸Šä¸¤ä¸ªå˜é‡éƒ½æ˜¯è¦è€ƒè™‘åˆ°çš„ï¼Œ<code>BufferQueue</code> ä¼šé€šè¿‡æƒè¡¡å„ä¸ªå€¼æ¥é€‰æ‹©æœ€ä½³çš„è§£å†³æ–¹æ¡ˆã€‚</p><h3 id="_6-2-surfaceflinger-çš„å¯åŠ¨" tabindex="-1"><a class="header-anchor" href="#_6-2-surfaceflinger-çš„å¯åŠ¨" aria-hidden="true">#</a> 6.2 <code>SurfaceFlinger</code> çš„å¯åŠ¨</h3><p><code>SurfaceFlinger</code> çš„å¯åŠ¨å’Œ <code>ServiceManager</code> æœ‰ç‚¹ç±»ä¼¼ï¼Œå®ƒä»¬éƒ½å±äºç³»ç»Ÿçš„åº•å±‚æ”¯æ’‘æœåŠ¡ï¼Œå› è€Œå¿…é¡»åœ¨è®¾å¤‡å¼€æœºçš„æ—©æœŸå°±è¿è¡Œèµ·æ¥ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*frameworks/base/cmds/system_server/library/System_init.cpp*/</span>
<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> status_t <span class="token function">system_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    
    <span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">&quot;system_init.startsurfaceflinger&quot;</span><span class="token punctuation">,</span> propBuf<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>propBuf<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>è¿™ä¸ª <code>System_init.cpp</code> ä¼šè¢«ç¼–è¯‘åˆ° <code>libsystem_server</code> åº“ä¸­ï¼Œç„¶åç”± <code>SystemServer</code> åœ¨ <code>JNI</code> å±‚è¿›è¡ŒåŠ è½½è°ƒç”¨ï¼Œä»è€Œå¯åŠ¨åŒ…æ‹¬ <code>SurfaceFlinger</code>ï¼Œ<code>SensorService</code> ç­‰åœ¨å†…çš„ç³»ç»ŸæœåŠ¡ã€‚</p><blockquote><p>é«˜ç‰ˆæœ¬ä¸­çš„å¯åŠ¨å…¥å£å·²æ‰€æœ‰ä¸åŒï¼Œåç»­å†æ›´æ–°ã€‚</p></blockquote><p><code>system_init</code> è°ƒç”¨ <code>instantiate</code> æ¥åˆ›å»ºä¸€ä¸ª <code>Binder Server</code>ï¼Œåç§°ä¸º <code>&quot;SurfaceFlinger&quot;</code>ï¼›è€Œä¸”å¼ºæŒ‡é’ˆçš„ç‰¹æ€§è®©å®ƒåœ¨ç¬¬ä¸€æ¬¡è¢«å¼•ç”¨æ—¶è§¦å‘äº† <code>onFirstRef</code>ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mEventQueue<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–äº‹ä»¶é˜Ÿåˆ—</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token string">&quot;SurfaceFlinger&quot;</span><span class="token punctuation">,</span> PRIORITY_URGENT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¯åŠ¨ä¸€ä¸ªæ–°çš„ä¸šåŠ¡çº¿ç¨‹</span>
    mReadyToRunBarrier<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç­‰å¾…æ–°çº¿ç¨‹å¯åŠ¨å®Œæ¯•</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆå‘˜å˜é‡ <code>mEventQueue</code> æ˜¯ä¸€ä¸ª <code>MessageQueue</code> ç±»å‹çš„å¯¹è±¡ã€‚æ—¢ç„¶æœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé‚£å°±ä¸€å®šä¼šæœ‰é…å¥—çš„äº‹ä»¶å¤„ç†å™¨ <code>Handler</code> ä»¥åŠå¾ªç¯ä½“ <code>Looper</code>ï¼Œè¿™äº›æ˜¯åœ¨ <code>MessageQueue::init</code> å‡½æ•°ä¸­åˆ›å»ºçš„ã€‚å³ï¼š</p><blockquote><p>è™½ç„¶ <code>Java</code> å±‚çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ä¸ <code>SurfaceFlinger</code> ä¸­ç”¨åˆ°çš„æœ‰ä¸€å®šå·®å¼‚ï¼Œä½†å…¶æœ¬è´¨åŸç†æ˜¯ä¸€æ ·çš„ã€‚</p></blockquote><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*frameworks/native/services/surfaceflinger/MessageQueue.cpp*/</span>
<span class="token keyword">void</span> <span class="token class-name">MessageQueue</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>SurfaceFlinger<span class="token operator">&gt;</span><span class="token operator">&amp;</span> flinger<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mFlinger <span class="token operator">=</span> flinger<span class="token punctuation">;</span>
    mLooper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Looper</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤Handlerç±»æ˜¯SurfaceFlingerè‡ªå·±å®šä¹‰çš„ï¼Œåé¢æœ‰è®²è§£</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>é«˜ç‰ˆæœ¬ä¸­çš„å·®å¼‚ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp */</span>
<span class="token class-name">MessageQueue</span><span class="token double-colon punctuation">::</span><span class="token function">MessageQueue</span><span class="token punctuation">(</span>ICompositor<span class="token operator">&amp;</span> compositor<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>Handler<span class="token operator">&gt;</span> handler<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">mCompositor</span><span class="token punctuation">(</span>compositor<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mLooper</span><span class="token punctuation">(</span><span class="token class-name">sp</span><span class="token operator">&lt;</span>Looper<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span>kAllowNonCallbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mHandler</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª <code>MessageQueue</code> ç±»ä¸ä½†æä¾›äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶å†…éƒ¨è¿˜å›Šæ‹¬äº†æ¶ˆæ¯çš„å¤„ç†æœºåˆ¶ã€‚</p><p>é‚£ä¹ˆï¼Œè¿™ä¸ª <code>Looper</code> ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è¿è¡Œèµ·æ¥å‘¢ï¼Ÿ æ˜¾ç„¶ <code>SurfaceFlinger</code> éœ€è¦å…ˆè‡ªè¡Œåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰¿è½½è¿™ä¸€ â€œä¸šåŠ¡â€ï¼Œå¦åˆ™å°±ä¼šé˜»å¡ <code>SystemServer</code> çš„ä¸»çº¿ç¨‹ã€‚</p><p><code>SurfaceFlinger::onFirstRef</code> å‡½æ•°æœ€åçš„ <code>mReadyToRunBarrier.wait()</code> ä¹Ÿå¯ä»¥è¯æ˜è¿™ä¸€ç‚¹ï¼Œå³ï¼š<code>mReadyToRunBarrier</code> åœ¨ç­‰å¾…ä¸€ä¸ªäº‹ä»¶ï¼Œåœ¨äº‹ä»¶æ²¡æœ‰å‘ç”Ÿå‰å…¶æ‰€åœ¨çš„çº¿ç¨‹å°±ä¼šå¤„äºç­‰å¾…çŠ¶æ€ã€‚</p><blockquote><p>è¿™æ˜¯ <code>Android</code> ç³»ç»Ÿé‡Œä¸¤ä¸ªçº¿ç¨‹é—´çš„ä¸€ç§å…¸å‹äº¤äº’æ–¹å¼ã€‚</p></blockquote><p>ç”±æ­¤å¯è§ï¼Œ<code>SurfaceFlinger</code> æ–°å¯åŠ¨çš„è¿™ä¸ªçº¿ç¨‹ä¸­ä¸€å®šè¿˜ä¼šè°ƒç”¨ <code>mReadyToRunBarrier.open</code> æ¥ä¸ºç­‰å¾…å®ƒçš„çº¿ç¨‹è§£ç¦ã€‚</p><p>è¿™æ ·æˆ‘ä»¬ä¹Ÿèƒ½æ¨æ–­å‡º <code>SurfaceFlinger</code> ä¸€å®šæ˜¯ç»§æ‰¿è‡ª <code>Thread</code> çº¿ç¨‹ç±»çš„ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">SurfaceFlinger</span> <span class="token operator">:</span><span class="token keyword">public</span> BinderService<span class="token operator">&lt;</span>SurfaceFlinger<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span> Thread<span class="token punctuation">,</span>
</code></pre></div><blockquote><p>é«˜ç‰ˆæœ¬ä¸­ <code>SurfaceFlinger</code> ä¸åœ¨ç»§æ‰¿ <code>Thread</code> äº†ï¼Œåç»­ä¼šæ›´æ–°å¯¹é«˜ç‰ˆæœ¬çš„åˆ†æã€‚</p></blockquote><p>æ‰€ä»¥ä¸Šé¢ <code>SurfaceFlinger::onFirstRef</code> å‡½æ•°ä¸­å¯ä»¥è°ƒç”¨ <code>Thread::run()</code> æ–¹æ³•æ¥å¯åŠ¨ä¸€ä¸ªåä¸º <code>&quot;SurfaceFlinger&quot;</code> çš„çº¿ç¨‹ï¼Œå¹¶ä¸ºå…¶è®¾ç½® <code>PRIORITY_URGENT_DISPLAY</code> çš„ä¼˜å…ˆçº§ã€‚è¿™ä¸ªä¼˜å…ˆçº§æ˜¯åœ¨ <code>ThreadDefs.h</code> ä¸­å®šä¹‰çš„ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><thead><tr><th style="text-align:left;"><strong>Priority</strong></th><th style="text-align:left;"><strong>Value</strong></th><th style="text-align:left;"><strong>Description</strong></th></tr></thead><tbody><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_LOWEST</code></td><td style="text-align:left;">19</td><td style="text-align:left;">æœ€ä½ä¼˜å…ˆçº§</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_BACKGROUND</code></td><td style="text-align:left;">10</td><td style="text-align:left;">ç”¨äº <code>Background Tasks</code></td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_NORMAL</code></td><td style="text-align:left;">0</td><td style="text-align:left;">å¤§éƒ¨åˆ†çº¿ç¨‹éƒ½ä»¥è¿™ä¸ªä¼˜å…ˆçº§è¿è¡Œ</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_FOREGROUND</code></td><td style="text-align:left;">-2</td><td style="text-align:left;">ç”¨æˆ·æ­£åœ¨äº¤äº’çº¿ç¨‹çš„ä¼˜å…ˆçº§</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_DISPLAY</code></td><td style="text-align:left;">-4</td><td style="text-align:left;">UI ä¸»çº¿ç¨‹ä¼˜å…ˆçº§</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_URGENT_DISPLAY</code></td><td style="text-align:left;">-8</td><td style="text-align:left;">è¿™ä¸ªå€¼ç”± <code>HAL_PRIORITY_URGENT_DISPLAY</code> æ¥æŒ‡å®šï¼Œå½“å‰ç‰ˆæœ¬ä¸­æ˜¯ -8ã€‚åªåœ¨éƒ¨åˆ†ç´§æ€¥çŠ¶æ€ä¸‹ä½¿ç”¨</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_AUDIO</code></td><td style="text-align:left;">-16</td><td style="text-align:left;">æ­£å¸¸æƒ…å†µä¸‹çš„å£°éŸ³çº¿ç¨‹ä¼˜å…ˆçº§</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_URGENT_AUDIO</code></td><td style="text-align:left;">-19</td><td style="text-align:left;">ç´§æ€¥å£°éŸ³çº¿ç¨‹ä¼˜å…ˆçº§ï¼ˆé€šå¸¸æƒ…å†µä¸‹ä¸ä½¿ç”¨ï¼‰</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_HIGHEST</code></td><td style="text-align:left;">-20</td><td style="text-align:left;">æœ€é«˜ä¼˜å…ˆçº§ï¼Œç¦æ­¢ä½¿ç”¨</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_DEFAULT</code></td><td style="text-align:left;">0</td><td style="text-align:left;">é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯ ANDROID_PRIORITY_NORMAL</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_MORE_FAVORABLE</code></td><td style="text-align:left;">-1</td><td style="text-align:left;">åœ¨ä¸Šè¿°å„ä¼˜å…ˆçº§å®šä¹‰çš„åŸºç¡€ä¸Šï¼Œç”¨äºé€‚å½“å¾®è°ƒï¼ˆåŠ å¤§ï¼‰ä¼˜å…ˆçº§</td></tr><tr><td style="text-align:left;"><code>ANDROID_PRIORITY_LESS_FAVORABLE</code></td><td style="text-align:left;">+1</td><td style="text-align:left;">åœ¨ä¸Šè¿°å„ä¼˜å…ˆçº§å®šä¹‰çš„åŸºç¡€ä¸Šï¼Œç”¨äºé€‚å½“å¾®è°ƒï¼ˆå‡å°ï¼‰ä¼˜å…ˆçº§</td></tr></tbody></table><blockquote><p>æ•°å€¼è¶Šå¤§çš„ï¼Œä¼˜å…ˆçº§è¶Šå°ã€‚</p><p>å› ä¸ºå„ç­‰çº§é—´çš„æ•°å€¼å¹¶ä¸æ˜¯è¿ç»­çš„ï¼Œ</p><p>æ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è¡¨ä¸­æœ€åçš„ <code>ANDROID_PRIORITY_MORE_FAVORABLE</code>(-1) æ¥é€‚å½“åœ°æé«˜ä¼˜å…ˆçº§ï¼›</p><p>æˆ–è€…åˆ©ç”¨ <code>ANDROID_PRIORITY_LESS_FAVORABLE</code>(+1) æ¥é™ä½ä¼˜å…ˆçº§ã€‚</p></blockquote><div class="language-text ext-text"><pre class="language-text"><code>ç”±æ­¤å¯è§ï¼ŒSurfaceFlinger å·¥ä½œçº¿ç¨‹æ‰€é‡‡ç”¨çš„ä¼˜å…ˆçº§ç›¸å¯¹è¾ƒé«˜ã€‚
å› ä¸ºå±å¹• UI æ˜¾ç¤ºæ— ç–‘æ˜¯äººæœºäº¤äº’ä¸­ä¸ç”¨æˆ·ä½“éªŒå…³è”æœ€ç›´æ¥çš„ï¼Œä»»ä½•æ»åçš„å“åº”é€Ÿåº¦éƒ½å°†å¤§å¤§é™ä½äº§å“çš„å¸å¼•åŠ›ã€‚
</code></pre></div><p>åœ¨æ‰§è¡Œäº† <code>Thread::run()</code> ä»¥åï¼Œ<code>Thread</code> ä¼šè‡ªåŠ¨è°ƒç”¨ <code>Thread::threadLoop()</code> æ¥å£ã€‚å³ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">threadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">waitForEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å…¶ä¸­<code> waitForEvent()</code> æ˜¯ <code>SurfaceFlinger</code> ä¸­çš„æˆå‘˜å‡½æ•°ï¼Œå®ƒä¼šè¿›ä¸€æ­¥è°ƒç”¨ <code>mEventQueue.waitMessage()</code>ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* 
    æ­¤å‡½æ•°åœ¨é«˜ç‰ˆæœ¬ä¸­æœªå‘ç”Ÿå˜åŒ–ï¼Œåªæ˜¯ MessageQueue æ–‡ä»¶çš„è·¯å¾„å‘ç”Ÿäº†å˜åŒ–ï¼š
    frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp
*/</span>
<span class="token keyword">void</span> <span class="token class-name">MessageQueue</span><span class="token double-colon punctuation">::</span><span class="token function">waitMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">flushCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int32_t</span> ret <span class="token operator">=</span> mLooper<span class="token operator">-&gt;</span><span class="token function">pollOnce</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> ALOOPER_POLL_WAKE<span class="token operator">:</span>
            <span class="token keyword">case</span> ALOOPER_POLL_CALLBACK<span class="token operator">:</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> ALOOPER_POLL_ERROR<span class="token operator">:</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;ALOOPER_POLL_ERROR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> ALOOPER_POLL_TIMEOUT<span class="token operator">:</span>
                <span class="token comment">// timeout (should not happen)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">// should not happen</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;Looper::pollOnce() returned unknown status %d&quot;</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>å¯ä»¥çœ‹åˆ°ç¨‹åºåœ¨è¿™é‡Œè¿›å…¥äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè€Œä¸”å³ä¾¿ <code>pollOnce</code> çš„æ‰§è¡Œç»“æœæ˜¯ <code>ALOOPER_POLL_TIMEOUT</code>ï¼Œä¹ŸåŒæ ·ä¸ä¼šè·³å‡ºå¾ªç¯ã€‚</p><p>è¿™æ˜¯ <code>Android</code> åœ¨å¯¹å¾…ä¸¥é‡é”™è¯¯æ—¶çš„ä¸€ç§æ™®éæ€åº¦ï¼Œå³ï¼šå¦‚æœä¸å¹¸å‘ç”Ÿè‡´å‘½é”™è¯¯ï¼Œå°±å¬å¤©ç”±å‘½å§ã€‚</p></blockquote><p><strong><code>mLooper-&gt;pollOnce(-1)</code></strong> åœ¨å†…éƒ¨è°ƒç”¨ <code>MessageQueue::mHandler</code> æ¥å¤„ç†æ¶ˆæ¯ï¼š</p><blockquote><p>æ³¨æ„ï¼š<code>pollOnce</code> å‡½æ•°åŒæ ·ä½¿ç”¨äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå®ƒä¸æ–­åœ°è¯»å–æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚</p></blockquote><p><code>MessageQueue</code> æ˜¯æ¶ˆæ¯å¾ªç¯å¤„ç†æœºåˆ¶çš„ç®¡ç†è€…ï¼Œå…¶ä¸‹åŒ…å«äº†ä¸€ä¸ª <code>Looper</code> å’Œä¸€ä¸ª <code>Handler</code>ã€‚<code>Looper</code> ä¸­çš„ <code>mMessageEnvelope</code> æ‰æ˜¯çœŸæ­£å­˜å‚¨æ¶ˆæ¯çš„åœ°æ–¹ã€‚</p><blockquote><p>é«˜ç‰ˆæœ¬ä¸­ï¼Œ<code>Looper</code> çš„æ–‡ä»¶ä½ç½®å¦‚ä¸‹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>system/core/libutils/include/utils/Looper.h
system/core/libutils/Looper.cpp
</code></pre></div></blockquote><p>è¿™æ ·å°±æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯æ¶ˆæ¯å¤„ç†æ¡†æ¶ï¼Œ<code>SurfaceFlinger</code> å°±æ˜¯åŸºäºè¿™ä¸ªæ¡†æ¶æ¥å®Œæˆå„ä¸ªåº”ç”¨ç¨‹åºçš„æ˜¾ç¤ºè¯·æ±‚çš„ã€‚</p><p><code>MessageQueue::mHandler</code> å¹¶éæˆ‘ä»¬åœ¨æ¶ˆæ¯æœºåˆ¶ä¸­è®¤è¯†çš„é‚£ä¸ª <code>Handler</code>ï¼Œè€Œæ˜¯ <code>MessageQueue</code> ä¸­è‡ªå®šä¹‰çš„ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼Œå³å®ƒæ˜¯ä¸“é—¨ä¸º <code>SurfaceFlinger</code> è®¾è®¡çš„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*frameworks/native/services/surfaceflinger/MessageQueue.cpp*/</span>
<span class="token keyword">void</span> MessageQueue<span class="token double-colon punctuation">::</span><span class="token class-name">Handler</span><span class="token double-colon punctuation">::</span><span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> Message<span class="token operator">&amp;</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> INVALIDATE<span class="token operator">:</span>
           <span class="token function">android_atomic_and</span><span class="token punctuation">(</span>ï½eventMaskInvalidate<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mEventMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
           mQueue<span class="token punctuation">.</span>mFlinger<span class="token operator">-&gt;</span><span class="token function">onMessageReceived</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> REFRESH<span class="token operator">:</span>
           <span class="token function">android_atomic_and</span><span class="token punctuation">(</span>ï½eventMaskRefresh<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mEventMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
           mQueue<span class="token punctuation">.</span>mFlinger<span class="token operator">-&gt;</span><span class="token function">onMessageReceived</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> TRANSACTION<span class="token operator">:</span>
           <span class="token function">android_atomic_and</span><span class="token punctuation">(</span>ï½eventMaskTransaction<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mEventMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
           mQueue<span class="token punctuation">.</span>mFlinger<span class="token operator">-&gt;</span><span class="token function">onMessageReceived</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚ä¸Šè¿°ä»£ç æ®µæ‰€ç¤ºï¼Œå½“ <code>mHandler</code> æ”¶åˆ° <code>INVALIDATE</code>ï¼Œ<code>REFRESH</code> åŠ <code>TRANSACTION</code> çš„è¯·æ±‚æ—¶ï¼Œå°†è¿›ä¸€æ­¥å›è°ƒ <code>SurfaceFlinger</code> ä¸­çš„ <code>onMessageReceived</code>ã€‚ç­‰äºç»•äº†ä¸€ä¸ªå¤§åœˆï¼Œåˆå›åˆ° <code>SurfaceFlinger</code> ä¸­äº†ã€‚</p><blockquote><p>é«˜ç‰ˆä¸­çš„å·®å¼‚ï¼š<code>SurfaceFlinger::onMessageReceived</code> è¢« <code>Scheduler::onFrameSignal</code> æ›¿ä»£ã€‚</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp */</span>
<span class="token keyword">void</span> MessageQueue<span class="token double-colon punctuation">::</span><span class="token class-name">Handler</span><span class="token double-colon punctuation">::</span><span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> Message<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mFramePending<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        mQueue æ˜¯ MessageQueue çš„å®ç°ç±» Scheduler
        [class Scheduler : public IEventThreadCallback, android::impl::MessageQueue]
        å¤´æ–‡ä»¶è·¯å¾„ï¼šframeworks/native/services/surfaceflinger/Scheduler/Scheduler.h
        
    */</span>
    mQueue<span class="token punctuation">.</span><span class="token function">onFrameSignal</span><span class="token punctuation">(</span>mQueue<span class="token punctuation">.</span>mCompositor<span class="token punctuation">,</span> mVsyncId<span class="token punctuation">,</span> mExpectedVsyncTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></blockquote><h3 id="_6-3-æ¥å£çš„æœåŠ¡ç«¯-â€”â€”-client" tabindex="-1"><a class="header-anchor" href="#_6-3-æ¥å£çš„æœåŠ¡ç«¯-â€”â€”-client" aria-hidden="true">#</a> 6.3 æ¥å£çš„æœåŠ¡ç«¯ â€”â€” <code>Client</code></h3><p><code>SurfaceFlinger</code> è¿è¡Œäº <code>SystemServer</code> è¿™ä¸€ç³»ç»Ÿè¿›ç¨‹ä¸­ï¼Œéœ€è¦æ˜¾ç¤º <code>UI</code> ç•Œé¢çš„åº”ç”¨ç¨‹åºåˆ™é€šè¿‡ <code>Binder</code> æœåŠ¡ä¸å®ƒè¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ã€‚æ¯ä¸ªåº”ç”¨ç¨‹åºåœ¨ <code>SurfaceFlinger</code> ä¸­éƒ½æœ‰ <code>Client</code> ä¸ºå…¶æä¾›æœåŠ¡ã€‚</p><p><code>Client</code> è¿™ä¸ªç±»åå¹¶æ²¡æœ‰å®Œå…¨è¡¨è¾¾å‡ºå®ƒçš„çœŸæ­£å«ä¹‰ï¼Œå› ä¸ºåœ¨ <code>Android</code> ç³»ç»Ÿçš„å¾ˆå¤šå…¶ä»–åœ°æ–¹éƒ½å¯ä»¥æ‰¾åˆ°åŒåçš„ç±»ã€‚</p><p>åº”ç”¨ç¨‹åºä¸ <code>Client</code> é—´çš„ <code>Binder</code> æ¥å£æ˜¯ <code>ISurfaceComposerClient</code>ï¼Œæ‰€ä»¥ä½œä¸ºæ¥å£çš„æœåŠ¡ç«¯å®ç°ï¼Œ<code>Client</code> ç»§æ‰¿è‡ª <code>BnSurfaceComposerClient</code>ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/*frameworks/native/include/gui/ISurfaceComposerClient.h*/</span>
<span class="token keyword">class</span> <span class="token class-name">ISurfaceComposerClient</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IInterface</span></span>
<span class="token punctuation">{</span>   
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">virtual</span> status_t <span class="token function">createSurface</span><span class="token punctuation">(</span><span class="token keyword">const</span> String8<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> w<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> h<span class="token punctuation">,</span> PixelFormat format<span class="token punctuation">,</span>
                        <span class="token keyword">uint32_t</span> flags<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">*</span> gbp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> status_t <span class="token function">destroySurface</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">&amp;</span> handle<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šè¿°æ¥å£æ–¹æ³•ä¸­æœ€é‡è¦çš„ä¸¤ä¸ªæ˜¯ <code>createSurface()</code> å’Œ <code>destroySurface()</code>ï¼Œåˆ†åˆ«ç”¨äºå‘ <code>SurfaceFlinger</code> ç”³è¯·å’Œé”€æ¯ä¸€ä¸ª <code>Surface</code>ã€‚</p><blockquote><p>æ›´æ—©æœŸç‰ˆæœ¬çš„ç³»ç»Ÿä¸­ <code>createSurface</code> è¿”å›çš„æ˜¯ä¸€ä¸ªå«ä½œ <code>ISurface</code> çš„ <code>Binder</code> æ¥å£ï¼Œç›®å‰å·²ç»ä¸å¤å­˜åœ¨ã€‚</p><p>ä½† <code>createSurface</code> è¿™ä¸ªå‡½æ•°åç§°è¿˜æ²¡æœ‰å˜ã€‚<strong>æˆ‘ä»¬å¯ä»¥è®¤ä¸º <code>Surface</code> åœ¨æœåŠ¡å™¨ç«¯å¯¹åº”çš„æ˜¯ <code>Layer</code></strong>ã€‚</p></blockquote><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ<code>SurfaceFlinger</code> çš„å®¢æˆ·ç«¯ç¨‹åºæ‹¥æœ‰çš„ <code>Surface</code> æ•°é‡å¾ˆå¯èƒ½ä¸æ­¢ä¸€ä¸ªã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>é€šå¸¸æƒ…å†µä¸‹ï¼ŒåŒä¸€ä¸ª Activity ä¸­çš„ UI å¸ƒå±€å…±ç”¨ç³»ç»Ÿåˆ†é…çš„ Surface è¿›è¡Œç»˜å›¾ï¼Œ
ä½†åƒ SurfaceView è¿™ç§ UI ç»„ä»¶å´æ˜¯ç‰¹ä¾‹ â€”â€” å®ƒç‹¬å ä¸€ä¸ª Surface è¿›è¡Œç»˜åˆ¶ã€‚
</code></pre></div><p>æ¢å¥è¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªå¸¦ <code>SurfaceView</code> çš„è§†é¢‘æ’­æ”¾å™¨ï¼Œå…¶æ‰€åœ¨çš„åº”ç”¨ç¨‹åºæœ€ç»ˆå°±ä¼šæœ‰ä¸æ­¢ä¸€ä¸ªçš„ <code>Surface</code> å­˜åœ¨ã€‚</p><blockquote><p>è¿™æ ·çš„è®¾è®¡æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºæ’­æ”¾è§†é¢‘å¯¹åˆ·æ–°é¢‘ç‡è¦æ±‚å¾ˆé«˜ï¼Œé‡‡ç”¨å•ç‹¬çš„ <code>Surface</code> æ—¢å¯ä»¥ä¿è¯è§†é¢‘çš„æµç•…åº¦ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è®©ç”¨æˆ·çš„äº¤äº’åŠ¨ä½œï¼ˆæ¯”å¦‚è§¦æ‘¸äº‹ä»¶ï¼‰å¾—åˆ°åŠæ—¶çš„å“åº”ã€‚</p></blockquote><p>ä¸‹é¢æˆ‘ä»¬ä»æºç è§’åº¦æ¥åˆ†æå®¢æˆ·ç«¯ä¸ <code>SurfaceFlinger</code> è¿æ¥å¹¶åˆ›å»º <code>Layer</code> çš„ä¸¤ä¸ªé‡è¦æ¥å£ã€‚</p><h4 id="_6-3-1-surfaceflinger-createconnection" tabindex="-1"><a class="header-anchor" href="#_6-3-1-surfaceflinger-createconnection" aria-hidden="true">#</a> 6.3.1 <code>SurfaceFlinger::createConnection</code></h4><p><code>Client</code> å±äºåŒ¿å <code>Binder</code> æœåŠ¡ï¼Œå¤–ç•Œçš„è¿›ç¨‹ä¸å¯èƒ½ç›´æ¥è·å–åˆ°ï¼Œå› è€Œå®ƒé¦–å…ˆéœ€è¦å€ŸåŠ©äº <code>SurfaceFlinger</code> è¿™ä¸€å®å <code>Binder Server</code>ã€‚æºç å®ç°å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>sp<span class="token operator">&lt;</span>ISurfaceComposerClient<span class="token operator">&gt;</span> <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>ISurfaceComposerClient<span class="token operator">&gt;</span> bclient<span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>Client<span class="token operator">&gt;</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Client</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    status_t err <span class="token operator">=</span> client<span class="token operator">-&gt;</span><span class="token function">initCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bclient <span class="token operator">=</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bclient<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é¦–å…ˆç”Ÿæˆä¸€ä¸ª <code>Client</code> æœ¬åœ°å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ <code>initCheck</code> è¿›è¡Œå¿…è¦çš„æœ‰æ•ˆæ€§æ£€æŸ¥ï¼ˆå½“å‰å®ç°ä¸­ç›´æ¥è¿”å› <code>NO_ERROR</code>ï¼‰ã€‚</p><p>å¦‚æœ <code>initCheck</code> æ²¡æœ‰é”™è¯¯ï¼Œç¨‹åºå°±ä¼šæŠŠæ–°ç”Ÿæˆçš„ <code>Client</code> å¯¹è±¡ä»¥ <code>ISurfaceComposerClient</code> å¼ºæŒ‡é’ˆçš„å½¢å¼è¿”å›ã€‚</p><p>è¿™æ ·åº”ç”¨ç¨‹åºå†…éƒ¨å°±æ‹¥æœ‰ä¸€ä¸ª <code>Client</code> æœåŠ¡äº†ã€‚</p><blockquote><p>é«˜ç‰ˆæœ¬çš„å·®å¼‚ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp */</span>
binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">SurfaceComposerAIDL</span><span class="token double-colon punctuation">::</span><span class="token function">createConnection</span><span class="token punctuation">(</span>sp<span class="token operator">&lt;</span>gui<span class="token double-colon punctuation">::</span>ISurfaceComposerClient<span class="token operator">&gt;</span><span class="token operator">*</span> outClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Client<span class="token operator">&gt;</span> client <span class="token operator">=</span> <span class="token class-name">sp</span><span class="token operator">&lt;</span>Client<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span>mFlinger<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆ›å»º Client å¯¹è±¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token operator">-&gt;</span><span class="token function">initCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>outClient <span class="token operator">=</span> client<span class="token punctuation">;</span> <span class="token comment">// å°† Client å¯¹è±¡ä»¥ ISurfaceComposerClient å¼ºæŒ‡é’ˆçš„å½¢å¼è¿”å›</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> binder<span class="token double-colon punctuation">::</span><span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>outClient <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">binderStatusFromStatusT</span><span class="token punctuation">(</span>BAD_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></blockquote><h4 id="_6-3-2-client-createsurface" tabindex="-1"><a class="header-anchor" href="#_6-3-2-client-createsurface" aria-hidden="true">#</a> 6.3.2 <code>Client::createSurface</code></h4><p><code>Client</code> åªæ˜¯ <code>SurfaceFlinger</code> åˆ†æ´¾ç»™åº”ç”¨ç¨‹åºçš„ä¸€ä¸ª â€œä»£è¡¨â€ï¼ŒçœŸæ­£çš„å›¾å½¢å±‚ï¼ˆ<code>Layer</code>ï¼‰åˆ›å»ºéœ€è¦å¦å¤–ç”³è¯·ï¼Œå³è°ƒç”¨ <code>Client</code> æä¾›çš„ <code>createSurface</code> æ¥å£ã€‚è¿™ä¸ªæ¥å£çš„å®ç°åœ¨å‰å‡ ä¸ªå°èŠ‚å·²ç»æœ‰è¿‡ç²—ç•¥çš„åˆ†æï¼Œä¸‹é¢å†ä» <code>SurfaceFlinger</code> çš„è§’åº¦æ¥å®¡è§†ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/Client.cpp */</span>
status_t <span class="token class-name">Client</span><span class="token double-colon punctuation">::</span><span class="token function">createSurface</span><span class="token punctuation">(</span><span class="token keyword">const</span> String8<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> w<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> h<span class="token punctuation">,</span> 
            PixelFormat format<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">,</span>sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">*</span> gbp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">MessageCreateLayer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">MessageBase</span></span> <span class="token punctuation">{</span>
        SurfaceFlinger<span class="token operator">*</span> flinger<span class="token punctuation">;</span> <span class="token comment">// SurfaceFlinger æœåŠ¡</span>
        Client<span class="token operator">*</span> client<span class="token punctuation">;</span> <span class="token comment">// è¡¨æ˜æ­¤æ¶ˆæ¯æ¥æºäºå“ªä¸ª Client</span>
        sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">*</span> handle<span class="token punctuation">;</span> <span class="token comment">// ä¸ Layer ç›¸å¯¹åº”çš„ Handle</span>
        sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">*</span> gbp<span class="token punctuation">;</span> <span class="token comment">// ä¸ Layer ç›¸å¯¹åº”çš„ gbp</span>
        status_t result<span class="token punctuation">;</span>
        <span class="token keyword">const</span> String8<span class="token operator">&amp;</span> name<span class="token punctuation">;</span>
        <span class="token keyword">uint32_t</span> w<span class="token punctuation">,</span> h<span class="token punctuation">;</span>
        PixelFormat format<span class="token punctuation">;</span>
        <span class="token keyword">uint32_t</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">MessageCreateLayer</span><span class="token punctuation">(</span>SurfaceFlinger<span class="token operator">*</span> flinger<span class="token punctuation">,</span> <span class="token keyword">const</span> String8<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> Client<span class="token operator">*</span> client<span class="token punctuation">,</span> uint32_tw<span class="token punctuation">,</span>
                           <span class="token keyword">uint32_t</span> h<span class="token punctuation">,</span> PixelFormat format<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">,</span>
                           sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IGraphicBufferProducer<span class="token operator">&gt;</span><span class="token operator">*</span> gbp<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">flinger</span><span class="token punctuation">(</span>flinger<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">handle</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">gbp</span><span class="token punctuation">(</span>gbp<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">name</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">w</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">format</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        status_t <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// SurfaceFlinger å°†å›è°ƒè¿™ä¸ª handler æ¥æ‰§è¡Œå…·ä½“çš„äº‹åŠ¡</span>
            result <span class="token operator">=</span> flinger<span class="token operator">-&gt;</span><span class="token function">createLayer</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> client<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> format<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> gbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    sp<span class="token operator">&lt;</span>MessageBase<span class="token operator">&gt;</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MessageCreateLayer</span><span class="token punctuation">(</span>mFlinger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> format<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> gbp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç”Ÿæˆä¸€ä¸ªæ¶ˆæ¯</span>
    mFlinger<span class="token operator">-&gt;</span><span class="token function">postMessageSync</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†è¿™ä¸€ Message æ¨é€åˆ° SurfaceFlinger çº¿ç¨‹ä¸­</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>MessageCreateLayer<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¿”å›ç»“æœ</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>createSurface</code> è¿™ä¸ªå‡½æ•°éœ€è¦ä» <code>OpenGL ES</code> çš„ç¯å¢ƒçº¿ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œè¿™æ ·å®ƒæ‰èƒ½è®¿é—®åˆ°åè€…æä¾›çš„æœåŠ¡ã€‚</p></blockquote><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç‰¹åˆ«çš„åœ°æ–¹ï¼Œæ˜¯å®ƒå…ˆåœ¨å†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ª <code>MessageCreateLayer</code> ç±»ï¼Œå‰©ä½™éƒ¨åˆ†ä»£ç å°±æ˜¯å›´ç»•è¿™ä¸ªç±»æ¥å±•å¼€çš„ã€‚</p><p><code>MessageCreateLayer</code> ç»§æ‰¿è‡ª <code>MessageBase</code>ï¼Œæ‰€ä»¥ <code>MessageCreateLayer</code> æ˜¯ä¸€ä¸ª <code>Message</code> çš„æ‰¿è½½ä½“ï¼Œå¹¶ä¸”å†…éƒ¨æä¾›äº†å¤„ç†è¿™æ¡ <code>Message</code> çš„ <code>handler()</code> å‡½æ•°ã€‚</p><p>åœ¨ <code>Client::createSurface</code> å‡½æ•°æœ€åè°ƒç”¨ <code>SurfaceFlinger::postMessageSync</code> å°†ä¸€ä¸ª <code>MessageCreateLayer</code> å¯¹è±¡ <code>msg</code> å‘é€åˆ°äº† <code>SurfaceFlinger</code> ä¸­ã€‚</p><p>å‡½æ•° <code>SurfaceFlinger::postMessageSync</code> é€šè¿‡ <code>mEventQueue</code> å°† <code>msg</code> å‹å…¥å…¶æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>status_t <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">postMessageSync</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>MessageBase<span class="token operator">&gt;</span><span class="token operator">&amp;</span> msg<span class="token punctuation">,</span>nsecs_t reltime<span class="token punctuation">,</span> uint <span class="token number">32</span>_t flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status_t res <span class="token operator">=</span> mEventQueue<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> reltime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msg<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>MessageBase::wait()</code> è°ƒç”¨å†…éƒ¨çš„ <code>Barrier::wait</code> æ¥å®ç°ç­‰å¾…ï¼Œè¿™æ„å‘³ç€å‘é€æ¶ˆæ¯çš„çº¿ç¨‹å°†æš‚æ—¶åœæ­¢æ‰§è¡Œï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™æ‰èƒ½ç»§ç»­å‘¢ï¼Ÿæ˜¾ç„¶å¾—å…ˆå”¤é†’å®ƒæ‰è¡Œã€‚è¿™ä¸ªå”¤é†’çš„åœ°æ–¹éšè—åœ¨ <code>MessageBase::handleMessage()</code> ä¸­ã€‚å³ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/MessageQueue.cpp */</span>
<span class="token keyword">void</span> <span class="token class-name">MessageBase</span><span class="token double-colon punctuation">::</span><span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> Message<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    barrier<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯ <code>Client</code> ä¸€æ—¦æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶ä¸ä¼šé©¬ä¸Šè®© <code>SurfaceFlinger</code> æ‰§è¡Œï¼Œè€Œæ˜¯é—´æ¥åœ°æŠŠè¯·æ±‚å…ˆæŠ•é€’åˆ°åè€…çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·ä¸€æ–¹é¢ä¿è¯è¿™ä¸ªè¯·æ±‚ä¸ä¼šä¸¢å¤±ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿä½¿ <code>SurfaceFlinger</code> ä¸è‡³äºä¸­æ–­å½“å‰çš„æ“ä½œã€‚</p><p>ç»•äº†ä¸€åœˆï¼Œå…¶å® <code>Client::createSurface</code> å‡½æ•°çš„ä½œç”¨å°±æ˜¯é€šè¿‡æ‰§è¡Œ <code>SurfaceFlinger::createLayer</code> å‡½æ•°æ¥åˆ›å»º <code>Layer</code>ã€‚</p><blockquote><p><code>SurfaceFlinger::createLayer</code> åˆ›å»ºå›¾å±‚çš„è¿‡ç¨‹åˆ†æè§ <a href="#_9-5-4-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%8E-bufferqueue-%E7%9A%84%E5%85%B3%E7%B3%BB">9.5.4 åº”ç”¨ç¨‹åºä¸ BufferQueue çš„å…³ç³»</a> å°èŠ‚ã€‚</p></blockquote><h2 id="_7-vsync-çš„äº§ç”Ÿå’Œå¤„ç†" tabindex="-1"><a class="header-anchor" href="#_7-vsync-çš„äº§ç”Ÿå’Œå¤„ç†" aria-hidden="true">#</a> 7 <code>VSync</code> çš„äº§ç”Ÿå’Œå¤„ç†</h2><p><code>VSync</code> åŒæ­¥æ˜¯ä» <code>Android 4.1</code> å¼€å§‹å¼•å…¥çš„æ˜¾ç¤ºç³»ç»Ÿæ–°ç‰¹æ€§ï¼Œä¹Ÿæ˜¯ â€œé»„æ²¹è®¡åˆ’â€ çš„ä¸€ä¸ªé‡è¦æ ¸å¿ƒã€‚</p><p>åœ¨ <a href="#_9-6-1-%E9%BB%84%E6%B2%B9%E8%AE%A1%E5%88%92-project-butter">9.6.1 â€œé»„æ²¹è®¡åˆ’â€</a> å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»ç†è®ºçš„è§’åº¦åˆ†æäº†é‡‡ç”¨è¿™ä¸€æœºåˆ¶çš„å¿…è¦æ€§å’Œè¿ä½œæœºç†ï¼Œé‚£ä¹ˆ <code>SurfaceFlinger</code> å…·ä½“æ˜¯å¦‚ä½•å®æ–½çš„å‘¢ï¼Ÿ</p><p>å…ˆæ¥æ€è€ƒä¸€ä¸‹ <code>SurfaceFlinger</code> å®ç° <code>VSync</code> åŒæ­¥æœ‰å“ªäº›è¦ç‚¹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>VSync ä¿¡å·çš„äº§ç”Ÿå’Œåˆ†å‘
    å¦‚æœæœ‰ç¡¬ä»¶ä¸»åŠ¨å‘å‡ºè¿™ä¸€ä¿¡å·ï¼Œé‚£æ˜¯æœ€å¥½çš„ï¼›
    å¦åˆ™å°±å¾—é€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿäº§ç”Ÿã€‚

VSync ä¿¡å·çš„å¤„ç†
    å½“ä¿¡å·äº§ç”Ÿåï¼ŒSurfaceFlinger å¦‚ä½•åœ¨æœ€çŸ­çš„æ—¶é—´å†…åšå‡ºå“åº”ã€‚
    å¦å¤–ï¼Œå…·ä½“çš„å¤„ç†æµç¨‹æ˜¯æ€æ ·çš„ã€‚
</code></pre></div><h3 id="_7-1-vsync-ä¿¡å·çš„äº§ç”Ÿå’Œåˆ†å‘" tabindex="-1"><a class="header-anchor" href="#_7-1-vsync-ä¿¡å·çš„äº§ç”Ÿå’Œåˆ†å‘" aria-hidden="true">#</a> 7.1 <code>VSync</code> ä¿¡å·çš„äº§ç”Ÿå’Œåˆ†å‘</h3><p><code>Android</code> æºç å·¥ç¨‹çš„ <code>surfaceflinger</code> ç›®å½•ä¸‹æœ‰ä¸€ä¸ª <code>displayhardware</code> æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­ <code>HWComposer</code> çš„ä¸»è¦èŒè´£ä¹‹ä¸€ï¼Œå°±æ˜¯ç”¨äºäº§ç”Ÿ <code>VSync</code> ä¿¡å·ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/displayhardware/HWComposer.cpp */</span>
<span class="token class-name">HWComposer</span><span class="token double-colon punctuation">::</span><span class="token function">HWComposer</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>SurfaceFlinger<span class="token operator">&gt;</span><span class="token operator">&amp;</span> flinger<span class="token punctuation">,</span> EventHandler<span class="token operator">&amp;</span> handler<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">mFlinger</span><span class="token punctuation">(</span>flinger<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mFbDev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mHwc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mNumDisplays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mCBContext</span><span class="token punctuation">(</span><span class="token keyword">new</span> cb_context<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mEventHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mVSyncCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mDebugForceFakeVSync</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">char</span> value<span class="token punctuation">[</span>PROPERTY_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">&quot;debug.sf.no_hw_vsync&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è·å–ç³»ç»Ÿå±æ€§</span>
    mDebugForceFakeVSync <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> needVSyncThread <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// æ˜¯å¦éœ€è¦è½¯ä»¶æ¨¡æ‹Ÿäº§ç”Ÿ VSync ä¿¡å·ï¼Œé»˜è®¤æ˜¯ true</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    
    <span class="token function">loadHwcModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ‰“å¼€ HWC çš„ HAL æ¨¡å—</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mHwc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mHwc<span class="token operator">-&gt;</span>registerProcs<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// æ³¨å†Œç¡¬ä»¶å›è°ƒäº‹ä»¶</span>
            mCBContext<span class="token operator">-&gt;</span>hwc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
            mCBContext<span class="token operator">-&gt;</span>procs<span class="token punctuation">.</span>invalidate <span class="token operator">=</span> <span class="token operator">&amp;</span>hook_invalidate<span class="token punctuation">;</span>
            mCBContext<span class="token operator">-&gt;</span>procs<span class="token punctuation">.</span>vsync <span class="token operator">=</span> <span class="token operator">&amp;</span>hook_vsync<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hwcHasApiVersion</span><span class="token punctuation">(</span>mHwc<span class="token punctuation">,</span> HWC_DEVICE_API_VERSION_1_1<span class="token punctuation">)</span><span class="token punctuation">)</span>
                mCBContext<span class="token operator">-&gt;</span>procs<span class="token punctuation">.</span>hotplug <span class="token operator">=</span> <span class="token operator">&amp;</span>hook_hotplug<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                mCBContext<span class="token operator">-&gt;</span>procs<span class="token punctuation">.</span>hotplug <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>mCBContext<span class="token operator">-&gt;</span>procs<span class="token punctuation">.</span>zero<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mCBContext<span class="token operator">-&gt;</span>procs<span class="token punctuation">.</span>zero<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHwc<span class="token operator">-&gt;</span><span class="token function">registerProcs</span><span class="token punctuation">(</span>mHwc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mCBContext<span class="token operator">-&gt;</span>procs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">// don&#39;t need a vsync thread if we have a hardware composer</span>
        needVSyncThread <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//ä¸éœ€è¦è½¯ä»¶æ¨¡æ‹Ÿ</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>needVSyncThread<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœéœ€è¦è½¯ä»¶æ¨¡æ‹Ÿ VSync ä¿¡å·çš„è¯ï¼Œå¯åŠ¨ä¸€ä¸ª VSyncThread çº¿ç¨‹</span>
        <span class="token comment">// we don&#39;t have VSYNC support, we need to fake it</span>
        mVSyncThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">VSyncThread</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒå°±æ˜¯å†³å®š <code>VSync</code> çš„ â€œä¿¡å·å‘ç”Ÿæºâ€ â€”â€” ç¡¬ä»¶å®ç°æˆ–è€…è½¯ä»¶æ¨¡æ‹Ÿã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>å‡å¦‚å½“å‰ç³»ç»Ÿå¯ä»¥æˆåŠŸåœ°åŠ è½½åç§°ä¸º HWC_HARDWARE_MODULE_ID=&quot;hwcomposer&quot; çš„ HAL æ¨¡å—ï¼Œ
å¹¶ä¸”é€šè¿‡è¿™ä¸ªåº“æ¨¡å—èƒ½é¡ºåˆ©æ‰“å¼€è®¾å¤‡ï¼ˆhwc_composer_device_tï¼‰ï¼Œå…¶ç‰ˆæœ¬å·åˆå¤§äº HWC_DEVICE_API_VERSION_1_1ï¼Œ
æˆ‘ä»¬å°±é‡‡ç”¨ â€œç¡¬ä»¶æºâ€ï¼ˆæ­¤æ—¶ needVSyncThread ä¸º falseï¼‰ï¼›
å¦åˆ™éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ VSync çº¿ç¨‹æ¥æ¨¡æ‹Ÿäº§ç”Ÿä¿¡å·ã€‚
</code></pre></div><blockquote><p>é«˜ç‰ˆæœ¬çš„å·®å¼‚ï¼š<code>HWComposer</code> ä¸­äº§ç”Ÿä¿¡å·å‘ç”Ÿæºçš„ä»£ç å­˜åœ¨å·®å¼‚ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp */</span>
<span class="token class-name">HWComposer</span><span class="token double-colon punctuation">::</span><span class="token function">HWComposer</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> composerServiceName<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">HWComposer</span><span class="token punctuation">(</span>Hwc2<span class="token double-colon punctuation">::</span><span class="token class-name">Composer</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span>composerServiceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/* frameworks/native/services/surfaceflinger/DisplayHardware/ComposerHal.cpp */</span>
std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Composer<span class="token operator">&gt;</span> <span class="token class-name">Composer</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> serviceName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AidlComposer</span><span class="token double-colon punctuation">::</span><span class="token function">isDeclared</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>AidlComposer<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>HidlComposer<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></blockquote><h4 id="_7-1-1-ç¡¬ä»¶æº" tabindex="-1"><a class="header-anchor" href="#_7-1-1-ç¡¬ä»¶æº" aria-hidden="true">#</a> 7.1.1 ç¡¬ä»¶æº</h4><blockquote><p>é«˜ç‰ˆæœ¬å­˜åœ¨å·®å¼‚ï¼Œåç»­å†æ›´æ–°ã€‚</p></blockquote><p>å¦‚æœ <code>mHwc-&gt;registerProcs</code> ä¸ä¸ºç©ºï¼Œæˆ‘ä»¬æ³¨å†Œç¡¬ä»¶å›è°ƒ <code>mCBContext.procs</code>ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp */</span>
status_t <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">readyToRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mHwc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">HWComposer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>HWComposer<span class="token double-colon punctuation">::</span>EventHandler <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä»ä¸­å¯ä»¥çœ‹å‡ºï¼Œ<code>HWComposer</code> ä¸­çš„ <code>mEventHandler</code> å°±æ˜¯ <code>SurfaceFlinger</code> å¯¹è±¡ï¼Œ æ‰€ä»¥ <code>SurfaceFlinger</code> å¿…é¡»è¦ç»§æ‰¿è‡ª <code>HWComposer::EventHandler</code>ï¼Œè¿™æ ·æ‰èƒ½å¤„ç† <code>callback</code> å‡½æ•° <code>onVSyncReceived</code>ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">SurfaceFlinger</span> <span class="token operator">:</span> <span class="token keyword">public</span> BinderService<span class="token operator">&lt;</span>SurfaceFlinger<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token keyword">private</span> HWComposer<span class="token double-colon punctuation">::</span>EventHandler
</code></pre></div><h4 id="_7-1-2-è½¯ä»¶æº" tabindex="-1"><a class="header-anchor" href="#_7-1-2-è½¯ä»¶æº" aria-hidden="true">#</a> 7.1.2 è½¯ä»¶æº</h4><p>è½¯ä»¶æºå’Œç¡¬ä»¶æºç›¸æ¯”æœ€å¤§åŒºåˆ«æ˜¯å®ƒéœ€è¦å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ <code>VSyncThread</code>ï¼Œå…¶è¿è¡Œä¼˜å…ˆçº§ä¸ <code>SurfaceFlinger</code> çš„å·¥ä½œçº¿ç¨‹æ˜¯ä¸€æ ·çš„ã€‚</p><blockquote><p>ä»ç†è®ºçš„è§’åº¦æ¥è®²ï¼Œä»»ä½•é€šè¿‡è½¯ä»¶å®šæ—¶æ¥å®ç°çš„æœºåˆ¶éƒ½ä¸å¯èƒ½æ˜¯ 100% å¯é çš„ï¼Œå³ä½¿ä¼˜å…ˆçº§å†é«˜ä¹Ÿå¯èƒ½å‡ºç°å»¶è¿Ÿå’Œæ„å¤–ã€‚</p><p>ä¸è¿‡å¦‚æœ â€œä¸å¯é â€ çš„æ¦‚ç‡å¾ˆå°ï¼Œè€Œä¸”å°±ç®—å‡ºç°æ„å¤–æ—¶ä¹Ÿä¸è‡³äºæ˜¯è‡´å‘½é”™è¯¯ï¼Œé‚£ä¹ˆè¿˜æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p><p>æ‰€ä»¥è¯´ <code>VSyncThread</code> ä»å®è·µçš„è§’åº¦æ¥è®²ï¼Œçš„ç¡®èµ·åˆ°äº†å¾ˆå¥½çš„ä½œç”¨ã€‚</p></blockquote><p>æ¥çœ‹çœ‹ <code>VSyncThread</code> éƒ½åšäº†äº›ä»€ä¹ˆå·¥ä½œï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">bool</span> HWComposer<span class="token double-colon punctuation">::</span><span class="token class-name">VSyncThread</span><span class="token double-colon punctuation">::</span><span class="token function">threadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">/* Step1. åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦ä½¿èƒ½äº† VSync ä¿¡å·å‘ç”Ÿæœºåˆ¶ */</span>
    <span class="token punctuation">{</span> <span class="token comment">// è‡ªåŠ¨é”æ§åˆ¶èŒƒå›´</span>
        Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>mEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//VSyncä¿¡å·å¼€å…³</span>
            mCondition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* Step2. è®¡ç®—éœ€è¦äº§ç”Ÿ VSync ä¿¡å·çš„æ—¶é—´ç‚¹ */</span>
    <span class="token keyword">const</span> nsecs_t period <span class="token operator">=</span> mRefreshPeriod<span class="token punctuation">;</span> <span class="token comment">// ä¿¡å·çš„äº§ç”Ÿé—´éš”</span>
    <span class="token keyword">const</span> nsecs_t now <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>CLOCK_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nsecs_t next_vsync <span class="token operator">=</span> mNextFakeVSync<span class="token punctuation">;</span> <span class="token comment">// äº§ç”Ÿä¿¡å·çš„æ—¶é—´</span>
    nsecs_t sleep <span class="token operator">=</span> next_vsync <span class="token operator">-</span> now<span class="token punctuation">;</span> <span class="token comment">// éœ€è¦ä¼‘çœ çš„æ—¶é•¿</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sleep <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//å·²ç»è¿‡äº†æ—¶é—´ç‚¹</span>
        sleep <span class="token operator">=</span> <span class="token punctuation">(</span>period <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>now <span class="token operator">-</span> next_vsync<span class="token punctuation">)</span> <span class="token operator">%</span> period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        next_vsync <span class="token operator">=</span> now <span class="token operator">+</span> sleep<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mNextFakeVSync <span class="token operator">=</span> next_vsync <span class="token operator">+</span> period<span class="token punctuation">;</span> <span class="token comment">// ä¸‹ä¸€æ¬¡çš„ VSync æ—¶é—´</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> spec<span class="token punctuation">;</span>
    spec<span class="token punctuation">.</span>tv_sec  <span class="token operator">=</span> next_vsync <span class="token operator">/</span> <span class="token number">1000000000</span><span class="token punctuation">;</span>
    spec<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> next_vsync <span class="token operator">%</span> <span class="token number">1000000000</span><span class="token punctuation">;</span>


    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">clock_nanosleep</span><span class="token punctuation">(</span>CLOCK_MONOTONIC<span class="token punctuation">,</span> TIMER_ABSTIME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>spec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¿›å…¥ä¼‘çœ </span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>err<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mHwc<span class="token punctuation">.</span>mEventHandler<span class="token punctuation">.</span><span class="token function">onVSyncReceived</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> next_vsync<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å’Œç¡¬ä»¶æºæ˜¯ä¸€æ ·çš„å›è°ƒ</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step1@VSyncThread::threadLoop

mEnabled æ˜¯ç”¨äºæ§åˆ¶æ˜¯å¦äº§ç”Ÿ VSync ä¿¡å·çš„ä¸€ä¸ªä½¿èƒ½å˜é‡ã€‚
å½“ç³»ç»Ÿå¸Œæœ›å…³é—­ VSync ä¿¡å·å‘ç”Ÿæºæ—¶ï¼Œå¯ä»¥è°ƒç”¨ VSyncThread::setEnabled(false)ï¼›å¦åˆ™è°ƒç”¨ setEnabled (true)ã€‚
å‡å¦‚ mEnabled ä¸º falseï¼ŒVSyncThread å°±å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°æœ‰äººå†æ¬¡ä½¿èƒ½è¿™ä¸ªçº¿ç¨‹ã€‚
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>Step2@VSyncThread::threadLoop

æ¥ä¸‹æ¥çš„ä»£ç ç”¨äºçœŸæ­£äº§ç”Ÿä¸€ä¸ª VSync ä¿¡å·ã€‚å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œæ— éå°±æ˜¯ä»¥ä¸‹æ­¥éª¤ï¼š
1. è®¡ç®—ä¸‹ä¸€æ¬¡äº§ç”Ÿ VSync ä¿¡å·çš„æ—¶é—´ï¼›
2. è¿›å…¥ä¼‘çœ ï¼›
3. ä¼‘çœ æ—¶é—´åˆ°äº†åï¼Œå‘å‡º VSync ä¿¡å·ï¼Œé€šçŸ¥æ„Ÿå…´è¶£çš„äººï¼›
4. å¾ªç¯å¾€å¤ã€‚
</code></pre></div><p>å˜é‡ <code>mRefreshPeriod</code> æŒ‡å®šäº†äº§ç”Ÿ <code>VSync</code> ä¿¡å·çš„é—´éš”ã€‚å®ƒçš„è®¡ç®—è¿‡ç¨‹åˆ†ä¸ºå‡ ç§æƒ…å†µï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. é¦–é€‰æ˜¯ä»ç¡¬ä»¶è®¾å¤‡è·å¾—çœŸå®çš„å€¼ï¼›
2. å¦åˆ™å°±é‡‡ç”¨å¦‚ä¸‹åŠæ³•ï¼š
    if (disp.refresh == 0) {
        disp.refresh = nsecs_t(1e9 / mFbDev-&gt;fps);
    }
    if (disp.refresh == 0) {
        disp.refresh = nsecs_t(1e9 / 60.0);
    }

ä¹Ÿå°±æ˜¯è¯´ä»ç¡¬ä»¶è®¾å¤‡è·å–ä¸åˆ°åï¼Œå–å€¼å…ˆç”± nsecs_t(1e9 / mFbDev-&gt;fps) è®¡ç®—å¾—åˆ°çš„
å¦‚æœè¿˜ä¸è¡Œï¼Œé‚£å°±åªèƒ½é‡‡ç”¨é»˜è®¤å€¼äº†ï¼Œå³ï¼šnsecs_t(1e9 / 60.0)ï¼Œæ­¤æ—¶ï¼ŒmRefreshPeriod å·®ä¸å¤šæ˜¯ 16ms
</code></pre></div><p>å› ä¸º <code>mNextFakeVSync</code> ä»£è¡¨çš„æ˜¯ â€œä¸‹ä¸€æ¬¡â€ äº§ç”Ÿä¿¡å·çš„æ—¶é—´ç‚¹ï¼Œæ‰€ä»¥é¦–å…ˆé€šè¿‡ <code>next_vsync = mNextFakeVSync</code> æ¥ç¡®å®š <code>next_vsync</code> çš„å€¼ã€‚</p><p>æ¥ç€è®¡ç®— <code>sleep</code>ï¼Œä¹Ÿå°±æ˜¯è·ç¦»äº§ç”Ÿä¿¡å·çš„æ—¶é—´ç‚¹è¿˜æœ‰å¤šé•¿ï¼ˆåŒæ—¶ä¹Ÿæ˜¯éœ€è¦ä¼‘çœ çš„æ—¶é—´ï¼‰ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚æœ <code>sleep</code> çš„ç»“æœå°äº 0 å‘¢ï¼Ÿä»£è¡¨æˆ‘ä»¬å·²ç»é”™è¿‡äº†è¿™ä¸€æ¬¡äº§ç”Ÿä¿¡å·çš„æœ€ä½³æ—¶é—´ç‚¹ï¼ˆè¿™æ˜¯æœ‰å¯èƒ½å‘ç”Ÿçš„ï¼‰ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±åªèƒ½è®¡ç®—ä¸‹ä¸€ä¸ªæœ€è¿‘çš„ <code>VSync</code> ç¦»ç°åœ¨è¿˜å‰©å¤šå°‘æ—¶é—´ã€‚å…¬å¼å¦‚ä¸‹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>sleep = (period - ((now - next_vsync) % period));
</code></pre></div><p>æˆ‘ä»¬é‡‡ç”¨è¿™ä¸ªå…¬å¼çš„ä¾æ®å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/assets/18.33026ab1.png" alt="" loading="lazy"></p><blockquote><p>ä¸Šå›¾çš„å‰ææ˜¯ <code>now</code> è¶…æ—¶æ—¶é—´ä¸èƒ½è¶…è¿‡ä¸€ä¸ª <code>period</code>ï¼Œå› è€Œ <code>sleep</code> å…¬å¼ä¸­è¿˜è¦åŠ ä¸Š <code>%period</code>ã€‚</p></blockquote><p>è®¡ç®—å®Œæˆ <code>sleep</code> åï¼Œ<code>mNextFakeVSync = next_vsync + period</code>ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>è¿™æ˜¯å› ä¸º mNextFakeVSync ä»£è¡¨çš„æ˜¯ä¸‹ä¸€æ¬¡ threadLoop éœ€è¦ç”¨åˆ°çš„æ—¶é—´ç‚¹ï¼Œ
è€Œ next_vsync æ˜¯æŒ‡ä¸‹ä¸€æ¬¡ï¼ˆæœ€è¿‘ä¸€æ¬¡ï¼‰äº§ç”Ÿ VSync çš„æ—¶é—´ç‚¹ã€‚
</code></pre></div><p>è¿™æ ·æˆ‘ä»¬å°±è®¡ç®—å‡ºæ¥ä¸‹ä¸€æ¬¡äº§ç”Ÿä¿¡å·çš„æ—¶é—´ç‚¹äº†ï¼Œé‚£ä¹ˆå¦‚ä½•åœ¨æŒ‡å®šçš„æ—¶é—´ç‚¹äº§ç”Ÿä¿¡å·å‘¢ï¼Ÿæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>å…¶ä¸€æ˜¯é‡‡ç”¨å®šæ—¶å™¨å›è°ƒï¼›
å…¶äºŒå°±æ˜¯é‡‡ç”¨ä¼‘çœ çš„å½¢å¼ä¸»åŠ¨ç­‰å¾…
</code></pre></div><blockquote><p><code>HWCompose</code> é‡‡ç”¨ä¼‘çœ çš„å½¢å¼ä¸»åŠ¨ç­‰å¾…ã€‚</p></blockquote><p>å¯æƒ³è€ŒçŸ¥è¿™é‡Œå¯¹æ—¶é—´ç²¾åº¦çš„è¦æ±‚æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥é‡‡ç”¨çš„å•ä½æ˜¯ <code>nanosecond</code>ï¼Œå³çº³ç§’çº§ã€‚</p><blockquote><p>å‡½æ•° <code>clock_nanosleep</code> çš„ç¬¬ä¸€ä¸ªå…¥å‚æ˜¯ <code>CLOCK_MONOTONIC</code>ï¼Œè¿™ç§ç±»å‹çš„æ—¶é’Ÿæ›´åŠ ç¨³å®šï¼Œä¸”ä¸å—ç³»ç»Ÿæ—¶é—´çš„å½±å“ã€‚</p></blockquote><p>ä¼‘çœ æ—¶é—´ä¸€åˆ°ï¼Œè¡¨ç¤ºäº§ç”Ÿä¿¡å·çš„æ—¶åˆ»åˆ°äº†ã€‚æ ¹æ®å‰é¢çš„åˆ†æï¼Œå°±æ˜¯é€šè¿‡ <code>mEventHandler.onVSyncReceived()</code> å›è°ƒæ¥é€šçŸ¥å¯¹æ¶ˆæ¯æ„Ÿå…´è¶£çš„äººï¼Œæ— è®ºè½¯ä»¶è¿˜æ˜¯ç¡¬ä»¶å‘ç”Ÿæºï¼Œå…¶å›è°ƒæ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><blockquote><p>é«˜ç‰ˆæœ¬ä¸­é€šè¿‡ <code>IComposerCallback::onVsync</code> å›è°ƒæ¥é€šçŸ¥ <code>Vsync</code> ä¿¡å·çš„äº§ç”Ÿã€‚</p></blockquote><p>å½“äº§ç”Ÿå®Œä¸€æ¬¡ä¿¡å·åï¼Œ<code>VSyncThread::threadLoop</code> è¿™ä¸ªå‡½æ•°å°±ç›´æ¥è¿”å› <code>true</code> äº†ã€‚</p><blockquote><p>æ€ä¹ˆæ²¡æœ‰çœ‹åˆ°å¾ªç¯çš„åœ°æ–¹ï¼Ÿè¿™æ˜¯å› ä¸ºå½“ <code>threadLoop</code> è¿”å›å€¼ <code>true</code> æ—¶ï¼Œå®ƒå°†è¢«ç³»ç»Ÿå†ä¸€æ¬¡è°ƒç”¨ï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚</p></blockquote><p><strong>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸‹ <code>SurfaceFlinger</code> æ˜¯å¦‚ä½•å¤„ç†è¿™ä¸ª <code>VSync</code> ä¿¡å·çš„ã€‚</strong></p><p>åœ¨ <code>SurfaceFlinger::onVSyncReceived</code> ä¸­ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">onVSyncReceived</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> nsecs_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">&lt;</span> DisplayDevice<span class="token double-colon punctuation">::</span>NUM_DISPLAY_TYPES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// we should only receive DisplayDevice::DisplayType from the vsync callback        </span>
        mEventThread<span class="token operator">-&gt;</span><span class="token function">onVSyncReceived</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// EventThread æ˜¯ä»€ä¹ˆï¼Ÿ</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>SurfaceFlinger</code> ç›´æ¥è°ƒç”¨äº† <code>EventThread</code> çš„ <code>onVSyncReceived</code> å®ç°ã€‚</p><p>ä»åç§°ä¸Šå¯ä»¥çŒœæµ‹åˆ°ï¼Œ<code>EventThread</code> æ˜¯ <code>SurfaceFilnger</code> ä¸­ä¸“é—¨ç”¨äºå¤„ç†äº‹ä»¶çš„çº¿ç¨‹ã€‚è¿™ä¸ª <code>EventThread</code> çº¿ç¨‹å¯¹è±¡æ˜¯åœ¨ <code>SurfaceFlinger::readyToRun</code> ç”Ÿæˆçš„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>status_t <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">readyToRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mEventThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">EventThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEventQueue<span class="token punctuation">.</span><span class="token function">setEventThread</span><span class="token punctuation">(</span>mEventThread<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// EventQueue ä¸ EventThread è¿›è¡Œäº†ç»‘å®š</span>
</code></pre></div><p><code>EventThread</code> çš„å¯åŠ¨å¹¶ä¸æ˜¯ç”± <code>SurfaceFlinger</code> å†³å®šçš„ï¼Œè€Œæ˜¯å–å†³äºå¼•ç”¨å®ƒçš„äººï¼Œå› ä¸º <code>EventThread</code> ç»§æ‰¿è‡ª <code>Thread</code>ï¼Œåè€…åˆæ˜¯ <code>RefBase</code> çš„å­ç±»ï¼Œæ‰€ä»¥å½“ç¬¬ä¸€æ¬¡æœ‰äººç”¨æ™ºèƒ½æŒ‡é’ˆå¼•ç”¨å®ƒæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ <code>onFirstRef</code> å‡½æ•°ï¼Œç»§è€ŒæŠŠè¿™ä¸ªçº¿ç¨‹ <code>run</code> èµ·æ¥ã€‚</p><blockquote><p><code>EventThread</code> çº¿ç¨‹ä¼˜å…ˆçº§ä¸º <code>PRIORITY_URGENT_DISPLAY + PRIORITY_MORE_FAVORABLE</code>ã€‚</p></blockquote><blockquote><p>é«˜ç‰ˆæœ¬çš„å·®å¼‚ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>SurfaceFlinger ä¸å†ç›´æ¥å¼•ç”¨ EventThreadï¼Œ è€Œæ˜¯æŠŠ EventThread ä¿å­˜åœ¨äº† Scheduler::mConnections ä¸­ï¼Œ
Scheduler::mConnects æ˜¯ä¸€ä¸ª Map é›†åˆï¼Œå­˜æ”¾ &lt;ConnectionHandle, Connection&gt; é”®å€¼å¯¹ï¼Œ
é”®å€¼å¯¹ä¸­ï¼ŒConnection æŒæœ‰ EventThread å¯¹è±¡çš„å¼•ç”¨ã€‚å¤–ç•Œé€šè¿‡ ConnectionHandle ä» Scheduler ä¸­è·å– Connectionã€‚

æ¶‰åŠåˆ°çš„å‡½æ•°ï¼š
    Scheduler::createEventThread
    Scheduler::createConnection
    EventThread::createEventConnection
</code></pre></div></blockquote><p>ä»‹ç»äº† <code>EventThread</code> çš„åˆ›å»ºå’Œå¯åŠ¨è¿‡ç¨‹åï¼Œå†æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å¤„ç†æ¶ˆæ¯çš„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/EventThread.cpp*/</span>
<span class="token keyword">void</span> <span class="token class-name">EventThread</span><span class="token double-colon punctuation">::</span><span class="token function">onVSyncReceived</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> nsecs_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>â€¦    
    Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">&lt;</span> HWC_NUM_DISPLAY_TYPES<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æ˜¾ç¤ºç±»å‹ç›®å‰æœ‰ä¸¤ç§</span>
        mVSyncEvent<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> DisplayEventReceiver<span class="token double-colon punctuation">::</span>DISPLAY_EVENT_VSYNC<span class="token punctuation">;</span>
        mVSyncEvent<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>id <span class="token operator">=</span> type<span class="token punctuation">;</span>
        mVSyncEvent<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
        mVSyncEvent<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span>vsync<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
        mCondition<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¡ä»¶æ»¡è¶³ï¼Œå”¤é†’è°ï¼Ÿ</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>EventThread::onVSyncReceived</code> å‡½æ•°å¯¹ <code>mVSyncEvent[type]</code> æ•°ç»„ä¸­çš„ <code>DisplayEventReceiver::Event</code> å¯¹è±¡çš„æˆå‘˜è¿›è¡Œæ•°æ®å¡«å……ï¼ˆåŒ…æ‹¬ï¼š<code>Event</code> ç±»å‹ã€æ—¶é—´æˆ³ã€ä¿¡å·è®¡æ•°ç­‰ï¼‰ã€‚</p><p>æœ€é‡è¦çš„æ˜¯ï¼Œ<code>EventThread::onVSyncReceived</code> å‡½æ•°æœ€åé€šè¿‡ <code>mCondition.broadcast()</code> æ¥é€šçŸ¥ç­‰å¾… <code>Event</code> çš„äºº â€”â€” ä¼šæ˜¯è°å‘¢ï¼Ÿæ²¡é”™ï¼Œæ˜¯ <code>EventThread</code> æ‰€åœ¨çš„çº¿ç¨‹ã€‚</p><p>å¯èƒ½æœ‰äººä¼šè§‰å¾—å¥‡æ€ªï¼Œ<code>onVSyncReceived</code> ä¸å°±æ˜¯å±äº <code>EventThread</code> å—ï¼Œæ€ä¹ˆè¿˜èƒ½å¤„äºç­‰å¾…ä¸­ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>ç”±ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œ
EventThread::onVSyncReceived å…¶å®æ˜¯ç”± SurfaceFlinger æ‰€åœ¨çº¿ç¨‹è°ƒç”¨çš„ï¼Œæ‰€ä»¥å®ƒçš„æ‰§è¡Œä¹Ÿæ˜¯ç”± SurfaceFlinger æ‰€åœ¨çº¿ç¨‹å®Œæˆçš„ã€‚
ä¸è¿‡ onVSyncReceived å¹¶æ²¡æœ‰å¯¹ä¿¡å·åšå…·ä½“çš„å¤„ç†ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼š
    SurfaceFlinger çº¿ç¨‹åªæ˜¯åˆ°äº† EventThread å®¶çš„å¨æˆ¿ï¼ˆonVSyncReceivedï¼‰é‡Œï¼Œ
    ç„¶åæŠŠ â€œé£Ÿæâ€ é€šè¿‡ DisplayEventReceiver::Event å‡†å¤‡å¥½ï¼Œæ”¾åœ¨ mVSyncEvent ä¸­ï¼Œ
    ç„¶åå”¤é†’æ­£åœ¨ç­‰å¾…çš„ EventThread â€”â€” ä¸œè¥¿éƒ½å‡†å¤‡å¥½äº†ï¼Œå¼€åŠ¨å§ï¼
    äºæ˜¯æ¥ä¸‹æ¥çš„å¤„ç†å·¥ä½œå°±æ­£å¼ç§»äº¤åˆ° EventThread çº¿ç¨‹äº†ã€‚
</code></pre></div><p>è¿™ç‚¹æˆ‘ä»¬ä»ä¸‹é¢è¿™ä¸ªä»£ç æ®µä¸­ä¹Ÿèƒ½å¾—åˆ°éªŒè¯ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">EventThread</span><span class="token double-colon punctuation">::</span><span class="token function">threadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DisplayEventReceiver<span class="token double-colon punctuation">::</span>Event event<span class="token punctuation">;</span>
    Vector<span class="token operator">&lt;</span> sp<span class="token operator">&lt;</span>EventThread<span class="token double-colon punctuation">::</span>Connection<span class="token operator">&gt;&gt;</span> signalConnections<span class="token punctuation">;</span>
    signalConnections <span class="token operator">=</span> <span class="token function">waitForEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// EventThread å°±æ˜¯åœ¨è¿™é‡Œé¢å¼€å§‹ç­‰å¾…çš„</span>
    <span class="token keyword">const</span> size_t count <span class="token operator">=</span> signalConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span>count <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¼€å§‹ dispatch æ¶ˆæ¯ç»™æ‰€æœ‰æ„Ÿå…´è¶£çš„äºº</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Connection<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">conn</span><span class="token punctuation">(</span>signalConnections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        status_t err <span class="token operator">=</span> conn<span class="token operator">-&gt;</span><span class="token function">postEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é€šè¿‡ Connection â€œé€šé“â€ é€šçŸ¥å¯¹æ–¹</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// è¿”å› true åç³»ç»Ÿå°†å†æ¬¡è°ƒç”¨ threadLoop</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>é«˜ç‰ˆæœ¬çš„ä»£ç å­˜åœ¨å·®å¼‚ï¼Œä½†æµç¨‹ç±»ä¼¼ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token comment">/* frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp */</span>
<span class="token keyword">void</span> <span class="token class-name">EventThread</span><span class="token double-colon punctuation">::</span><span class="token function">threadMain</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span><span class="token operator">&amp;</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DisplayEventConsumers consumers<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>mState <span class="token operator">!=</span> State<span class="token double-colon punctuation">::</span>Quit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>DisplayEventReceiver<span class="token double-colon punctuation">::</span>Event<span class="token operator">&gt;</span> event<span class="token punctuation">;</span>

        <span class="token comment">// Determine next event to dispatch.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingEvents<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            event <span class="token operator">=</span> mPendingEvents<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPendingEvents<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumers<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token operator">*</span>event<span class="token punctuation">,</span> consumers<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// dispatch æ¶ˆæ¯ç»™æ‰€æœ‰æ„Ÿå…´è¶£çš„äºº</span>
            consumers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingEvents<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// mPendingEvents ä¸­è¿˜æœ‰æœªå¤„ç†å®Œçš„ DisplayEventReceiver::Event</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mState <span class="token operator">==</span> State<span class="token double-colon punctuation">::</span>Idle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCondition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾… VSync ä¿¡å·çš„åˆ°æ¥</span>
        <span class="token punctuation">}</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// cancel any pending vsync event before exiting</span>
    mVsyncRegistration<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></blockquote><p><code>EventThread</code> çº¿ç¨‹åœ¨ <code>mCondition.broadcast()</code> å¾—åˆ°å”¤é†’ã€‚æ¥ç€ <code>EventThread</code> ä¼šç»Ÿè®¡æ‰€æœ‰å¯¹ <code>Event</code> æ„Ÿå…´è¶£çš„äººï¼Œå³è®°å½•åœ¨ <code>signalConnections</code> ä¸­çš„å…ƒç´ ã€‚ç„¶åå®ƒé€šè¿‡ä¸è¿™äº›å…ƒç´ é—´çš„çº½å¸¦ï¼ˆ<code>Connection</code>ï¼‰æ¥é€šçŸ¥å®ƒä»¬æœ‰äº‹ä»¶å‘ç”Ÿäº†ã€‚</p><p>å˜é‡ <code>signalConnections</code> æ˜¯åœ¨ <code>waitForEvent</code> ä¸­å‡†å¤‡çš„ï¼Œæ ¹æ® <code>Event</code> çš„å®é™…æƒ…å†µä» <code>EventThread</code> çš„å…¨å±€å˜é‡ <code>mDisplayEventConnections</code> ä¸­æŒ‘é€‰å‡ºæ¥çš„ã€‚æ¢å¥è¯è¯´ï¼Œæ‰€æœ‰å¯¹ <code>Event</code> æ„Ÿå…´è¶£çš„äººéƒ½éœ€è¦è¢«è®°å½•åˆ° <code>mDisplayEventConnections</code> ä¸­ã€‚å…·ä½“è€Œè¨€ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„ â€œå¿ å®å¬ä¼—â€ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. SurfaceFlinger
æ¯‹åº¸ç½®ç–‘ï¼ŒSurfaceFlinger ä¸€å®šä¼šæ”¶å¬ VSync ä¿¡å·çš„äº§ç”Ÿã€‚
è¿™ä¸€å·¥ä½œç”±å®ƒå†…éƒ¨çš„ EventQueueï¼Œå³ â€œäº‹ä»¶é˜Ÿåˆ—ç®¡å®¶â€ æ¥å®Œæˆã€‚
å½“ SurfaceFlinger::readyToRun ä¸­ç”Ÿæˆ EventThread å¯¹è±¡åï¼Œ
ä¼šé©¬ä¸Šè°ƒç”¨ MessageQueue::setEventThread æ¥æŠŠå®ƒè®¾ç½®åˆ°å†…éƒ¨çš„ mEventThread å˜é‡ä¸­ï¼›
åŒæ—¶ï¼ŒMessageQueue è¿˜ä¼šé€šè¿‡æ¥å£ EventThread::createEventConnection æ¥åˆ›å»ºä¸€ä¸ª Connection è¿æ¥ã€‚

2. éœ€è¦åˆ·æ–° UI çš„å„è¿›ç¨‹
SurfaceFlinger åªæ˜¯è´Ÿè´£æœ€åçš„ UI æ•°æ®åˆæˆï¼Œè€Œå„åº”ç”¨ç¨‹åºæ‰æ˜¯çœŸæ­£çš„æ•°æ®ç”Ÿäº§è€…ï¼Œæ‰€ä»¥å®ƒä»¬ä¹Ÿå¿…å®šæ˜¯è¦ç›‘å¬ VSync ä¿¡å·çš„ã€‚
SurfaceFlinger æä¾›äº† createDisplayEventConnection æ¥å£æ¥æ»¡è¶³å„åº”ç”¨ç¨‹åºçš„éœ€æ±‚ï¼Œ
è¿™ä¸ªæ¥å£åŒæ ·è°ƒç”¨äº† EventThread::createEventConnection æ¥åˆ›å»ºä¸€ä¸ª Connection è¿æ¥ã€‚
</code></pre></div><p>é‚£ä¹ˆï¼Œä»€ä¹ˆæƒ…å†µä¸‹è¿™äº›åˆ›å»ºçš„ <code>Connection</code> ä¼šæ·»åŠ åˆ° <code>EventThread</code> çš„ <code>mDisplayEventConnections</code> ä¸­å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>å½“è¿™äº› Connection è¢«ç¬¬ä¸€æ¬¡å¼•ç”¨çš„æ—¶å€™ï¼Œå®ƒä¼šè‡ªåŠ¨è°ƒç”¨ registerDisplayEventConnection æ¥æ³¨å†Œåˆ° EventThread ä¸­ã€‚
</code></pre></div><h3 id="_7-2-vsync-ä¿¡å·çš„å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_7-2-vsync-ä¿¡å·çš„å¤„ç†" aria-hidden="true">#</a> 7.2 <code>VSync</code> ä¿¡å·çš„å¤„ç†</h3><p>ç»è¿‡ä¸Šä¸€å°èŠ‚çš„åˆ†æï¼Œç°åœ¨æˆ‘ä»¬å·²ç»æ˜ç™½äº†ç³»ç»Ÿæ˜¯å¦‚ä½•é€šè¿‡ç¡¬ä»¶è®¾å¤‡æˆ–è€…è½¯ä»¶æ¨¡æ‹Ÿæ¥äº§ç”Ÿ <code>VSync</code> ä¿¡å·äº†ï¼Œä¹Ÿæ˜ç™½äº†å®ƒçš„æµè½¬è¿‡ç¨‹ã€‚</p><p><code>VSync</code> æœ€ç»ˆä¼šè¢« <code>EventThread::threadLoop()</code> åˆ†å‘ç»™å„ç›‘å¬è€…ï¼Œå¦‚ <code>SurfaceFlinger</code> è¿›ç¨‹ä¸­å°±æ˜¯ <code>MessageQueue</code>ã€‚<code>MessageQueue</code> é€šè¿‡ä¸ <code>EventThread</code> å»ºç«‹ä¸€ä¸ª <code>Connection</code> æ¥ç›‘å¬äº‹ä»¶ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>å¯¹ VSYNC ç­‰äº‹ä»¶æ„Ÿå…´è¶£çš„å¯¹è±¡ï¼ˆå¦‚ MessageQueueï¼‰ï¼Œ
é¦–å…ˆè¦é€šè¿‡è°ƒç”¨æ¥å£ EventThread::createEventConnection() æ¥å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼ˆåº”ç”¨è¿›ç¨‹æ˜¯é—´æ¥ç”± SurfaceFlinger å®Œæˆçš„ï¼‰ï¼Œ
å®é™…ä¸Šå°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ª EventThread::Connection å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡å°†å¯¹åŒæ–¹äº§ç”Ÿå¦‚ä¸‹å½±å“ï¼š

å½±å“1ï¼š
å½“ Connection::onFirstRef() æ—¶ï¼Œå³ â€œè¿æ¥â€ ç¬¬ä¸€æ¬¡è¢«å¼•ç”¨æ—¶ï¼Œ
å®ƒä¼šä¸»åŠ¨è°ƒç”¨ EventThread::registerDisplayEventConnection() æ¥æŠŠè‡ªå·±æ·»åŠ åˆ° EventThread çš„ mDisplayEventConnections ä¸­ï¼Œ
è¿™æ˜¯ä¿è¯äº‹ä»¶å‘ç”Ÿå EventThread èƒ½æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„ â€œè¿æ¥â€ çš„å…³é”®ä¸€æ­¥ã€‚

å½±å“2ï¼š
å½“ MessageQueue å¾—åˆ° Connection åï¼Œå®ƒä¼šé©¬ä¸Šè°ƒç”¨ getDataChannel æ¥è·å¾—ä¸€ä¸ª BitTubeã€‚
ä»é€»è¾‘å…³ç³»ä¸Šçœ‹ï¼ŒConnection åªæ˜¯åŒæ–¹ä¸šåŠ¡ä¸Šçš„è¿æ¥ï¼Œè€Œ BitTube åˆ™æ˜¯æ•°æ®ä¼ è¾“é€šé“ï¼Œå„ç§ Event ä¿¡æ¯å°±æ˜¯é€šè¿‡è¿™é‡Œä¼ è¾“çš„ã€‚
</code></pre></div><p>ä¸‹é¢ä»¥ <code>MessageQueue</code> ä¸ºä¾‹æ¥åˆ†æå„ä¸ªè¿›ç¨‹æ˜¯å¦‚ä½•ä¸ <code>MessageThread</code> è¿›è¡Œäº¤äº’çš„ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">MessageQueue</span><span class="token double-colon punctuation">::</span><span class="token function">setEventThread</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>EventThread<span class="token operator">&gt;</span><span class="token operator">&amp;</span> eventThread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mEventThread <span class="token operator">=</span> eventThread<span class="token punctuation">;</span>
    mEvents <span class="token operator">=</span> eventThread<span class="token operator">-&gt;</span><span class="token function">createEventConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å»ºç«‹ä¸€ä¸ª Connection</span>
    mEventTube <span class="token operator">=</span> mEvents<span class="token operator">-&gt;</span><span class="token function">getDataChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç«‹å³è·å– BitTube</span>
    mLooper<span class="token operator">-&gt;</span><span class="token function">addFd</span><span class="token punctuation">(</span>mEventTube<span class="token operator">-&gt;</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
                    ALOOPER_EVENT_INPUT<span class="token punctuation">,</span>MessageQueue<span class="token double-colon punctuation">::</span>cb_eventReceiver<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»æ‰®æ¼”çš„è§’è‰²æ¥çœ‹ï¼Œ<code>EventThread</code> æ˜¯ <code>Server</code>ï¼Œä¸æ–­åœ°å¾€ <code>Tube</code> ä¸­å†™å…¥æ•°æ®ï¼›è€Œ <code>MessageQueue</code> æ˜¯ <code>Client</code>ï¼Œè´Ÿè´£è¯»å–æ•°æ®ã€‚</p><blockquote><p><code>MessageQueue</code> å¦‚ä½•å¾—çŸ¥æœ‰ <code>Event</code> åˆ°æ¥ï¼Œç„¶åå»è¯»å–å®ƒå‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯å®ƒä»¬ä¹‹é—´çš„æ•°æ®è¯»å†™æ¨¡å¼é‡‡ç”¨çš„æ˜¯ <code>Socket</code>ï¼ˆ<code>AF_UNIX</code> åŸŸï¼‰ã€‚</p></blockquote><p>ä¸Šé¢è¿™ä¸ªå‡½æ•°çš„æœ«å°¾é€šè¿‡ <code>Looper</code> æ·»åŠ äº†ä¸€ä¸ª <code>fd</code>ï¼Œè¿™å®é™…ä¸Šå°±æ˜¯ <code>Socket Pair</code> ä¸­çš„ä¸€ç«¯ã€‚ ç„¶å <code>Looper</code> å°†è¿™ä¸ª <code>fd</code> ä¸å…¶ <code>callback</code> å‡½æ•°ï¼ˆå³ <code>MessageQueue::cb_eventReceiver</code>ï¼‰åŠ å…¥å…¨å±€çš„ <code>mRequests</code> è¿›è¡Œç®¡ç†ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code>KeyedVector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Request<span class="token operator">&gt;</span> mRequests<span class="token punctuation">;</span>
</code></pre></div><p>è¿™ä¸ª <code>mRequests</code> é›†åˆä¸­ä¼šæŒæœ‰æ‰€æœ‰éœ€è¦ç›‘æµ‹çš„ <code>fd</code>ã€‚è¿™æ ·å½“ <code>Looper</code> è¿›è¡Œ <code>pollInner</code> æ—¶ï¼Œåªè¦æœ‰äº‹ä»¶éœ€è¦å¤„ç†ï¼Œå®ƒå°±å¯ä»¥é€šè¿‡ <code>callback</code> å‡½æ•°é€šçŸ¥ â€œæ¥æ”¶è€…â€ã€‚è¿™é‡Œé¢çš„å®ç°ç»†èŠ‚ä¸»è¦åŒ…æ‹¬ <code>BitTube.cpp</code> å’Œ <code>Looper.cpp</code> ä¸¤ä¸ªæºæ–‡ä»¶ã€‚</p><p>å½“ <code>Event</code> å‘ç”Ÿåï¼Œ<code>MessageQueue::cb_eventReceiver</code> å¼€å§‹æ‰§è¡Œï¼Œè¿›è€Œè°ƒç”¨ <code>eventReceiver</code>ã€‚å¦‚æœ <code>event</code> çš„ç±»å‹æ˜¯ <code>DisplayEventReceiver::DISPLAY_EVENT_VSYNC</code>ï¼Œåˆ™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦ç›‘å¬çš„äº‹ä»¶ã€‚è¿™æ—¶ä¼šæœ‰ä¸¤ç§æƒ…å†µï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">==</span> DisplayEventReceiver<span class="token double-colon punctuation">::</span>DISPLAY_EVENT_VSYNC<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">INVALIDATE_ON_VSYNC</span></span>
    mHandler<span class="token operator">-&gt;</span><span class="token function">dispatchInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    mHandler<span class="token operator">-&gt;</span><span class="token function">dispatchRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre></div><p>å® <code>INVALIDATE_ON_VSYNC</code> é»˜è®¤æƒ…å†µä¸‹è¢« <code>define</code> ä¸º 1ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p><div class="language-text ext-text"><pre class="language-text"><code>æˆ‘ä»¬çŸ¥é“åœ¨æŠŠ UI åˆ·æ–°åˆ°å±å¹•ä¸Šï¼ˆrefreshï¼‰ä¹‹å‰ï¼Œå„ UI è¿›ç¨‹éœ€è¦å…ˆå‡†å¤‡å¥½æ•°æ®ï¼ˆinvalidateï¼‰ã€‚åˆ†ä¸¤ç§æƒ…å†µï¼š
1. SurfaceFlinger åœ¨ VSYNC æ¥ä¸´æ—¶å†åšæ•°æ®çš„å‡†å¤‡å·¥ä½œï¼Œç„¶åç«‹å³åˆ·æ–°åˆ°å±å¹•ä¸Šï¼›
2. å¹³å¸¸å°±å¼€å§‹å‡†å¤‡ï¼Œè€Œå½“ VSYNC æ¥ä¸´æ—¶æŠŠæ•°æ®åˆ·æ–°åˆ°å±å¹•ä¸Šã€‚

å½“ INVALIDATE_ON_VSYNC ä¸º 1 æ—¶ï¼Œç¨‹åºæ‰§è¡Œæƒ…å†µ 1 çš„æ“ä½œï¼›å¦åˆ™å°±æ˜¯æƒ…å†µ 2ã€‚
</code></pre></div><p>å‡½æ•° <code>dispatchInvalidate</code> å’Œ <code>dispatchRefresh</code> åœ¨ <code>SurfaceFlinger</code> ä¸­çš„å¤„ç†è¿‡ç¨‹æ˜¯æœ‰ä¸€å®šå·®å¼‚çš„ï¼Œå¯¹æ¯”å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><tr><th>dispatchInvalidate</th><th>dispatchRefresh</th></tr><tr><td> case MessageQueue::INVALIDATE:<br> Â Â Â Â handleMessageTransaction();<br> Â Â Â Â handleMessageInvalidate();<br> Â Â Â Â signalRefresh(); </td><td> case MessageQueue::REFRESH:<br> Â Â Â Â handleMessageRefresh(); </td></tr></table><p>å…ˆæ¥çœ‹çœ‹ <code>handleMessageRefresh</code> æ‰€è¦åšçš„å·¥ä½œï¼ˆè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åç»­å‡ ä¸ªå°èŠ‚çš„é˜è¿°é‡ç‚¹ï¼‰ï¼š</p><div class="language-cpp ext-cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">SurfaceFlinger</span><span class="token double-colon punctuation">::</span><span class="token function">handleMessageRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">preComposition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆæˆå‰çš„å‡†å¤‡</span>
    <span class="token function">rebuildLayerStacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡æ–°å»ºç«‹ Layer å †æ ˆ</span>
    <span class="token function">setUpHWComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// HWComposer çš„è®¾å®š</span>
    <span class="token function">doDebugFlashRegions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">doComposition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ­£å¼çš„åˆæˆå·¥ä½œ</span>
    <span class="token function">postComposition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//åˆæˆåæœŸå·¥ä½œ</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ•´ä¸ª <code>UI</code> åˆæˆè¿‡ç¨‹åŒ…æ‹¬äº†å¦‚ä¸Šå‡ ä¸ªå‡½æ•°ï¼Œå†åŠ ä¸Š <code>handleMessageTransaction</code>ã€<code>handleMessageInvalidate</code>ï¼ŒåŸºæœ¬æ¶µç›–äº† <code>SurfaceFlinger</code> çš„æ‰€æœ‰åŠŸèƒ½ã€‚</p><blockquote><p>ä»åˆ†å‘ <code>VSync</code> ä¿¡å·ï¼Œåˆ°è¿›è¡Œ <code>UI</code> åˆæˆè¿‡ç¨‹ï¼Œé«˜ç‰ˆæœ¬ä¸­çš„å·®å¼‚è¾ƒå¤§ï¼Œåç»­å†æ›´æ–°ã€‚</p></blockquote><!--]--></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/zengkaiqiang562/JavaGuide/edit/main/docs/lango-tech/subject/surfaceflinger.md" rel="noopener noreferrer" target="_blank" arialabel="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" arialabelledby="edit"><title id="edit" lang="en">edit icon</title><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="info">2024/4/30 18:39:15</span></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: kaiqiang.zeng@lango-tech.cn">zengkaiqiang</span><!--]--><!--]--></div></footer><!----><!----><!----></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright Â© 2024 Zenk562</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.2a01fc36.js" defer></script>
  </body>
</html>
