<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.38" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://zengkaiqiang562.github.io/zkq/android/basic/handler.html"><meta property="og:site_name" content="Android Guide"><meta property="og:title" content="Androidçš„æ¶ˆæ¯æœºåˆ¶ï¼ˆTODOï¼‰"><meta property="og:type" content="article"><meta property="og:image" content="https://zengkaiqiang562.github.io/"><meta property="og:updated_time" content="2022-07-08T06:42:00.000Z"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="Androidçš„æ¶ˆæ¯æœºåˆ¶ï¼ˆTODOï¼‰"><meta property="article:tag" content="android"><meta property="article:modified_time" content="2022-07-08T06:42:00.000Z"><script>var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?5dd2e8c97962d57b7b8fea1737c01743";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2922463_99aa80ii7cf.css"><title>Androidçš„æ¶ˆæ¯æœºåˆ¶ï¼ˆTODOï¼‰ | Android Guide</title><meta name="description" content="Android å­¦ä¹  && é¢è¯•æŒ‡å—">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.5a38b724.css">
    <link rel="modulepreload" href="/assets/app.625aa393.js"><link rel="modulepreload" href="/assets/handler.html.4f76fffb.js"><link rel="modulepreload" href="/assets/handler.html.4a4034b5.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc sidebar-open"><!--[--><header class="navbar"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><a href="/" class="home-link"><img class="logo" src="/logo.png" alt="Android Guide"><!----><span class="site-name hide-in-pad">Android Guide</span><!--[--><!----><!--]--></a><nav class="nav-links" style=""><div class="nav-item hide-in-mobile"><a href="/home.html" class="nav-link" arialabel="é¢è¯•æŒ‡å—"><i class="icon iconfont icon-java"></i>é¢è¯•æŒ‡å—<!----></a></div><div class="nav-item hide-in-mobile"><a href="/zhuanlan/" class="nav-link" arialabel="ä¼˜è´¨ä¸“æ "><i class="icon iconfont icon-recommend"></i>ä¼˜è´¨ä¸“æ <!----></a></div><div class="nav-item hide-in-mobile"><a href="/open-source-project/" class="nav-link" arialabel="é¡¹ç›®ç²¾é€‰"><i class="icon iconfont icon-github"></i>é¡¹ç›®ç²¾é€‰<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://snailclimb.gitee.io/javaguide/#/" rel="noopener noreferrer" target="_blank" arialabel="æ—§ç‰ˆé“¾æ¥" class="nav-link"><i class="icon iconfont icon-java"></i>æ—§ç‰ˆé“¾æ¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="https://javaguide.cn/feed.json" rel="noopener noreferrer" target="_blank" arialabel="RSSè®¢é˜…" class="nav-link"><i class="icon iconfont icon-rss"></i>RSSè®¢é˜…<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="/about-the-author/" class="nav-link" arialabel="å…³äºä½œè€…"><i class="icon iconfont icon-zuozhe"></i>å…³äºä½œè€…<!----></a></div></nav><div class="nav-actions-wrapper"><!--[--><!----><!--]--><div class="nav-item"><!----></div><div class="nav-item"><a class="repo-link" href="https://github.com/zengkaiqiang562/JavaGuide" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" arialabelledby="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><title id="github" lang="en">github icon</title><g fill="currentColor"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></g></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" arialabelledby="auto" style="display:block;"><title id="auto" lang="en">auto icon</title><g fill="currentColor"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" arialabelledby="dark" style="display:none;"><title id="dark" lang="en">dark icon</title><g fill="currentColor"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" arialabelledby="light" style="display:none;"><title id="light" lang="en">light icon</title><g fill="currentColor"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></g></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button><!--[--><!----><!--]--></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">åŸºç¡€</span><span class="arrow down"></span></button><!--[--><ul class="sidebar-links"><li><!--[--><a href="/zkq/android/basic/activity.html" class="nav-link sidebar-link sidebar-page" arialabel="Activity"><!---->Activity<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/zkq/android/basic/fragment.html" class="nav-link sidebar-link sidebar-page" arialabel="Fragmentï¼ˆTODOï¼‰"><!---->Fragmentï¼ˆTODOï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/zkq/android/basic/service.html" class="nav-link sidebar-link sidebar-page" arialabel="Service"><!---->Service<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/zkq/android/basic/broadcast.html" class="nav-link sidebar-link sidebar-page" arialabel="BroadcastReceiver"><!---->BroadcastReceiver<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/zkq/android/basic/contentprovider.html" class="nav-link sidebar-link sidebar-page" arialabel="ContentProvider"><!---->ContentProvider<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/zkq/android/basic/serialize.html" class="nav-link sidebar-link sidebar-page" arialabel="å¯¹è±¡åºåˆ—åŒ–ï¼ˆTODOï¼‰"><!---->å¯¹è±¡åºåˆ—åŒ–ï¼ˆTODOï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/zkq/android/basic/asynctask.html" class="nav-link sidebar-link sidebar-page" arialabel="AsyncTask"><!---->AsyncTask<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/zkq/android/basic/handler.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" arialabel="Androidçš„æ¶ˆæ¯æœºåˆ¶ï¼ˆTODOï¼‰"><!---->Androidçš„æ¶ˆæ¯æœºåˆ¶ï¼ˆTODOï¼‰<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_1-æ¦‚è¿°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1. æ¦‚è¿°"><!---->1. æ¦‚è¿°<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_2-handler-æ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œè¿‡ç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2. Handler æ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œè¿‡ç¨‹"><!---->2. Handler æ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œè¿‡ç¨‹<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_2-1-handler-å‘é€æ¶ˆæ¯" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.1 Handler å‘é€æ¶ˆæ¯"><!---->2.1 Handler å‘é€æ¶ˆæ¯<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_2-2-ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„è§’åº¦ç†è§£-handler-æœºåˆ¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.2 ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„è§’åº¦ç†è§£ Handler æœºåˆ¶"><!---->2.2 ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„è§’åº¦ç†è§£ Handler æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_3-messagequeue-æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±å•é“¾è¡¨å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3. MessageQueue æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±å•é“¾è¡¨å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—"><!---->3. MessageQueue æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±å•é“¾è¡¨å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_4-ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª-looper-å¯¹è±¡-æ„é€ æ–¹æ³•ç§æœ‰åŒ–-threadlocal" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4. ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª Looper å¯¹è±¡ï¼ˆæ„é€ æ–¹æ³•ç§æœ‰åŒ– + ThreadLocalï¼‰"><!---->4. ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª Looper å¯¹è±¡ï¼ˆæ„é€ æ–¹æ³•ç§æœ‰åŒ– + ThreadLocalï¼‰<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_4-1-threadlocal-å¦‚ä½•å°†-looper-å¯¹è±¡ä¸çº¿ç¨‹ç»‘å®š" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1 ThreadLocal å¦‚ä½•å°† Looper å¯¹è±¡ä¸çº¿ç¨‹ç»‘å®šï¼Ÿ"><!---->4.1 ThreadLocal å¦‚ä½•å°† Looper å¯¹è±¡ä¸çº¿ç¨‹ç»‘å®šï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_5-messagequeue-çš„åˆ›å»ºæ—¶æœº" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5. MessageQueue çš„åˆ›å»ºæ—¶æœº"><!---->5. MessageQueue çš„åˆ›å»ºæ—¶æœº<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_6-handler-messagequeue-looper-ä¸‰è€…ä¹‹é—´çš„å¼•ç”¨å…³ç³»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6. Handler &amp; MessageQueue &amp; Looper ä¸‰è€…ä¹‹é—´çš„å¼•ç”¨å…³ç³»"><!---->6. Handler &amp; MessageQueue &amp; Looper ä¸‰è€…ä¹‹é—´çš„å¼•ç”¨å…³ç³»<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_7-handler-æ¶ˆæ¯æœºåˆ¶ä¸­çš„ç­‰å¾…å”¤é†’æœºåˆ¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7. Handler æ¶ˆæ¯æœºåˆ¶ä¸­çš„ç­‰å¾…å”¤é†’æœºåˆ¶"><!---->7. Handler æ¶ˆæ¯æœºåˆ¶ä¸­çš„ç­‰å¾…å”¤é†’æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_8-æ¶ˆæ¯å…¥é˜Ÿå’Œæ¶ˆæ¯å‡ºé˜Ÿæ—¶çš„åŠ é”åŸå› " class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="8. æ¶ˆæ¯å…¥é˜Ÿå’Œæ¶ˆæ¯å‡ºé˜Ÿæ—¶çš„åŠ é”åŸå› "><!---->8. æ¶ˆæ¯å…¥é˜Ÿå’Œæ¶ˆæ¯å‡ºé˜Ÿæ—¶çš„åŠ é”åŸå› <!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_9-handler-æ¶ˆæ¯æœºåˆ¶çš„é€€å‡ºæµç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="9. Handler æ¶ˆæ¯æœºåˆ¶çš„é€€å‡ºæµç¨‹"><!---->9. Handler æ¶ˆæ¯æœºåˆ¶çš„é€€å‡ºæµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_10-messagequeue-æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡æ²¡æœ‰é™åˆ¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="10. MessageQueue æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡æ²¡æœ‰é™åˆ¶"><!---->10. MessageQueue æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡æ²¡æœ‰é™åˆ¶<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_11-æ¶ˆæ¯æ± -äº«å…ƒè®¾è®¡æ¨¡å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="11. æ¶ˆæ¯æ±  &amp; äº«å…ƒè®¾è®¡æ¨¡å¼"><!---->11. æ¶ˆæ¯æ±  &amp; äº«å…ƒè®¾è®¡æ¨¡å¼<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_12-åŒæ­¥å±éšœ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="12. åŒæ­¥å±éšœ"><!---->12. åŒæ­¥å±éšœ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_12-1-åŒæ­¥å±éšœçš„å«ä¹‰åŠä½œç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="12.1 åŒæ­¥å±éšœçš„å«ä¹‰åŠä½œç”¨ï¼š"><!---->12.1 åŒæ­¥å±éšœçš„å«ä¹‰åŠä½œç”¨ï¼š<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_12-2-åŒæ­¥å±éšœçš„å®ç°æ–¹å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="12.2 åŒæ­¥å±éšœçš„å®ç°æ–¹å¼ï¼š"><!---->12.2 åŒæ­¥å±éšœçš„å®ç°æ–¹å¼ï¼š<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_12-3-åŒæ­¥å±éšœçš„åº”ç”¨-åˆ·æ–°-ui" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="12.3 åŒæ­¥å±éšœçš„åº”ç”¨ï¼šåˆ·æ–° UI"><!---->12.3 åŒæ­¥å±éšœçš„åº”ç”¨ï¼šåˆ·æ–° UI<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_13-handlerthread" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="13. HandlerThread"><!---->13. HandlerThread<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_14-intentservice" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="14. IntentService"><!---->14. IntentService<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_14-1-ç¤ºä¾‹-intentservice-çš„ä½¿ç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="14.1 ç¤ºä¾‹ï¼šIntentService çš„ä½¿ç”¨"><!---->14.1 ç¤ºä¾‹ï¼šIntentService çš„ä½¿ç”¨<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-handler-é¢è¯•é¢˜" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15. Handler é¢è¯•é¢˜"><!---->15. Handler é¢è¯•é¢˜<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-1-ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª-handler" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15.1 ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª Handlerï¼Ÿ"><!---->15.1 ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª Handlerï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-2-ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª-looper-å¦‚ä½•ä¿è¯" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15.2 ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª Looperï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ"><!---->15.2 ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª Looperï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-3-handler-å†…å­˜æ³„æ¼åŸå› -ä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15.3 Handler å†…å­˜æ³„æ¼åŸå› ï¼Ÿä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ"><!---->15.3 Handler å†…å­˜æ³„æ¼åŸå› ï¼Ÿä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-4-ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥-new-handler" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15.4 ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥ new Handlerï¼Ÿ"><!---->15.4 ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥ new Handlerï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-5-å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­-new-handler-è¦åšäº›ä»€ä¹ˆå‡†å¤‡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15.5 å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­ new Handler è¦åšäº›ä»€ä¹ˆå‡†å¤‡ï¼Ÿ"><!---->15.5 å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­ new Handler è¦åšäº›ä»€ä¹ˆå‡†å¤‡ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-6-æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ-æœ‰ä»€ä¹ˆç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15.6 æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ"><!---->15.6 æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-7-å¤šä¸ª-handler-åœ¨ä¸åŒçº¿ç¨‹ä¸­å‘æ¶ˆæ¯æ—¶-å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15.7 å¤šä¸ª Handler åœ¨ä¸åŒçº¿ç¨‹ä¸­å‘æ¶ˆæ¯æ—¶ï¼Œå¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ"><!---->15.7 å¤šä¸ª Handler åœ¨ä¸åŒçº¿ç¨‹ä¸­å‘æ¶ˆæ¯æ—¶ï¼Œå¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-8-ä½¿ç”¨-message-æ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15.8 ä½¿ç”¨ Message æ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒï¼Ÿ"><!---->15.8 ä½¿ç”¨ Message æ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-9-looper-æ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="15.9 Looper æ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ"><!---->15.9 Looper æ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/zkq/android/basic/custom-view.html" class="nav-link sidebar-link sidebar-page" arialabel="è‡ªå®šä¹‰Viewï¼ˆTODOï¼‰"><!---->è‡ªå®šä¹‰Viewï¼ˆTODOï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/zkq/android/basic/ui-draw-process.html" class="nav-link sidebar-link sidebar-page" arialabel="UIç»˜åˆ¶æµç¨‹ï¼ˆDOINGï¼‰"><!---->UIç»˜åˆ¶æµç¨‹ï¼ˆDOINGï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/zkq/android/basic/event-dispatch-mechanism.html" class="nav-link sidebar-link sidebar-page" arialabel="äº‹ä»¶åˆ†å‘æœºåˆ¶"><!---->äº‹ä»¶åˆ†å‘æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ç»˜å›¾åŸºç¡€</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">åŠ¨ç”»</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">UI</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Jetpack</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">NDK</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">IPC</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">è“ç‰™å¼€å‘</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">æ€§èƒ½ä¼˜åŒ–</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ç³»ç»Ÿæºç åˆ†æ</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">å…¶ä»–</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Androidçš„æ¶ˆæ¯æœºåˆ¶ï¼ˆTODOï¼‰</h1><div class="article-info"><span class="author-info" arialabel="ä½œè€…ğŸ–Š" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" arialabelledby="author"><title id="author" lang="en">author icon</title><g fill="currentColor"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></g></svg><span><a class="author-item" href="https://zengkaiqiang562.github.io/" target="_blank" rel="noopener noreferrer">Zenk562</a></span><span property="author" content="Zenk562"></span></span><span class="category-info" arialabel="åˆ†ç±»ğŸŒˆ" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" arialabelledby="category"><title id="category" lang="en">category icon</title><g fill="currentColor"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></g></svg><ul class="categories-wrapper"><li class="category clickable" role="navigation">android</li><meta property="articleSection" content="android"></ul></span><span arialabel="æ ‡ç­¾ğŸ·" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" arialabelledby="tag"><title id="tag" lang="en">tag icon</title><g fill="currentColor"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></g></svg><ul class="tags-wrapper"><li class="tag clickable" role="navigation">android</li></ul><meta property="keywords" content="android"></span><span class="date-info" arialabel="å†™ä½œæ—¥æœŸğŸ“…" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" arialabelledby="calendar"><title id="calendar" lang="en">calendar icon</title><g fill="currentColor"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></g></svg><span>2022å¹´7æœˆ8æ—¥</span><meta property="datePublished" content="2022-07-08T06:42:00.000Z"></span><!----><span class="words-info" arialabel="å­—æ•°ğŸ” " isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" arialabelledby="word"><title id="word" lang="en">word icon</title><g fill="currentColor"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></g></svg><span>çº¦ 6389 å­—</span><meta property="wordCount" content="6389"></span></div><hr></div><div class="toc-place-holder"><aside id="toc-list"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_1-æ¦‚è¿°" class="router-link-active router-link-exact-active toc-link level2">1. æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_2-handler-æ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œè¿‡ç¨‹" class="router-link-active router-link-exact-active toc-link level2">2. Handler æ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œè¿‡ç¨‹</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_2-1-handler-å‘é€æ¶ˆæ¯" class="router-link-active router-link-exact-active toc-link level3">2.1 Handler å‘é€æ¶ˆæ¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_2-2-ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„è§’åº¦ç†è§£-handler-æœºåˆ¶" class="router-link-active router-link-exact-active toc-link level3">2.2 ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„è§’åº¦ç†è§£ Handler æœºåˆ¶</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_3-messagequeue-æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±å•é“¾è¡¨å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—" class="router-link-active router-link-exact-active toc-link level2">3. MessageQueue æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±å•é“¾è¡¨å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_4-ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª-looper-å¯¹è±¡-æ„é€ æ–¹æ³•ç§æœ‰åŒ–-threadlocal" class="router-link-active router-link-exact-active toc-link level2">4. ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª Looper å¯¹è±¡ï¼ˆæ„é€ æ–¹æ³•ç§æœ‰åŒ– + ThreadLocalï¼‰</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_4-1-threadlocal-å¦‚ä½•å°†-looper-å¯¹è±¡ä¸çº¿ç¨‹ç»‘å®š" class="router-link-active router-link-exact-active toc-link level3">4.1 ThreadLocal å¦‚ä½•å°† Looper å¯¹è±¡ä¸çº¿ç¨‹ç»‘å®šï¼Ÿ</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_5-messagequeue-çš„åˆ›å»ºæ—¶æœº" class="router-link-active router-link-exact-active toc-link level2">5. MessageQueue çš„åˆ›å»ºæ—¶æœº</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_6-handler-messagequeue-looper-ä¸‰è€…ä¹‹é—´çš„å¼•ç”¨å…³ç³»" class="router-link-active router-link-exact-active toc-link level2">6. Handler &amp; MessageQueue &amp; Looper ä¸‰è€…ä¹‹é—´çš„å¼•ç”¨å…³ç³»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_7-handler-æ¶ˆæ¯æœºåˆ¶ä¸­çš„ç­‰å¾…å”¤é†’æœºåˆ¶" class="router-link-active router-link-exact-active toc-link level2">7. Handler æ¶ˆæ¯æœºåˆ¶ä¸­çš„ç­‰å¾…å”¤é†’æœºåˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_8-æ¶ˆæ¯å…¥é˜Ÿå’Œæ¶ˆæ¯å‡ºé˜Ÿæ—¶çš„åŠ é”åŸå› " class="router-link-active router-link-exact-active toc-link level2">8. æ¶ˆæ¯å…¥é˜Ÿå’Œæ¶ˆæ¯å‡ºé˜Ÿæ—¶çš„åŠ é”åŸå› </a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_9-handler-æ¶ˆæ¯æœºåˆ¶çš„é€€å‡ºæµç¨‹" class="router-link-active router-link-exact-active toc-link level2">9. Handler æ¶ˆæ¯æœºåˆ¶çš„é€€å‡ºæµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_10-messagequeue-æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡æ²¡æœ‰é™åˆ¶" class="router-link-active router-link-exact-active toc-link level2">10. MessageQueue æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡æ²¡æœ‰é™åˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_11-æ¶ˆæ¯æ± -äº«å…ƒè®¾è®¡æ¨¡å¼" class="router-link-active router-link-exact-active toc-link level2">11. æ¶ˆæ¯æ±  &amp; äº«å…ƒè®¾è®¡æ¨¡å¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_12-åŒæ­¥å±éšœ" class="router-link-active router-link-exact-active toc-link level2">12. åŒæ­¥å±éšœ</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_12-1-åŒæ­¥å±éšœçš„å«ä¹‰åŠä½œç”¨" class="router-link-active router-link-exact-active toc-link level3">12.1 åŒæ­¥å±éšœçš„å«ä¹‰åŠä½œç”¨ï¼š</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_12-2-åŒæ­¥å±éšœçš„å®ç°æ–¹å¼" class="router-link-active router-link-exact-active toc-link level3">12.2 åŒæ­¥å±éšœçš„å®ç°æ–¹å¼ï¼š</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_12-3-åŒæ­¥å±éšœçš„åº”ç”¨-åˆ·æ–°-ui" class="router-link-active router-link-exact-active toc-link level3">12.3 åŒæ­¥å±éšœçš„åº”ç”¨ï¼šåˆ·æ–° UI</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_13-handlerthread" class="router-link-active router-link-exact-active toc-link level2">13. HandlerThread</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_14-intentservice" class="router-link-active router-link-exact-active toc-link level2">14. IntentService</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_14-1-ç¤ºä¾‹-intentservice-çš„ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level3">14.1 ç¤ºä¾‹ï¼šIntentService çš„ä½¿ç”¨</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-handler-é¢è¯•é¢˜" class="router-link-active router-link-exact-active toc-link level2">15. Handler é¢è¯•é¢˜</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-1-ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª-handler" class="router-link-active router-link-exact-active toc-link level3">15.1 ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª Handlerï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-2-ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª-looper-å¦‚ä½•ä¿è¯" class="router-link-active router-link-exact-active toc-link level3">15.2 ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª Looperï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-3-handler-å†…å­˜æ³„æ¼åŸå› -ä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜" class="router-link-active router-link-exact-active toc-link level3">15.3 Handler å†…å­˜æ³„æ¼åŸå› ï¼Ÿä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-4-ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥-new-handler" class="router-link-active router-link-exact-active toc-link level3">15.4 ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥ new Handlerï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-5-å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­-new-handler-è¦åšäº›ä»€ä¹ˆå‡†å¤‡" class="router-link-active router-link-exact-active toc-link level3">15.5 å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­ new Handler è¦åšäº›ä»€ä¹ˆå‡†å¤‡ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-6-æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ-æœ‰ä»€ä¹ˆç”¨" class="router-link-active router-link-exact-active toc-link level3">15.6 æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-7-å¤šä¸ª-handler-åœ¨ä¸åŒçº¿ç¨‹ä¸­å‘æ¶ˆæ¯æ—¶-å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨" class="router-link-active router-link-exact-active toc-link level3">15.7 å¤šä¸ª Handler åœ¨ä¸åŒçº¿ç¨‹ä¸­å‘æ¶ˆæ¯æ—¶ï¼Œå¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-8-ä½¿ç”¨-message-æ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒ" class="router-link-active router-link-exact-active toc-link level3">15.8 ä½¿ç”¨ Message æ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒï¼Ÿ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/basic/handler.html#_15-9-looper-æ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»" class="router-link-active router-link-exact-active toc-link level3">15.9 Looper æ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><!--[--><h2 id="_1-æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#_1-æ¦‚è¿°" aria-hidden="true">#</a> 1. æ¦‚è¿°</h2><p><code>Android</code> çš„æ¶ˆæ¯æœºåˆ¶ä¸»è¦æ˜¯æŒ‡ <code>Handler</code> çš„è¿è¡Œæœºåˆ¶ï¼Œä»¥åŠ <code>Handler</code> æ‰€é™„å¸¦çš„ <code>MessageQueue</code> å’Œ <code>Looper</code> çš„å·¥ä½œè¿‡ç¨‹ã€‚</p><blockquote><p><code>Handler</code>ã€<code>MessageQueue</code>ã€<code>Looper</code> è¿™ä¸‰è€…å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œåªä¸è¿‡åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ¯”è¾ƒå¤šåœ°æ¥è§¦ <code>Handler</code> è€Œå·²ã€‚</p></blockquote><p><code>Handler</code> çš„ä¸»è¦ä½œç”¨æ˜¯å°†ä¸€ä¸ªä»»åŠ¡åˆ‡æ¢åˆ°æŸä¸ªæŒ‡å®šçš„çº¿ç¨‹ä¸­å»æ‰§è¡Œã€‚</p><h2 id="_2-handler-æ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_2-handler-æ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œè¿‡ç¨‹" aria-hidden="true">#</a> 2. <code>Handler</code> æ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œè¿‡ç¨‹</h2><p><code>Handler</code> æœºåˆ¶çš„å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/assets/02.ee13d32a.png" alt="" loading="lazy"></p><h3 id="_2-1-handler-å‘é€æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_2-1-handler-å‘é€æ¶ˆæ¯" aria-hidden="true">#</a> 2.1 <code>Handler</code> å‘é€æ¶ˆæ¯</h3><p><img src="/assets/01.13cea3ea.png" alt="" loading="lazy"></p><blockquote><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ<code>Handler.sendXxx</code> å’Œ <code>Handler.postXxx</code> æ–¹æ³•æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨äº† <code>Handler.enqueueMessage</code> æ–¹æ³•ã€‚</p></blockquote><h3 id="_2-2-ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„è§’åº¦ç†è§£-handler-æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_2-2-ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„è§’åº¦ç†è§£-handler-æœºåˆ¶" aria-hidden="true">#</a> 2.2 ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„è§’åº¦ç†è§£ <code>Handler</code> æœºåˆ¶</h3><p><code>Handler</code> æœºåˆ¶ç¬¦åˆç”Ÿäº§è€…æ¶ˆè´¹å€¼æ¨¡å¼ï¼Œå…¶ä¸­ï¼š</p><ol><li><code>Handler</code> ä½œä¸ºç”Ÿäº§è€…ï¼Œç”¨æ¥ç”Ÿäº§ <code>Message</code>ï¼›</li><li><code>MessageQueue</code> ä½œä¸ºå­˜å‚¨å®¹å™¨ï¼Œç”¨æ¥å­˜æ”¾ç”Ÿäº§çš„ <code>Message</code>ï¼›</li><li><code>Looper</code> ä½œä¸ºæ¶ˆè´¹å€¼ï¼Œç”¨æ¥ä» <code>MessageQueue</code> å–å‡º <code>Message</code> è¿›è¡Œæ¶ˆè´¹ã€‚</li></ol><p>ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„è§’åº¦ç†è§£ <code>Handler</code> çš„çº¿ç¨‹åˆ‡æ¢ï¼š</p><ol><li><p><code>Handler</code> ç”Ÿäº§ <code>Message</code> æ˜¯é€šè¿‡è°ƒç”¨ Handler.enqueueMessage æ–¹æ³•å®ç°çš„ï¼š</p></li><li><p><code>Looper</code> æ¶ˆè´¹ <code>Message</code> çš„å®ç°è¿‡ç¨‹æ˜¯é€šè¿‡ â€œæ­»å¾ªç¯ + ç­‰å¾…å”¤é†’æœºåˆ¶â€ ä» <code>MessageQueue</code> ä¸­å–å‡º <code>Message</code>ï¼Œç„¶åè°ƒç”¨ <code>Handler.dispatchMessage</code> æ–¹æ³•å¤„ç†æ¶ˆæ¯çš„ã€‚</p></li></ol><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>Handler.enqueueMessage</code> æ–¹æ³•æ˜¯åœ¨ç”Ÿäº§çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼›<code>Handler.dispatchMessage</code> æ–¹æ³•æ˜¯åœ¨æ¶ˆè´¹çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚ <code>Handler</code> æœºåˆ¶çš„çº¿ç¨‹åˆ‡æ¢å…¶å®å°±æ˜¯ <code>Handler.enqueueMessage</code> æ–¹æ³•å’Œ <code>Handler.dispatchMessage</code> æ–¹æ³•çš„æ‰§è¡Œçº¿ç¨‹çš„åˆ‡æ¢ã€‚</p><h2 id="_3-messagequeue-æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±å•é“¾è¡¨å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#_3-messagequeue-æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±å•é“¾è¡¨å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—" aria-hidden="true">#</a> 3. <code>MessageQueue</code> æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±å•é“¾è¡¨å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—</h2><p><code>MessageQueue</code> æ¶ˆæ¯é˜Ÿåˆ—çš„è¯´æ˜ï¼š</p><ol><li>å¤´èŠ‚ç‚¹æ˜¯ <code>MessageQueue.mMessages</code>ï¼Œ</li><li>é˜Ÿåˆ—ä¸­èŠ‚ç‚¹çš„ç±»å‹æ˜¯ <code>Message</code>ï¼Œ</li><li><code>Message</code> èŠ‚ç‚¹ä¸­ç»´æŠ¤ä¸€ä¸ª <code>Message.next</code> æŒ‡é’ˆï¼ŒæŒ‡å‘é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ï¼ˆå¹¶æ²¡æœ‰æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆï¼‰</li><li>é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹åœ¨æ’å…¥æ—¶ä¼šæŒ‰ç…§ <code>Message.when</code> ï¼ˆæ¶ˆæ¯è¢«å¤„ç†çš„æ—¶é—´ï¼‰çš„å…ˆåé¡ºåºè¿›è¡Œæ’åºã€‚</li></ol><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* MessageQueue.java */</span>

<span class="token comment">// æ¶ˆæ¯å…¥é˜Ÿ</span>
<span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        msg<span class="token punctuation">.</span>when <span class="token operator">=</span> when<span class="token punctuation">;</span>
        <span class="token class-name">Message</span> p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span> <span class="token comment">// mMessages æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„é˜Ÿå¤´</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">/*
            æ¶ˆæ¯åœ¨å…¥é˜Ÿæ—¶ï¼ŒæŒ‰ç…§æ¶ˆæ¯è¢«å¤„ç†çš„æ—¶é—´ msg.when ä»å°åˆ°å¤§æ’åˆ—ï¼Œ
            msg.when è¶Šå°ï¼Œåˆ™è¶Šå…ˆè¢«å¤„ç†ã€‚
            é˜Ÿå¤´èŠ‚ç‚¹ mMessages æŒ‡å‘æœ€å…ˆè¢«å¤„ç†çš„æ¶ˆæ¯ã€‚
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å½“å‰æ’å…¥çš„æ¶ˆæ¯ msg æœ€å…ˆè¢«å¤„ç†ï¼Œæ‰€ä»¥æ”¾åœ¨é˜Ÿå¤´</span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">Message</span> prev<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
                p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æ’å…¥æ—¶ï¼ŒæŒ‰ç…§ msg.when ä»å°ï¼ˆå…ˆï¼‰åˆ°å¤§ï¼ˆåï¼‰é¡ºåºè¿›è¡Œæ’åˆ—ã€‚</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å”¤é†’æ¶ˆè´¹ Message çš„çº¿ç¨‹</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* MessageQueue.java */</span>

<span class="token comment">// æ¶ˆæ¯å‡ºé˜Ÿ</span>
<span class="token class-name">Message</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
        åœ¨æ¶ˆè´¹ Message çš„çº¿ç¨‹ä¸­æ‰§è¡Œ next æ–¹æ³•ï¼Œ
        é€šè¿‡ â€œæ­»å¾ªç¯ + ç­‰å¾…å”¤é†’æœºåˆ¶â€ å–å‡ºé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œè¿”å›ç»™ Looperã€‚
    */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¼‘çœ  nextPollTimeoutMillis æ—¶é—´</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> prevMsg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span> <span class="token comment">// ä»é˜Ÿå¤´å–æ¶ˆæ¯ï¼Œå–åˆ°çš„æ¶ˆæ¯å°±åº”è¯¥æ˜¯æœ€å…ˆè¢«å¤„ç†çš„æ¶ˆæ¯ï¼ˆä¸è€ƒè™‘å¼‚æ­¥æ¶ˆæ¯ï¼‰</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// </span>
                    <span class="token comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span>
                    <span class="token comment">/*
                        å¦‚æœæœ€å…ˆè¢«å¤„ç†çš„æ¶ˆæ¯ msg åœ¨å½“å‰æ—¶é—´ now éƒ½è¿˜æ²¡åˆ°è¢«å¤„ç†çš„æ—¶å€™ï¼Œ
                        é‚£ä¹ˆå°±ä¼‘çœ åˆ°æ¶ˆæ¯ msg åº”è¯¥è¢«å¤„ç†çš„æ—¶é—´ msg.when åˆ°æ¥ä¸ºæ­¢ï¼Œå³ä¼‘çœ  (msg.when - now) æ—¶é—´
                    */</span>
                    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token comment">/*
                        å¦‚æœæœ€å…ˆè¢«å¤„ç†çš„æ¶ˆæ¯ msg åœ¨å½“å‰æ—¶é—´ now å¯ä»¥è¢«å¤„ç†äº†ï¼Œ
                        é‚£ä¹ˆå°±å°†æ¶ˆæ¯ msg è¿”å›ç»™ Looperï¼Œå¹¶ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚
                    */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevMsg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        prevMsg<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        mMessages <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    msg<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª-looper-å¯¹è±¡-æ„é€ æ–¹æ³•ç§æœ‰åŒ–-threadlocal" tabindex="-1"><a class="header-anchor" href="#_4-ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª-looper-å¯¹è±¡-æ„é€ æ–¹æ³•ç§æœ‰åŒ–-threadlocal" aria-hidden="true">#</a> 4. ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª <code>Looper</code> å¯¹è±¡ï¼ˆæ„é€ æ–¹æ³•ç§æœ‰åŒ– + <code>ThreadLocal</code>ï¼‰</h2><p>é€šè¿‡ä»¥ä¸‹ <code>2</code> ç‚¹ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª <code>Looper</code> å¯¹è±¡ï¼š</p><ol><li><p><code>Looper</code> çš„æ„é€ æ–¹æ³•ç§æœ‰åŒ–ï¼Œåªèƒ½é€šè¿‡é™æ€æ–¹æ³• <code>static void prepare(boolean quitAllowed)</code> æ¥åˆ›å»º <code>Looper</code> å¯¹è±¡ï¼›</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* Looper.java */</span>

<span class="token comment">/*
    Looper ç±»åªæä¾›äº†è¿™ä¸€ä¸ªç§æœ‰çš„æ„é€ æ–¹æ³•ã€‚
    å‚æ•° quitAllowed è¡¨ç¤ºæ˜¯å¦å…è®¸é€€å‡ºæ¶ˆæ¯å¾ªç¯æœºåˆ¶ã€‚true å…è®¸ï¼›false ä¸å…è®¸ã€‚
*/</span>
<span class="token keyword">private</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
    prepare(quitAllowed) æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œå¯¹å¤–åªæä¾›äº†å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•æ¥åˆ›å»º Looper å¯¹è±¡ï¼š
        1. prepare()ï¼šåœ¨å­çº¿ç¨‹ä¸­é€šè¿‡è¯¥æ–¹æ³•æ¥åˆ›å»º Looper å¯¹è±¡ã€‚æ¶ˆæ¯å¾ªç¯æœºåˆ¶æ˜¯å…è®¸é€€å‡ºçš„ã€‚
        2. prepareMainLooper()ï¼šåœ¨ä¸»çº¿ç¨‹ä¸­é€šè¿‡è¯¥æ–¹æ³•æ¥åˆ›å»º Looper å¯¹è±¡ã€‚æ¶ˆæ¯å¾ªç¯æœºåˆ¶æ˜¯ä¸å…è®¸é€€å‡ºçš„ã€‚
*/</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>Android</code> ç³»ç»Ÿå·²ç»åœ¨ <code>ActivityThread.main</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>prepareMainLooper()</code> æ–¹æ³•ï¼Œä¸º <code>App</code> è¿›ç¨‹çš„ä¸»çº¿ç¨‹åˆ›å»ºäº†ä¸€ä¸ª <code>Looper</code> å¯¹è±¡ã€‚</p></blockquote></li><li><p>åœ¨ <code>prepare(quitAllowed)</code> æ–¹æ³•ä¸­é€šè¿‡é™æ€çš„ <code>ThreadLocal&lt;Looper&gt;</code> ç±»å‹çš„å¯¹è±¡ <code>sThreadLocal</code> ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­åªèƒ½æœ‰ä¸€ä¸ª <code>Looper</code> å¯¹è±¡ã€‚</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* Looper.java */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Looper</span><span class="token punctuation">&gt;</span></span> sThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Looper</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
    prepare(quitAllowed) æ–¹æ³•åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨ä¸€æ¬¡ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚
    ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹å¤–æä¾›çš„ prepare() æˆ– prepareMainLooper() åªèƒ½åœ¨çº¿ç¨‹ä¸­è°ƒç”¨ä¸€æ¬¡ï¼‰

    å› ä¸ºä¸€ä¸ªçº¿ç¨‹ä¸­åªèƒ½è°ƒç”¨ä¸€æ¬¡ prepare(quitAllowed) æ–¹æ³•ï¼Œ
    è€Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šåˆ›å»ºä¸€ä¸ª Looper å¯¹è±¡ï¼Œå¹¶é€šè¿‡ ThreadLocal ä¸å½“å‰çº¿ç¨‹ç»‘å®šèµ·æ¥ã€‚
    æ‰€ä»¥å°±ä¿è¯äº†ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª Looper å¯¹è±¡ã€‚
*/</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Only one Looper may be created per thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><h3 id="_4-1-threadlocal-å¦‚ä½•å°†-looper-å¯¹è±¡ä¸çº¿ç¨‹ç»‘å®š" tabindex="-1"><a class="header-anchor" href="#_4-1-threadlocal-å¦‚ä½•å°†-looper-å¯¹è±¡ä¸çº¿ç¨‹ç»‘å®š" aria-hidden="true">#</a> 4.1 <code>ThreadLocal</code> å¦‚ä½•å°† <code>Looper</code> å¯¹è±¡ä¸çº¿ç¨‹ç»‘å®šï¼Ÿ</h3><ol><li><p><code>Thread</code> çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤äº†ä¸€ä¸ªä»¥ <code>ThreadLocal</code> å¯¹è±¡ä¸ºé”®ï¼Œ<code>Object</code> å¯¹è±¡ä¸ºå€¼çš„é”®å€¼å¯¹æ•°ç»„ã€‚</p><div class="language-text ext-text"><pre class="language-text"><code>Thread å¯¹è±¡é€šè¿‡ threadLocals å±æ€§å¼•ç”¨äº† ThreadLocal.ThreadLocalMap å¯¹è±¡ã€‚
ThreadLocalMap å¯¹è±¡ä¸­ä¿å­˜äº† ThreadLocalMap.Entry[] ç±»å‹çš„æ•°ç»„ tableã€‚
Entry è¡¨ç¤ºä»¥ ThreadLocal&lt;T&gt; ä¸ºé”®ï¼Œä»¥ T ä¸ºå€¼çš„é”®å€¼å¯¹ã€‚
</code></pre></div></li><li><p>è°ƒç”¨ <code>sThreadLocal.set(looper)</code> æ–¹æ³•ï¼Œå°±æ˜¯å°†ä»¥ <code>sThreadLocal</code> ä¸ºé”®ï¼Œä»¥ <code>looper</code> ä¸ºå€¼çš„é”®å€¼å¯¹ä¿å­˜åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡ç»´æŠ¤çš„é”®å€¼å¯¹æ•°ç»„ä¸­ã€‚</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* ThreadLocal.java */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// map = t.threadLocals</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// t.threadLocals.table[index] = new Entry(this, value)</span>
    <span class="token keyword">else</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// t.threadLocals = new ThreadLocalMap(this, value);</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>è°ƒç”¨ ThreadLocal&lt;Looper&gt; å¯¹è±¡çš„ set(Looper) æ–¹æ³•ï¼Œ
å°±æ˜¯å°†ä»¥ ThreadLocal&lt;Looper&gt; å¯¹è±¡ä¸ºé”®ï¼Œä»¥ Looper å‚æ•°ä¸ºå€¼çš„é”®å€¼å¯¹ Entry å¯¹è±¡ï¼Œ
ä¿å­˜åˆ° set æ–¹æ³•çš„æ‰§è¡Œçº¿ç¨‹å¯¹è±¡æ‰€ç»´æŠ¤çš„ threadLocals.table æ•°ç»„ä¸­ã€‚
</code></pre></div></li><li><p>è°ƒç”¨ <code>sThreadLocal.get()</code> æ–¹æ³•ï¼Œå°±æ˜¯ä»å½“å‰çº¿ç¨‹å¯¹è±¡ç»´æŠ¤çš„é”®å€¼å¯¹æ•°ç»„ä¸­å–å‡ºä»¥ <code>sThreadLocal</code> ä¸ºé”®çš„å€¼ã€‚</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* ThreadLocal.java */</span>
<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// map = t.threadLocals</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-text ext-text"><pre class="language-text"><code>è°ƒç”¨ ThreadLocal&lt;Looper&gt; å¯¹è±¡çš„ get() æ–¹æ³•ï¼Œ
å°±æ˜¯åœ¨ get æ–¹æ³•çš„æ‰§è¡Œçº¿ç¨‹å¯¹è±¡æ‰€ç»´æŠ¤çš„ threadLocals.table æ•°ç»„ä¸­ï¼Œ
è·å–åˆ°ä»¥ ThreadLocal&lt;Looper&gt; å¯¹è±¡ä¸ºé”®çš„é”®å€¼å¯¹ Entry å¯¹è±¡ï¼Œå¹¶å°†ä½œä¸ºå€¼çš„ Looper å¯¹è±¡å–å‡ºæ¥ã€‚
</code></pre></div></li></ol><p>å› ä¸º <code>sThreadLocal</code> ä½œä¸º <code>Looper</code> ç±»çš„é™æ€å±æ€§ï¼Œæ˜¯å”¯ä¸€å­˜åœ¨çš„ï¼Œä¸” <code>prepare(quitAllowed)</code> æ–¹æ³•åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œä»¥ <code>sThreadLocal</code> ä¸ºé”®è·å¾—çš„ <code>Looper</code> å¯¹è±¡åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­ä¹Ÿæ˜¯å”¯ä¸€çš„ã€‚</p><p>æ³¨æ„ï¼š</p><ol><li><p>ä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥ä¿å­˜å¤šä¸ª <code>ThreadLocal&lt;T&gt;</code> å’Œ <code>T</code> æ„æˆçš„é”®å€¼å¯¹ã€‚</p></li><li><p><strong>ä¸€ä¸ª <code>ThreadLocal&lt;T&gt;</code> å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å¯¹åº”æœ‰ä¸åŒçš„ <code>T</code> å€¼</strong>ã€‚</p></li><li><p>é€šè¿‡ <code>ThreadLocal&lt;T&gt;</code> ä¿å­˜åœ¨çº¿ç¨‹ä¸­çš„ <code>T</code> å€¼æ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</p><blockquote><p>å³ï¼šåœ¨çº¿ç¨‹ <code>A</code> ä¸­è°ƒç”¨ <code>sThreadLocal.set(looper)</code> ä¿å­˜åœ¨çº¿ç¨‹ <code>A</code> ä¸­çš„ <code>looper</code> å¯¹è±¡ï¼Œæ˜¯æ— æ³•åœ¨çº¿ç¨‹ <code>B</code> ä¸­é€šè¿‡è°ƒç”¨ <code>sThreadLocal.get()</code> æ–¹æ³•è·å–åˆ°çš„ã€‚</p></blockquote></li><li><p><code>T</code> å€¼æ˜¯è¢«çº¿ç¨‹å¯¹è±¡æŒæœ‰çš„ï¼Œè€Œä¸æ˜¯è¢« <code>ThreadLocal&lt;T&gt;</code> å¯¹è±¡æŒæœ‰çš„ã€‚<code>ThreadLocal&lt;T&gt;</code> å¯¹è±¡åªæ˜¯ä½œä¸ºé”®ï¼Œå¯¹çº¿ç¨‹ç›¸å…³çš„ <code>T</code> å€¼è¿›è¡Œå­˜å–ã€‚</p></li></ol><h2 id="_5-messagequeue-çš„åˆ›å»ºæ—¶æœº" tabindex="-1"><a class="header-anchor" href="#_5-messagequeue-çš„åˆ›å»ºæ—¶æœº" aria-hidden="true">#</a> 5. <code>MessageQueue</code> çš„åˆ›å»ºæ—¶æœº</h2><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* Looper.java */</span>
<span class="token keyword">private</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>MessageQueue</code> å¯¹è±¡ æ˜¯åœ¨ <code>Looper</code> çš„æ„é€ æ–¹æ³•ä¸­åˆ›å»ºçš„ã€‚å³åœ¨çº¿ç¨‹ä¸­è°ƒç”¨ <code>Looper</code> çš„é™æ€æ–¹æ³• <code>prepare</code> åå°±åˆ›å»ºå¥½äº† <code>Looper</code> å’Œ <code>MessageQueue</code> å¯¹è±¡ã€‚</p><p>å› ä¸º <code>Looper</code> å¯¹è±¡æ˜¯çº¿ç¨‹å”¯ä¸€çš„ï¼Œæ‰€ä»¥åœ¨ <code>Looper</code> çš„æ„é€ æ–¹æ³•ä¸­åˆ›å»ºçš„ <code>MessageQueue</code> å¯¹è±¡ä¹Ÿæ˜¯çº¿ç¨‹å”¯ä¸€çš„ã€‚</p><h2 id="_6-handler-messagequeue-looper-ä¸‰è€…ä¹‹é—´çš„å¼•ç”¨å…³ç³»" tabindex="-1"><a class="header-anchor" href="#_6-handler-messagequeue-looper-ä¸‰è€…ä¹‹é—´çš„å¼•ç”¨å…³ç³»" aria-hidden="true">#</a> 6. <code>Handler</code> &amp; <code>MessageQueue</code> &amp; <code>Looper</code> ä¸‰è€…ä¹‹é—´çš„å¼•ç”¨å…³ç³»</h2><ol><li><p>ä¸€ä¸ªçº¿ç¨‹ä¸­æœ€å¤šåªæœ‰ä¸€ä¸ª <code>Looper</code> å¯¹è±¡ï¼Œå’Œä¸€ä¸ª <code>MessageQueue</code> å¯¹è±¡ã€‚ï¼ˆä½†åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ª <code>Handler</code> å¯¹è±¡ï¼‰</p></li><li><p><code>Handler</code> å¯¹è±¡ä¸­é€šè¿‡å±æ€§ <code>mLooper</code> æŒæœ‰ <code>Looper</code> å¯¹è±¡çš„å¼•ç”¨ï¼Œé€šè¿‡å±æ€§ <code>mQueue</code> æŒæœ‰ <code>MessageQueue</code> å¯¹è±¡çš„å¼•ç”¨ã€‚å…¶ä¸­ï¼Œ<code>Handler.mQueue</code> å°±æ˜¯å¼•ç”¨äº† <code>mLooper.mQueue</code>ï¼Œå³ <code>Handler</code> å¯¹è±¡ä¸­å¼•ç”¨çš„ <code>MessageQueue</code> å°±æ˜¯åœ¨ <code>mLooper</code> å¯¹è±¡ä¸­åˆ›å»ºçš„ã€‚ï¼ˆå³ï¼š<code>Handler</code> å¯¹è±¡ç»‘å®šäº† <code>Looper</code> å¯¹è±¡ï¼ŒåŒæ—¶ä¹Ÿå°±ç»‘å®šäº† <code>MessageQueue</code> å¯¹è±¡ï¼‰</p><p><img src="/assets/03.3c6c91ba.png" alt="" loading="lazy"></p><blockquote><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåˆ›å»º <code>Handler</code> å¯¹è±¡æ—¶ï¼š</p><ol><li><p>å¦‚æœæ²¡æœ‰ä¼ å…¥ <code>Looper</code> å¯¹è±¡ï¼Œé‚£ä¹ˆ <code>Handler</code> å¯¹è±¡ç»‘å®šçš„ <code>Looper</code> å¯¹è±¡å°±æ˜¯å½“å‰çº¿ç¨‹ä¸­çš„ <code>Looper</code> å¯¹è±¡ã€‚ï¼ˆæ³¨æ„ï¼šå¦‚æœå½“å‰çº¿ç¨‹ä¸­è¿˜æ²¡æœ‰è°ƒç”¨ <code>Looper.prepare</code> æ–¹æ³•åˆ›å»º <code>Looper</code> å¯¹è±¡ï¼Œå°±ä¼šæŠ¥é”™ï¼‰</p></li><li><p>åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨ <code>Handler</code> æœºåˆ¶æ—¶ï¼Œåˆ™éœ€è¦ä¼ å…¥ä¸€ä¸ªä¸è¯¥å­çº¿ç¨‹ç›¸å…³çš„ <code>Looper</code> å¯¹è±¡ã€‚</p></li></ol></blockquote></li><li><p>å¤šä¸ª <code>Handler</code> å¯¹è±¡å¯ä»¥ç»‘å®šåŒä¸€ä¸ª <code>Looper</code> å¯¹è±¡ã€‚æ­¤æ—¶ï¼Œé€šè¿‡è¿™äº› <code>Handler</code> å¯¹è±¡å‘é€çš„æ¶ˆæ¯éƒ½ä¼šæŒ‰ç…§æ¶ˆæ¯çš„è¢«å¤„ç†æ—¶é—´ <code>msg.when</code> æ’å…¥åˆ°åŒä¸€ä¸ª <code>MessageQueue</code> æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚</p></li></ol><h2 id="_7-handler-æ¶ˆæ¯æœºåˆ¶ä¸­çš„ç­‰å¾…å”¤é†’æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_7-handler-æ¶ˆæ¯æœºåˆ¶ä¸­çš„ç­‰å¾…å”¤é†’æœºåˆ¶" aria-hidden="true">#</a> 7. <code>Handler</code> æ¶ˆæ¯æœºåˆ¶ä¸­çš„ç­‰å¾…å”¤é†’æœºåˆ¶</h2><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* MessageQueue.java */</span>

<span class="token comment">// æ¶ˆæ¯å‡ºé˜Ÿï¼ˆåœ¨æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰</span>
<span class="token class-name">Message</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
        è°ƒç”¨ nativePollOnce(ptr, nextPollTimeoutMillis) ä¼šè®© next æ–¹æ³•çš„æ‰§è¡Œçº¿ç¨‹ï¼ˆå³æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹ï¼‰è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå…¶ä¸­ï¼š
            1. nextPollTimeoutMillis = 0 æ—¶ï¼Œä¸ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€
            2. nextPollTimeoutMillis &gt; 0 æ—¶ï¼Œè¿›å…¥è®¡æ—¶ç­‰å¾…çŠ¶æ€ï¼Œ
                å½“è°ƒç”¨ nativeWake(mPtr) æ–¹æ³• æˆ–ç»è¿‡ nextPollTimeoutMillis æ—¶é—´åæ‰ä¼šå”¤é†’
            3. nextPollTimeoutMillis = -1 æ—¶ï¼Œè¿›å…¥æ— é™ç­‰å¾…çŠ¶æ€ï¼Œåªæœ‰è°ƒç”¨ nativeWake(mPtr) æ‰ä¼šå”¤é†’
    */</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> ptr <span class="token operator">=</span> mPtr<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">int</span> nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 1. é»˜è®¤ä¸è¿›å…¥ç­‰å¾…çŠ¶æ€</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> prevMsg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 2. å½“å‰æ—¶é—´è¿˜æ²¡æœ‰å¯å¤„ç†çš„æ¶ˆæ¯ï¼Œç­‰å¾… nextPollTimeoutMillis = msg.when - now æ—¶é—´åæ‰èƒ½å–å‡ºæœ€å…ˆè¢«å¤„ç†çš„æ¶ˆæ¯</span>
                    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevMsg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        prevMsg<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        mMessages <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    msg<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 3. æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯äº†ï¼Œè¿›å…¥æ— é™ç­‰å¾…çŠ¶æ€</span>
                nextPollTimeoutMillis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">/*
                æ‰§è¡Œåˆ°è¿™é‡Œï¼ŒnextPollTimeoutMillis ä¸€å®šä¸ä¸º 0ï¼Œ
                ä¸è€ƒè™‘æ·»åŠ äº† IdleHandler çš„æƒ…å†µï¼ŒpendingIdleHandlerCount &lt;= 0 æ€»æ˜¯æˆç«‹
                å³å½“æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€æ—¶ï¼ŒmBlocked ç½®ä¸º true
            */</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* MessageQueue.java */</span>

<span class="token comment">// æ¶ˆæ¯å…¥é˜Ÿï¼ˆåœ¨ç”Ÿäº§æ¶ˆæ¯çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰</span>
<span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
        åœ¨æ¶ˆæ¯å…¥é˜Ÿæ—¶ï¼Œä»¥ä¸‹æƒ…å†µä¸­éœ€è¦å”¤é†’æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹ï¼š
        1. å½“å‰æ’å…¥çš„æ¶ˆæ¯ msg æœ€å…ˆè¢«å¤„ç†æ—¶ï¼Œè‹¥æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œåˆ™éœ€è¦å”¤é†’ï¼›
        2. åœ¨å¼€å¯äº†åŒæ­¥å±éšœï¼Œä¸”å¤„äºä¼˜å…ˆéå†å¼‚æ­¥æ¶ˆæ¯çš„æ¡ä»¶ä¸‹ï¼Œå³ï¼šé˜Ÿå¤´æ¶ˆæ¯æ˜¯å±éšœæ¶ˆæ¯ï¼ˆmMessages.target == nullï¼‰ï¼Œ
            å¦‚æœå½“å‰æ’å…¥çš„æ¶ˆæ¯ msg æ˜¯å¼‚æ­¥æ¶ˆæ¯ï¼Œä¸”æ˜¯æœ€å…ˆè¢«å¤„ç†çš„å¼‚æ­¥æ¶ˆæ¯ï¼Œé‚£ä¹ˆï¼Œè‹¥æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œåˆ™éœ€è¦å”¤é†’ï¼›
        3. å¦‚æœå½“å‰æ’å…¥çš„æ¶ˆæ¯ msg ä¸æ˜¯åº”è¯¥è¢«æœ€å…ˆå¤„ç†çš„ï¼Œé‚£ä¹ˆå°±ç®—æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œä¹Ÿä¸éœ€è¦å”¤é†’ã€‚
            å› ä¸ºæ­¤æ—¶ï¼Œè‹¥æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè¯´æ˜å…ˆäº msg è¢«å¤„ç†çš„ä¸Šä¸€ä¸ªæ¶ˆæ¯è¿˜åœ¨ç­‰å¾…å¤„ç†ï¼Œä¸åº”è¯¥æå‰å”¤é†’ã€‚
    */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        msg<span class="token punctuation">.</span>when <span class="token operator">=</span> when<span class="token punctuation">;</span>
        <span class="token class-name">Message</span> p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> needWake<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æƒ…å†µ 1</span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>
            needWake <span class="token operator">=</span> mBlocked<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// æƒ…å†µ 2 å’Œ 3</span>
            needWake <span class="token operator">=</span> mBlocked <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>target <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> prev<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
                p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    needWake <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span> 
            prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å”¤é†’æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_8-æ¶ˆæ¯å…¥é˜Ÿå’Œæ¶ˆæ¯å‡ºé˜Ÿæ—¶çš„åŠ é”åŸå› " tabindex="-1"><a class="header-anchor" href="#_8-æ¶ˆæ¯å…¥é˜Ÿå’Œæ¶ˆæ¯å‡ºé˜Ÿæ—¶çš„åŠ é”åŸå› " aria-hidden="true">#</a> 8. æ¶ˆæ¯å…¥é˜Ÿå’Œæ¶ˆæ¯å‡ºé˜Ÿæ—¶çš„åŠ é”åŸå› </h2><p>å¦‚ä¸Šæ‰€ç¤ºçš„æ¶ˆæ¯å‡ºé˜Ÿï¼ˆ<code>MessageQueue.next</code>ï¼‰å’Œæ¶ˆæ¯å…¥é˜Ÿï¼ˆ<code>MessageQueue.enqueueMessage</code>ï¼‰çš„ä»£ç ä¸­ï¼Œéƒ½ä½¿ç”¨äº†åŒä¸€ä¸ªé”å¯¹è±¡ï¼ˆ<code>synchronized(this)</code>ï¼‰è¿›è¡Œäº†åŠ é”ã€‚è¿™æ˜¯å› ä¸ºï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>1. ç”Ÿäº§æ¶ˆæ¯çš„çº¿ç¨‹å¯ä»¥æœ‰å¤šä¸ªï¼Œå³ MessageQueue.enqueueMessage æ–¹æ³•å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­è°ƒç”¨ã€‚
    ï¼ˆä¹Ÿå°±æ˜¯ Handler.sendXxx å’Œ Handler.postXxx æ–¹æ³•å¯ä»¥åœ¨å¤šä¸ªä¸åŒçš„çº¿ç¨‹ä¸­è°ƒç”¨ï¼‰
2. æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œå³è°ƒç”¨ Looper.preapre æ–¹æ³•çš„é‚£ä¸ªçº¿ç¨‹ã€‚
äºæ˜¯ï¼š
    æ¶ˆæ¯å…¥é˜Ÿæ—¶åŠ é” thisï¼Œä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæ¶ˆæ¯å…¥é˜Ÿï¼›
    æ¶ˆæ¯å‡ºé˜Ÿæ—¶åŠ é” thisï¼Œä¿è¯å…¥é˜Ÿå’Œå‡ºé˜Ÿä¸ä¼šåœ¨åŒä¸€æ—¶é—´å‘ç”Ÿã€‚ä»è€Œä½¿å¾—ï¼š
        å³ä½¿æœ€ä¼˜å…ˆæ¶ˆæ¯åå…¥é˜Ÿï¼Œä¹Ÿèƒ½åœ¨æ¥ä¸‹æ¥çš„å‡ºé˜Ÿæ“ä½œä¸­åŠæ—¶å–å‡ºæ¥ã€‚ï¼ˆå³ä¿è¯æ’å…¥æ¶ˆæ¯èƒ½å¾—åˆ°åŠæ—¶å¤„ç†ï¼‰
</code></pre></div><h2 id="_9-handler-æ¶ˆæ¯æœºåˆ¶çš„é€€å‡ºæµç¨‹" tabindex="-1"><a class="header-anchor" href="#_9-handler-æ¶ˆæ¯æœºåˆ¶çš„é€€å‡ºæµç¨‹" aria-hidden="true">#</a> 9. <code>Handler</code> æ¶ˆæ¯æœºåˆ¶çš„é€€å‡ºæµç¨‹</h2><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* MessageQueue.java */</span>

<span class="token comment">// é€€å‡ºæ¶ˆæ¯å¾ªç¯</span>
<span class="token keyword">void</span> <span class="token function">quit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> safe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mQuitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread not allowed to quit.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
            mQuitting ç½®ä¸º true è¡¨ç¤ºé€€å‡ºæ¶ˆæ¯å¾ªç¯æœºåˆ¶ã€‚
            åœ¨ next æ–¹æ³•ä¸­æ ¹æ®è¯¥å˜é‡åˆ¤æ–­æ˜¯å¦é€€å‡ºæ¶ˆæ¯å¾ªç¯ã€‚
        */</span>
        mQuitting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 

        <span class="token comment">/*
            å¦‚æœ safe ä¸º trueï¼Œåˆ™åªä¼šæ¸…ç©ºé˜Ÿåˆ—ä¸­ msg.when &gt; now çš„æ¶ˆæ¯ï¼ˆremoveAllFutureMessagesLockedï¼‰ï¼Œ
                å³å½“é˜Ÿåˆ—ä¸­ msg.when &lt;= now çš„æ¶ˆæ¯å¤„ç†å®Œä¹‹åï¼Œæ‰ä¼šé€€å‡ºæ¶ˆæ¯å¾ªç¯ã€‚
            å¦‚æœ safe ä¸º falseï¼Œåˆ™ä¼šæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆremoveAllMessagesLockedï¼‰ï¼Œ
                å³ç«‹å³é€€å‡ºæ¶ˆæ¯å¾ªç¯ã€‚
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>safe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">removeAllFutureMessagesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">removeAllMessagesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/*
            ä¸ºäº†é¿å…æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€è€Œæ— æ³•é€€å‡ºæ¶ˆæ¯å¾ªç¯ï¼Œ
            æ‰€ä»¥ä¸ç®¡æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹æ˜¯å¦å¤„äºç­‰å¾…çŠ¶æ€ï¼Œéƒ½è°ƒç”¨ä¸‹ nativeWake(mPtr) æ–¹æ³•å”¤é†’ä¸‹
        */</span> 
        <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* MessageQueue.java */</span>

<span class="token comment">// æ¶ˆæ¯å‡ºé˜Ÿï¼ˆåœ¨æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰</span>
<span class="token class-name">Message</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> ptr <span class="token operator">=</span> mPtr<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">int</span> nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> prevMsg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token comment">// ä»é˜Ÿåˆ—ä¸­ç§»é™¤ msg</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                nextPollTimeoutMillis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//  åªæœ‰å½“é€€å‡ºæ¶ˆæ¯å¾ªç¯æœºåˆ¶æ—¶ï¼Œæ‰ä¼šè¿”å› nullã€‚å¦åˆ™æ²¡æ¶ˆæ¯å¤„ç†æ—¶åªä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€</span>
                <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* Looper.java */</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Looper</span> me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>me <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å…ˆè°ƒç”¨ Looper.prepare åï¼Œæ‰èƒ½è°ƒç”¨ Looper.loop()</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;No Looper; Looper.prepare() wasn&#39;t called on this thread.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> queue <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
            å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œæˆ–è€…æ¶ˆæ¯çš„å¤„ç†æ—¶é—´è¿˜æ²¡åˆ°ï¼Œåˆ™ queue.next() æ–¹æ³•ä¼šé˜»å¡
            åªæœ‰å½“é€€å‡ºæ¶ˆæ¯å¾ªç¯æœºåˆ¶æ—¶ï¼Œqueue.next() æ‰ä¼šè¿”å› nullï¼Œç»“æŸæ¶ˆæ¯å¾ªç¯ã€‚
        */</span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¤„ç†æ¶ˆæ¯</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        msg<span class="token punctuation">.</span><span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å›æ”¶æ¶ˆæ¯</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_10-messagequeue-æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡æ²¡æœ‰é™åˆ¶" tabindex="-1"><a class="header-anchor" href="#_10-messagequeue-æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡æ²¡æœ‰é™åˆ¶" aria-hidden="true">#</a> 10. <code>MessageQueue</code> æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡æ²¡æœ‰é™åˆ¶</h2><p>åœ¨è°ƒç”¨ <code>MessageQueue.enqueueMessage(msg, when)</code> æ–¹æ³•ï¼Œå°†æ¶ˆæ¯ <code>msg</code> å…¥é˜Ÿæ—¶ï¼Œæ²¡æœ‰é™åˆ¶æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡ã€‚å³å¯ä»¥æ— é™åˆ¶åœ°å°†æ¶ˆæ¯æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚</p><p>äºæ˜¯ï¼Œå½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­å­˜æ”¾äº†è¿‡å¤šçš„æ¶ˆæ¯å¯¹è±¡æ—¶ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p><p>å› æ­¤ï¼Œå°½é‡ä¸è¦ä½¿ç”¨ <code>Handler</code> æ¥åšå®šæ—¶ä»»åŠ¡ã€‚</p><h2 id="_11-æ¶ˆæ¯æ± -äº«å…ƒè®¾è®¡æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_11-æ¶ˆæ¯æ± -äº«å…ƒè®¾è®¡æ¨¡å¼" aria-hidden="true">#</a> 11. æ¶ˆæ¯æ±  &amp; äº«å…ƒè®¾è®¡æ¨¡å¼</h2><p>åœ¨è®¾è®¡ <code>Message</code> çš„æ—¶å€™é‡‡ç”¨äº† <strong>äº«å…ƒè®¾è®¡æ¨¡å¼</strong>ï¼ˆäº«å…ƒè®¾è®¡æ¨¡å¼å°±æ˜¯é€šè¿‡ <strong>å¯¹è±¡æ± </strong> æ¥å®ç°å¯¹è±¡å…±äº«ï¼Œé¿å…åˆ›å»ºå¤šå¯¹è±¡ï¼‰ã€‚</p><p>å› ä¸º <code>App</code> åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šé¢‘ç¹åœ°ä½¿ç”¨ <code>Handler</code> æ¶ˆæ¯æœºåˆ¶æ¥å¤„ç†ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šé€ æˆ <code>Message</code> å¯¹è±¡çš„é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ï¼Œä»è€Œå‡ºç° <strong>å†…å­˜æŠ–åŠ¨</strong>ï¼Œå¹¶äº§ç”Ÿå¤§é‡çš„ <strong>å†…å­˜ç¢ç‰‡</strong>ï¼Œä½¿å¾—å †ä¸­å¯èƒ½æ²¡æœ‰è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜ç©ºé—´æ¥å­˜æ”¾å ç”¨å†…å­˜è¾ƒå¤§çš„å¯¹è±¡ï¼ˆå¦‚ <code>Bitmap</code>ï¼‰ï¼Œå¯¼è‡´å†…å­˜æº¢å‡ºï¼ˆ<code>OOM</code>ï¼‰çš„å‘ç”Ÿã€‚</p><p>æ‰€ä»¥ï¼Œä¸ºäº†é¿å…è¿™ç§é—®é¢˜ï¼Œåº”è¯¥è°ƒç”¨ <code>Message.obtain</code> æ–¹æ³•å°è¯•ä»å¯¹è±¡æ±  <code>sPool</code> ä¸­è·å–ä¸€ä¸ªå¯å¤ç”¨çš„ <code>Message</code> å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç›´æ¥ <code>new</code> ä¸€ä¸ª <code>Message</code> å¯¹è±¡ã€‚å¹¶ä¸”åœ¨ <code>Message</code> å¯¹è±¡ä½¿ç”¨å®Œæ¯•åï¼Œè°ƒç”¨ <code>Message.recycleUnchecked()</code> æ–¹æ³•æ¸…é™¤æ‰ <code>Message</code> å¯¹è±¡çš„æ¶ˆæ¯æ•°æ®ï¼Œå†å°†å…¶å›æ”¶åˆ°å¯¹è±¡æ±  <code>sPool</code> ä¸­ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡èƒ½å¤Ÿç»§ç»­å¤ç”¨ã€‚</p><p><img src="/assets/04.1726c581.png" alt="" loading="lazy"></p><blockquote><p>ä¼˜å…ˆé€šè¿‡é‡è½½çš„ <code>obtain</code> é™æ€æ–¹æ³•è·å– <code>Message</code> å¯¹è±¡ã€‚</p></blockquote><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* Message.java */</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> sPoolSync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åŒæ­¥é”</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Message</span> sPool<span class="token punctuation">;</span> <span class="token comment">// æ¶ˆæ¯æ± é‡‡ç”¨å•é“¾è¡¨ç»“æ„ï¼ŒsPool æ˜¯é“¾è¡¨çš„å¤´èŠ‚ç‚¹</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> sPoolSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token comment">// æ¶ˆæ¯æ± çš„å®¹é‡ä¸º 50ã€‚ï¼ˆå³æœ€å¤šç¼“å­˜ 50 ä¸ª Message å¯¹è±¡ï¼‰</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Message</span> <span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sPoolSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sPool <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ä¼˜å…ˆå¤ç”¨æ¶ˆæ¯æ± ä¸­ç¼“å­˜çš„ Message å¯¹è±¡</span>
            <span class="token class-name">Message</span> m <span class="token operator">=</span> sPool<span class="token punctuation">;</span>
            sPool <span class="token operator">=</span> m<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            m<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            m<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
            sPoolSize<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> m<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    flags <span class="token operator">=</span> <span class="token constant">FLAG_IN_USE</span><span class="token punctuation">;</span>
    what <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    arg1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    arg2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    replyTo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    sendingUid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    when <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    callback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sPoolSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sPoolSize <span class="token operator">&lt;</span> <span class="token constant">MAX_POOL_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å°†å›æ”¶çš„å½“å‰ Message å¯¹è±¡æ’å…¥åˆ°æ¶ˆæ¯æ± é“¾è¡¨çš„å¤´éƒ¨</span>
            next <span class="token operator">=</span> sPool<span class="token punctuation">;</span>
            sPool <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
            sPoolSize<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* Looper.java */</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Looper</span> me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>me <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;No Looper; Looper.prepare() wasn&#39;t called on this thread.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> queue <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        msg<span class="token punctuation">.</span><span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å›æ”¶æ¶ˆæ¯</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_12-åŒæ­¥å±éšœ" tabindex="-1"><a class="header-anchor" href="#_12-åŒæ­¥å±éšœ" aria-hidden="true">#</a> 12. åŒæ­¥å±éšœ</h2><h3 id="_12-1-åŒæ­¥å±éšœçš„å«ä¹‰åŠä½œç”¨" tabindex="-1"><a class="header-anchor" href="#_12-1-åŒæ­¥å±éšœçš„å«ä¹‰åŠä½œç”¨" aria-hidden="true">#</a> 12.1 åŒæ­¥å±éšœçš„å«ä¹‰åŠä½œç”¨ï¼š</h3><div class="language-text ext-text"><pre class="language-text"><code>å±è”½åŒæ­¥æ¶ˆæ¯ï¼ˆisAsynchronous() è¿”å› falseçš„æ¶ˆæ¯ï¼‰ï¼Œ
ä¼˜å…ˆå¤„ç†å¼‚æ­¥æ¶ˆæ¯ï¼ˆisAsynchronous() è¿”å› true çš„æ¶ˆæ¯ï¼‰
</code></pre></div><h3 id="_12-2-åŒæ­¥å±éšœçš„å®ç°æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_12-2-åŒæ­¥å±éšœçš„å®ç°æ–¹å¼" aria-hidden="true">#</a> 12.2 åŒæ­¥å±éšœçš„å®ç°æ–¹å¼ï¼š</h3><div class="language-text ext-text"><pre class="language-text"><code>åœ¨é€šè¿‡ Handler å‘é€å¼‚æ­¥æ¶ˆæ¯ä¹‹å‰ï¼Œè°ƒç”¨ MessageQueue çš„ postSyncBarrier() æ–¹æ³•ï¼Œå‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªä½œä¸ºåŒæ­¥å±éšœçš„æ¶ˆæ¯ï¼Œ
åœ¨é€šè¿‡ Handler å‘é€å¼‚æ­¥æ¶ˆæ¯ä¹‹åï¼Œå½“å¾ªç¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä½œä¸ºåŒæ­¥å±éšœçš„æ¶ˆæ¯æ—¶ï¼Œå°±åªä¼šä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºä½äºåŒæ­¥å±éšœä¹‹åçš„å¼‚æ­¥æ¶ˆæ¯ï¼Œ
ç›´åˆ°è°ƒç”¨ removeSyncBarrier æ–¹æ³•å°†ä½œä¸ºåŒæ­¥å±éšœçš„æ¶ˆæ¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»é™¤åï¼Œ
æ‰ä¼šä»æ¶ˆæ¯é˜Ÿåˆ—çš„å¤´éƒ¨èŠ‚ç‚¹å¼€å§‹ï¼Œä¾æ¬¡æŒ¨ä¸ªåœ°å–å‡ºæ¯ä¸ªæ¶ˆæ¯ï¼Œè€Œä¸è€ƒè™‘å–å‡ºçš„æ˜¯åŒæ­¥æ¶ˆæ¯è¿˜æ˜¯å¼‚æ­¥æ¶ˆæ¯ã€‚
</code></pre></div><p><img src="/assets/05.f490f0d7.png" alt="" loading="lazy"></p><h3 id="_12-3-åŒæ­¥å±éšœçš„åº”ç”¨-åˆ·æ–°-ui" tabindex="-1"><a class="header-anchor" href="#_12-3-åŒæ­¥å±éšœçš„åº”ç”¨-åˆ·æ–°-ui" aria-hidden="true">#</a> 12.3 åŒæ­¥å±éšœçš„åº”ç”¨ï¼šåˆ·æ–° <code>UI</code></h3><p>ä¸ºäº†ä¿è¯ <code>UI</code> ç•Œé¢çš„æµç•…ï¼Œåœ¨åˆ·æ–°é¢‘ç‡ä¸º <code>60Hz</code> çš„å®‰å“å±å¹•ä¸­ï¼Œåº”è¯¥ä¿è¯æ¯ <code>16ms</code> åˆ·æ–°ä¸€å¸§å±å¹•å›¾åƒã€‚ï¼ˆ<code>60hz =&gt; 1000s/60f = 16.666ms/s</code>ï¼‰ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½¿ç”¨ <code>Handler</code> æ¶ˆæ¯æœºåˆ¶æ¥åˆ·æ–°å±å¹•æ—¶ï¼Œå¿…é¡»ä¿è¯æ¯ <code>16ms</code> èƒ½å¤Ÿå¤„ç†ä¸€æ¬¡ <code>UI</code> åˆ·æ–°çš„æ¶ˆæ¯ï¼Œè€Œä¸èƒ½å—åˆ°å…¶å®ƒåŒæ­¥æ¶ˆæ¯çš„å½±å“ã€‚</p><p>å› æ­¤ï¼Œé€šè¿‡åŒæ­¥å±éšœï¼Œå°† <code>UI</code> åˆ·æ–°çš„æ¶ˆæ¯è®¾ç½®ä¸ºå¼‚æ­¥æ¶ˆæ¯ï¼Œå°±èƒ½å¤Ÿé¿å…åŒæ­¥æ¶ˆæ¯äº§ç”Ÿçš„å¹²æ‰°ã€‚ä»è€Œåœ¨åŒæ­¥å±éšœçš„ä¿è¯ä¸‹ï¼Œæ¯ <code>16ms</code> å¤„ç†ä¸€æ¬¡ <code>UI</code> åˆ·æ–°çš„å¼‚æ­¥æ¶ˆæ¯ã€‚</p><p><code>UI</code> ç»˜åˆ¶ä¸­ä½¿ç”¨åŒæ­¥å±éšœçš„ç›¸å…³æºç åˆ†æå¦‚ä¸‹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>åœ¨åˆ·æ–°ç•Œé¢æ—¶ï¼ˆå¦‚è°ƒç”¨ View.requestLayout æ–¹æ³•ï¼‰ï¼Œä¼šæ‰§è¡Œ ViewRootImpl.scheduleTraversals() æ–¹æ³•æ¥è¯·æ±‚ä¸€æ¬¡ UI ç»˜åˆ¶æµç¨‹ï¼Œ
åœ¨ scheduleTraversals() æ–¹æ³•ä¸­ï¼Œä¼šå…ˆè°ƒç”¨ MessageQueue.postSyncBarrier æ–¹æ³•å¼€å¯åŒæ­¥å±éšœï¼Œ
ç„¶åè°ƒç”¨ Choreographer.postCallback æ–¹æ³•å‘é€ä¸€ç³»åˆ—çš„å¼‚æ­¥æ¶ˆæ¯ï¼Œ
åœ¨åŒæ­¥å±éšœçš„ä½œç”¨ä¸‹ï¼Œä¼šä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºç»˜åˆ¶ UI çš„å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œ
å¤„ç†è¿‡ç¨‹ä¸­å°±ä¼šæ‰§è¡Œ TraversalRunnable.run() æ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨ doTraversal() æ–¹æ³•ï¼Œ
å› æ­¤ï¼Œå¯ä»¥åœ¨ doTraversal() æ–¹æ³•ä¸­è°ƒç”¨ MessageQueue.removeSyncBarrier æ–¹æ³•åœæ­¢åŒæ­¥å±éšœã€‚
</code></pre></div><p><img src="/assets/06.a0436178.png" alt="" loading="lazy"></p><h2 id="_13-handlerthread" tabindex="-1"><a class="header-anchor" href="#_13-handlerthread" aria-hidden="true">#</a> 13. <code>HandlerThread</code></h2><p><code>HandlerThread</code> æ˜¯ <code>Thread</code> çš„å­ç±»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>HandlerThread</code> è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ã€‚</p><p><code>HandlerThread</code> ä½œä¸ºä¸€ä¸ªçº¿ç¨‹ï¼Œå…¶ç‰¹æ®Šä¹‹å¤„å°±åœ¨äºï¼šå®ƒä¼šåœ¨çº¿ç¨‹ä¸­åˆ›å»ºå¹¶ç»‘å®šä¸€ä¸ª <code>Looper</code>ã€‚</p><p><code>HandlerThread</code> çš„ä½œç”¨å°±æ˜¯ï¼š</p><ol><li><p>æ–¹ä¾¿ä½¿ç”¨ï¼šåŒ…æ‹¬æ–¹ä¾¿åˆå§‹åŒ–ã€æ–¹ä¾¿è·å–çº¿ç¨‹ç»‘å®šçš„ <code>Looper</code>ã€‚</p></li><li><p>ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚</p></li></ol><p><code>HandlerThread</code> çš„å†…éƒ¨å®ç°ä¸»è¦å¦‚ä¸‹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>HandlerThread å†…éƒ¨é€šè¿‡åŒæ­¥é”ï¼Œä¿è¯åœ¨å…¶å®ƒçº¿ç¨‹ä¸­èƒ½å¤Ÿå®‰å…¨åœ°è°ƒç”¨ getLooper() æ–¹æ³•è·å–åˆ°ä¸€ä¸ªä¸ä¸º null çš„ Looper å¯¹è±¡ã€‚
å¦‚æœä¸ä½¿ç”¨ HandlerThreadï¼Œè€Œæ˜¯ new ä¸€ä¸ª Threadï¼Œé‡å†™ Thread.run() æ–¹æ³•ï¼Œåœ¨ run æ–¹æ³•ä¸­è°ƒç”¨ Looper.prepare å’Œ Looper.loop æ–¹æ³•ï¼Œ
é‚£ä¹ˆåœ¨å…¶å®ƒçº¿ç¨‹ä¸­è·å–è¿™ä¸ªæ–°åˆ›å»ºçº¿ç¨‹ä¸­çš„ Looper å¯¹è±¡æ—¶ï¼Œå¯èƒ½è·å–åˆ°çš„æ˜¯ä¸€ä¸ª nullï¼Œ
è¿™æ˜¯å› ä¸ºï¼Œæ–°åˆ›å»ºçº¿ç¨‹ä¸­çš„ run æ–¹æ³•ï¼Œåœ¨å…¶å®ƒçº¿ç¨‹è°ƒç”¨ getLooper æ—¶å¯èƒ½è¿˜æœªæ‰§è¡Œï¼Œä»è€Œæ–°åˆ›å»ºçº¿ç¨‹ä¸­çš„ Looper å¯¹è±¡è¿˜æœªåˆ›å»ºã€‚
</code></pre></div><p><img src="/assets/07.afe8e599.png" alt="" loading="lazy"></p><h2 id="_14-intentservice" tabindex="-1"><a class="header-anchor" href="#_14-intentservice" aria-hidden="true">#</a> 14. <code>IntentService</code></h2><p><code>Service</code> ä¸€èˆ¬ç”¨äºå¤„ç†åå°è€—æ—¶ä»»åŠ¡ã€‚</p><p>å¯¹äºå¦‚ä¸‹éœ€æ±‚ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>ä¸€é¡¹ä»»åŠ¡åˆ†æˆå‡ ä¸ªå­ä»»åŠ¡ï¼Œå­ä»»åŠ¡æŒ‰é¡ºåºå…ˆåæ‰§è¡Œï¼Œå­ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œåï¼Œè¿™é¡¹ä»»åŠ¡æ‰ç®—æˆåŠŸã€‚
</code></pre></div><p>è¿™ä¸ªéœ€æ±‚å¯ä»¥ç”¨å¤šä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œä¸€ä¸ªçº¿ç¨‹å¤„ç† -&gt; ä¸‹ä¸€ä¸ªçº¿ç¨‹ -&gt; ä¸‹ä¸€ä¸ªçº¿ç¨‹</p><p><code>IntentService</code> å¯ä»¥å®Œæˆè¿™ä¸ªéœ€æ±‚ï¼Œè€Œä¸”èƒ½å¤Ÿå¾ˆå¥½çš„ç®¡ç†çº¿ç¨‹ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªå­çº¿ç¨‹å¤„ç†å·¥ä½œï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªä¸€ä¸ªåœ°å®Œæˆä»»åŠ¡ï¼Œæœ‰æ¡ä¸ç´Šåœ°è¿›è¡Œã€‚</p><p><code>IntentService</code> çš„å®ç°å¦‚ä¸‹ï¼š</p><div class="language-text ext-text"><pre class="language-text"><code>IntentService å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåœ¨å­çº¿ç¨‹ä¸­è¿è¡Œçš„ Handler æ¶ˆæ¯æœºåˆ¶ã€‚
åœ¨ä¸åœæ­¢ IntentService çš„æƒ…å†µä¸‹ï¼Œ
æ¯æ¬¡å¯åŠ¨ IntentService æ—¶ï¼Œéƒ½ä¼šå°†ä¸€ä¸ªæŒæœ‰æœ€æ–° startId çš„æ¶ˆæ¯ï¼ˆmsg.arg1 = startIdï¼‰æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œ
åœ¨ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªæ¶ˆæ¯è¢«å¤„ç†å®Œæˆåï¼Œéƒ½ä¼šå°è¯•è°ƒç”¨ stopSelf(msg.arg1) åœæ­¢ IntentServiceï¼Œ
ä½†æ˜¯ï¼Œåªæœ‰æœ€åä¸€ä¸ªæ¶ˆæ¯æ‰ä¼šæŒæœ‰æœ€æ–°çš„ startIdã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿˜å­˜åœ¨æ¶ˆæ¯æ—¶ï¼Œæ­£åœ¨è¢«å¤„ç†çš„æ¶ˆæ¯æ˜¯æ— æ³•é€šè¿‡ stopSelf(msg.arg1) å°† IntentService ç»™åœä¸‹æ¥çš„ã€‚
é™¤éåœ¨é‡å†™çš„ onHandleIntent ä¸­è°ƒç”¨ stopSelf()ã€stopSelf(-1)ã€stopService(intent) æ‰ä¼šç«‹å³å°† IntentService åœä¸‹æ¥ã€‚
</code></pre></div><p><img src="/assets/08.8586c72a.png" alt="" loading="lazy"></p><h3 id="_14-1-ç¤ºä¾‹-intentservice-çš„ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_14-1-ç¤ºä¾‹-intentservice-çš„ä½¿ç”¨" aria-hidden="true">#</a> 14.1 ç¤ºä¾‹ï¼š<code>IntentService</code> çš„ä½¿ç”¨</h3><p><img src="/assets/09.07da3606.png" alt="" loading="lazy"></p><h2 id="_15-handler-é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#_15-handler-é¢è¯•é¢˜" aria-hidden="true">#</a> 15. <code>Handler</code> é¢è¯•é¢˜</h2><h3 id="_15-1-ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª-handler" tabindex="-1"><a class="header-anchor" href="#_15-1-ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª-handler" aria-hidden="true">#</a> 15.1 ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª <code>Handler</code>ï¼Ÿ</h3><div class="language-text ext-text"><pre class="language-text"><code>ä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥ new æ— æ•°ä¸ª Handler å¯¹è±¡ï¼Œ
ä½†ä¸€ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ª Handler æ¶ˆæ¯æœºåˆ¶ï¼Œå³åªèƒ½ç»‘å®šä¸€ä¸ª Looper å¯¹è±¡å’Œ ä¸€ä¸ª MessageQueue å¯¹è±¡ã€‚
</code></pre></div><h3 id="_15-2-ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª-looper-å¦‚ä½•ä¿è¯" tabindex="-1"><a class="header-anchor" href="#_15-2-ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª-looper-å¦‚ä½•ä¿è¯" aria-hidden="true">#</a> 15.2 ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ª <code>Looper</code>ï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ</h3><div class="language-text ext-text"><pre class="language-text"><code>ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª Looper å¯¹è±¡ã€‚ä¿è¯æªæ–½ï¼š
1. Looper çš„æ„é€ æ–¹æ³•ç§æœ‰åŒ–
2. é€šè¿‡é™æ€æ–¹æ³• Looper.prepare åˆ›å»º Looper å¯¹è±¡æ—¶ï¼Œä½¿ç”¨ ThreadLocal ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ä¸­åªç»‘å®šä¸€ä¸ª Looper å¯¹è±¡
</code></pre></div><h3 id="_15-3-handler-å†…å­˜æ³„æ¼åŸå› -ä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_15-3-handler-å†…å­˜æ³„æ¼åŸå› -ä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜" aria-hidden="true">#</a> 15.3 <code>Handler</code> å†…å­˜æ³„æ¼åŸå› ï¼Ÿä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ</h3><div class="language-text ext-text"><pre class="language-text"><code>ä»¥ Activity ä¸ºä¾‹ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šå°† Handler ä½œä¸º Activity çš„å†…éƒ¨ç±»ã€‚
ç”±äºå†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œå› æ­¤ï¼ŒHandler å¯¹è±¡å¼•ç”¨äº† Activity å¯¹è±¡ã€‚
å¹¶ä¸”ï¼Œåœ¨å‘é€æ¶ˆæ¯å¹¶å°†æ¶ˆæ¯å…¥é˜Ÿæ—¶ï¼Œä¼šé€šè¿‡ msg.target = this; ä½¿å¾—æ¶ˆæ¯å¯¹è±¡å¼•ç”¨ Handler å¯¹è±¡ï¼Œ
äºæ˜¯ï¼Œæ¶ˆæ¯å¯¹è±¡é—´æ¥å¼•ç”¨äº† Activity å¯¹è±¡ã€‚
å¦‚æœåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å¯¹è±¡åœ¨ Activity å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸåä»ç„¶æ²¡æœ‰å‡ºé˜Ÿï¼Œé‚£ä¹ˆä¾æ®åƒåœ¾å›æ”¶æ—¶çš„æ ¹æœç´¢ç®—æ³•ï¼Œ
Activity å¯¹è±¡å¯è¾¾ï¼Œä¸è¢«è®¤ä¸ºæ˜¯åƒåœ¾ï¼Œæ— æ³•å›æ”¶ã€‚ä»è€Œå¯¼è‡´äº†ç”±äº Activity å¯¹è±¡æ— æ³•è¢«å›æ”¶è€Œå¼•ç”¨çš„å†…å­˜æ³„æ¼ã€‚
</code></pre></div><h3 id="_15-4-ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥-new-handler" tabindex="-1"><a class="header-anchor" href="#_15-4-ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥-new-handler" aria-hidden="true">#</a> 15.4 ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥ <code>new Handler</code>ï¼Ÿ</h3><div class="language-text ext-text"><pre class="language-text"><code>åœ¨ ActivityThread.main æ–¹æ³•ä¸­ï¼Œå·²ç»ä¾æ¬¡è°ƒç”¨è¿‡ Looper çš„ prepare å’Œ loop æ–¹æ³•äº†ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹ä¸­å¯ä»¥ç›´æ¥ new Handlerã€‚
</code></pre></div><h3 id="_15-5-å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­-new-handler-è¦åšäº›ä»€ä¹ˆå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#_15-5-å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­-new-handler-è¦åšäº›ä»€ä¹ˆå‡†å¤‡" aria-hidden="true">#</a> 15.5 å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­ <code>new Handler</code> è¦åšäº›ä»€ä¹ˆå‡†å¤‡ï¼Ÿ</h3><div class="language-text ext-text"><pre class="language-text"><code>è€Œå¦‚æœåœ¨å­çº¿ç¨‹ä¸­ new Handlerï¼Œé‚£ä¹ˆéœ€è¦å…ˆä¾æ¬¡è°ƒç”¨ Looper çš„ prepare å’Œ loop æ–¹æ³•ã€‚
</code></pre></div><h3 id="_15-6-æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ-æœ‰ä»€ä¹ˆç”¨" tabindex="-1"><a class="header-anchor" href="#_15-6-æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ-æœ‰ä»€ä¹ˆç”¨" aria-hidden="true">#</a> 15.6 æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h3><div class="language-text ext-text"><pre class="language-text"><code>æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ— æ¶ˆæ¯æ—¶ï¼Œä¼šè°ƒç”¨ nativePollOnce(ptr, -1) æ–¹æ³•ï¼Œä½¿æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹è¿›å…¥æ— é™ç­‰å¾…çŠ¶æ€ã€‚
ä»è€Œäº¤å‡º CPU çš„æ‰§è¡Œæƒç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ã€‚
</code></pre></div><h3 id="_15-7-å¤šä¸ª-handler-åœ¨ä¸åŒçº¿ç¨‹ä¸­å‘æ¶ˆæ¯æ—¶-å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨" tabindex="-1"><a class="header-anchor" href="#_15-7-å¤šä¸ª-handler-åœ¨ä¸åŒçº¿ç¨‹ä¸­å‘æ¶ˆæ¯æ—¶-å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨" aria-hidden="true">#</a> 15.7 å¤šä¸ª <code>Handler</code> åœ¨ä¸åŒçº¿ç¨‹ä¸­å‘æ¶ˆæ¯æ—¶ï¼Œå¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ</h3><div class="language-text ext-text"><pre class="language-text"><code>é€šè¿‡å¯¹ MessageQueue çš„ enqueueMessage æ–¹æ³•ä¸­çš„æ¶ˆæ¯å…¥é˜Ÿè¿‡ç¨‹å’Œ MessageQueue çš„ next æ–¹æ³•ä¸­çš„æ¶ˆæ¯å‡ºé˜Ÿè¿‡ç¨‹ï¼Œ
åˆ†åˆ«åŠ ä¸Šç›¸åŒçš„åŒæ­¥é”ï¼Œä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
</code></pre></div><h3 id="_15-8-ä½¿ç”¨-message-æ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒ" tabindex="-1"><a class="header-anchor" href="#_15-8-ä½¿ç”¨-message-æ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒ" aria-hidden="true">#</a> 15.8 ä½¿ç”¨ <code>Message</code> æ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒï¼Ÿ</h3><div class="language-text ext-text"><pre class="language-text"><code>Message ç±»åœ¨è®¾è®¡æ—¶é‡‡ç”¨æ¥äº†äº«å…ƒè®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡é™æ€å˜é‡ sPool æ¥ç»´æŠ¤ä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡æ± ï¼Œä½¿å¾—å¯ä»¥å¤ç”¨å·²å­˜åœ¨çš„ Message å¯¹è±¡ï¼Œ
Message ç±»æä¾›é™æ€æ–¹æ³• obtain è¿”å›ä¸€ä¸ª Message å¯¹è±¡ï¼š
    1. å½“ sPool ä¸­å­˜åœ¨æ¶ˆæ¯å¯¹è±¡æ—¶ï¼Œè¿”å› sPool ä¸­çš„æ¶ˆæ¯å¯¹è±¡ï¼›
    2. å½“ sPool ä¸­ä¸å­˜åœ¨æ¶ˆæ¯å¯¹è±¡æ—¶ï¼Œè¿”å›ä¸€ä¸ªæ–°åˆ›å»ºçš„å¯¹è±¡ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ºäº†é¿å…é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯ Message å¯¹è±¡æ‰€é€ æˆçš„å†…å­˜æŠ–åŠ¨ï¼Œåº”è¯¥ä½¿ç”¨ Message.obtain æ–¹æ³•æ¥åˆ›å»º Messageã€‚
</code></pre></div><h3 id="_15-9-looper-æ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»" tabindex="-1"><a class="header-anchor" href="#_15-9-looper-æ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»" aria-hidden="true">#</a> 15.9 <code>Looper</code> æ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ</h3><div class="language-text ext-text"><pre class="language-text"><code>Looper æ­»å¾ªç¯çš„ç›®çš„åªæ˜¯ä¸ºäº†å°†æ¶ˆæ¯é˜Ÿåˆ—ä¸­å­˜åœ¨çš„æ¶ˆæ¯å‡ºé˜Ÿï¼Œå½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼ŒLooper å¾ªç¯æ‰€åœ¨çš„çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œ
æ­¤æ—¶ï¼Œè°ƒåº¦å™¨å°±ä¼šå°† CPU èµ„æºåˆ†é…ç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ï¼Œæ‰§è¡Œå…¶å®ƒçº¿ç¨‹ä¸­çš„ä»£ç ã€‚
åº”ç”¨å¡æ­»å°±æ˜¯è¯´å‡ºç°äº† ANRï¼ŒANR å‡ºç°çš„åœºæ™¯å¯åˆ†ä¸ºï¼š
    1. Input äº‹ä»¶ï¼ˆå¦‚ç‚¹å‡»ï¼Œè§¦æ‘¸ï¼‰çš„å¤„ç†æ—¶é—´è¶…è¿‡ 5sï¼›
    2. Broadcast å¹¿æ’­çš„å¤„ç†æ—¶é—´è¶…è¿‡ 10s
    3. Service å‰å°æœåŠ¡çš„å¤„ç†æ—¶é—´è¶…è¿‡ 20s
ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¼è‡´ ANR å‡ºç°çš„åŸå› æ˜¯å¯¹æŸä¸ªä»»åŠ¡çš„å¤„ç†ä¸ºæŒ‰æ—¶å®Œæˆã€‚
è€Œåœ¨ App ä¸­ï¼Œä¸€åˆ‡ä»»åŠ¡éƒ½æ˜¯é€šè¿‡å‘é€ Message æ¶ˆæ¯æ¥å¤„ç†çš„ã€‚
æ¢å¥è¯è¯´ï¼Œå¯¼è‡´ ANR å‡ºç°çš„åŸå› æ˜¯ Message æ¶ˆæ¯å‡ºé˜Ÿåçš„å¤„ç†è¿‡ç¨‹æœªæŒ‰æ—¶å®Œæˆï¼
è¿™å°±æ„å‘³ç€ï¼Œåªæœ‰å½“å­˜åœ¨ Message æ¶ˆæ¯çš„æƒ…å†µä¸‹ï¼Œæ‰æœ‰å¯èƒ½å‡ºç° ANRï¼Œå³å‡ºç°åº”ç”¨å¡æ­»çš„ç°è±¡ã€‚
è€Œç”±äºä¸å­˜åœ¨ Message æ¶ˆæ¯ï¼Œå¯¼è‡´çš„ Looper æ‰€åœ¨çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè·Ÿåº”è¯¥å¡æ­»æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚
è€Œ Looper æ­»å¾ªç¯çš„ç›®çš„åªæ˜¯ä¸åœåœ°å°†æ¶ˆæ¯å‡ºé˜Ÿï¼Œè·Ÿæ¶ˆæ¯å‡ºé˜Ÿåçš„å¤„ç†è¿‡ç¨‹æ— å…³ï¼Œä¹Ÿå°±æ˜¯è¯´è·Ÿ ANR æ— å…³ï¼Œå› æ­¤ä¹Ÿè·Ÿåº”è¯¥å¡æ­»æ— å…³ã€‚
</code></pre></div><!--]--></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/zengkaiqiang562/JavaGuide/edit/main/docs/zkq/android/basic/handler.md" rel="noopener noreferrer" target="_blank" arialabel="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" arialabelledby="edit"><title id="edit" lang="en">edit icon</title><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="info">2022/7/8 14:42:00</span></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: zengkaiqiang562@163.com">zengk</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/zkq/android/basic/asynctask.html" class="nav-link prev" arialabel="AsyncTask"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->AsyncTask</div></a><a href="/zkq/android/basic/custom-view.html" class="nav-link next" arialabel="è‡ªå®šä¹‰Viewï¼ˆTODOï¼‰"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">è‡ªå®šä¹‰Viewï¼ˆTODOï¼‰<!----></div></a></nav><!----><!----></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright Â© 2023 Zenk562</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.625aa393.js" defer></script>
  </body>
</html>
