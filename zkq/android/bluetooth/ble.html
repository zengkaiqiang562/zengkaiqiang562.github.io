<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.38" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://zengkaiqiang562.github.io/zkq/android/bluetooth/ble.html"><meta property="og:site_name" content="Android Guide"><meta property="og:title" content="低功耗蓝牙（BLE）"><meta property="og:type" content="article"><meta property="og:image" content="https://zengkaiqiang562.github.io/"><meta property="og:updated_time" content="2022-07-07T10:02:39.000Z"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="低功耗蓝牙（BLE）"><meta property="article:tag" content="android-蓝牙开发"><meta property="article:modified_time" content="2022-07-07T10:02:39.000Z"><script>var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?5dd2e8c97962d57b7b8fea1737c01743";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2922463_99aa80ii7cf.css"><title>低功耗蓝牙（BLE） | Android Guide</title><meta name="description" content="Android 学习 && 面试指南">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.5a38b724.css">
    <link rel="modulepreload" href="/assets/app.625aa393.js"><link rel="modulepreload" href="/assets/ble.html.22487863.js"><link rel="modulepreload" href="/assets/ble.html.2ad92873.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc sidebar-open"><!--[--><header class="navbar"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><a href="/" class="home-link"><img class="logo" src="/logo.png" alt="Android Guide"><!----><span class="site-name hide-in-pad">Android Guide</span><!--[--><!----><!--]--></a><nav class="nav-links" style=""><div class="nav-item hide-in-mobile"><a href="/home.html" class="nav-link" arialabel="面试指南"><i class="icon iconfont icon-java"></i>面试指南<!----></a></div><div class="nav-item hide-in-mobile"><a href="/zhuanlan/" class="nav-link" arialabel="优质专栏"><i class="icon iconfont icon-recommend"></i>优质专栏<!----></a></div><div class="nav-item hide-in-mobile"><a href="/open-source-project/" class="nav-link" arialabel="项目精选"><i class="icon iconfont icon-github"></i>项目精选<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://snailclimb.gitee.io/javaguide/#/" rel="noopener noreferrer" target="_blank" arialabel="旧版链接" class="nav-link"><i class="icon iconfont icon-java"></i>旧版链接<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="https://javaguide.cn/feed.json" rel="noopener noreferrer" target="_blank" arialabel="RSS订阅" class="nav-link"><i class="icon iconfont icon-rss"></i>RSS订阅<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="/about-the-author/" class="nav-link" arialabel="关于作者"><i class="icon iconfont icon-zuozhe"></i>关于作者<!----></a></div></nav><div class="nav-actions-wrapper"><!--[--><!----><!--]--><div class="nav-item"><!----></div><div class="nav-item"><a class="repo-link" href="https://github.com/zengkaiqiang562/JavaGuide" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" arialabelledby="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><title id="github" lang="en">github icon</title><g fill="currentColor"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></g></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" arialabelledby="auto" style="display:block;"><title id="auto" lang="en">auto icon</title><g fill="currentColor"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" arialabelledby="dark" style="display:none;"><title id="dark" lang="en">dark icon</title><g fill="currentColor"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" arialabelledby="light" style="display:none;"><title id="light" lang="en">light icon</title><g fill="currentColor"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></g></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button><!--[--><!----><!--]--></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">基础</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">绘图基础</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">动画</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">UI</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Jetpack</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">NDK</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">IPC</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">蓝牙开发</span><span class="arrow down"></span></button><!--[--><ul class="sidebar-links"><li><!--[--><a href="/zkq/android/bluetooth/classic-bluetooth.html" class="nav-link sidebar-link sidebar-page" arialabel="经典蓝牙"><!---->经典蓝牙<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/zkq/android/bluetooth/ble.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" arialabel="低功耗蓝牙（BLE）"><!---->低功耗蓝牙（BLE）<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_1-蓝牙-4-0-ble-概述" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1. 蓝牙 4.0（BLE）概述"><!---->1. 蓝牙 4.0（BLE）概述<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_2-应用场景" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2. 应用场景"><!---->2. 应用场景<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_2-1-ibeacon-技术" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.1 iBeacon 技术"><!---->2.1 iBeacon 技术<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_2-2-蓝牙防丢器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.2 蓝牙防丢器"><!---->2.2 蓝牙防丢器<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_3-sensortag-开发套件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3. SensorTag 开发套件"><!---->3. SensorTag 开发套件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-gap-generic-access-profile-通用访问配置文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4. GAP（Generic Access Profile 通用访问配置文件）"><!---->4. GAP（Generic Access Profile 通用访问配置文件）<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-1-gap-作用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1 GAP 作用"><!---->4.1 GAP 作用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-2-设备角色-外围设备-peripheral-中心设备-central" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.2 设备角色：外围设备（Peripheral） &amp; 中心设备（Central）"><!---->4.2 设备角色：外围设备（Peripheral） &amp; 中心设备（Central）<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-3-广播" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3 广播"><!---->4.3 广播<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-3-1-外围设备向外广播数据的两种方式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.1 外围设备向外广播数据的两种方式"><!---->4.3.1 外围设备向外广播数据的两种方式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-3-2-广播的工作流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.2 广播的工作流程"><!---->4.3.2 广播的工作流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-3-3-广播的网络拓扑结构" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.3 广播的网络拓扑结构"><!---->4.3.3 广播的网络拓扑结构<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-gatt-generic-attribute-profile-通用属性配置文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5. GATT（Generic Attribute Profile 通用属性配置文件）"><!---->5. GATT（Generic Attribute Profile 通用属性配置文件）<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-1-gatt-概述" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.1 GATT 概述"><!---->5.1 GATT 概述<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-2-gatt-gap-的关系" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.2 GATT &amp; GAP 的关系"><!---->5.2 GATT &amp; GAP 的关系<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-3-gatt-连接是独占的-gatt-连接的网络拓扑图" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.3 GATT 连接是独占的 &amp; GATT 连接的网络拓扑图"><!---->5.3 GATT 连接是独占的 &amp; GATT 连接的网络拓扑图<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-4-gatt-通信事务-数据交互流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.4 GATT 通信事务 &amp; 数据交互流程"><!---->5.4 GATT 通信事务 &amp; 数据交互流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-5-gatt-结构" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5 GATT 结构"><!---->5.5 GATT 结构<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-5-1-profile" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5.1 Profile"><!---->5.5.1 Profile<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-5-2-service" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5.2 Service"><!---->5.5.2 Service<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-5-3-characteristic" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5.3 Characteristic"><!---->5.5.3 Characteristic<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-ble-的开发流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6. BLE 的开发流程"><!---->6. BLE 的开发流程<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-1-申请蓝牙相关的权限" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.1 申请蓝牙相关的权限"><!---->6.1 申请蓝牙相关的权限<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-2-检查手机是否支持蓝牙设备-以及是否支持蓝牙-4-0-ble-功能" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.2 检查手机是否支持蓝牙设备 &amp; 以及是否支持蓝牙 4.0（BLE）功能"><!---->6.2 检查手机是否支持蓝牙设备 &amp; 以及是否支持蓝牙 4.0（BLE）功能<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-3-打开蓝牙功能" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.3 打开蓝牙功能"><!---->6.3 打开蓝牙功能<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-4-扫描附近的设备" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.4 扫描附近的设备"><!---->6.4 扫描附近的设备<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-5-连接-断开-ble-设备" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.5 连接 &amp; 断开 BLE 设备"><!---->6.5 连接 &amp; 断开 BLE 设备<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-6-发现-查询-蓝牙设备的-service-和-characteristic-特征值" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.6 发现（查询）蓝牙设备的 Service 和 Characteristic（特征值）"><!---->6.6 发现（查询）蓝牙设备的 Service 和 Characteristic（特征值）<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-7-示例-1-特征值中的描述符-bluetoothgattdescriptor" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.7 示例 1：特征值中的描述符（BluetoothGattDescriptor）"><!---->6.7 示例 1：特征值中的描述符（BluetoothGattDescriptor）<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-8-示例-2-与红外温度传感器-外围设备-的数据交互" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.8 示例 2：与红外温度传感器（外围设备）的数据交互"><!---->6.8 示例 2：与红外温度传感器（外围设备）的数据交互<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-9-示例-3-sensortag-属性表-基于-att-协议的查找表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.9 示例 3：SensorTag 属性表（基于 ATT 协议的查找表）"><!---->6.9 示例 3：SensorTag 属性表（基于 ATT 协议的查找表）<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li></ul><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">性能优化</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">系统源码分析</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">其他</span><span class="arrow right"></span></button><!--[--><!----><!----><!--]--></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->低功耗蓝牙（BLE）</h1><div class="article-info"><span class="author-info" arialabel="作者🖊" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" arialabelledby="author"><title id="author" lang="en">author icon</title><g fill="currentColor"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></g></svg><span><a class="author-item" href="https://zengkaiqiang562.github.io/" target="_blank" rel="noopener noreferrer">Zenk562</a></span><span property="author" content="Zenk562"></span></span><span class="category-info" arialabel="分类🌈" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" arialabelledby="category"><title id="category" lang="en">category icon</title><g fill="currentColor"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></g></svg><ul class="categories-wrapper"><li class="category clickable" role="navigation">android-蓝牙开发</li><meta property="articleSection" content="android-蓝牙开发"></ul></span><span arialabel="标签🏷" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" arialabelledby="tag"><title id="tag" lang="en">tag icon</title><g fill="currentColor"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></g></svg><ul class="tags-wrapper"><li class="tag clickable" role="navigation">android-蓝牙开发</li></ul><meta property="keywords" content="android-蓝牙开发"></span><span class="date-info" arialabel="写作日期📅" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" arialabelledby="calendar"><title id="calendar" lang="en">calendar icon</title><g fill="currentColor"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></g></svg><span>2022年7月6日</span><meta property="datePublished" content="2022-07-06T10:07:29.000Z"></span><!----><span class="words-info" arialabel="字数🔠" isoriginal="false" pageview="false" color="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" arialabelledby="word"><title id="word" lang="en">word icon</title><g fill="currentColor"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></g></svg><span>约 4581 字</span><meta property="wordCount" content="4581"></span></div><hr></div><div class="toc-place-holder"><aside id="toc-list"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_1-蓝牙-4-0-ble-概述" class="router-link-active router-link-exact-active toc-link level2">1. 蓝牙 4.0（BLE）概述</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_2-应用场景" class="router-link-active router-link-exact-active toc-link level2">2. 应用场景</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_2-1-ibeacon-技术" class="router-link-active router-link-exact-active toc-link level3">2.1 iBeacon 技术</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_2-2-蓝牙防丢器" class="router-link-active router-link-exact-active toc-link level3">2.2 蓝牙防丢器</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_3-sensortag-开发套件" class="router-link-active router-link-exact-active toc-link level2">3. SensorTag 开发套件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-gap-generic-access-profile-通用访问配置文件" class="router-link-active router-link-exact-active toc-link level2">4. GAP（Generic Access Profile 通用访问配置文件）</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-1-gap-作用" class="router-link-active router-link-exact-active toc-link level3">4.1 GAP 作用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-2-设备角色-外围设备-peripheral-中心设备-central" class="router-link-active router-link-exact-active toc-link level3">4.2 设备角色：外围设备（Peripheral） &amp; 中心设备（Central）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-3-广播" class="router-link-active router-link-exact-active toc-link level3">4.3 广播</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-3-1-外围设备向外广播数据的两种方式" class="router-link-active router-link-exact-active toc-link level4">4.3.1 外围设备向外广播数据的两种方式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-3-2-广播的工作流程" class="router-link-active router-link-exact-active toc-link level4">4.3.2 广播的工作流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_4-3-3-广播的网络拓扑结构" class="router-link-active router-link-exact-active toc-link level4">4.3.3 广播的网络拓扑结构</a></li><!----><!--]--></ul><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-gatt-generic-attribute-profile-通用属性配置文件" class="router-link-active router-link-exact-active toc-link level2">5. GATT（Generic Attribute Profile 通用属性配置文件）</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-1-gatt-概述" class="router-link-active router-link-exact-active toc-link level3">5.1 GATT 概述</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-2-gatt-gap-的关系" class="router-link-active router-link-exact-active toc-link level3">5.2 GATT &amp; GAP 的关系</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-3-gatt-连接是独占的-gatt-连接的网络拓扑图" class="router-link-active router-link-exact-active toc-link level3">5.3 GATT 连接是独占的 &amp; GATT 连接的网络拓扑图</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-4-gatt-通信事务-数据交互流程" class="router-link-active router-link-exact-active toc-link level3">5.4 GATT 通信事务 &amp; 数据交互流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-5-gatt-结构" class="router-link-active router-link-exact-active toc-link level3">5.5 GATT 结构</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-5-1-profile" class="router-link-active router-link-exact-active toc-link level4">5.5.1 Profile</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-5-2-service" class="router-link-active router-link-exact-active toc-link level4">5.5.2 Service</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_5-5-3-characteristic" class="router-link-active router-link-exact-active toc-link level4">5.5.3 Characteristic</a></li><!----><!--]--></ul><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-ble-的开发流程" class="router-link-active router-link-exact-active toc-link level2">6. BLE 的开发流程</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-1-申请蓝牙相关的权限" class="router-link-active router-link-exact-active toc-link level3">6.1 申请蓝牙相关的权限</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-2-检查手机是否支持蓝牙设备-以及是否支持蓝牙-4-0-ble-功能" class="router-link-active router-link-exact-active toc-link level3">6.2 检查手机是否支持蓝牙设备 &amp; 以及是否支持蓝牙 4.0（BLE）功能</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-3-打开蓝牙功能" class="router-link-active router-link-exact-active toc-link level3">6.3 打开蓝牙功能</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-4-扫描附近的设备" class="router-link-active router-link-exact-active toc-link level3">6.4 扫描附近的设备</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-5-连接-断开-ble-设备" class="router-link-active router-link-exact-active toc-link level3">6.5 连接 &amp; 断开 BLE 设备</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-6-发现-查询-蓝牙设备的-service-和-characteristic-特征值" class="router-link-active router-link-exact-active toc-link level3">6.6 发现（查询）蓝牙设备的 Service 和 Characteristic（特征值）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-7-示例-1-特征值中的描述符-bluetoothgattdescriptor" class="router-link-active router-link-exact-active toc-link level3">6.7 示例 1：特征值中的描述符（BluetoothGattDescriptor）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-8-示例-2-与红外温度传感器-外围设备-的数据交互" class="router-link-active router-link-exact-active toc-link level3">6.8 示例 2：与红外温度传感器（外围设备）的数据交互</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zkq/android/bluetooth/ble.html#_6-9-示例-3-sensortag-属性表-基于-att-协议的查找表" class="router-link-active router-link-exact-active toc-link level3">6.9 示例 3：SensorTag 属性表（基于 ATT 协议的查找表）</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><!--[--><blockquote><p>参考：<code>Android相关【公众号：启舰杂谈】\14、Android强化：服务与通信\步骤二：Android App通信\第5课：低功耗蓝牙</code></p></blockquote><h2 id="_1-蓝牙-4-0-ble-概述" tabindex="-1"><a class="header-anchor" href="#_1-蓝牙-4-0-ble-概述" aria-hidden="true">#</a> 1. 蓝牙 <code>4.0</code>（<code>BLE</code>）概述</h2><ol><li><p>蓝牙 <code>4.0</code> 就是 <code>BLE</code>（低功耗蓝牙）；</p></li><li><p>低功耗、低成本（蓝牙芯片成本低）、低延迟；</p></li><li><p>兼容不同厂商的设备交互；</p><blockquote><p>经典蓝牙中，安卓和苹果设备无法进行交互，不同品牌手机直接的交互存在兼容问题。</p></blockquote></li><li><p>完全向下兼容（即兼容经典蓝牙）；</p></li><li><p><code>BLE</code> 的主打功能是快速搜索、快速连接、超低功耗保持连接和传输数据；</p></li><li><p>弱点是数据传输速率低；</p></li><li><p>由于 <code>BLE</code> 的低功耗特点，因此普遍用于穿戴设备。</p></li></ol><h2 id="_2-应用场景" tabindex="-1"><a class="header-anchor" href="#_2-应用场景" aria-hidden="true">#</a> 2. 应用场景</h2><h3 id="_2-1-ibeacon-技术" tabindex="-1"><a class="header-anchor" href="#_2-1-ibeacon-技术" aria-hidden="true">#</a> 2.1 <code>iBeacon</code> 技术</h3><p><code>2013</code> 年 <code>9</code> 月苹果公司发布了 <code>iBeacon</code> 技术。</p><p><code>ShellBeacon</code>、<code>BrightBeacon</code> 在基于 <code>iBeacon</code> 技术和运用蓝牙 <code>4.0</code> 标准为通信方式的前提下，提供了一整套基于 <code>iBeacon</code> 的技术解决方案和便于开发的 <code>SDK</code>。</p><p><img src="/assets/01.6a2ab869.png" alt="" loading="lazy"></p><h3 id="_2-2-蓝牙防丢器" tabindex="-1"><a class="header-anchor" href="#_2-2-蓝牙防丢器" aria-hidden="true">#</a> 2.2 蓝牙防丢器</h3><p>蓝牙 <code>4.0</code> 防丢器即：智能蓝牙（<code>Smart Bluetooth</code>）防丢器。</p><p>采用最新蓝牙 <code>4.0</code> 技术，专门为 <code>iPhone</code>/<code>iPad</code> 设计的防丢器。</p><p>简单轻巧的设计，方便携带。</p><p>工作原理主要是通过距离变化来判断物品是否还控制在你的安全范围。</p><p><img src="/assets/02.d37c46c7.png" alt="" loading="lazy"></p><h2 id="_3-sensortag-开发套件" tabindex="-1"><a class="header-anchor" href="#_3-sensortag-开发套件" aria-hidden="true">#</a> 3. <code>SensorTag</code> 开发套件</h2><p><code>SensorTag</code> 是德州仪器（<code>TI</code>）为其公司生产的蓝牙芯片所提供的开发套件。</p><p>即 <code>SensorTag</code> 作为开发套件，集成了蓝牙芯片和一些传感器元件。</p><p><img src="/assets/03.ee299286.png" alt="" loading="lazy"></p><p>手机通过蓝牙连接到 <code>SensorTag</code> 后，就可以读写 <code>SensorTag</code> 中的传感器数据。</p><p><img src="/assets/04.d391d57f.png" alt="" loading="lazy"></p><p>上图所示就是 <code>TI</code> 为 <code>SensorTag</code> 开发套件提供的 <code>App</code>，手机上运行 <code>SensorTag App</code>，开启蓝牙并连接 <code>SensorTag</code>，就可以通过蓝牙 <code>4.0</code> 读取 <code>SensorTag</code> 中的服务（即每个列表 <code>item</code> 项）。</p><h2 id="_4-gap-generic-access-profile-通用访问配置文件" tabindex="-1"><a class="header-anchor" href="#_4-gap-generic-access-profile-通用访问配置文件" aria-hidden="true">#</a> 4. <code>GAP</code>（<code>Generic Access Profile</code> 通用访问配置文件）</h2><h3 id="_4-1-gap-作用" tabindex="-1"><a class="header-anchor" href="#_4-1-gap-作用" aria-hidden="true">#</a> 4.1 <code>GAP</code> 作用</h3><ol><li><p>控制设备的连接和广播；</p></li><li><p>控制设备是否被其他设备可见；</p></li><li><p>决定设备是否可以与其他设备进行交互，以及怎样与其他设备进行交互。</p><blockquote><p>例如：<code>Beacon</code> 设备只能向外广播，不支持连接。小米手环就可以与作为中心设备的其他设备连接。</p></blockquote></li></ol><h3 id="_4-2-设备角色-外围设备-peripheral-中心设备-central" tabindex="-1"><a class="header-anchor" href="#_4-2-设备角色-外围设备-peripheral-中心设备-central" aria-hidden="true">#</a> 4.2 设备角色：外围设备（<code>Peripheral</code>） &amp; 中心设备（<code>Central</code>）</h3><p><code>GAP</code> 给设备定义了若干角色，其中主要的两个是：</p><ol><li><p>外围设备（<code>Peripheral</code>）：一般是非常小或简单的低功耗设备，用来提供数据，并连接到一个相对更强大的中心设备。</p><blockquote><p>如：小米手环、<code>SensorTag</code> 等就是作为外围设备。</p></blockquote></li><li><p>中心设备（<code>Central</code>）：相对比较强大，用来连接其它外围设备。</p><blockquote><p>如：手机就是作为中心设备。</p><p>对于外围设备 <code>SensorTag</code>，运行了 <code>SensorTag App</code> 的手机就是作为中心设备。</p></blockquote></li></ol><h3 id="_4-3-广播" tabindex="-1"><a class="header-anchor" href="#_4-3-广播" aria-hidden="true">#</a> 4.3 广播</h3><h4 id="_4-3-1-外围设备向外广播数据的两种方式" tabindex="-1"><a class="header-anchor" href="#_4-3-1-外围设备向外广播数据的两种方式" aria-hidden="true">#</a> 4.3.1 外围设备向外广播数据的两种方式</h4><p><code>GAP</code> 为外围设备定义了两种向外广播数据的方式：</p><ol><li><p>广播数据（<code>Advertising Data Payload</code>）：广播数据是必需的。外围设备必需不停地向外广播，以便让中心设备知道它的存在。</p></li><li><p>扫描回复数据（<code>Scan Response Data Payload</code>）：扫描回复是可选的。中心设备可以向外围设备请求扫描回复。扫描回复数据中包含一些设备额外的信息（如设备的名字）。</p></li></ol><blockquote><p>外围设备在广播数据或扫描回复数据时，数据最长可以包含 <code>31</code> 字节（<code>byte</code>）</p></blockquote><h4 id="_4-3-2-广播的工作流程" tabindex="-1"><a class="header-anchor" href="#_4-3-2-广播的工作流程" aria-hidden="true">#</a> 4.3.2 广播的工作流程</h4><p><img src="/assets/05.02068274.png" alt="" loading="lazy"></p><p>如上图所示的 <code>GAP</code> 的广播工作流程中，可以清晰地看出广播数据和扫描回复数据是怎样工作的。其中，外围设备会设定一个广播间隔，每个广播间隔中，外围设备会重新发送自己的广播数据。</p><blockquote><p>广播间隔越长，越省电，但同时也不太容易扫描到。</p></blockquote><h4 id="_4-3-3-广播的网络拓扑结构" tabindex="-1"><a class="header-anchor" href="#_4-3-3-广播的网络拓扑结构" aria-hidden="true">#</a> 4.3.3 广播的网络拓扑结构</h4><p>外围设备向外广播数据的使用场景有两种：</p><ol><li><p>通过广播数据让中心设备发现自己，然后建立 <code>GATT</code> 连接，从而在连接的基础上进行更多的数据交互。</p><blockquote><p>一个外围设备同时只能与一个中心设备建立 <code>GATT</code> 连接，即连接后的数据交互是一对一的。</p></blockquote></li><li><p>仅仅只是将数据向外广播出去，<strong>不需要与中心设备建立连接</strong>。</p><blockquote><p>对于外围设备广播出去的数据，是可以被多个中心设备接收到的，即广播数据的交互是一对多的。</p><p>基于广播数据的交互方式最典型的应用就是苹果的 <code>iBeacon</code>。</p></blockquote></li></ol><p>广播数据的工作模式下的网络拓扑图如下所示：</p><p><img src="/assets/06.08dd7359.png" alt="" loading="lazy"></p><h2 id="_5-gatt-generic-attribute-profile-通用属性配置文件" tabindex="-1"><a class="header-anchor" href="#_5-gatt-generic-attribute-profile-通用属性配置文件" aria-hidden="true">#</a> 5. <code>GATT</code>（<code>Generic Attribute Profile</code> 通用属性配置文件）</h2><h3 id="_5-1-gatt-概述" tabindex="-1"><a class="header-anchor" href="#_5-1-gatt-概述" aria-hidden="true">#</a> 5.1 <code>GATT</code> 概述</h3><p>低功耗蓝牙（<code>BLE</code>）连接都是建立在 <code>GATT</code> 协议之上的。</p><p><code>GATT</code> 是一个在蓝牙连接之上的发送和接收很短的数据段的通用规范。这些很短的数据段被称为属性（<code>Attribute</code>）。</p><p>在两个建立了连接的 <code>BLE</code> 设备之间进行通信时，<code>GATT</code> 定义 <code>Service</code> 和 <code>Characteristic</code> 这两种数据结构进行数据交互。</p><p><code>GATT</code> 使用了 <code>ATT</code> 协议（<code>Attribute Protocol</code>），<code>ATT</code> 协议将 <code>Service</code> 和 <code>Characteristic</code> 以及对应的数据保存在一个查找表中。</p><blockquote><p>查找表使用占 <code>16 bit</code> 的 <code>ID</code> 作为每一项的索引。</p></blockquote><h3 id="_5-2-gatt-gap-的关系" tabindex="-1"><a class="header-anchor" href="#_5-2-gatt-gap-的关系" aria-hidden="true">#</a> 5.2 <code>GATT</code> &amp; <code>GAP</code> 的关系</h3><p>只有在两个设备建立起连接之后，<code>GATT</code> 才开始起作用。这意味着必需先完成 <code>GAP</code> 协议。</p><blockquote><p><code>GAP</code> 协议的内容包括：发现（扫描）设备、连接设备等。</p></blockquote><p>实际上，在 <code>Android</code> 开发中，可以直接使用设备的 <code>mac</code> 地址发起连接，而不需要经过扫描的步骤。但是，这并不意味着不需要经过 <code>GAP</code>，因为在芯片级别上已经完成了扫描。也就是说：蓝牙芯片发起连接之前，总是得先扫描设备，只有扫描到了设备后才会发起连接。</p><h3 id="_5-3-gatt-连接是独占的-gatt-连接的网络拓扑图" tabindex="-1"><a class="header-anchor" href="#_5-3-gatt-连接是独占的-gatt-连接的网络拓扑图" aria-hidden="true">#</a> 5.3 <code>GATT</code> 连接是独占的 &amp; <code>GATT</code> 连接的网络拓扑图</h3><p><code>GATT</code> 连接是独占的，这意味着一个 <code>BLE</code> 外围设备只能同时被一个中心设备连接。</p><p><strong>一旦外围设备被连接，该外围设备就会马上停止广播</strong>。于是，被连接了的外围设备对其他设备就不可见了。当连接断开后，该外围设备又可以开始广播了。</p><p><img src="/assets/07.6548eac3.png" alt="" loading="lazy"></p><p>从如上图所示的 <code>GATT</code> 连接的网络拓扑结构中可以看出：<strong>一个外围设备只能连接一个中心设备，而一个中心设备可以连接多个外围设备</strong>。</p><p>一旦建立起了连接，通信就是双向的了，对比 <code>GAP</code> 中广播的网络拓扑结构可以看出：<strong><code>GAP</code> 通信是单向的</strong>。</p><p><strong>注意</strong>：</p><ol><li><p>中心设备和外围设备需要双向通信时，唯一的方式就是建立 <code>GATT</code> 连接；</p></li><li><p>如果要让两个外围设备能相互通信，只能通过中心设备进行中转。</p></li></ol><h3 id="_5-4-gatt-通信事务-数据交互流程" tabindex="-1"><a class="header-anchor" href="#_5-4-gatt-通信事务-数据交互流程" aria-hidden="true">#</a> 5.4 <code>GATT</code> 通信事务 &amp; 数据交互流程</h3><p><code>GATT</code> 通信的双方是 <code>C/S</code> 关系：</p><ol><li><p>外围设备（<code>Peripheral</code>）作为 <code>GATT</code> 服务端（<code>Server</code>）：维持了 <code>ATT</code> 的查找表，以及 <code>Service</code> 和 <code>Characteristic</code> 数据结构的定义。</p></li><li><p>中心设备（<code>Central</code>）作为 <code>GATT</code> 客户端（<code>Client</code>）：向 <code>Server</code> 发起请求。</p></li></ol><p><strong>所有的通信事务，都是由 <code>GATT</code> 客户端发起的</strong>，因此 <code>GATT</code> 客户端也称为主设备（<code>Master</code>）；<code>GATT</code> 服务端用于接收并处理主设备发起的通信事务，因此 <code>GATT</code> 服务端也称为从设备（<code>Slave</code>）。即：</p><ol><li>主设备发起通信事务，并接收从设备响应的事务处理结果；</li><li>从设备接收并处理事务，然后将事务处理结果发送给主设备。</li></ol><blockquote><p>注意：</p><ol><li><p>外围设备 &lt;=&gt; <code>GATT</code> 服务端 &lt;=&gt; 从设备，即：<code>Peripheral</code> &lt;=&gt; <code>Server</code> &lt;=&gt; <code>Slave</code></p></li><li><p>中心设备 &lt;=&gt; <code>GATT</code> 客户端 &lt;=&gt; 主设备，即：<code>Central</code> &lt;=&gt; <code>Client</code> &lt;=&gt; <code>Master</code></p></li></ol><p>其中，外围设备/中心设备是 <code>GAP</code> 中的称呼。</p><p><code>GATT</code> 服务端/<code>GATT</code> 客户端，或从设备/主设备是 <code>GATT</code> 中的称呼。</p></blockquote><p>一旦连接建立，外围设备将会给中心设备建议一个连接间隔（<code>Connection Interval</code>）。这样，中心设备就会在每个连接间隔尝试去重新连接，检测是否有新的数据。</p><blockquote><p>注意：这个连接间隔只是一个建议，你的中心设备可能并不会严格按照这个间隔来执行，例如：中心设备正忙于连接其它的外围设备；或中心设备资源太忙。</p></blockquote><p><img src="/assets/08.730a4cb5.png" alt="" loading="lazy"></p><p>从如上图所示的外围设备（<code>GATT</code> 服务端）和中心设备（<code>GATT</code> 客户端）之间的数据交互流程中可以看出：每次都是主设备（中心设备）发起请求的。</p><h3 id="_5-5-gatt-结构" tabindex="-1"><a class="header-anchor" href="#_5-5-gatt-结构" aria-hidden="true">#</a> 5.5 <code>GATT</code> 结构</h3><p><code>GATT</code> 事务是建立在嵌套的 <code>Profile</code>、<code>Service</code>、<code>Characteristic</code> 之上的，如下图所示：</p><p><img src="/assets/09.a4ca4f11.png" alt="" loading="lazy"></p><p>其中，更详细的 <code>Characteristic</code> 结构如下图所示：</p><p><img src="/assets/10.a94a7522.png" alt="" loading="lazy"></p><h4 id="_5-5-1-profile" tabindex="-1"><a class="header-anchor" href="#_5-5-1-profile" aria-hidden="true">#</a> 5.5.1 <code>Profile</code></h4><p><code>Profile</code> 并不是实际存在于 <code>BLE</code> 外围设备上的。</p><p><code>Profile</code> 只是一个被 <code>Bluetooth SIG</code> 或者外围设备的设计者所预先定义的 <strong><code>Service</code> 集合</strong>。</p><blockquote><p>如：心率 <code>Profile</code>（<code>Heart Rate Profile</code>）就是 <code>Heart Rate Service</code> 和 <code>Device Information Service</code> 的集合。</p></blockquote><blockquote><p><code>Bluetooth SIG</code> 即：<code>Bluetooth Special Interest Group</code> 蓝牙技术联盟。</p></blockquote><h4 id="_5-5-2-service" tabindex="-1"><a class="header-anchor" href="#_5-5-2-service" aria-hidden="true">#</a> 5.5.2 <code>Service</code></h4><p><code>Service</code> 是把数据分成一个个的独立逻辑项。<code>Service</code> 中包含一个或多个 <code>Characteristic</code>。</p><p>每个 <code>Service</code> 都有一个 <code>UUID</code> 唯一标识。</p><blockquote><p><code>UUID</code> 可包括 <code>16 bit</code> 的和 <code>128 bit</code> 的。其中：</p><ol><li><p><code>16 bit</code> 的 <code>UUID</code> 是官方通过认证的，需要花钱购买；</p></li><li><p><code>128 bit</code> 的 <code>UUID</code> 是自定义的，可以自己随便设置。</p></li></ol></blockquote><blockquote><p>另外，官方还定义了一些标准的 <code>Service</code>，如 <code>Heart Rate Service</code>。</p></blockquote><h4 id="_5-5-3-characteristic" tabindex="-1"><a class="header-anchor" href="#_5-5-3-characteristic" aria-hidden="true">#</a> 5.5.3 <code>Characteristic</code></h4><p><code>Characteristic</code> 是 <code>GATT</code> 事务中的最小逻辑单元。</p><p>与 <code>Service</code> 类似，每个 <code>Characteristic</code> 都有一个 <code>UUID</code> 唯一标识（可以是 <code>16 bit</code> 或 <code>128 bit</code>）。</p><p><code>Bluetooth SIG</code>（蓝牙技术联盟）定义了一些标准的 <code>Characteristic</code>（免费使用），使用这些标准的 <code>Characteristic</code> 可以保证软件和硬件能相互兼容。</p><blockquote><p>当然，可以自定义 <code>Characteristic</code>。这样的话，就只有你自己开发的软件和外设能够识别 <code>Characteristic</code>，进行通信。</p></blockquote><p>中心设备（<code>GATT</code> 客户端）和外围设备（<code>GATT</code> 服务端）主要是通过 <code>Characteristic</code> 进行数据交互。即：你可以从 <code>Characteristic</code> 中读取数据，也可以向 <code>Characteristic</code> 中写入数据，从而实现双向通信。</p><h2 id="_6-ble-的开发流程" tabindex="-1"><a class="header-anchor" href="#_6-ble-的开发流程" aria-hidden="true">#</a> 6. <code>BLE</code> 的开发流程</h2><h3 id="_6-1-申请蓝牙相关的权限" tabindex="-1"><a class="header-anchor" href="#_6-1-申请蓝牙相关的权限" aria-hidden="true">#</a> 6.1 申请蓝牙相关的权限</h3><p>需要申请三个静态权限：</p><div class="language-xml ext-xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.BLUETOOTH<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.BLUETOOTH_ADMIN<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.ACCESS_COARSE_LOCATION<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>需要向应用市场告知：该 <code>App</code> 需要用到 <code>BLE</code>。（如果手机设备不支持 <code>BLE</code>，那么无法在应用市场下载该 <code>App</code>）</p><blockquote><p><code>uses-feature</code> 仅仅只是描述 <code>App</code> 会用到什么功能，并不会去申请相关的权限。</p></blockquote><div class="language-xml ext-xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-feature</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.hardware.bluetooth.le<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>required</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>需要动态申请 <code>ACCESS_COARSE_LOCATION</code> 定位权限：</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">PERMISSION_GRANTED</span> <span class="token operator">==</span> <span class="token class-name">ContextCompat</span><span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">ACCESS_COARSE_LOCATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//has permission, do operation directly</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//do not have permission</span>
        <span class="token comment">// Should we show an explanation?</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ActivityCompat</span><span class="token punctuation">.</span><span class="token function">shouldShowRequestPermissionRationale</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">ACCESS_COARSE_LOCATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Show an explanation to the user *asynchronously* -- don&#39;t block</span>
            <span class="token comment">// this thread waiting for the user&#39;s response! After the user</span>
            <span class="token comment">// sees the explanation, try again to request the permission.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// No explanation needed, we can request the permission.</span>
            <span class="token class-name">ActivityCompat</span><span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">ACCESS_COARSE_LOCATION</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// MY_PERMISSIONS_REQUEST_READ_CONTACTS is an</span>
            <span class="token comment">// app-defined int constant. The callback method gets the</span>
            <span class="token comment">// result of the request.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-2-检查手机是否支持蓝牙设备-以及是否支持蓝牙-4-0-ble-功能" tabindex="-1"><a class="header-anchor" href="#_6-2-检查手机是否支持蓝牙设备-以及是否支持蓝牙-4-0-ble-功能" aria-hidden="true">#</a> 6.2 检查手机是否支持蓝牙设备 &amp; 以及是否支持蓝牙 <code>4.0</code>（<code>BLE</code>）功能</h3><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">final</span> <span class="token class-name">BluetoothManager</span> bluetoothManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BLUETOOTH_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// bluetoothManager.getAdapter() 返回的 adapter 就是 BluetoothAdapter.getDefaultAdapter() 返回的。</span>
    mBluetoothAdapter <span class="token operator">=</span> bluetoothManager<span class="token punctuation">.</span><span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
        BLE（低功耗蓝牙）也是蓝牙的一种，所以也得先判断手机是否具有蓝牙功能：
            如果拿不到 BluetoothAdapter 对象，那么说明手机不支持蓝牙功能。从而更别说支持 BLE 了。
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string">&quot;手机支持蓝牙功能&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
        如果手机支持蓝牙功能，那么还需要进一步判断是否具有 BLE 特性（即是否支持 BLE）。
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasSystemFeature</span><span class="token punctuation">(</span><span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">FEATURE_BLUETOOTH_LE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string">&quot;手机不支持蓝牙BLE功能&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string">&quot;手机支持蓝牙BLE功能!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-3-打开蓝牙功能" tabindex="-1"><a class="header-anchor" href="#_6-3-打开蓝牙功能" aria-hidden="true">#</a> 6.3 打开蓝牙功能</h3><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        如果手机支持蓝牙功能，那么在使用蓝牙前，需要先判断有没有打开蓝牙功能。
        没有的话，则跳转到系统设置中将蓝牙功能打开。
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//申请打开蓝牙功能</span>
        <span class="token class-name">Intent</span> enableBtIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name">BluetoothAdapter</span><span class="token punctuation">.</span><span class="token constant">ACTION_REQUEST_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">startActivity</span><span class="token punctuation">(</span>enableBtIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-4-扫描附近的设备" tabindex="-1"><a class="header-anchor" href="#_6-4-扫描附近的设备" aria-hidden="true">#</a> 6.4 扫描附近的设备</h3><p>获取扫描器 <code>BluetoothLeScanner</code> 对象 &amp; 设置扫描相关的配置参数：</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token keyword">private</span> <span class="token class-name">BluetoothLeScanner</span> mLeScanner<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">ScanSettings</span> mScanSettings<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&gt;=</span> <span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION_CODES</span><span class="token punctuation">.</span><span class="token constant">LOLLIPOP</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
            1. 扫描模式 SCAN_MODE_LOW_LATENCY 表示低延迟的扫描方式，也就是占空比最大的扫描方式。其中：
               占空比就是在一个扫描周期中，扫描持续的工作时长占整个周期时长的比例。
               占空比越高，说明一个扫描周期中，扫描的持续工作时间越长。因此，扫描速度越快。
            2. setReportDelay(3000) 表示在扫描到设备后，延迟 3s 上报（即触发回调函数）
            3. ScanSettings 对象在调用 BluetoothLeScanner.startScan 方法开始扫描时，作为实参传入。
        */</span>
        mLeScanner <span class="token operator">=</span> mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">getBluetoothLeScanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mScanSettings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanSettings<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setScanMode</span><span class="token punctuation">(</span><span class="token class-name">ScanSettings</span><span class="token punctuation">.</span><span class="token constant">SCAN_MODE_LOW_LATENCY</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setReportDelay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>开始扫描 &amp; 停止扫描：</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mBtScan <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Button</span><span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>bt_scan<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mBtScan<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mIsScanStart<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 点击按钮开始扫描，并在下一次点击按钮之前将按钮文本改为 “停止扫描”</span>
                mBtScan<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">&quot;停止扫描&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mIsScanStart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">scan</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>             <span class="token comment">// 点击按钮停止扫描，并在下一次点击按钮之前将按钮文本改为 “开始扫描”</span>
                mBtScan<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">&quot;开始扫描&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mIsScanStart <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token function">scan</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@TargetApi</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ScanCallback</span> scanCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
            当扫描到蓝牙设备时，触发回调方法 ScanCallback.onScanResult(int, ScanResult)
            注意：
                1. 每扫描到一个蓝牙设备触发一次回调
                2. 参数 ScanResult 中封装了扫描到的蓝牙设备 BluetoothDevice 对象
        */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onScanResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> callbackType<span class="token punctuation">,</span> <span class="token class-name">ScanResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onScanResult</span><span class="token punctuation">(</span>callbackType<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BluetoothDevice</span> device <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;name = &quot;</span> <span class="token operator">+</span> device<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, address = &quot;</span> <span class="token operator">+</span> device<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mBleTextView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; - &quot;</span> <span class="token operator">+</span> device<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mBleAddress <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLeScanner<span class="token punctuation">.</span><span class="token function">startScan</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> mScanSettings<span class="token punctuation">,</span> scanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 开始扫描</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mLeScanner<span class="token punctuation">.</span><span class="token function">stopScan</span><span class="token punctuation">(</span>scanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 停止扫描</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>从 <code>BluetoothLeScanner.startScan</code> 方法源码中的文档注释可以看出：调用 <code>startScan</code> 方法需要 <code>BLUETOOTH_ADMIN</code> 和 <code>ACCESS_FINE_LOCATION</code> 权限。</p></blockquote><h3 id="_6-5-连接-断开-ble-设备" tabindex="-1"><a class="header-anchor" href="#_6-5-连接-断开-ble-设备" aria-hidden="true">#</a> 6.5 连接 &amp; 断开 <code>BLE</code> 设备</h3><p><code>step1</code>：先获取扫描到的蓝牙设备的 <code>mac</code> 地址 <code>address</code></p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> mBleAddress <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@TargetApi</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ScanCallback</span> scanCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onScanResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> callbackType<span class="token punctuation">,</span> <span class="token class-name">ScanResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BluetoothDevice</span> device <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取扫描到的蓝牙设备的 mac 地址</span>
            mBleAddress <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLeScanner<span class="token punctuation">.</span><span class="token function">startScan</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> mScanSettings<span class="token punctuation">,</span> scanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mLeScanner<span class="token punctuation">.</span><span class="token function">stopScan</span><span class="token punctuation">(</span>scanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>step2</code>：调用 <code>BluetoothAdapter.getRemoteDevice(address)</code> 方法，根据 <code>mac</code> 地址得到远程蓝牙设备的 <code>BluetoothDevice</code> 对象</p><p><code>step3</code>：调用 <code>BluetoothDevice.connectGatt(context, autoConnect, callback)</code> 方法请求连接远程蓝牙设备</p><p><code>step4</code>：当远程蓝牙设备连接或断开时，会触发 <code>connectGatt</code> 方法中参数 <code>callback</code> 的回调方法 <code>onConnectionStateChange</code></p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mConnectButton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Button</span><span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>bt_connect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mConnectButton<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mIsConnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">BluetoothGatt</span> mGatt<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// step2. 根据 mac 地址得到远程蓝牙设备（即外围设备）的 BluetoothDevice 对象</span>
    <span class="token keyword">final</span> <span class="token class-name">BluetoothDevice</span> device <span class="token operator">=</span> mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">getRemoteDevice</span><span class="token punctuation">(</span>mBleAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// step3. 请求连接远程蓝牙设备</span>
    mGatt <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">connectGatt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mGatt <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 断开与远程蓝牙设备的连接</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mGatt <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mGatt<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BluetoothGattCallback</span> mCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothGattCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionStateChange</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">int</span> newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// step4. 当远程蓝牙设备连接或断开时，会触发回调方法 onConnectionStateChange</span>
        mMainUIHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>newState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServicesDiscovered</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicRead</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicWrite</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicChanged</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Handler</span> mMainUIHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> newState <span class="token operator">=</span> msg<span class="token punctuation">.</span>what<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">STATE_CONNECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 远程蓝牙设备已连接</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">STATE_DISCONNECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 远程蓝牙设备已断开</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>注意：</p><ol><li><p>调用 <code>BluetoothDevice.connectGatt(context, autoConnect, callback)</code> 方法连接远程蓝牙设备时，<code>BluetoothGattCallback</code> 类型的参数 <code>callback</code> 提供了一系列回调方法，用于监听蓝牙设备的连接状态、数据读写等操作；</p></li><li><p><code>BluetoothGattCallback</code> 中的回调方法是在 <code>binder</code> 线程中调用的，因此不能直接在回调方法中更新 <code>UI</code>；</p></li><li><p><code>connectGatt</code> 方法的返回值为 <code>BluetoothGatt</code> 对象，可用于操作已连接上的远程蓝牙设备（如：断开连接、读写数据等）。</p></li></ol><h3 id="_6-6-发现-查询-蓝牙设备的-service-和-characteristic-特征值" tabindex="-1"><a class="header-anchor" href="#_6-6-发现-查询-蓝牙设备的-service-和-characteristic-特征值" aria-hidden="true">#</a> 6.6 发现（查询）蓝牙设备的 <code>Service</code> 和 <code>Characteristic</code>（特征值）</h3><p>当中心设备（即 <code>GATT</code> 客户端，如运行 <code>SensorTag App</code> 的手机）与外围设备（即 <code>GATT</code> 服务端，如 <code>SensorTag</code>）建立起 <code>GATT</code> 连接后，可调用 <code>BluetoothGatt.discoverServices()</code> 方法查询外围设备提供的服务列表（<a href="#_5-5-1-profile"><code>Profile</code></a> 是 <code>Service</code> 的集合，即查询外围设备的 <code>Profile</code>）。</p><p>当查询到服务列表时，会执行 <code>BluetoothGattCallback</code> 的回调函数 <code>onServiceDiscoverd</code>。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mDiscoveryButton<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mGatt <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                    mGatt 是在连接外围设备时调用 `BluetoothDevice.connectGatt` 方法返回的。
                    调用 mGatt.discoverServices() 方法获取外围设备中的 Profile（即 Service 集合）
                */</span>
                mGatt<span class="token punctuation">.</span><span class="token function">discoverServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">/* BleActivity.java */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BluetoothGattCallback</span> mCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothGattCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServicesDiscovered</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
            1. 当中心设备查询到外围设备中的 Profile 时，会通过该回调方法接收一个封装了 Profile 的参数 gatt
            2. 自定义 discoverGattService(services) 方法，遍历外围设备的 Profile 中的 Service 集合。
        */</span>
        <span class="token function">discoverGattService</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">discoverGattService</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BluetoothGattService</span><span class="token punctuation">&gt;</span></span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>services <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothGattService</span> service <span class="token operator">:</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">/*
            遍历 Profile 中 Service 集合内的每个 Service，并打印 Service 的 UUID
        */</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Service uuid = &quot;</span> <span class="token operator">+</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
            每个 Service 中包含一个或多个 Characteristic（特征值），
            遍历 Service 中包含的所有 Characteristic，并打印每个 Characteristic 的 UUID
        */</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BluetoothGattCharacteristic</span><span class="token punctuation">&gt;</span></span> characteristics <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getCharacteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothGattCharacteristic</span> characteristic <span class="token operator">:</span> characteristics<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> char_uuid <span class="token operator">=</span> characteristic<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Characteristic uuid = &quot;</span> <span class="token operator">+</span> char_uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-7-示例-1-特征值中的描述符-bluetoothgattdescriptor" tabindex="-1"><a class="header-anchor" href="#_6-7-示例-1-特征值中的描述符-bluetoothgattdescriptor" aria-hidden="true">#</a> 6.7 示例 1：特征值中的描述符（<code>BluetoothGattDescriptor</code>）</h3><p><img src="/assets/11.ac69e3ac.png" alt="" loading="lazy"></p><h3 id="_6-8-示例-2-与红外温度传感器-外围设备-的数据交互" tabindex="-1"><a class="header-anchor" href="#_6-8-示例-2-与红外温度传感器-外围设备-的数据交互" aria-hidden="true">#</a> 6.8 示例 2：与红外温度传感器（外围设备）的数据交互</h3><p><img src="/assets/12.a3e731fe.png" alt="" loading="lazy"></p><h3 id="_6-9-示例-3-sensortag-属性表-基于-att-协议的查找表" tabindex="-1"><a class="header-anchor" href="#_6-9-示例-3-sensortag-属性表-基于-att-协议的查找表" aria-hidden="true">#</a> 6.9 示例 3：<code>SensorTag</code> 属性表（基于 <code>ATT</code> 协议的查找表）</h3><p><img src="/assets/13.fd9ad9ce.png" alt="" loading="lazy"></p><!--]--></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/zengkaiqiang562/JavaGuide/edit/main/docs/zkq/android/bluetooth/ble.md" rel="noopener noreferrer" target="_blank" arialabel="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" arialabelledby="edit"><title id="edit" lang="en">edit icon</title><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/7/7 18:02:39</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: zengkaiqiang562@163.com">zengk</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/zkq/android/bluetooth/classic-bluetooth.html" class="nav-link prev" arialabel="经典蓝牙"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->经典蓝牙</div></a><!----></nav><!----><!----></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright © 2023 Zenk562</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.625aa393.js" defer></script>
  </body>
</html>
